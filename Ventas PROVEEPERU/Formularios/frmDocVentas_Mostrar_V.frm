VERSION 5.00
Object = "{6A24B331-7634-11D3-A5B0-0050044A7E1A}#1.5#0"; "DXDBGrid.dll"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "MSCOMCTL.OCX"
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCT2.OCX"
Object = "{F41D1D30-7878-4923-8CB3-6CCACDC9C9DE}#1.0#0"; "CATControls.ocx"
Begin VB.Form frmDocVentas_Mostrar_V 
   Appearance      =   0  'Flat
   BorderStyle     =   3  'Fixed Dialog
   Caption         =   "Ventas - Versiones"
   ClientHeight    =   9585
   ClientLeft      =   3690
   ClientTop       =   2940
   ClientWidth     =   13380
   BeginProperty Font 
      Name            =   "Arial"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   MDIChild        =   -1  'True
   MinButton       =   0   'False
   ScaleHeight     =   9585
   ScaleWidth      =   13380
   ShowInTaskbar   =   0   'False
   Begin VB.Frame fraListado 
      Appearance      =   0  'Flat
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   8865
      Left            =   120
      TabIndex        =   59
      Top             =   690
      Width           =   13215
      Begin VB.Frame FraAtencionPed 
         Appearance      =   0  'Flat
         ForeColor       =   &H80000008&
         Height          =   2970
         Left            =   3180
         TabIndex        =   220
         Top             =   2250
         Visible         =   0   'False
         Width           =   6630
         Begin VB.Frame Frame4 
            Height          =   1125
            Left            =   900
            TabIndex        =   229
            Top             =   1710
            Width           =   3195
            Begin VB.TextBox TxtcantProducto_Atn 
               Alignment       =   1  'Right Justify
               BackColor       =   &H00C0FFFF&
               Height          =   345
               Left            =   1800
               TabIndex        =   233
               Top             =   660
               Width           =   1275
            End
            Begin VB.TextBox TxtcantProducto 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H00FFFFC0&
               Height          =   345
               Left            =   1800
               Locked          =   -1  'True
               TabIndex        =   232
               Top             =   240
               Width           =   1275
            End
            Begin VB.Label Label11 
               Caption         =   "Cantidad Atentida"
               BeginProperty Font 
                  Name            =   "Arial"
                  Size            =   9
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   195
               Left            =   120
               TabIndex        =   231
               Top             =   720
               Width           =   1515
            End
            Begin VB.Label Label10 
               Caption         =   "Cantidad Pedido"
               BeginProperty Font 
                  Name            =   "Arial"
                  Size            =   9
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   195
               Left            =   120
               TabIndex        =   230
               Top             =   330
               Width           =   1485
            End
         End
         Begin VB.TextBox TxtDesproducto 
            Appearance      =   0  'Flat
            BackColor       =   &H00FFFFC0&
            Height          =   345
            Left            =   900
            Locked          =   -1  'True
            TabIndex        =   225
            Top             =   1350
            Width           =   5595
         End
         Begin VB.TextBox TxtCodProducto 
            Alignment       =   2  'Center
            Appearance      =   0  'Flat
            BackColor       =   &H00FFFFC0&
            Height          =   345
            Left            =   900
            Locked          =   -1  'True
            TabIndex        =   224
            Top             =   960
            Width           =   1275
         End
         Begin VB.TextBox txtItmProducto 
            Alignment       =   2  'Center
            Appearance      =   0  'Flat
            BackColor       =   &H00FFFFC0&
            Height          =   345
            Left            =   900
            Locked          =   -1  'True
            TabIndex        =   223
            Top             =   570
            Width           =   675
         End
         Begin VB.CommandButton CmdCancelarAtn 
            Caption         =   "Cancelar"
            Height          =   450
            Left            =   4260
            Style           =   1  'Graphical
            TabIndex        =   222
            Top             =   2370
            Width           =   1455
         End
         Begin VB.CommandButton CmdAceptarAtn 
            Caption         =   "&Aceptar"
            Height          =   450
            Left            =   4260
            Style           =   1  'Graphical
            TabIndex        =   221
            Top             =   1800
            Width           =   1455
         End
         Begin VB.Label Label12 
            Alignment       =   2  'Center
            Appearance      =   0  'Flat
            BackColor       =   &H8000000D&
            Caption         =   "REGISTRO DE ATENCIÓN"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   9
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   285
            Left            =   0
            TabIndex        =   234
            Top             =   120
            Width           =   6615
         End
         Begin VB.Label Label9 
            Caption         =   "Producto"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   9
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Left            =   60
            TabIndex        =   228
            Top             =   1410
            Width           =   855
         End
         Begin VB.Label Label8 
            Caption         =   "Codigo"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   9
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Left            =   60
            TabIndex        =   227
            Top             =   1050
            Width           =   645
         End
         Begin VB.Label Label7 
            Caption         =   "Item"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   9
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Left            =   90
            TabIndex        =   226
            Top             =   660
            Width           =   645
         End
      End
      Begin VB.Frame FraModificaCC 
         Appearance      =   0  'Flat
         ForeColor       =   &H80000008&
         Height          =   1860
         Left            =   2430
         TabIndex        =   185
         Top             =   2250
         Visible         =   0   'False
         Width           =   7980
         Begin VB.CommandButton CmdCancelarCC 
            Caption         =   "Cancelar"
            Height          =   390
            Left            =   4185
            Style           =   1  'Graphical
            TabIndex        =   194
            Top             =   1260
            Width           =   1185
         End
         Begin VB.CommandButton CmdAceptar 
            Caption         =   "&Aceptar"
            Height          =   390
            Left            =   2925
            Style           =   1  'Graphical
            TabIndex        =   193
            Top             =   1260
            Width           =   1185
         End
         Begin VB.CommandButton CmdAyudaCentroCostoNuevo 
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   7305
            Picture         =   "frmDocVentas_Mostrar_V.frx":0000
            Style           =   1  'Graphical
            TabIndex        =   189
            Top             =   765
            Width           =   390
         End
         Begin CATControls.CATTextBox TxtGlsCentroCostoAnt 
            Height          =   315
            Left            =   2520
            TabIndex        =   186
            Top             =   315
            Width           =   4725
            _ExtentX        =   8334
            _ExtentY        =   556
            BackColor       =   16777152
            Enabled         =   0   'False
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Container       =   "frmDocVentas_Mostrar_V.frx":038A
            Vacio           =   -1  'True
         End
         Begin CATControls.CATTextBox TxtCodCentroCostoAnt 
            Height          =   315
            Left            =   1575
            TabIndex        =   187
            Top             =   315
            Width           =   915
            _ExtentX        =   1614
            _ExtentY        =   556
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Locked          =   -1  'True
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":03A6
            Estilo          =   1
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtGlsCentroCostoNuevo 
            Height          =   315
            Left            =   2520
            TabIndex        =   190
            Top             =   765
            Width           =   4725
            _ExtentX        =   8334
            _ExtentY        =   556
            BackColor       =   16777152
            Enabled         =   0   'False
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Container       =   "frmDocVentas_Mostrar_V.frx":03C2
            Vacio           =   -1  'True
         End
         Begin CATControls.CATTextBox TxtCodCentroCostoNuevo 
            Height          =   315
            Left            =   1575
            TabIndex        =   191
            Top             =   765
            Width           =   915
            _ExtentX        =   1614
            _ExtentY        =   556
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":03DE
            Estilo          =   1
            EnterTab        =   -1  'True
         End
         Begin VB.Label Label5 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "C.Costo Nuevo"
            ForeColor       =   &H80000007&
            Height          =   210
            Left            =   270
            TabIndex        =   192
            Top             =   810
            Width           =   1080
         End
         Begin VB.Label Label4 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "C.Costo Anterior"
            ForeColor       =   &H80000007&
            Height          =   210
            Left            =   270
            TabIndex        =   188
            Top             =   360
            Width           =   1200
         End
      End
      Begin VB.Frame Frame1 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   735
         Left            =   120
         TabIndex        =   60
         Top             =   240
         Width           =   12960
         Begin CATControls.CATTextBox txt_TextoBuscar 
            Height          =   315
            Left            =   990
            TabIndex        =   0
            Top             =   270
            Width           =   4935
            _ExtentX        =   8705
            _ExtentY        =   556
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Container       =   "frmDocVentas_Mostrar_V.frx":03FA
            Estilo          =   1
            Vacio           =   -1  'True
            EnterTab        =   -1  'True
         End
         Begin VB.ComboBox cbx_Mes 
            Height          =   330
            ItemData        =   "frmDocVentas_Mostrar_V.frx":0416
            Left            =   8670
            List            =   "frmDocVentas_Mostrar_V.frx":043E
            Style           =   2  'Dropdown List
            TabIndex        =   1
            Top             =   270
            Width           =   2025
         End
         Begin CATControls.CATTextBox txt_Ano 
            Height          =   315
            Left            =   11610
            TabIndex        =   2
            Top             =   270
            Width           =   870
            _ExtentX        =   1535
            _ExtentY        =   556
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Container       =   "frmDocVentas_Mostrar_V.frx":04A7
            Estilo          =   3
            Vacio           =   -1  'True
            EnterTab        =   -1  'True
         End
         Begin VB.ComboBox CbxGanadas 
            Height          =   330
            ItemData        =   "frmDocVentas_Mostrar_V.frx":04C3
            Left            =   6720
            List            =   "frmDocVentas_Mostrar_V.frx":04D0
            Style           =   2  'Dropdown List
            TabIndex        =   218
            Top             =   270
            Width           =   1335
         End
         Begin VB.Label Label3 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "Año"
            ForeColor       =   &H80000008&
            Height          =   210
            Left            =   11130
            TabIndex        =   79
            Top             =   330
            Width           =   300
         End
         Begin VB.Label Label2 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "Mes"
            ForeColor       =   &H80000008&
            Height          =   210
            Left            =   8280
            TabIndex        =   78
            Top             =   330
            Width           =   300
         End
         Begin VB.Label Label1 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "Búsqueda"
            ForeColor       =   &H80000008&
            Height          =   210
            Left            =   210
            TabIndex        =   61
            Top             =   330
            Width           =   735
         End
         Begin VB.Label Label6 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            Caption         =   "Ganadas"
            ForeColor       =   &H80000008&
            Height          =   210
            Left            =   6000
            TabIndex        =   219
            Top             =   300
            Width           =   660
         End
      End
      Begin DXDBGRIDLibCtl.dxDBGrid gListaDetalle 
         Height          =   3210
         Left            =   90
         OleObjectBlob   =   "frmDocVentas_Mostrar_V.frx":04E3
         TabIndex        =   4
         Top             =   5475
         Width           =   13035
      End
      Begin DXDBGRIDLibCtl.dxDBGrid gLista 
         Height          =   4185
         Left            =   120
         OleObjectBlob   =   "frmDocVentas_Mostrar_V.frx":411F
         TabIndex        =   3
         Top             =   1080
         Width           =   12975
      End
   End
   Begin VB.Frame Frame2 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   4125
      Index           =   0
      Left            =   3300
      TabIndex        =   151
      Top             =   6750
      Visible         =   0   'False
      Width           =   7110
      Begin VB.CommandButton Command2 
         Caption         =   "&Cancelar"
         Height          =   390
         Index           =   0
         Left            =   3735
         Style           =   1  'Graphical
         TabIndex        =   154
         Top             =   3540
         Width           =   1140
      End
      Begin VB.CommandButton Command1 
         Caption         =   "&Aceptar"
         Height          =   390
         Index           =   0
         Left            =   2295
         Style           =   1  'Graphical
         TabIndex        =   153
         Top             =   3555
         Width           =   1140
      End
      Begin VB.TextBox CATTextBox1 
         Height          =   3045
         Index           =   0
         Left            =   90
         MultiLine       =   -1  'True
         ScrollBars      =   2  'Vertical
         TabIndex        =   152
         Top             =   270
         Width           =   6915
      End
   End
   Begin VB.Frame FraFormatoImp 
      Caption         =   " Formato de Impresión "
      Height          =   1560
      Left            =   4080
      TabIndex        =   166
      Top             =   5760
      Visible         =   0   'False
      Width           =   4665
      Begin VB.CommandButton CmdCancelar 
         Caption         =   "Cancelar"
         Height          =   405
         Left            =   2370
         TabIndex        =   170
         Top             =   945
         Width           =   1305
      End
      Begin VB.OptionButton OptFormatoImp 
         Caption         =   "Formato 1"
         Height          =   315
         Index           =   0
         Left            =   825
         TabIndex        =   169
         Top             =   390
         Value           =   -1  'True
         Width           =   1320
      End
      Begin VB.OptionButton OptFormatoImp 
         Caption         =   "Formato 2"
         Height          =   315
         Index           =   1
         Left            =   2715
         TabIndex        =   168
         Top             =   375
         Width           =   1320
      End
      Begin VB.CommandButton CmdImprime 
         Caption         =   "Imprimir"
         Height          =   405
         Left            =   1005
         TabIndex        =   167
         Top             =   945
         Width           =   1305
      End
   End
   Begin VB.Frame fraTotales 
      Appearance      =   0  'Flat
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   690
      Left            =   90
      TabIndex        =   23
      Top             =   8775
      Width           =   13245
      Begin CATControls.CATTextBox txt_TotalDsctoVV 
         Height          =   285
         Left            =   1830
         TabIndex        =   117
         Top             =   60
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   12640511
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":96FA
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalDsctoPV 
         Height          =   285
         Left            =   2760
         TabIndex        =   119
         Top             =   60
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   12640511
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":9716
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalBruto 
         Height          =   315
         Left            =   5625
         TabIndex        =   80
         Top             =   225
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   556
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontBold        =   -1  'True
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":9732
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalIGV 
         Height          =   315
         Left            =   8190
         TabIndex        =   81
         Top             =   225
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   556
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontBold        =   -1  'True
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":974E
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalNeto 
         Height          =   315
         Left            =   10950
         TabIndex        =   82
         Tag             =   "NTotalPrecioVenta"
         Top             =   225
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   556
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontBold        =   -1  'True
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":976A
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_MontoLetras 
         Height          =   285
         Left            =   75
         TabIndex        =   98
         Tag             =   "TtotalLetras"
         Top             =   375
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   33023
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":9786
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_SimboloMonBruto 
         Height          =   285
         Left            =   1050
         TabIndex        =   99
         Tag             =   "TsimboloMonBruto"
         Top             =   375
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   33023
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":97A2
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_DocReferencia 
         Height          =   285
         Left            =   4050
         TabIndex        =   106
         Tag             =   "TGlsDocReferencia"
         Top             =   375
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   33023
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":97BE
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_SimboloMonIGV 
         Height          =   285
         Left            =   2025
         TabIndex        =   107
         Tag             =   "TsimboloMonIGV"
         Top             =   375
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   33023
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":97DA
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_SimboloMonNeto 
         Height          =   285
         Left            =   2970
         TabIndex        =   108
         Tag             =   "TsimboloMonNeto"
         Top             =   405
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   33023
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":97F6
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalExonerado 
         Height          =   285
         Left            =   3570
         TabIndex        =   118
         Top             =   60
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   12640511
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":9812
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TotalBaseImponible 
         Height          =   285
         Left            =   5625
         TabIndex        =   120
         Top             =   225
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   16775664
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":982E
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox TxtTotalIvap 
         Height          =   315
         Left            =   8190
         TabIndex        =   197
         Tag             =   "NTotalCosto"
         Top             =   0
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   556
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontBold        =   -1  'True
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":984A
         Text            =   "0"
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox TxtTotalDescuento 
         Height          =   285
         Left            =   0
         TabIndex        =   207
         Tag             =   "NTotalDescuento"
         Top             =   0
         Visible         =   0   'False
         Width           =   1005
         _ExtentX        =   1773
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":9866
         Text            =   "------- "
         Decimales       =   2
         TextoInicio     =   "0"
         EnterTab        =   -1  'True
      End
      Begin VB.Label LblSimboloMonIvap 
         Appearance      =   0  'Flat
         Caption         =   "S/."
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   7830
         TabIndex        =   199
         Top             =   45
         Visible         =   0   'False
         Width           =   330
      End
      Begin VB.Label LblTotalIvap 
         Appearance      =   0  'Flat
         Caption         =   "Total Costo"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   6825
         TabIndex        =   198
         Top             =   0
         Visible         =   0   'False
         Width           =   1020
      End
      Begin VB.Label lbl_SimbMonBruto 
         Appearance      =   0  'Flat
         Caption         =   "S/."
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   5280
         TabIndex        =   97
         Top             =   270
         Visible         =   0   'False
         Width           =   285
      End
      Begin VB.Label lbl_SimbMonIGV 
         Appearance      =   0  'Flat
         Caption         =   "S/."
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   7830
         TabIndex        =   96
         Top             =   270
         Visible         =   0   'False
         Width           =   330
      End
      Begin VB.Label lbl_SimbMonNeto 
         Appearance      =   0  'Flat
         Caption         =   "S/."
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   10560
         TabIndex        =   95
         Top             =   270
         Visible         =   0   'False
         Width           =   330
      End
      Begin VB.Label lbl_TotalLetras 
         Appearance      =   0  'Flat
         ForeColor       =   &H80000007&
         Height          =   390
         Left            =   120
         TabIndex        =   90
         Top             =   225
         Visible         =   0   'False
         Width           =   4500
      End
      Begin VB.Label lbl_TotalNeto 
         Appearance      =   0  'Flat
         Caption         =   "Total"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   9960
         TabIndex        =   85
         Top             =   270
         Visible         =   0   'False
         Width           =   540
      End
      Begin VB.Label lbl_TotalIGV 
         Appearance      =   0  'Flat
         Caption         =   "IGV"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   7425
         TabIndex        =   84
         Top             =   270
         Visible         =   0   'False
         Width           =   330
      End
      Begin VB.Label lbl_TotalBruto 
         Appearance      =   0  'Flat
         Caption         =   "Bruto"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   4665
         TabIndex        =   83
         Top             =   270
         Visible         =   0   'False
         Width           =   465
      End
   End
   Begin MSComctlLib.Toolbar Toolbar1 
      Height          =   660
      Left            =   90
      TabIndex        =   159
      Top             =   0
      Width           =   13230
      _ExtentX        =   23336
      _ExtentY        =   1164
      ButtonWidth     =   3043
      ButtonHeight    =   1005
      AllowCustomize  =   0   'False
      Appearance      =   1
      ImageList       =   "imgDocVentas"
      _Version        =   393216
      BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
         NumButtons      =   24
         BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "      Nuevo      "
            Object.ToolTipText     =   "Nuevo"
            ImageIndex      =   1
         EndProperty
         BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Grabar"
            Object.ToolTipText     =   "Grabar"
            ImageIndex      =   4
         EndProperty
         BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Modificar"
            Object.ToolTipText     =   "Modificar"
            ImageIndex      =   10
         EndProperty
         BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Cancelar"
            Object.ToolTipText     =   "Cancelar"
            ImageIndex      =   9
         EndProperty
         BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Eliminar"
            Object.ToolTipText     =   "Eliminar"
            ImageIndex      =   6
         EndProperty
         BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Anular"
            Object.ToolTipText     =   "Anular"
            ImageIndex      =   6
         EndProperty
         BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Imprimir"
            Object.ToolTipText     =   "Imprimir"
            ImageIndex      =   11
         EndProperty
         BeginProperty Button8 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Guia Abierta"
            Object.ToolTipText     =   "Imp Guia Abierta"
            ImageIndex      =   11
         EndProperty
         BeginProperty Button9 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Lista"
            Object.ToolTipText     =   "Lista"
            ImageIndex      =   12
         EndProperty
         BeginProperty Button10 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Excel"
            Object.ToolTipText     =   "Excel"
            ImageIndex      =   13
         EndProperty
         BeginProperty Button11 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Versiones"
            Object.ToolTipText     =   "Pagos"
            ImageIndex      =   14
         EndProperty
         BeginProperty Button12 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Letras"
            Object.ToolTipText     =   "Letras"
            ImageIndex      =   5
         EndProperty
         BeginProperty Button13 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Importar"
            Object.ToolTipText     =   "Importar"
            ImageIndex      =   15
         EndProperty
         BeginProperty Button14 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Grabar Contado"
            Object.ToolTipText     =   "Grabar Contado"
            ImageIndex      =   16
         EndProperty
         BeginProperty Button15 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Imp.Decla"
            ImageIndex      =   8
         EndProperty
         BeginProperty Button16 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Aprobacion"
            ImageIndex      =   16
         EndProperty
         BeginProperty Button17 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Quitar Aprob."
            ImageIndex      =   8
         EndProperty
         BeginProperty Button18 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Previo"
            Key             =   "Previo"
            ImageIndex      =   11
         EndProperty
         BeginProperty Button19 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Importar"
            Object.ToolTipText     =   "Importar Documentos Entre Empresas"
            ImageIndex      =   15
         EndProperty
         BeginProperty Button20 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Preliminar"
            Object.ToolTipText     =   "Preliminar"
            ImageIndex      =   11
         EndProperty
         BeginProperty Button21 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Imp. H. Blanco"
            Object.ToolTipText     =   "Imprimir Hoja Blanco"
            ImageIndex      =   11
         EndProperty
         BeginProperty Button22 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "Importar Atenciones"
            ImageIndex      =   15
         EndProperty
         BeginProperty Button23 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Object.Visible         =   0   'False
            Caption         =   "Electrónica"
            Description     =   "Documento Electrónico "
            ImageIndex      =   1
         EndProperty
         BeginProperty Button24 {66833FEA-8583-11D1-B16A-00C0F0283628} 
            Caption         =   "            Salir            "
            Object.ToolTipText     =   "Salir"
            ImageIndex      =   2
         EndProperty
      EndProperty
      BorderStyle     =   1
   End
   Begin VB.Frame fraGeneral 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   4815
      Left            =   120
      TabIndex        =   5
      Top             =   720
      Width           =   13215
      Begin VB.CommandButton cmbAyudaDirRecojo 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5460
         Picture         =   "frmDocVentas_Mostrar_V.frx":9882
         Style           =   1  'Graphical
         TabIndex        =   214
         Top             =   0
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox TxtCodDir_Recojo 
         Height          =   285
         Left            =   870
         TabIndex        =   215
         Tag             =   "Tiddirrecojo"
         Top             =   0
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":9C0C
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox TxtGlsDir_Recojo 
         Height          =   285
         Left            =   1860
         TabIndex        =   216
         Top             =   0
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":9C28
         Vacio           =   -1  'True
      End
      Begin VB.CheckBox ChkfContado 
         Caption         =   "Guardar Versión"
         Height          =   315
         Left            =   11550
         TabIndex        =   213
         Top             =   840
         Visible         =   0   'False
         Width           =   1695
      End
      Begin VB.Frame FraCentroCostoCliente 
         Appearance      =   0  'Flat
         Caption         =   " Centro de Costo - Cliente Relacionado "
         ForeColor       =   &H80000008&
         Height          =   885
         Left            =   3570
         TabIndex        =   209
         Top             =   5400
         Visible         =   0   'False
         Width           =   5265
         Begin VB.CommandButton CmbCentroCostoCliente 
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   4710
            Picture         =   "frmDocVentas_Mostrar_V.frx":9C44
            Style           =   1  'Graphical
            TabIndex        =   210
            Top             =   360
            Width           =   390
         End
         Begin CATControls.CATTextBox TxtIdCentroCostoCliente 
            Height          =   285
            Left            =   165
            TabIndex        =   211
            Top             =   390
            Width           =   915
            _ExtentX        =   1614
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":9FCE
            Estilo          =   1
            Vacio           =   -1  'True
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtGlsCentroCostoCliente 
            Height          =   285
            Left            =   1110
            TabIndex        =   212
            Top             =   390
            Width           =   3570
            _ExtentX        =   6297
            _ExtentY        =   503
            BackColor       =   16777152
            Enabled         =   0   'False
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            Container       =   "frmDocVentas_Mostrar_V.frx":9FEA
            Vacio           =   -1  'True
         End
      End
      Begin VB.Frame FraDescuentoGlobal 
         Appearance      =   0  'Flat
         Caption         =   " Descuento Global "
         ForeColor       =   &H80000008&
         Height          =   1125
         Left            =   12810
         TabIndex        =   200
         Top             =   1500
         Visible         =   0   'False
         Width           =   3735
         Begin VB.OptionButton OptTipoDecuentoGlobal 
            Caption         =   "Monto"
            Height          =   315
            Index           =   1
            Left            =   1530
            TabIndex        =   203
            Top             =   480
            Width           =   825
         End
         Begin VB.OptionButton OptTipoDecuentoGlobal 
            Caption         =   "Porcentaje"
            Height          =   315
            Index           =   0
            Left            =   240
            TabIndex        =   202
            Top             =   480
            Value           =   -1  'True
            Width           =   1095
         End
         Begin CATControls.CATTextBox TxtDescuentoGlobal 
            Height          =   285
            Left            =   2490
            TabIndex        =   201
            Tag             =   "NDescuentoGlobal"
            Top             =   480
            Width           =   1005
            _ExtentX        =   1773
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":A006
            Text            =   "------- "
            Decimales       =   2
            TextoInicio     =   "0"
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtTotalDescuentolobalGrabado 
            Height          =   285
            Left            =   2490
            TabIndex        =   204
            Tag             =   "NTotalDescuentoGlobalGravado"
            Top             =   90
            Visible         =   0   'False
            Width           =   1005
            _ExtentX        =   1773
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":A022
            Text            =   "------- "
            Decimales       =   2
            TextoInicio     =   "0"
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtTotalPorcentajeDescuentoGlobal 
            Height          =   285
            Left            =   1110
            TabIndex        =   205
            Tag             =   "NTotalPorcentajeDescuentoGlobal"
            Top             =   90
            Visible         =   0   'False
            Width           =   1005
            _ExtentX        =   1773
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":A03E
            Text            =   "------- "
            Decimales       =   2
            TextoInicio     =   "0"
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtTotalDescuentolobalExonerado 
            Height          =   285
            Left            =   0
            TabIndex        =   206
            Tag             =   "NTotalDescuentoGlobalExonerado"
            Top             =   0
            Visible         =   0   'False
            Width           =   1005
            _ExtentX        =   1773
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":A05A
            Text            =   "------- "
            Decimales       =   2
            TextoInicio     =   "0"
            EnterTab        =   -1  'True
         End
         Begin CATControls.CATTextBox TxtTipoDescuentoGlobal 
            Height          =   285
            Left            =   720
            TabIndex        =   208
            Tag             =   "TTipoDescuentoGlobal"
            Top             =   840
            Visible         =   0   'False
            Width           =   1005
            _ExtentX        =   1773
            _ExtentY        =   503
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Alignment       =   1
            FontName        =   "Arial"
            FontSize        =   8.25
            ForeColor       =   -2147483640
            MaxLength       =   8
            Container       =   "frmDocVentas_Mostrar_V.frx":A076
            Text            =   "------- "
            Decimales       =   2
            TextoInicio     =   "0"
            EnterTab        =   -1  'True
         End
      End
      Begin VB.CheckBox ChkTransferenciaGratuita 
         Appearance      =   0  'Flat
         Caption         =   "Transferencia Gratuita"
         ForeColor       =   &H80000008&
         Height          =   315
         Left            =   10350
         TabIndex        =   196
         Tag             =   "NIndTransGratuita"
         Top             =   4455
         Visible         =   0   'False
         Width           =   2310
      End
      Begin VB.CheckBox ChkTransferenciaGratuitaMP 
         Appearance      =   0  'Flat
         Caption         =   "Transferencia Gratuita M.P."
         ForeColor       =   &H80000008&
         Height          =   315
         Left            =   10395
         TabIndex        =   195
         Tag             =   "NIndTransGratuitaMP"
         Top             =   4185
         Visible         =   0   'False
         Width           =   2310
      End
      Begin VB.CommandButton CmdAyudaSucursalDestino 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11370
         Picture         =   "frmDocVentas_Mostrar_V.frx":A092
         Style           =   1  'Graphical
         TabIndex        =   181
         Top             =   1935
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtGls_AlmacenDestino 
         Height          =   285
         Left            =   7700
         TabIndex        =   178
         Tag             =   "TGlsAlmacenDestino"
         Top             =   4500
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":A41C
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_AlmacenDestino 
         Height          =   285
         Left            =   6720
         TabIndex        =   177
         Tag             =   "TAlmacenDestino"
         Top             =   4500
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":A438
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_SucursalDestino 
         Height          =   285
         Left            =   7710
         TabIndex        =   176
         Tag             =   "TglsSucursalDestino"
         Top             =   4155
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":A454
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_SucursalDestino 
         Height          =   285
         Left            =   6735
         TabIndex        =   175
         Tag             =   "TSucursalDestino"
         Top             =   4155
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":A470
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin VB.CommandButton cmbAyudaAlmacenDestino 
         Height          =   315
         Left            =   11400
         Picture         =   "frmDocVentas_Mostrar_V.frx":A48C
         Style           =   1  'Graphical
         TabIndex        =   174
         Top             =   4500
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaSucursalDestino 
         Height          =   315
         Left            =   11385
         Picture         =   "frmDocVentas_Mostrar_V.frx":A816
         Style           =   1  'Graphical
         TabIndex        =   173
         Top             =   4155
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CheckBox chkVentaGratuita 
         Appearance      =   0  'Flat
         Caption         =   "Venta Gratuita"
         ForeColor       =   &H80000008&
         Height          =   315
         Left            =   11295
         TabIndex        =   172
         Tag             =   "NindVtaGratuita"
         Top             =   3870
         Visible         =   0   'False
         Width           =   1545
      End
      Begin VB.CommandButton cmbAyudaDirLlegada 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5445
         Picture         =   "frmDocVentas_Mostrar_V.frx":ABA0
         Style           =   1  'Graphical
         TabIndex        =   171
         Top             =   2700
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.TextBox txtGls_Obj2 
         Height          =   780
         Left            =   5520
         MultiLine       =   -1  'True
         ScrollBars      =   2  'Vertical
         TabIndex        =   164
         Tag             =   "TObsDocVentas2"
         Top             =   2520
         Visible         =   0   'False
         Width           =   4980
      End
      Begin VB.CommandButton CmdSituacionCre 
         Appearance      =   0  'Flat
         Caption         =   "Situación Crediticia"
         Height          =   510
         Left            =   4590
         TabIndex        =   161
         Top             =   180
         Visible         =   0   'False
         Width           =   1275
      End
      Begin CATControls.CATTextBox txtCod_contacto 
         Height          =   285
         Left            =   900
         TabIndex        =   158
         Tag             =   "TIdContacto"
         Top             =   3690
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":AF2A
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_contacto 
         Height          =   330
         Left            =   1890
         TabIndex        =   155
         Top             =   3645
         Visible         =   0   'False
         Width           =   3570
         _ExtentX        =   6297
         _ExtentY        =   582
         BackColor       =   16777152
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":AF46
      End
      Begin VB.CommandButton cmbcontactosclientes 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5445
         Picture         =   "frmDocVentas_Mostrar_V.frx":AF62
         Style           =   1  'Graphical
         TabIndex        =   157
         Top             =   3690
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton btnvt 
         Height          =   315
         Left            =   9600
         Picture         =   "frmDocVentas_Mostrar_V.frx":B2EC
         Style           =   1  'Graphical
         TabIndex        =   144
         Top             =   3840
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.TextBox txtObs 
         Height          =   465
         Left            =   6240
         MultiLine       =   -1  'True
         ScrollBars      =   2  'Vertical
         TabIndex        =   142
         Tag             =   "TObsDocVentas"
         Top             =   2400
         Visible         =   0   'False
         Width           =   4980
      End
      Begin VB.CommandButton cmbAyudaFormaPago 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5460
         Picture         =   "frmDocVentas_Mostrar_V.frx":B676
         Style           =   1  'Graphical
         TabIndex        =   138
         Top             =   600
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton CmdAyudaUnidProduc 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11385
         Picture         =   "frmDocVentas_Mostrar_V.frx":BA00
         Style           =   1  'Graphical
         TabIndex        =   135
         Top             =   495
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtVal_Camision 
         Height          =   285
         Left            =   9720
         TabIndex        =   131
         Tag             =   "NComisionVtas"
         Top             =   3120
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   11
         Container       =   "frmDocVentas_Mostrar_V.frx":BD8A
         Text            =   "0.00"
         Decimales       =   2
         Estilo          =   4
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Partida2 
         Height          =   285
         Left            =   900
         TabIndex        =   125
         Tag             =   "TPartida2"
         Top             =   3900
         Visible         =   0   'False
         Width           =   4515
         _ExtentX        =   7964
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":BDA6
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Llegada2 
         Height          =   285
         Left            =   900
         TabIndex        =   126
         Tag             =   "Tllegada2"
         Top             =   4200
         Visible         =   0   'False
         Width           =   4515
         _ExtentX        =   7964
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":BDC2
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin VB.CommandButton cmbAyudaTipoTicket 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5460
         Picture         =   "frmDocVentas_Mostrar_V.frx":BDDE
         Style           =   1  'Graphical
         TabIndex        =   121
         Top             =   4170
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtCod_TipoTicket 
         Height          =   285
         Left            =   885
         TabIndex        =   122
         Tag             =   "TidTipoTicket"
         Top             =   4170
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":C168
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_TipoTicket 
         Height          =   285
         Left            =   1950
         TabIndex        =   123
         Top             =   4170
         Visible         =   0   'False
         Width           =   3405
         _ExtentX        =   6006
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":C184
         Vacio           =   -1  'True
      End
      Begin VB.CommandButton cmbAyudaVendedorCampo 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5460
         Picture         =   "frmDocVentas_Mostrar_V.frx":C1A0
         Style           =   1  'Graphical
         TabIndex        =   113
         Top             =   4500
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaCentroCosto 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11340
         Picture         =   "frmDocVentas_Mostrar_V.frx":C52A
         Style           =   1  'Graphical
         TabIndex        =   109
         Top             =   3840
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtCod_CentroCosto 
         Height          =   285
         Left            =   6765
         TabIndex        =   110
         Tag             =   "TidCentroCosto"
         Top             =   3840
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":C8B4
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_CentroCosto 
         Height          =   285
         Left            =   7740
         TabIndex        =   111
         Tag             =   "TGlsCentroCosto"
         Top             =   3840
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":C8D0
         Vacio           =   -1  'True
      End
      Begin MSComCtl2.DTPicker dtp_IniTraslado 
         Height          =   315
         Left            =   6825
         TabIndex        =   100
         Tag             =   "FFecIniTraslado"
         Top             =   3675
         Visible         =   0   'False
         Width           =   1335
         _ExtentX        =   2355
         _ExtentY        =   556
         _Version        =   393216
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Format          =   133365761
         CurrentDate     =   38955
      End
      Begin VB.CommandButton cmbAyudaMotivoNCD 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11340
         Picture         =   "frmDocVentas_Mostrar_V.frx":C8EC
         Style           =   1  'Graphical
         TabIndex        =   91
         Top             =   4320
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtCod_MotivoNCD 
         Height          =   285
         Left            =   6750
         TabIndex        =   92
         Tag             =   "TidMotivoNCD"
         Top             =   4200
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":CC76
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_MotivoNCD 
         Height          =   285
         Left            =   7725
         TabIndex        =   93
         Tag             =   "TGlsMotivoNCD"
         Top             =   4200
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":CC92
         Vacio           =   -1  'True
      End
      Begin VB.CommandButton cmbAyudaMotivoTraslado 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11325
         Picture         =   "frmDocVentas_Mostrar_V.frx":CCAE
         Style           =   1  'Graphical
         TabIndex        =   86
         Top             =   4425
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaLista 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11325
         Picture         =   "frmDocVentas_Mostrar_V.frx":D038
         Style           =   1  'Graphical
         TabIndex        =   74
         Top             =   4050
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaVendedor 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11400
         Picture         =   "frmDocVentas_Mostrar_V.frx":D3C2
         Style           =   1  'Graphical
         TabIndex        =   73
         Top             =   1500
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaAlmacen 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11400
         Picture         =   "frmDocVentas_Mostrar_V.frx":D74C
         Style           =   1  'Graphical
         TabIndex        =   72
         Top             =   1200
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaMoneda 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11400
         Picture         =   "frmDocVentas_Mostrar_V.frx":DAD6
         Style           =   1  'Graphical
         TabIndex        =   71
         Top             =   1800
         Visible         =   0   'False
         Width           =   390
      End
      Begin CATControls.CATTextBox txtCod_Cliente 
         Height          =   285
         Left            =   900
         TabIndex        =   37
         Tag             =   "TidPerCliente"
         Top             =   900
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":DE60
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_NumDoc 
         Height          =   315
         Left            =   10125
         TabIndex        =   35
         Tag             =   "TidDocVentas"
         Top             =   195
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   556
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":DE7C
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin VB.CommandButton cmbAyudaVehiculo 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5445
         Picture         =   "frmDocVentas_Mostrar_V.frx":DE98
         Style           =   1  'Graphical
         TabIndex        =   32
         Top             =   3375
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaEmpTrans 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5445
         Picture         =   "frmDocVentas_Mostrar_V.frx":E222
         Style           =   1  'Graphical
         TabIndex        =   30
         Top             =   3075
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaChofer 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5445
         Picture         =   "frmDocVentas_Mostrar_V.frx":E5AC
         Style           =   1  'Graphical
         TabIndex        =   26
         Top             =   2400
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.CommandButton cmbAyudaCliente 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5440
         Picture         =   "frmDocVentas_Mostrar_V.frx":E936
         Style           =   1  'Graphical
         TabIndex        =   19
         Top             =   870
         Visible         =   0   'False
         Width           =   390
      End
      Begin MSComCtl2.DTPicker dtp_Emision 
         Height          =   315
         Left            =   10275
         TabIndex        =   11
         Tag             =   "FFecEmision"
         Top             =   825
         Visible         =   0   'False
         Width           =   1290
         _ExtentX        =   2275
         _ExtentY        =   556
         _Version        =   393216
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Format          =   133365761
         CurrentDate     =   38955
      End
      Begin MSComctlLib.ImageList imgDocVentas 
         Left            =   105
         Top             =   1815
         _ExtentX        =   1005
         _ExtentY        =   1005
         BackColor       =   -2147483643
         ImageWidth      =   16
         ImageHeight     =   16
         MaskColor       =   12632256
         _Version        =   393216
         BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
            NumListImages   =   16
            BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":ECC0
               Key             =   ""
            EndProperty
            BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":F05A
               Key             =   ""
            EndProperty
            BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":F4AC
               Key             =   ""
            EndProperty
            BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":F846
               Key             =   ""
            EndProperty
            BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":FBE0
               Key             =   ""
            EndProperty
            BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":FF7A
               Key             =   ""
            EndProperty
            BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":10314
               Key             =   ""
            EndProperty
            BeginProperty ListImage8 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":106AE
               Key             =   ""
            EndProperty
            BeginProperty ListImage9 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":10A48
               Key             =   ""
            EndProperty
            BeginProperty ListImage10 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":10DE2
               Key             =   ""
            EndProperty
            BeginProperty ListImage11 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":1117C
               Key             =   ""
            EndProperty
            BeginProperty ListImage12 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":11E3E
               Key             =   ""
            EndProperty
            BeginProperty ListImage13 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":121D8
               Key             =   ""
            EndProperty
            BeginProperty ListImage14 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":1262A
               Key             =   ""
            EndProperty
            BeginProperty ListImage15 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":129C4
               Key             =   ""
            EndProperty
            BeginProperty ListImage16 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmDocVentas_Mostrar_V.frx":133D6
               Key             =   ""
            EndProperty
         EndProperty
      End
      Begin CATControls.CATTextBox txt_Serie 
         Height          =   315
         Left            =   7950
         TabIndex        =   36
         Tag             =   "TidSerie"
         Top             =   195
         Visible         =   0   'False
         Width           =   990
         _ExtentX        =   1746
         _ExtentY        =   556
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   4
         Container       =   "frmDocVentas_Mostrar_V.frx":13AA8
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Cliente 
         Height          =   285
         Left            =   1845
         TabIndex        =   38
         Tag             =   "TGlsCliente"
         Top             =   900
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777215
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         Container       =   "frmDocVentas_Mostrar_V.frx":13AC4
         Estilo          =   1
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Chofer 
         Height          =   285
         Left            =   900
         TabIndex        =   39
         Tag             =   "TidPerChofer"
         Top             =   2400
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13AE0
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Chofer 
         Height          =   285
         Left            =   1875
         TabIndex        =   40
         Tag             =   "TglsChofer"
         Top             =   2400
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13AFC
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_EmpTrans 
         Height          =   285
         Left            =   900
         TabIndex        =   41
         Tag             =   "TidPerEmpTrans"
         Top             =   3075
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13B18
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_EmpTrans 
         Height          =   285
         Left            =   1875
         TabIndex        =   42
         Tag             =   "TGlsEmpTrans"
         Top             =   3075
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13B34
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Vehiculo 
         Height          =   285
         Left            =   900
         TabIndex        =   43
         Tag             =   "TidVehiculo"
         Top             =   3375
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13B50
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Vehiculo 
         Height          =   285
         Left            =   1890
         TabIndex        =   44
         Tag             =   "TGlsVehiculo"
         Top             =   3375
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13B6C
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Almacen 
         Height          =   285
         Left            =   6840
         TabIndex        =   45
         Tag             =   "TidAlmacen"
         Top             =   1200
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13B88
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Almacen 
         Height          =   285
         Left            =   7800
         TabIndex        =   46
         Top             =   1200
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13BA4
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Vendedor 
         Height          =   285
         Left            =   6840
         TabIndex        =   47
         Tag             =   "TidPerVendedor"
         Top             =   1500
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13BC0
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Vendedor 
         Height          =   285
         Left            =   7785
         TabIndex        =   48
         Tag             =   "TGlsVendedor"
         Top             =   1485
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13BDC
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Moneda 
         Height          =   285
         Left            =   6825
         TabIndex        =   49
         Tag             =   "TidMoneda"
         Top             =   1800
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13BF8
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Moneda 
         Height          =   285
         Left            =   7800
         TabIndex        =   50
         Tag             =   "Tglsmoneda"
         Top             =   1800
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13C14
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txt_RUC 
         Height          =   285
         Left            =   900
         TabIndex        =   51
         Tag             =   "TRUCCliente"
         Top             =   1200
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   11
         Container       =   "frmDocVentas_Mostrar_V.frx":13C30
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Direccion 
         Height          =   285
         Left            =   900
         TabIndex        =   52
         Tag             =   "TdirCliente"
         Top             =   1500
         Visible         =   0   'False
         Width           =   4515
         _ExtentX        =   7964
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":13C4C
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Partida 
         Height          =   285
         Left            =   900
         TabIndex        =   53
         Tag             =   "TPartida"
         Top             =   1800
         Visible         =   0   'False
         Width           =   4515
         _ExtentX        =   7964
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":13C68
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Llegada 
         Height          =   285
         Left            =   900
         TabIndex        =   54
         Tag             =   "Tllegada"
         Top             =   2100
         Visible         =   0   'False
         Width           =   4515
         _ExtentX        =   7964
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":13C84
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Brevete 
         Height          =   285
         Left            =   900
         TabIndex        =   55
         Tag             =   "TBrevete"
         Top             =   2700
         Visible         =   0   'False
         Width           =   1890
         _ExtentX        =   3334
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   45
         Container       =   "frmDocVentas_Mostrar_V.frx":13CA0
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Placa 
         Height          =   285
         Left            =   900
         TabIndex        =   56
         Tag             =   "TPlaca"
         Top             =   3675
         Visible         =   0   'False
         Width           =   1890
         _ExtentX        =   3334
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   10
         Container       =   "frmDocVentas_Mostrar_V.frx":13CBC
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Bultos 
         Height          =   285
         Left            =   3750
         TabIndex        =   57
         Tag             =   "NBultos"
         Top             =   3675
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13CD8
         Estilo          =   3
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_TipoCambio 
         Height          =   285
         Left            =   6825
         TabIndex        =   58
         Tag             =   "NTipoCambio"
         Top             =   900
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Alignment       =   1
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13CF4
         Text            =   "0"
         Estilo          =   4
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Marca 
         Height          =   285
         Left            =   900
         TabIndex        =   62
         Tag             =   "TMarca"
         Top             =   3975
         Visible         =   0   'False
         Width           =   1890
         _ExtentX        =   3334
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   128
         Container       =   "frmDocVentas_Mostrar_V.frx":13D10
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Modelo 
         Height          =   285
         Left            =   3750
         TabIndex        =   64
         Tag             =   "TModelo"
         Top             =   3975
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   128
         Container       =   "frmDocVentas_Mostrar_V.frx":13D2C
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_Color 
         Height          =   285
         Left            =   900
         TabIndex        =   66
         Tag             =   "TColor"
         Top             =   4125
         Visible         =   0   'False
         Width           =   1890
         _ExtentX        =   3334
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   128
         Container       =   "frmDocVentas_Mostrar_V.frx":13D48
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txt_CodInscripcion 
         Height          =   285
         Left            =   3750
         TabIndex        =   68
         Tag             =   "TCodInsCrip"
         Top             =   4125
         Visible         =   0   'False
         Width           =   1665
         _ExtentX        =   2937
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   128
         Container       =   "frmDocVentas_Mostrar_V.frx":13D64
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Lista 
         Height          =   285
         Left            =   6615
         TabIndex        =   75
         Tag             =   "TidLista"
         Top             =   4050
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13D80
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_Lista 
         Height          =   285
         Left            =   7725
         TabIndex        =   76
         Top             =   4050
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13D9C
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_MotivoTraslado 
         Height          =   285
         Left            =   6750
         TabIndex        =   87
         Tag             =   "TidMotivoTraslado"
         Top             =   4425
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Locked          =   -1  'True
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":13DB8
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_MotivoTraslado 
         Height          =   285
         Left            =   7680
         TabIndex        =   88
         Top             =   4440
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":13DD4
         Vacio           =   -1  'True
      End
      Begin DXDBGRIDLibCtl.dxDBGrid gDocReferencia 
         Height          =   1200
         Left            =   5985
         OleObjectBlob   =   "frmDocVentas_Mostrar_V.frx":13DF0
         TabIndex        =   22
         Top             =   2160
         Visible         =   0   'False
         Width           =   5685
      End
      Begin CATControls.CATTextBox txt_RUCEmp 
         Height          =   285
         Left            =   10875
         TabIndex        =   104
         Tag             =   "TrucEmpTrans"
         Top             =   3375
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   11
         Container       =   "frmDocVentas_Mostrar_V.frx":1731E
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_VendedorCampo 
         Height          =   285
         Left            =   885
         TabIndex        =   114
         Tag             =   "TidPerVendedorCampo"
         Top             =   4500
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":1733A
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_VendedorCampo 
         Height          =   285
         Left            =   1860
         TabIndex        =   115
         Tag             =   "TGlsVendedorCampo"
         Top             =   4500
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":17356
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txt_OrdenCompra 
         Height          =   285
         Left            =   900
         TabIndex        =   129
         Tag             =   "TnumOrdenCompra"
         Top             =   2850
         Visible         =   0   'False
         Width           =   1890
         _ExtentX        =   3334
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   25
         Container       =   "frmDocVentas_Mostrar_V.frx":17372
         Estilo          =   1
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_UnidProd 
         Height          =   285
         Left            =   6840
         TabIndex        =   136
         Tag             =   "Tidupp"
         Top             =   585
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":1738E
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_UnidProd 
         Height          =   285
         Left            =   7815
         TabIndex        =   137
         Top             =   585
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":173AA
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_FormaPago 
         Height          =   285
         Left            =   885
         TabIndex        =   139
         Tag             =   "TidFormaPago"
         Top             =   600
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":173C6
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtGls_FormaPago 
         Height          =   285
         Left            =   1860
         TabIndex        =   140
         Tag             =   "TglsFormaPago"
         Top             =   600
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":173E2
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtvtcodigo 
         Height          =   285
         Left            =   6705
         TabIndex        =   143
         Tag             =   "TvterceroCodigo"
         Top             =   3870
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":173FE
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtvtglscliente 
         Height          =   285
         Left            =   7680
         TabIndex        =   145
         Tag             =   "TvtercerosCliente"
         Top             =   3870
         Visible         =   0   'False
         Width           =   1845
         _ExtentX        =   3254
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":1741A
         Estilo          =   1
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox txtvtruc 
         Height          =   285
         Left            =   6705
         TabIndex        =   146
         Tag             =   "TvterceroRuc"
         Top             =   4170
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   11
         Container       =   "frmDocVentas_Mostrar_V.frx":17436
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtvtdireccion 
         Height          =   285
         Left            =   6705
         TabIndex        =   147
         Tag             =   "Tvtercerosdireccion"
         Top             =   4470
         Visible         =   0   'False
         Width           =   3195
         _ExtentX        =   5636
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   255
         Container       =   "frmDocVentas_Mostrar_V.frx":17452
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin MSComCtl2.DTPicker dtp_Pago 
         Height          =   315
         Left            =   10125
         TabIndex        =   102
         Tag             =   "FFecPago"
         Top             =   3630
         Visible         =   0   'False
         Width           =   1335
         _ExtentX        =   2355
         _ExtentY        =   556
         _Version        =   393216
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Format          =   133365761
         CurrentDate     =   38955
      End
      Begin CATControls.CATTextBox txtgls_contacto 
         Height          =   330
         Left            =   1890
         TabIndex        =   160
         Tag             =   "TGlsContacto"
         Top             =   3330
         Visible         =   0   'False
         Width           =   3570
         _ExtentX        =   6297
         _ExtentY        =   582
         BackColor       =   12648447
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":1746E
      End
      Begin CATControls.CATTextBox Txt_ProvCliente 
         Height          =   285
         Left            =   3555
         TabIndex        =   162
         Tag             =   "TidProvCliente"
         Top             =   1215
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   11
         Container       =   "frmDocVentas_Mostrar_V.frx":1748A
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox txtCod_Tienda 
         Height          =   285
         Left            =   3060
         TabIndex        =   165
         Tag             =   "Tidtienda"
         Top             =   2745
         Visible         =   0   'False
         Width           =   1815
         _ExtentX        =   3201
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":174A6
         Vacio           =   -1  'True
         EnterTab        =   -1  'True
      End
      Begin CATControls.CATTextBox TxtGlsSucursalDestino 
         Height          =   285
         Left            =   7785
         TabIndex        =   183
         Top             =   1950
         Visible         =   0   'False
         Width           =   3540
         _ExtentX        =   6244
         _ExtentY        =   503
         BackColor       =   16777152
         Enabled         =   0   'False
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         Container       =   "frmDocVentas_Mostrar_V.frx":174C2
         Vacio           =   -1  'True
      End
      Begin CATControls.CATTextBox TxtCodSucursalDestino 
         Height          =   285
         Left            =   6810
         TabIndex        =   182
         Tag             =   "TIdSucursalDestino"
         Top             =   1935
         Visible         =   0   'False
         Width           =   915
         _ExtentX        =   1614
         _ExtentY        =   503
         BackColor       =   16777215
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         FontName        =   "Arial"
         FontSize        =   8.25
         ForeColor       =   -2147483640
         MaxLength       =   8
         Container       =   "frmDocVentas_Mostrar_V.frx":174DE
         Estilo          =   1
         EnterTab        =   -1  'True
      End
      Begin VB.Label lblDirRecojo 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Recojo"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   60
         TabIndex        =   217
         Top             =   75
         Visible         =   0   'False
         Width           =   495
      End
      Begin VB.Label LblSucursalDestino 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Destino"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5985
         TabIndex        =   184
         Top             =   2010
         Visible         =   0   'False
         Width           =   540
      End
      Begin VB.Label lbl_SucursalDestino 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Suc Dest"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   180
         Top             =   4155
         Visible         =   0   'False
         Width           =   660
      End
      Begin VB.Label lbl_AlmacenDestino 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Alm Dest"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   179
         Top             =   4500
         Visible         =   0   'False
         Width           =   645
      End
      Begin VB.Label lbl_ProvCli 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "ProvCli."
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   2880
         TabIndex        =   163
         Top             =   1260
         Visible         =   0   'False
         Width           =   540
      End
      Begin VB.Label lblcontacto 
         AutoSize        =   -1  'True
         Caption         =   "Contacto"
         Height          =   210
         Left            =   90
         TabIndex        =   156
         Top             =   3690
         Visible         =   0   'False
         Width           =   645
      End
      Begin VB.Label lblvtcliente 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Terceros"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5850
         TabIndex        =   150
         Top             =   3870
         Visible         =   0   'False
         Width           =   705
      End
      Begin VB.Label lvlvtdireccion 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Dirección"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5880
         TabIndex        =   149
         Top             =   4470
         Visible         =   0   'False
         Width           =   720
      End
      Begin VB.Label lblvtruc 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "R.U.C."
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5880
         TabIndex        =   148
         Top             =   4170
         Visible         =   0   'False
         Width           =   495
      End
      Begin VB.Label lbl_FormaPago 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "F. Pago"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   120
         TabIndex        =   141
         Top             =   660
         Visible         =   0   'False
         Width           =   540
      End
      Begin VB.Label lbl_upp 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "UUPP"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5985
         TabIndex        =   134
         Top             =   585
         Visible         =   0   'False
         Width           =   390
      End
      Begin VB.Label lbl_Comision 
         Appearance      =   0  'Flat
         Caption         =   "RUC Emp."
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   8850
         TabIndex        =   132
         Top             =   3240
         Visible         =   0   'False
         Width           =   915
      End
      Begin VB.Label lbl_OrdenCompra 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "O.Compra"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   130
         Top             =   2925
         Visible         =   0   'False
         Width           =   720
      End
      Begin VB.Label lbl_Partida2 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Partida 2"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   128
         Top             =   3900
         Visible         =   0   'False
         Width           =   630
      End
      Begin VB.Label lbl_Llegada2 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Llegada 2"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   127
         Top             =   4200
         Visible         =   0   'False
         Width           =   705
      End
      Begin VB.Label lbl_TipoTicket 
         Appearance      =   0  'Flat
         Caption         =   "Tipo Ticket"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   30
         TabIndex        =   124
         Top             =   4245
         Visible         =   0   'False
         Width           =   855
      End
      Begin VB.Label lbl_VendedorCampo 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Vendedor"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   90
         TabIndex        =   116
         Top             =   4500
         Visible         =   0   'False
         Width           =   720
      End
      Begin VB.Label lbl_CentroCosto 
         Appearance      =   0  'Flat
         Caption         =   "C. Costo"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   6000
         TabIndex        =   112
         Top             =   5000
         Visible         =   0   'False
         Width           =   1065
      End
      Begin VB.Label lbl_RUCEmp 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "RUC Emp."
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   9900
         TabIndex        =   105
         Top             =   3375
         Visible         =   0   'False
         Width           =   705
      End
      Begin VB.Label lbl_FechaPago 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Fec. Pago"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   8925
         TabIndex        =   103
         Top             =   3660
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_IniTraslado 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Ini. Tras"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   101
         Top             =   3750
         Visible         =   0   'False
         Width           =   660
      End
      Begin VB.Label lbl_Obs 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Obs."
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5925
         TabIndex        =   13
         Top             =   3450
         Visible         =   0   'False
         Width           =   345
      End
      Begin VB.Label lbl_MotivoNCD 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Motivo"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   94
         Top             =   4275
         Visible         =   0   'False
         Width           =   510
      End
      Begin VB.Label lbl_MotivoTraslado 
         Appearance      =   0  'Flat
         Caption         =   "Motivo"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   5985
         TabIndex        =   89
         Top             =   4500
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Lista 
         Appearance      =   0  'Flat
         Caption         =   "Lista"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   6000
         TabIndex        =   77
         Top             =   4125
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_CodInscrip 
         Appearance      =   0  'Flat
         Caption         =   "Cod. Ins."
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   2850
         TabIndex        =   69
         Top             =   4200
         Visible         =   0   'False
         Width           =   1215
      End
      Begin VB.Label lbl_Color 
         Appearance      =   0  'Flat
         Caption         =   "Color"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   75
         TabIndex        =   67
         Top             =   4200
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Modelo 
         Appearance      =   0  'Flat
         Caption         =   "Modelo"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   2850
         TabIndex        =   65
         Top             =   4050
         Visible         =   0   'False
         Width           =   615
      End
      Begin VB.Label lbl_Marca 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Marca"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   63
         Top             =   4050
         Visible         =   0   'False
         Width           =   450
      End
      Begin VB.Label lbl_Bultos 
         Appearance      =   0  'Flat
         Caption         =   "Bultos"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   2850
         TabIndex        =   34
         Top             =   3750
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Vehiculo 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Vehículo"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   33
         Top             =   3405
         Visible         =   0   'False
         Width           =   630
      End
      Begin VB.Label lbl_EmpTrans 
         Appearance      =   0  'Flat
         Caption         =   "Emp.Transp."
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   75
         TabIndex        =   31
         Top             =   3105
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Brevete 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Brevete"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   29
         Top             =   2775
         Visible         =   0   'False
         Width           =   570
      End
      Begin VB.Label lbl_Placa 
         Appearance      =   0  'Flat
         Caption         =   "Placa"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   75
         TabIndex        =   28
         Top             =   3750
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Chofer 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Chofer"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   27
         Top             =   2430
         Visible         =   0   'False
         Width           =   495
      End
      Begin VB.Label lbl_Llegada 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Llegada"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   25
         Top             =   2100
         Visible         =   0   'False
         Width           =   570
      End
      Begin VB.Label lbl_Partida 
         Appearance      =   0  'Flat
         Caption         =   "Partida"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   75
         TabIndex        =   24
         Top             =   1800
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Almacen 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Almacén"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   20
         Top             =   1275
         Visible         =   0   'False
         Width           =   630
      End
      Begin VB.Label lbl_RUC 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "R.U.C."
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   18
         Top             =   1200
         Visible         =   0   'False
         Width           =   450
      End
      Begin VB.Label lbl_Direccion 
         Appearance      =   0  'Flat
         Caption         =   "Dirección"
         ForeColor       =   &H80000007&
         Height          =   240
         Left            =   75
         TabIndex        =   17
         Top             =   1500
         Visible         =   0   'False
         Width           =   765
      End
      Begin VB.Label lbl_Vendedor 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Responsable"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   16
         Top             =   1575
         Visible         =   0   'False
         Width           =   945
      End
      Begin VB.Label lbl_TC 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "T/C"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   5985
         TabIndex        =   15
         Top             =   900
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Label lbl_Moneda 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Moneda"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   6000
         TabIndex        =   14
         Top             =   1875
         Visible         =   0   'False
         Width           =   570
      End
      Begin VB.Label lbl_Cliente 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Cliente"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   75
         TabIndex        =   12
         Top             =   900
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.Label lbl_NumDoc 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Número"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   9405
         TabIndex        =   10
         Top             =   270
         Visible         =   0   'False
         Width           =   660
      End
      Begin VB.Label lbl_FechaEmision 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "F. Emisión"
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   9075
         TabIndex        =   9
         Top             =   900
         Visible         =   0   'False
         Width           =   720
      End
      Begin VB.Label lbl_Serie 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         Caption         =   "Serie"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000007&
         Height          =   210
         Left            =   7290
         TabIndex        =   8
         Top             =   270
         Visible         =   0   'False
         Width           =   435
      End
      Begin VB.Label lblDoc 
         Appearance      =   0  'Flat
         Caption         =   "Boleta de Venta"
         BeginProperty Font 
            Name            =   "Arial Narrow"
            Size            =   20.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   465
         Left            =   90
         TabIndex        =   7
         Top             =   180
         Width           =   5400
      End
   End
   Begin VB.Frame fraDetalle 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   3390
      Left            =   120
      TabIndex        =   6
      Top             =   5430
      Width           =   13200
      Begin DXDBGRIDLibCtl.dxDBGrid gDetalle 
         Height          =   3090
         Left            =   90
         OleObjectBlob   =   "frmDocVentas_Mostrar_V.frx":174FA
         TabIndex        =   70
         Top             =   225
         Width           =   13005
      End
      Begin VB.OLE OLE1 
         Height          =   60
         Left            =   3600
         TabIndex        =   133
         Top             =   765
         Width           =   60
      End
   End
   Begin VB.Label Label15 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      Caption         =   "Almacén"
      ForeColor       =   &H80000007&
      Height          =   240
      Left            =   6075
      TabIndex        =   21
      Top             =   1830
      Width           =   765
   End
End
Attribute VB_Name = "frmDocVentas_Mostrar_V"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim RsD                                 As New ADODB.Recordset
Public strTipoDoc                       As String
Public strSerieDocventas                As String
Public strNumDocVentas                  As String
Public strNumitmlogDocVentas                  As String
Public IndAtribucionNC                  As Integer
Dim objDocVentas                        As New clsDocVentas
Dim indCargando                         As Boolean
Dim indNuevoDoc                         As Boolean
Dim intBoton                            As Integer
Dim intRegMax                           As Integer
Dim dblPorDsctoEspecial                 As Double
Private indGeneraVale                   As Boolean
Private indInserta                      As Boolean
Private indInsertaDocRef                As Boolean
Private strEstDocVentas                 As String
Private strGlsTipoDoc                   As String
Dim rsTempLotes                         As New ADODB.Recordset
Dim rsTempLiquidacion                   As New ADODB.Recordset
Dim RsDetProductos                      As New ADODB.Recordset
Dim RsListaCab                          As New ADODB.Recordset
Dim dblIgvNEw                           As Double
Dim longitud                            As String
Dim CIdPeriodoAux                       As String
Dim CIdComprobanteAux                   As String

Dim rsdEmpresas                         As New ADODB.Recordset
Dim ccodproparam                        As String
Dim ccodparamemp                        As String
Dim CIndEnviarCaja                      As Boolean
Dim indCodApimas                        As Boolean
Dim strParamModGlsPro                   As String
Dim strParamItemPro                     As String
Dim strParamEmpSuc                      As String
'--- Variables libera item productos
Dim cantidad                As Double
Dim rst                     As New ADODB.Recordset
Dim rsh                     As New ADODB.Recordset
Dim RstDet                  As New ADODB.Recordset
Dim rstdetref               As New ADODB.Recordset
Dim rstdocref               As New ADODB.Recordset
Dim rstactuest              As New ADODB.Recordset
Dim item                    As Integer
Dim cantidadtot             As Double
Dim producto1               As String
Dim producto2               As String
Dim cantidad1               As Double
Dim cantidad2               As Double
Dim indValorAnt             As Boolean
Dim strValor                As String
Dim SwF2                    As Boolean
Dim CTmpDocumentos          As String
Dim CTmpGuiasNF             As String
Dim CTmpDocumentosGen       As String
Dim CTmpStock               As String
Dim CTmpReferencia          As String
Dim CTmpProductosDesp       As String
Dim NTotalBruto             As Double
Dim NTotalIGV               As Double
Dim NTotalIVAP              As Double
Dim NTotalDsctoVV           As Double
Dim NTotalDsctoPV           As Double
Dim NTotalBaseImponible     As Double
Dim NTotalExonerado         As Double
    
Private Sub btnvt_Click()

    mostrarAyudaClientes txtvtcodigo, txtvtglscliente, txtvtruc, txtvtdireccion, txtCod_Tienda
    If txtCod_Cliente.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub CATTextBox1_KeyPress(Index As Integer, KeyAscii As Integer)
On Error GoTo Err
Dim StrMsgError As String
Dim i As Integer
    
    If Len(Trim(longitud)) > 0 Then
            If ((Len(gDetalle.Columns.ColumnByFieldName("glsProducto").Value & Space(2) & CATTextBox1(0).Text) Mod longitud) = 0) Then
                    Select Case KeyAscii
                        Case 65 To 90: KeyAscii = 0
                        Case 97 To 122: KeyAscii = 0
                        Case 48 To 57: KeyAscii = 0
                        Case 32: KeyAscii = 0
                    End Select
              If KeyAscii = 13 Then
                    Select Case KeyAscii
                        Case 65 To 90: KeyAscii = 1
                        Case 97 To 122: KeyAscii = 1
                        Case 48 To 57: KeyAscii = 1
                        Case 32: KeyAscii = 1
                    End Select
              End If
            End If
    End If
    
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub cbx_Mes_Click()
On Error GoTo Err
Dim StrMsgError As String
    
    If indNuevoDoc = False Then
        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub CbxGanadas_Click()
On Error GoTo Err
Dim StrMsgError As String
    
    If indNuevoDoc = False Then
        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub


Private Sub ChkTransferenciaGratuita_Click()
On Error GoTo Err
Dim StrMsgError                                 As String
    
    If ChkTransferenciaGratuita.Value = 1 Then
        
        ChkTransferenciaGratuitaMP.Value = 0
        
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub ChkTransferenciaGratuitaMP_Click()
On Error GoTo Err
Dim StrMsgError                                 As String
    
    If ChkTransferenciaGratuitaMP.Value = 1 Then
        
        ChkTransferenciaGratuita.Value = 0
        
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub chkVentaGratuita_Click()
If traerCampo("Parametros", "ValParametro", "GlsParametro", "CONCEPTO_VENTA_GRATUITA", True) = "S" Then
    
    If indValorAnt = False Then
     strValor = txtCod_MotivoTraslado.Text
    End If
    
    If chkVentaGratuita.Value Then
        indValorAnt = True
        txtCod_MotivoTraslado.Text = traerCampo("motivostraslados", "idMotivoTraslado", "idConcepto", "30", False, "idDocumento  = '" & strTipoDoc & "'")
    Else
        If strValor = "" Then
            txtCod_MotivoTraslado.Text = txtCod_MotivoTraslado.Text = traerCampo("motivostraslados", "idMotivoTraslado", "idConcepto", "30", False, "idDocumento  = '" & strTipoDoc & "'")
        Else
            txtCod_MotivoTraslado.Text = strValor
        End If
    End If
    
 End If
End Sub

Private Sub cmbAyudaAlmacen_Click()

    mostrarAyuda "ALMACEN", txtCod_Almacen, txtGls_Almacen
    'If txtCod_Almacen.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaAlmacenDestino_Click()
    
    mostrarAyuda "ALMACENDESTINO", txtCod_AlmacenDestino, txtGls_AlmacenDestino, " and idsucursal = '" & Trim(txtCod_SucursalDestino.Text) & "'"
    If txtCod_Almacen.Text = txtCod_AlmacenDestino.Text Then
        MsgBox "El almacen Destino no puede ser el mismo que el de Origen", vbInformation, App.Title
        txtCod_AlmacenDestino.Text = ""
        txtGls_AlmacenDestino.Text = ""
        Exit Sub
    End If
    txt_Llegada.Text = traerCampo("UnidadProduccion", "F4Direccion", "idalmacen", txtCod_AlmacenDestino.Text, True, "")
    If txtCod_CentroCosto.Text <> "" Then SendKeys "{tab}"

End Sub

Private Sub cmbAyudaCentroCosto_Click()

    mostrarAyuda "CENTROCOSTO", txtCod_CentroCosto, txtGls_CentroCosto
'    If txtCod_CentroCosto.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaChofer_Click()

    mostrarAyuda "CHOFER", txtCod_Chofer, txtGls_Chofer
'    If txtCod_Chofer.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaDirLlegada_Click()
On Error GoTo Err
Dim rst         As New ADODB.Recordset
Dim StrMsgError As String
Dim TX2         As TextBox
Dim TX3         As TextBox
Dim TX4         As TextBox
Dim TX5         As TextBox
    
    mostrarAyudaClientes TX2, TX3, TX4, TX5, txtCod_Tienda, , True
'    txt_Llegada.Text = "" & txt_Llegada.Text
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub cmbAyudaDirRecojo_Click()
    mostrarAyuda "DIRRECOJO", TxtCodDir_Recojo, TxtGlsDir_Recojo
End Sub

Private Sub cmbAyudaEmpTrans_Click()

    mostrarAyuda "EMPTRANS", txtCod_EmpTrans, txtGls_EmpTrans
    If txtCod_EmpTrans.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaFormaPago_Click()

    If Trim("" & traerCampo("parametros", "valparametro", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True)) = "S" Then
        mostrarAyuda "FORMASPAGOxCLIENTE", txtCod_FormaPago, txtGls_FormaPago, " and A.idcliente = '" & Trim("" & txtCod_Cliente.Text) & "' and a.idempresa = '" & glsEmpresa & "' "
    Else
        mostrarAyuda "FORMASPAGO", txtCod_FormaPago, txtGls_FormaPago
    End If
    
End Sub

Private Sub cmbAyudaLista_Click()
On Error GoTo Err
Dim CodListaAnt            As String
Dim StrMsgError             As String
Dim strMoneda               As String
Dim strCodUM                As String
Dim strDesUM                As String
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim intAfecto               As Integer
Dim strCodFabri             As String
Dim strCodMar               As String
Dim strDesMar               As String
Dim strTipoProd             As String
Dim NIvapUnit               As Double

    CodListaAnt = txtCod_Lista.Text
    mostrarAyuda "LISTAPRECIOS", txtCod_Lista, txtGls_Lista
    
    dblVVUnit = 0
    dblIGVUnit = 0
    dblPVUnit = 0
    
    strMoneda = traerCampo("Listaprecios", "idMoneda", "idLista", txtCod_Lista.Text, True)
        
    If CodListaAnt <> txtCod_Lista.Text Then
        gDetalle.Dataset.First
        If Not gDetalle.Dataset.EOF Then
            gDetalle.Dataset.First
            Do While Not gDetalle.Dataset.EOF
                If DatosProducto(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
                End If
                                
                If DatosPrecio(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strTipoProd, Trim("" & gDetalle.Columns.ColumnByFieldName("idUM").Value), strDesUM, dblVVUnit, dblFactor) = False Then
                End If
                
                procesaMoneda strMoneda, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, NIvapUnit, StrMsgError, Trim(gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("IvapUnit").Value = NIvapUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                gDetalle.Dataset.Post
                
                gDetalle.Dataset.Next
            Loop
        End If
        
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
    End If
    
    If txtCod_Lista.Text <> "" Then SendKeys "{tab}"
    
    Exit Sub
    
Err:
    Me.MousePointer = 1
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub cmbAyudaMoneda_Click()
On Error GoTo Err
Dim CodMonedaAnt            As String
Dim StrMsgError             As String
Dim strMoneda               As String
Dim strCodUM                As String
Dim strDesUM                As String
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim intAfecto               As Integer
Dim strCodFabri             As String
Dim strCodMar               As String
Dim strDesMar               As String
Dim strTipoProd             As String

    CodMonedaAnt = txtCod_Moneda.Text
    
    mostrarAyuda "MONEDA", txtCod_Moneda, txtGls_Moneda
    If Len(Trim(txtCod_Moneda.Text)) > 0 Then
        If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
            lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        Else
            lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        End If
        
        txt_MontoLetras.Text = lbl_TotalLetras.Caption
    End If

    gDetalle.Dataset.First
    If Not gDetalle.Dataset.EOF Then
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = lbl_SimbMonBruto.Caption
            gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = lbl_SimbMonBruto.Caption
            gDetalle.Columns.ColumnByFieldName("Simbolo3").Value = "%"
            gDetalle.Dataset.Post
            gDetalle.Dataset.Next
        Loop
    End If
            
    dblVVUnit = 0
    dblIGVUnit = 0
    dblPVUnit = 0
    
    '*********************** Luis 24/03/2019 ***********************
    strMoneda = traerCampo("Listaprecios", "idMoneda", "idLista", txtCod_Lista.Text, True)

    If CodMonedaAnt <> txtCod_Moneda.Text Then
        gDetalle.Dataset.First
        If Not gDetalle.Dataset.EOF Then
            gDetalle.Dataset.First
            Do While Not gDetalle.Dataset.EOF
                If txtCod_Moneda.Text = strMoneda Then
                    If DatosProducto(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
                    End If
                    If leeParametro("EXTRAE_PRECIO_COMPRAS") = "1" Then
                        If DatosPrecioCompras(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strTipoProd, Trim("" & gDetalle.Columns.ColumnByFieldName("idUM").Value), strDesUM, dblVVUnit, dblFactor) = False Then
                        End If
                    ElseIf leeParametro("EXTRAE_PRECIO_ULTIMA_VENTA") = "S" Then
                        If DatosPrecioUltimaVenta(StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strTipoProd, Trim("" & gDetalle.Columns.ColumnByFieldName("idUM").Value), strDesUM, dblVVUnit, dblFactor) = False Then
                        If StrMsgError <> "" Then GoTo Err
                        End If
                    Else
                        If DatosPrecio(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strTipoProd, Trim("" & gDetalle.Columns.ColumnByFieldName("idUM").Value), strDesUM, dblVVUnit, dblFactor) = False Then
                        End If
                    End If

                Else
                    dblVVUnit = gDetalle.Columns.ColumnByFieldName("VVUnit").Value
                    dblIGVUnit = gDetalle.Columns.ColumnByFieldName("IGVUnit").Value
                    dblPVUnit = gDetalle.Columns.ColumnByFieldName("PVUnit").Value
                End If
                procesaMoneda strMoneda, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, ""

                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)

                gDetalle.Dataset.Post
                gDetalle.Dataset.Next
            Loop
        End If

        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err

    End If
    If txtCod_Moneda.Text <> "" Then SendKeys "{tab}"
    '****************************************************************************
    
Exit Sub
Err:
    Me.MousePointer = 1
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub cmbAyudaMotivoNCD_Click()

    mostrarAyuda "MOTIVONCD", txtCod_MotivoNCD, txtGls_MotivoNCD, "And IdDocumento = '" & strTipoDoc & "'"
'    If txtCod_MotivoTraslado.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaMotivoTraslado_Click()
    
    mostrarAyuda "MOTIVOTRASLADO", txtCod_MotivoTraslado, txtGls_MotivoTraslado, "And  idDocumento = '" & strTipoDoc & "'"
    
    If txtCod_MotivoTraslado.Text = "06090006" Then
        lbl_SucursalDestino.Visible = True
        txtCod_SucursalDestino.Visible = True
        txtGls_SucursalDestino.Visible = True
        cmbAyudaSucursalDestino.Visible = True
        lbl_AlmacenDestino.Visible = True
        txtCod_AlmacenDestino.Visible = True
        txtGls_AlmacenDestino.Visible = True
        cmbAyudaAlmacenDestino.Visible = True
    Else
        lbl_SucursalDestino.Visible = False
        txtCod_SucursalDestino.Visible = False
        txtGls_SucursalDestino.Visible = False
        cmbAyudaSucursalDestino.Visible = False
        lbl_AlmacenDestino.Visible = False
        txtCod_AlmacenDestino.Visible = False
        txtGls_AlmacenDestino.Visible = False
        cmbAyudaAlmacenDestino.Visible = False
    End If
    If txtCod_MotivoTraslado.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaSucursalDestino_Click()
    mostrarAyuda "SUCURSALDESTINO", txtCod_SucursalDestino, txtGls_SucursalDestino
    If txtCod_Vehiculo.Text <> "" Then SendKeys "{tab}"
End Sub

Private Sub cmbAyudaTipoTicket_Click()

    mostrarAyuda "TIPOTICKET", txtCod_TipoTicket, txtGls_TipoTicket
    If txtCod_TipoTicket.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaVehiculo_Click()

    mostrarAyuda "VEHICULO", txtCod_Vehiculo, txtGls_Vehiculo
    'If txtCod_Vehiculo.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaVendedor_Click()

    mostrarAyuda "VENDEDOR", txtCod_Vendedor, txtGls_Vendedor
    If txtCod_Vendedor.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub cmbAyudaVendedorCampo_Click()

    If glsModVendCampo = False Then Exit Sub
    mostrarAyuda "VENDEDOR", txtCod_VendedorCampo, txtGls_VendedorCampo
    'If txtCod_VendedorCampo.Text <> "" Then SendKeys "{tab}"
    
End Sub

Private Sub CmbCentroCostoCliente_Click()
On Error GoTo Err
Dim StrMsgError                             As String

    mostrarAyuda "CENTROCOSTOCLIENTE", TxtIdCentroCostoCliente, TxtGlsCentroCostoCliente, "And IdEmpresa = '" & traerCampo("Empresas", "IdEmpresa", "IdPersona", txtCod_Cliente.Text, False) & "'"
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub cmbcontactosclientes_Click()

    mostrarAyuda "CONTACTOSCLIENTES", txtCod_contacto, txt_contacto, "AND C.IDCLIENTE='" & txtCod_Cliente.Text & "'"
    
End Sub

Private Sub cmdaceptar_Click()
On Error GoTo Err
Dim StrMsgError                             As String
Dim CSqlC                                   As String

    If Trim("" & TxtCodCentroCostoAnt.Text) = Trim("" & TxtCodCentroCostoNuevo.Text) Then
        
        StrMsgError = "El Centro de Costo no puede ser el mismo.": GoTo Err
        
    End If
    
    CSqlC = "Update DocVentas A " & _
            "Inner Join Documentos B " & _
                "On A.IdDocumento = B.IdDocumento " & _
            "Inner Join Cta_Dcto C " & _
                "On A.IdEmpresa = C.IdEmpresa And ConCat(B.AbreDocumento,A.IdSerie,'/',A.IdDocVentas) = C.Nro_Comp " & _
            "Set A.IdCentroCosto = '" & TxtCodCentroCostoNuevo.Text & "',A.GlsCentroCosto = '" & TxtGlsCentroCostoNuevo.Text & "'," & _
            "C.IdCentroCosto = '" & TxtCodCentroCostoNuevo.Text & "' " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & Trim("" & strTipoDoc) & "' " & _
            "And A.IdSerie = '" & Trim("" & gLista.Columns.ColumnByFieldName("IdSerie").Value) & "' " & _
            "And A.IdDocVentas = '" & Trim("" & gLista.Columns.ColumnByFieldName("IdDocVentas").Value) & "'"
    
    Cn.Execute CSqlC
    
    FraModificaCC.Visible = False
    gLista.Enabled = True
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub CmdAyudaCentroCostoAnt_Click()
On Error GoTo Err
Dim StrMsgError                             As String

    mostrarAyuda "CENTROCOSTO", TxtCodCentroCostoAnt, TxtGlsCentroCostoAnt
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub CmdAceptarAtn_Click()
Dim StrMsgError     As String
On Error GoTo Err

If Val(Format(TxtcantProducto.Text, "0.00")) < Val(Format(TxtcantProducto_Atn.Text, "0.00")) Then
    TxtcantProducto_Atn.SetFocus
    MsgBox "La cantidad atendida no puede ser mayor a la cantidad del pedido, Verifique.", vbInformation, Me.Caption
    Exit Sub
End If

csql = "EXEC spu_Docventas_Reg_AtnDet '" & glsEmpresa & "','" & glsSucursal & "','" & strTipoDoc & "','" & gLista.Columns.ColumnByFieldName("idDocVentas").Value & "','" & gLista.Columns.ColumnByFieldName("idSerie").Value & "'," & Val(txtItmProducto.Text) & "," & Val(Format(TxtcantProducto_Atn.Text, "0.00")) & ""
Cn.Execute csql

MsgBox "La cantidad se registró satisfactoriamente..", vbInformation, Me.Caption

FraAtencionPed.Visible = False
ListaDetalle


Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub CmdAyudaCentroCostoNuevo_Click()
On Error GoTo Err
Dim StrMsgError                             As String

    mostrarAyuda "CENTROCOSTO", TxtCodCentroCostoNuevo, TxtGlsCentroCostoNuevo
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub CmdAyudaSucursalDestino_Click()
On Error GoTo Err
Dim StrMsgError                             As String

    mostrarAyuda "SUCURSAL", TxtCodSucursalDestino, TxtGlsSucursalDestino, "And IdSucursal <> '" & glsSucursal & "'"
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub CmdAyudaUnidProduc_Click()
    
    mostrarAyuda "UNIDADPRODUC", txtCod_UnidProd, txtGls_UnidProd
    If txtCod_UnidProd.Text <> "" Then SendKeys "{tab}"
    
    If Len("" & Trim(traerCampo("unidadproduccion", "SerieGuia", "CodUnidProd", txtCod_UnidProd.Text, True))) > 0 Then
    
        txt_Serie.Text = traerCampo("unidadproduccion", "SerieGuia", "CodUnidProd", txtCod_UnidProd.Text, True)
    
    End If
    
End Sub

Private Sub CmdCancelar_Click()
    
    FraFormatoImp.Visible = False
    
End Sub

Private Sub CmdCancelarAtn_Click()
    FraAtencionPed.Visible = False
End Sub

Private Sub CmdCancelarCC_Click()
    
    FraModificaCC.Visible = False
    gLista.Enabled = True
    
End Sub

Private Sub CmdImprime_Click()
On Error GoTo Err
Dim StrMsgError     As String
Dim rsReporte       As New ADODB.Recordset
Dim vistaPrevia     As New frmReportePreview
Dim aplicacion      As New CRAXDRT.Application
Dim reporte         As CRAXDRT.Report
Dim strTitulo       As String
Dim strcontacto     As String
Dim strReporte      As String
Dim strSP           As String
    
    Screen.MousePointer = 11
    FraFormatoImp.Visible = False
    
    If strTipoDoc = "92" Then
        strTitulo = "Cotizacion"
        If OptFormatoImp(0).Value Then
            strReporte = "rptImpCotizacionHac01.rpt"
        Else
            strReporte = "rptImpCotizacionHac02.rpt"
        End If
        strSP = "spu_ImpCotizacionHac"
        
    ElseIf strTipoDoc = "40" Then
        strTitulo = "Pedido"
        If OptFormatoImp(0).Value Then
            strReporte = "rptImpPedidoHac01.rpt"
        Else
            strReporte = "rptImpPedidoHac02.rpt"
        End If
        strSP = "spu_ImpPedidoHac"
    End If
    
    Set reporte = aplicacion.OpenReport(gStrRutaRpts & strReporte)
    
    Set rsReporte = DataProcedimiento(strSP, StrMsgError, glsEmpresa, glsSucursal, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text)
    If StrMsgError <> "" Then GoTo Err

    If Not rsReporte.EOF And Not rsReporte.BOF Then
        reporte.database.SetDataSource rsReporte, 3
        vistaPrevia.CRViewer91.ReportSource = reporte
        vistaPrevia.Caption = strTitulo
        vistaPrevia.CRViewer91.ViewReport
        vistaPrevia.CRViewer91.DisplayGroupTree = False
        Screen.MousePointer = 0
        vistaPrevia.WindowState = 2
        vistaPrevia.Show
            
    Else
        Screen.MousePointer = 0
        MsgBox "No existen Registros  Seleccionados", vbInformation, App.Title
    End If
    
    Screen.MousePointer = 0
    Set rsReporte = Nothing
    Set vistaPrevia = Nothing
    Set aplicacion = Nothing
    Set reporte = Nothing
    
    Exit Sub
    
Err:
    Screen.MousePointer = 0
    If StrMsgError = "" Then StrMsgError = Err.Description
    If rsReporte.State = 1 Then rsReporte.Close
    Set rsReporte = Nothing
    Set vistaPrevia = Nothing
    Set aplicacion = Nothing
    Set reporte = Nothing
    MsgBox StrMsgError, vbInformation, App.Title

End Sub

Private Sub CmdSituacionCre_Click()
On Error GoTo Err
Dim StrMsgError                 As String

    FrmSituacionCreNuevo.MostrarFrom StrMsgError, txtCod_Cliente.Text, txtGls_Cliente.Text, txt_RUC.Text
    If StrMsgError <> "" Then GoTo Err
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub Command1_Click(Index As Integer)
Dim StrMsgError As String
Dim strGlsProOrigen As String
On Error GoTo Err

    strGlsProOrigen = traerCampo("Productos", "GlsProducto", "idProducto", gDetalle.Columns.ColumnByFieldName("idProducto").Value, True)

    If Len(Trim(longitud)) > 0 Then
        CATTextBox1(0).Text = Trim(CATTextBox1(0).Text) & vbCrLf
    End If
    
    If strParamModGlsPro = "S" Then
        gDetalle.Dataset.Edit
        gDetalle.Columns.ColumnByFieldName("glsProducto").Value = strGlsProOrigen & Space(2) & CATTextBox1(0).Text
        gDetalle.Dataset.Post
        Frame2(0).Visible = False
    Else
        gDetalle.Dataset.Edit
        gDetalle.Columns.ColumnByFieldName("glsProducto").Value = CATTextBox1(0).Text
        gDetalle.Dataset.Post
        Frame2(0).Visible = False
    End If
    
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, "Ventas"
    Exit Sub

End Sub

Private Sub Command2_Click(Index As Integer)
    
    Frame2(0).Visible = False
    
End Sub



Private Sub dtp_Emision_Change()
On Error GoTo Err
Dim StrMsgError                     As String
Dim dblVVUnit As Double, dblIGVUnit As Double, dblPVUnit As Double
Dim strMoneda As String
    
    txt_TipoCambio.Text = Val(traerCampo("TiposDeCambio", "TcVenta", "Fecha", Format(dtp_Emision.Value, "yyyy-mm-dd"), False))
    
    If Trim("" & STR_PERIODO_CAMBIO_IGV) > Format(dtp_Emision.Value, "yyyymm") Then
        dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
    Else
        dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
    End If
    
    With gDetalle
        If .Dataset.RecordCount > 0 Then
            .Dataset.First
            If Not .Dataset.EOF Then
                Do While Not .Dataset.EOF
                    procesaMoneda gDetalle.Columns.ColumnByFieldName("idMoneda").Value, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, ""
                    If StrMsgError <> "" Then GoTo Err
                    .Dataset.Edit
                    calculaTotalesFila .Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, .Columns.ColumnByFieldName("PorDcto").Value, .Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    .Dataset.Post
                    .Dataset.Next
                Loop
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
        
            End If
        End If
    End With
                   
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub dtp_Emision_KeyDown(KeyCode As Integer, Shift As Integer)

    If KeyCode = 13 Then
        SendKeys "{tab}"
    End If

End Sub

Private Sub Form_Load()
Dim StrMsgError  As String
Dim rsdatos      As New ADODB.Recordset
On Error GoTo Err
    
    indCargando = False
    
    FraFormatoImp.Visible = False
    indInserta = False
    indInsertaDocRef = False
    indNuevoDoc = True
    
    Me.top = 0
    Me.left = 0
    
    
    CTmpDocumentos = ""
    CTmpGuiasNF = ""
    CTmpDocumentosGen = ""
    CTmpStock = ""
    CTmpReferencia = ""
    CTmpProductosDesp = ""
    
    Toolbar1.ButtonHeight = 540.28
    Toolbar1.ButtonWidth = 750.04
    
    strEstDocVentas = "GEN"
    txt_Ano.Text = Year(getFechaSistema)
    cbx_Mes.ListIndex = Month(getFechaSistema) - 1
    CbxGanadas.ListIndex = 2
    
    If rsdatos.State = 1 Then rsdatos.Close: Set rsdatos = Nothing
    rsdatos.Open "EXEC spu_Documento '92'", Cn, adOpenStatic, adLockOptimistic
    If Not rsdatos.EOF Then
        'strGlsTipoDoc = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDoc, False)
        'fraGeneral.Height = traerCampo("documentos", "frameHeight", "idDocumento", strTipoDoc, False)
        strGlsTipoDoc = Trim("" & rsdatos.Fields("GlsDocumento")) & " - Versiones"
        fraGeneral.Height = rsdatos.Fields("frameHeight")
        
    End If
    
    Me.Caption = strGlsTipoDoc
    
    
    fraDetalle.Height = Me.Height - fraGeneral.Height - fraTotales.Height - Toolbar1.Height - 570
    gDetalle.Height = fraDetalle.Height - 320
    gDetalle.top = gDetalle.top - 50
    
    fraDetalle.top = fraGeneral.Height + Toolbar1.Height + 50
    lblDoc.Caption = Me.Caption
    
    '--- Parametro para Apimas facturacion entre empresas
    ccodparamemp = STR_IMPORTAR_DOCUMENTOS_ENTRE_EMPRESAS 'traerCampo("Parametros", "Valparametro", "GlsParametro", "IMPORTAR_DOCUMENTOS_ENTRE_EMPRESAS", True)
    strParamEmpSuc = STR_EMPRESA_SUCURSAL_DOCUMENTOS_ENTRE_EMPRESAS 'traerCampo("Parametros", "Valparametro", "GlsParametro", "EMPRESA_SUCURSAL_DOCUMENTOS_ENTRE_EMPRESAS", True)
    ccodproparam = ""
    
    muestraControlesCabecera
        
    'If leeParametro("DESCRIPCION_AREA_O_UPP") = "1" Then
    If STR_DESCRIPCION_AREA_O_UPP = "1" Then
        lbl_upp.Caption = "Área"
    Else
        lbl_upp.Caption = "UUPP"
    End If
    
    txt_TipoCambio.Decimales = glsDecimalesTC
    txtCod_Vendedor.Text = glsUser
    muestraColumnasDetalle
    
    ConfGrid gLista, True, True, False, False
    ConfGrid gListaDetalle, False, False, False, False
    ConfGrid gDetalle, True, False, False, False
    ConfGrid gDocReferencia, True, False, False, True
    
    If glsModificarPrecio = "N" Then
        gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = True
        gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = True
    Else
        gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = False
        gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = False
    End If
    
    If traerCampo("Parametros", "ValParametro", "GlsParametro", "BLOQUEA_CHK_AFECTO", True) = "S" Then
        gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = True
    Else
        gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = False
    End If
    
    If strTipoDoc = "92" Then
        gLista.Columns.ColumnByFieldName("btnRC").Visible = True
        txt_TextoBuscar.Width = 4935
        
    Else
        gLista.Columns.ColumnByFieldName("btnRC").Visible = False
        txt_TextoBuscar.Width = 7125
    End If
    
    If strTipoDoc = "86" Or strTipoDoc = "01" Or strTipoDoc = "92" Then
        gLista.Columns.ColumnByFieldName("docReferencia").Visible = True
    Else
        gLista.Columns.ColumnByFieldName("docReferencia").Visible = False
    End If
    
    If strTipoDoc = "92" Then
        gLista.Columns.ColumnByFieldName("Costototal").Visible = True
    Else
        gLista.Columns.ColumnByFieldName("Costototal").Visible = False
    End If
    
    If strTipoDoc = "40" Then
        gListaDetalle.Columns.ColumnByFieldName("CantidadImp").Visible = True
    End If
    
    fraListado.Visible = True
    fraGeneral.Visible = False
    fraDetalle.Visible = False
    fraTotales.Visible = False
    
    habilitaBotones 2, StrMsgError
    If StrMsgError <> "" Then GoTo Err
        
    indNuevoDoc = False
    
    If rsTempLotes.State = 1 Then rsTempLotes.Close
    Set rsTempLotes = Nothing
    
    If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close
    Set rsTempLiquidacion = Nothing
    
    Toolbar1.Buttons(15).Visible = False
    Toolbar1.Buttons(16).Visible = False
    Toolbar1.Buttons(17).Visible = False
    
    longitud = STR_LONGITUD_IMPRESION_DETALLE_PRODUCTO 'Trim("" & traerCampo("Parametros", "Valparametro", "GlsParametro", "LONGITUD_IMPRESION_DETALLE_PRODUCTO", True))
    
    
    '--- Parametro que permitira añadir una descripcion adicional al nombre del producto
    strParamModGlsPro = "N" 'Trim("" & traerCampo("Parametros", "Valparametro", "GlsParametro", "AÑADE_DESCRIPCION_AL_PRODUCTO", True))
    
    lbl_Llegada2.Caption = "Tiempo de Entrega"
    lbl_Llegada.Caption = "Lugar de Entrega"
    
    mostrarDocVentas strNumDocVentas, strSerieDocventas, strNumitmlogDocVentas, StrMsgError
    If StrMsgError <> "" Then GoTo Err

    If StrMsgError <> "" Then GoTo Err
    fraListado.Visible = False
    fraGeneral.Visible = True
    fraDetalle.Visible = True
    fraTotales.Visible = True
    
    fraGeneral.Enabled = False
    Activa_Desc_Grid True

    intBoton = 3
    habilitaBotones 2, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub Grabar(ByRef StrMsgError As String)
On Error GoTo Err
Dim strMsg              As String
Dim strtipodocref       As String
Dim strSerieRef         As String
Dim sqlupdate           As String
Dim NumFacturaRef       As String
Dim SerieFacturaRef     As String
Dim indTrans            As Boolean
Dim numCta_Dcto         As String
Dim strReferencia       As String
Dim numcom              As String
Dim strconsumido        As Double
Dim strCodMoneda        As String
Dim strtipocambio       As Double
Dim strutilizado        As Double
Dim strlineacredito     As Double
Dim strsaldo            As Double
Dim strmonto            As Double
Dim strcodmonedaCTD     As String
Dim Strdisponible       As Double
Dim strconsumidoLCR     As Double
Dim strCodCliente       As String
Dim rst                 As New ADODB.Recordset
Dim CantValDocLotes     As Double
Dim dias                As String
Dim fecvencimiento      As String
Dim csqludt             As String
Dim dias_1              As String
Dim fecvencimiento_1    As String
Dim csqludt_1           As String
Dim Docu                As String
Dim Nro_Comp            As String
Dim indAprueba          As Boolean
Dim strFormaPago        As String
Dim rsVenc              As New ADODB.Recordset
Dim visCodRapido        As String
Dim strCodPro           As String
Dim dblSaldo            As Double
Dim IndVencidos         As Boolean
Dim CIdUsuarioPase      As String
Dim NItem               As Long
Dim NArrTotales(7)      As Double
Dim CSqlC               As String
Dim RsC                 As New ADODB.Recordset
Dim rsValida            As New ADODB.Recordset

    If leeParametro("VENTA_ELECTRONICA") = "S" Then
    
        If Not IsNumeric(left(txt_Serie.Text, 1)) Then
            
            'CSqlC = "Select A.IdDocVentas,A.IndAceptadoSunat " & _
            '        "From DocVentas A " & _
            '        "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' And A.IdSerie = '" & txt_serie.Text & "' " & _
            '        "Order By A.IdDocVentas Desc Limit 1"
            'AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
            'If Not RsC.EOF Then
            '    If Val(txt_numdoc.Text) > 0 Then
            '        If Val(txt_numdoc.Text) < Val("" & RsC.Fields("IdDocVentas")) Then
            '            StrMsgError = "El último Documento ingresado de N° " & Trim("" & RsC.Fields("IdDocVentas")) & " es posterior al que quiere grabar. Verifique.": GoTo Err
            '        End If
            '    End If
            '
            '    If Val("" & RsC.Fields("IndAceptadoSunat")) = 0 Then
            '        If Trim("" & RsC.Fields("IdDocVentas")) <> txt_numdoc.Text Then
            '            StrMsgError = "El Documento N° " & Trim("" & RsC.Fields("IdDocVentas")) & " no ha sido aceptado por SUNAT. Verifique.": GoTo Err
            '        End If
            '    End If
            'End If
            'RsC.Close: Set RsC = Nothing
            
            If strTipoDoc = "07" Or strTipoDoc = "08" Then
                If txtObs.Text = "" Then
                    StrMsgError = "Debe ingresar el motivo del Documento en Observaciones.": GoTo Err
                End If
            End If
    
        End If
    
    End If
    
    NArrTotales(0) = NTotalBruto
    NArrTotales(1) = NTotalIGV
    NArrTotales(2) = NTotalIVAP
    NArrTotales(3) = NTotalDsctoVV
    NArrTotales(4) = NTotalDsctoPV
    NArrTotales(5) = NTotalBaseImponible
    NArrTotales(6) = NTotalExonerado
        
    If gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Visible Then
    
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            
            If gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value <> "" Then
            
                If traerCampo("CentrosCosto", "IdCodUNegocio", "IdCentroCosto", gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, True) <> txtCod_UnidProd.Text Then
                    
                    StrMsgError = "La Hoja de Costo del Item " & gDetalle.Columns.ColumnByFieldName("Item").Value & " no coincide con el Área, verificar.": GoTo Err
                
                End If
            
            End If
            
            gDetalle.Dataset.Next
            
        Loop
    
    End If
    
    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    '----- ASIGNAR PROPIEDAD VACIO A TIPDOC (03,40,90,91,92,12-TIPO BOLETA)
    If strTipoDoc = "03" Or strTipoDoc = "40" Or strTipoDoc = "90" Or strTipoDoc = "91" Or strTipoDoc = "92" Or (strTipoDoc = "12" And txtCod_TipoTicket.Text = "08002") Then
        txt_RUC.Vacio = True
        txt_Direccion.Vacio = True
    End If
    
    sw_graba_factura = False
    strNumDocReferencia = ""
    
    validaFormSQL Me, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    '----- DESHABILITANDO LA PROPIEDAD VACIO
    txt_RUC.Vacio = False
    txt_Direccion.Vacio = False
    
    eliminaNulosGrilla
    If gDetalle.Count >= 1 Then
        If gDetalle.Count = 1 And (gDetalle.Columns.ColumnByFieldName("idProducto").Value = "" Or gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0) Then
            StrMsgError = "Falta Ingresar Detalle"
            GoTo Err
        End If
    End If
    
    eliminaNulosGrillaDocRef
    generaSTRDocReferencia
    
    '-------------------------------------------------------------------------------------------------------------------------------------
    '------- Validando Stock
    visCodRapido = Trim("" & traerCampo("parametros", "ValParametro", "GlsParametro", "VIZUALIZA_CODIGO_RAPIDO", True))
        
'    If glsValidaStock = True Then
'
'        With GDetalle
'            .Dataset.First
'             Do While Not .Dataset.EOF
'
'                If visCodRapido = "S" Then
'                    strCodPro = traerCampo("Productos", "CodigoRapido", "idProducto", Trim("" & .Columns.ColumnByFieldName("idProducto").Value), True)
'                Else
'                    strCodPro = Trim("" & .Columns.ColumnByFieldName("idProducto").Value)
'                End If
'
'                dblsaldo = traerCantSaldo(Trim(.Columns.ColumnByFieldName("IdProducto").Value), Trim(txtCod_Almacen.Text), Format(dtp_Emision.Value, "yyyy-mm-dd"), StrMsgError)
'                If Trim(.Columns.ColumnByFieldName("idTipoProducto").Value) <> "06002" Then ' Diferente a servicio
'                    If dblsaldo < Val(.Columns.ColumnByFieldName("Cantidad").Value) Then
'                        StrMsgError = StrMsgError & "En el item " & .Columns.ColumnByFieldName("item").Value & " la cantidad ingresada para el producto " & " " & strCodPro & " excede el stock. Verifique. " & "  Disponible  " & Format(dblsaldo, "0.00") & Chr(13) & Chr(10)
'                    End If
'                End If
'                .Dataset.Next
'             Loop
'        End With
'
'    End If
'    If StrMsgError <> "" Then GoTo Err

    '-------------------------------------------------------------------------------------------------------------------------------------
    '------- Validando linea_credito_clientes
    strtipocambio = Trim(txt_TipoCambio.Text)
    strmonto = Val(Format(txt_TotalNeto.Text, "0.00"))
    strCodCliente = Trim(txtCod_Cliente.Text)
    gDocReferencia.Dataset.First
    
    indAprueba = False
    
    IndVencidos = False
    
    If intBoton = 1 Then
    
        CIdUsuarioPase = "Pase"
    
    Else
        
        If Val("" & traerCampo("DocVentas", "TotalPrecioVenta", "IdDocumento", strTipoDoc, True, "IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'")) = Val(Format(txt_TotalNeto.Text, "0.00")) Then
            
            CIdUsuarioPase = "Pase2"
        
        Else
        
            CIdUsuarioPase = "Pase"
        
        End If
        
    End If
    
''''    If ChkfContado.Value = 0 Then 'Luis 25/03/2017
''''
''''        'Luis 17/10/2018 forma de pago********************************
''''        Dim StrCadSqlx   As String
''''
''''        If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
''''
''''        StrCadSqlx = "SELECT a.idtipoformapago FROM formaspagos a inner join tipoformaspago b " & _
''''                     "on a.idtipoformapago  = b.idtipoformapago " & _
''''                     "where a.idformapago = '" & Trim("" & txtCod_FormaPago.Text) & "' and a.idempresa  = '01' and b.TipoFormaPago  = 'C' "
''''
''''        rsValida.Open StrCadSqlx, Cn, adOpenStatic, adLockOptimistic
''''        If rsValida.EOF Then
''''
''''            If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
''''            rsValida.Open "select idCliente from ClientesEspecial where idCliente = '" & Trim("" & txtCod_Cliente.Text) & "'", Cn, adOpenStatic, adLockOptimistic
''''            If rsValida.EOF Then
''''                ActualizaLineaCredito StrMsgError, txtCod_Cliente.Text
''''                VerificaLineaCredito StrMsgError, txtCod_Cliente.Text, IndVencidos, CIdUsuarioPase
''''                If StrMsgError <> "" Then GoTo Err
''''
''''            End If
''''
''''        End If
''''    End If
    '-------------------------------------------------------------------------------------------------------------------------------------
    '--- VALIDA STOCK POR LOTE
    If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
    If strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "56" Or strTipoDoc = "86" Then
        gDetalle.Dataset.First
        If Not gDetalle.Dataset.EOF Then
            Do While Not gDetalle.Dataset.EOF
                If rsTempLotes.State = 0 Then
                    If traerCampo("productos", "idTipoProducto", "idproducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True) = "06002" Then
                    Else
                        StrMsgError = StrMsgError & "El Producto con Código " & " " & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & " que se Encuentra en la Fila " & " " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " " & " No se le ha asignado una Talla. Verifique." & Chr(13) & Chr(10)
                    End If
                    
                ElseIf rsTempLotes.RecordCount = 0 Then
                    If traerCampo("productos", "idTipoProducto", "idproducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True) = "06002" Then
                    Else
                        StrMsgError = StrMsgError & "El Producto con Código " & " " & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & " que se Encuentra en la Fila " & " " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " " & " No se le ha asignado un Talla. Verifique." & Chr(13) & Chr(10)
                    End If
                
                Else
                    rsTempLotes.Filter = ""
                    rsTempLotes.Filter = adFilterNone
                    rsTempLotes.MoveFirst
                    If traerCampo("productos", "idTipoProducto", "idproducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True) = "06002" Then
                    Else
                        rsTempLotes.Filter = "idproducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and ItemDocVentas = " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " "
                        If rsTempLotes.RecordCount <> 0 Then
                            If Not rsTempLotes.EOF Then
                                rsTempLotes.MoveFirst
                            
                                CantValDocLotes = 0#
                                Do While Not rsTempLotes.EOF
                                    CantValDocLotes = CantValDocLotes + Format(rsTempLotes.Fields("Cantidad"), "0.00")
                                rsTempLotes.MoveNext
                                Loop
                            
                                If Format(gDetalle.Columns.ColumnByFieldName("Cantidad").Value, "0.00") <> Format(CantValDocLotes, "0.00") Then
                                    StrMsgError = StrMsgError & "El Producto Con Codigo " & " " & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & " que se Encuentra en la Fila " & " " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " " & " las Sumas de Las Cantidades no coinciden. Verifique." & Chr(13) & Chr(10)
                                End If
                            
                            Else
                                StrMsgError = StrMsgError & "El Producto Con Codigo " & " " & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & " que se Encuentra en la Fila " & " " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " " & " No se le ha asignado un Talla. Verifique." & Chr(13) & Chr(10)
                            End If
                        Else
                            StrMsgError = StrMsgError & "El Producto Con Codigo " & " " & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & " que se Encuentra en la Fila " & " " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & " " & " No se le ha asignado un Talla. Verifique." & Chr(13) & Chr(10)
                        End If
                    
                    End If
                                            
                End If
                gDetalle.Dataset.Next
            Loop
        End If
        
        If Len(StrMsgError) > 0 Then
            rsTempLotes.Filter = ""
            rsTempLotes.Filter = adFilterNone
            GoTo Err
        Else
            If rsTempLotes.State = 0 Then
            Else
                rsTempLotes.Filter = ""
                rsTempLotes.Filter = adFilterNone
                rsTempLotes.MoveFirst
            End If
        End If
    End If
    End If
    
    'PQS 03/11/2014
    If glsValidaStock Then
        
        If leeParametro("SOLOGUIAMUEVESTOCK") = "S" Then
        
            If strTipoDoc = "86" Then
            
                ValidaStock_Y_Saldos StrMsgError, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, "", dtp_Emision.Value
                If StrMsgError <> "" Then GoTo Err
            
            End If
            
        Else
            
            If strTipoDoc <> "07" And strTipoDoc <> "40" And strTipoDoc <> "92" Then
            
                ValidaStock_Y_Saldos StrMsgError, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, "", dtp_Emision.Value
                If StrMsgError <> "" Then GoTo Err
            
            End If
            
        End If
        
    End If
    '-------------------------------------------------------------------------------------------------------------------------------------
    txt_NumDoc.Text = Format(txt_NumDoc.Text, "00000000")
    indTrans = False
    
    If strTipoDoc = "07" Then
        
        indGeneraVale = False
        
        If Len(Trim("" & traerCampo("MotivosNCD", "IdConcepto", "IdMotivoNCD", txtCod_MotivoNCD.Text, False))) > 0 Then
            indGeneraVale = True
        End If
        
    End If
    
    '--------------------------------------------------------------------------------------------
    If intBoton = 1 Then '--- Graba
        '--- GENERAMOS EL CORRELATIVO
        If txt_NumDoc.Text = "" Then
           txt_NumDoc.Text = objDocVentas.generaCorrelativoDocVentas(strTipoDoc, txt_Serie.Text)
        End If

        sw_graba_factura = False
        
        '--------------------------------------------------------------------------------------------
        '--------- CONTROLAR CON PARAMETRO SI DESPUES DE GRABAR LA GUIA, GRABA LA FACTURA
        If traerCampo("seriesdocumento", "IndTransferencia", "idDocumento", strTipoDoc, True, " idserie = '" & Trim(txt_Serie.Text) & "' ") <> "S" Then
            If glsGrabaGuiaFactura = "S" Then
                '--------- VALIDA QUE SOLO HALLA UNA FACTURA EN EL GDOCREFERENCIAS (SOLO PARA GUIA)
                If strTipoDoc = "86" Then
                    validarDocReferencia StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    If sw_graba_factura Then
                        validarNumeroFactura SerieFacturaRef, NumFacturaRef, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        validarFacturaRef SerieFacturaRef, NumFacturaRef, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                    End If
                End If
            End If
        End If
        '--------------------------------------------------------------------------------------------
        '--- INICIANDO LA TRANSACCION
        indTrans = True
        Cn.BeginTrans
        
        If IndVencidos Then
            
            NItem = Val("" & traerCampo("PasesDocVenc", "Item", "IdCliente", txtCod_Cliente.Text, True, "IdCliente = IdCliente Order By Item Desc Limit 1")) + 1
            
            csql = "Insert Into PasesDocVenc(IdEmpresa,IdCliente,Item,IdUsuarioReg,IdUsuarioPase,Fecha,Hora,GlsPC,GlsPCUsuario)" & _
                   "Values('" & glsEmpresa & "','" & txtCod_Cliente.Text & "'," & NItem & ",'" & glsUser & "','" & CIdUsuarioPase & "',Cast(GETDATE() As Date)," & _
                   "Cast(GETDATE() As Time),'" & ComputerName & "','" & fpUsuarioActual & "')"
            
            Cn.Execute csql
            
        End If
            
        '--------- CONTROLAR CON PARAMETRO
        If glsGrabaGuiaFactura = "S" Then
            '------- SI EL SW DE FACTURA ESTA TRUE ELIMINA LA FACTURA
            If sw_graba_factura Then
                EliminarFacturasRef StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        End If
        '--------------------------------------------------------------------------------------------
        glsobservacionventas = txtObs.Text
        glsobservacionventas2 = txtGls_Obj2.Text
        
        If Len(Trim(ccodproparam)) > 0 Then
            If ccodparamemp = "S" Then
                objDocVentas.EjecutaSQLFormDocVentasEmpresas Me, 0, StrMsgError, strTipoDoc, txt_Serie.Text, gDetalle, gDocReferencia, indGeneraVale, rsTempLotes, RsDetProductos, rsTempLiquidacion, rsdEmpresas, NArrTotales
                If StrMsgError <> "" Then GoTo Err
            Else
                objDocVentas.EjecutaSQLFormDocVentas Me, 0, StrMsgError, strTipoDoc, txt_Serie.Text, gDetalle, gDocReferencia, indGeneraVale, rsTempLotes, RsDetProductos, rsTempLiquidacion, NArrTotales
                If StrMsgError <> "" Then GoTo Err
            End If
        Else
            objDocVentas.EjecutaSQLFormDocVentas Me, 0, StrMsgError, strTipoDoc, txt_Serie.Text, gDetalle, gDocReferencia, indGeneraVale, rsTempLotes, RsDetProductos, rsTempLiquidacion, NArrTotales
            If StrMsgError <> "" Then GoTo Err
        End If
        
        '--------------------------------------------------------------------------------------------
        '--------- CONTROLAR CON PARAMETRO
        If glsGrabaGuiaFactura = "S" Then
            '------- SI EL SW DE FACTURA ESTA TRUE GRABA LA FACTURA
            If sw_graba_factura Then
                objDocVentas.EjecutaSQLFormDocVentasFactura Me, 0, StrMsgError, NumFacturaRef, SerieFacturaRef, gDetalle, NArrTotales
                If StrMsgError <> "" Then GoTo Err
                
                csql = "UPDATE docventas set glsDocReferencia = 'Gre " & txt_Serie.Text & "-" & txt_NumDoc.Text & "' " & _
                         "where idEmpresa = '" & glsEmpresa & "' " & _
                         "and idSucursal = '" & glsSucursal & "' " & _
                         "and idDocumento = '01' " & _
                         "and idSerie = '" & SerieFacturaRef & "' " & _
                         "and idDocVentas = '" & NumFacturaRef & "' "
                Cn.Execute csql
            End If
        End If
        '--------------------------------------------------------------------------------------------
        
        If strTipoDoc = "07" Or strTipoDoc = "89" Or strTipoDoc = "08" Or (strTipoDoc = "25" And IndAtribucionNC = 1) Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "" Then
                    Exit Do
                End If
                strReferencia = strReferencia + " - " + traerCampo("Documentos", "AbreDocumento", "idDocumento", gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value, False) + gDocReferencia.Columns.ColumnByFieldName("idSerie").Value + "/" + Trim(gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value)
                gDocReferencia.Dataset.Next
            Loop
            If strReferencia <> "" Then
                strReferencia = Trim(Mid(strReferencia, 3, Len(strReferencia) - 3))
            End If
            If strTipoDoc = "07" Then
                numcom = "Cre" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
            
            ElseIf strTipoDoc = "89" Then
                
                numcom = "Nde" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ')"
            
            
            
            ElseIf strTipoDoc = "08" Then
            
                numcom = "Deb" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'D', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
            
            Else
            
                numcom = "Atr" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
                        
            End If
            Cn.Execute csql
                    
            dias = right(txtGls_FormaPago.Text, 7)
            
            If Val(left(dias, 2)) > 0 Then
                fecvencimiento = DateAdd("D", Val(left(dias, 2)), dtp_Emision.Value)
                csqludt = "update  docventas  set glsformaspago = '" & txtGls_FormaPago.Text & "' , fecpago = '" & Format(fecvencimiento, "YYYY-MM-DD") & "' " & _
                          " where idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and iddocventas = '" & txt_NumDoc.Text & "'  and idempresa = '" & glsEmpresa & "'  and idsucursal = '" & glsSucursal & "' "
                Cn.Execute (csqludt)
            Else
            
                csqludt = "update  docventas  set glsformaspago = '" & txtGls_FormaPago.Text & "' , fecpago = '" & Format(dtp_Emision.Value, "YYYY-MM-DD") & "' " & _
                            " where idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and iddocventas = '" & txt_NumDoc.Text & "'  and idempresa = '" & glsEmpresa & "'  and idsucursal = '" & glsSucursal & "' "
                Cn.Execute (csqludt)
            End If
        End If
            
        glsobservacionventas = ""
              
        If strTipoDoc = "40" And traerCampo("Parametros", "ValParametro", "GlsParametro", "APRUEBA_PEDIDO_AUTOMATICO", True) = "1" Then
            AprobacionAutomatica StrMsgError
            If StrMsgError <> "" Then GoTo Err
        End If
        
        ActualizaLineaCredito StrMsgError, txtCod_Cliente.Text
        If StrMsgError <> "" Then GoTo Err
        
        CSqlC = "Update DocVentas " & _
                "Set IndAtribucionNC = " & IndAtribucionNC & " " & _
                "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & strTipoDoc & "' " & _
                "And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'"
        
        Cn.Execute CSqlC
        
'        FacturacionEntreEmpresas StrMsgError, 1, txt_serie.Text, txt_numdoc.Text
'        If StrMsgError <> "" Then GoTo Err
        
'        FacturacionEntreEmpresasAsientoContable StrMsgError, False, txt_serie.Text, txt_numdoc.Text
'        If StrMsgError <> "" Then GoTo Err
    
        Cn.CommitTrans
        
        If Trim(STR_CLIENTE_ANULA & "") = "S" Then
            If traerCampo("Clientes", "IndAnula", "idCliente", txtCod_Cliente.Text, True) = 1 Then
                anularDoc StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        End If
        ListaTempLiquidaciones
        strMsg = "Grabó"
        intBoton = 3
    
    Else '--- Modifica
        glsobservacionventas = txtObs.Text
        glsobservacionventas2 = txtGls_Obj2.Text
        
        sw_graba_factura = False
        '--------------------------------------------------------------------------------------------
        '--------- CONTROLAR CON PARAMETRO
        If traerCampo("seriesdocumento", "IndTransferencia", "idDocumento", strTipoDoc, True, " idserie = '" & Trim(txt_Serie.Text) & "' ") <> "S" Then
            If glsGrabaGuiaFactura = "S" Then
                '------- SI EL SW DE FACTURA ESTA TRUE GRABA LA FACTURA
                If strTipoDoc = "86" Then
                    validarDocReferencia StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    If sw_graba_factura Then
                        validarNumeroFactura SerieFacturaRef, NumFacturaRef, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        validarFacturaRef SerieFacturaRef, NumFacturaRef, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                    End If
                End If
            End If
        End If
        
        
        ' ********** Franco 18012025 ************
        ' Grabamos logico de ventas - versiones
        If Val(ChkfContado.Value) = 1 Then
            csql = "EXECUTE spu_GrabaVentas_Log '" & glsEmpresa & "', '" & glsSucursal & "','" & Trim(strTipoDoc) & "','" & Trim(txt_Serie.Text) & "','" & Trim("" & txt_NumDoc.Text) & "','" & ComputerName & "','" & glsUser & "'"
            Cn.Execute csql
            ChkfContado.Value = 0
        End If
        '****************************************
        
        '----- INICIANDO EL TRANSAC
        indTrans = True
        Cn.BeginTrans
        
        If IndVencidos Then

            NItem = Val("" & traerCampo("PasesDocVenc", "Item", "IdCliente", txtCod_Cliente.Text, True, "IdCliente = IdCliente Order By Item Desc Limit 1")) + 1

            csql = "Insert Into PasesDocVenc(IdEmpresa,IdCliente,Item,IdUsuarioReg,IdUsuarioPase,Fecha,Hora,GlsPC,GlsPCUsuario)" & _
                   "Values('" & glsEmpresa & "','" & txtCod_Cliente.Text & "'," & NItem & ",'" & glsUser & "','" & CIdUsuarioPase & "',Cast(GETDATE() As Date)," & _
                   "Cast(GETDATE() As Time),'" & ComputerName & "','" & fpUsuarioActual & "')"

            Cn.Execute csql

        End If
        
        '--------------------------------------------------------------------------------------------
        '--------- CONTROLAR CON PARAMETRO
        If glsGrabaGuiaFactura = "S" Then
            '------- SI EL SW DE FACTURA ESTA TRUE ELIMINA LA FACTURA
            If sw_graba_factura Then
                EliminarFacturasRef StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        End If
        
        If ccodparamemp = "S" Then
            objDocVentas.EjecutaSQLFormDocVentasEmpresas Me, 1, StrMsgError, strTipoDoc, txt_Serie.Text, gDetalle, gDocReferencia, indGeneraVale, rsTempLotes, RsDetProductos, rsTempLiquidacion, rsdEmpresas, NArrTotales
            If StrMsgError <> "" Then GoTo Err
        Else
            objDocVentas.EjecutaSQLFormDocVentas Me, 1, StrMsgError, strTipoDoc, txt_Serie.Text, gDetalle, gDocReferencia, indGeneraVale, rsTempLotes, RsDetProductos, rsTempLiquidacion, NArrTotales
            If StrMsgError <> "" Then GoTo Err
        End If
        
        '--------------------------------------------------------------------------------------------
        '--------- CONTROLAR CON PARAMETRO
        If glsGrabaGuiaFactura = "S" Then
            '------- SI EL SW DE FACTURA ESTA TRUE GRABA LA FACTURA
            If sw_graba_factura Then
                objDocVentas.EjecutaSQLFormDocVentasFactura Me, 0, StrMsgError, NumFacturaRef, SerieFacturaRef, gDetalle, NArrTotales
                If StrMsgError <> "" Then GoTo Err
            End If
        End If
        
        If strTipoDoc = "07" Or strTipoDoc = "89" Or strTipoDoc = "08" Or (strTipoDoc = "25" And IndAtribucionNC = 1) Then
            Docu = traerCampo("documentos", "abredocumento", "iddocumento", strTipoDoc, False)
            Nro_Comp = Trim(Docu & txt_Serie.Text & "/" & txt_NumDoc.Text)
            
            csql = "delete from cta_dcto where nro_comp = '" & Nro_Comp & "'  and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
            Cn.Execute csql
            
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "" Then
                    Exit Do
                End If
                strReferencia = strReferencia + " - " + traerCampo("Documentos", "AbreDocumento", "idDocumento", gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value, False) + gDocReferencia.Columns.ColumnByFieldName("idSerie").Value + "/" + Trim(gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value)
                gDocReferencia.Dataset.Next
            Loop
            If strReferencia <> "" Then
                strReferencia = Trim(Mid(strReferencia, 3, Len(strReferencia) - 3))
            End If
            
            If strTipoDoc = "07" Then
                numcom = "Cre" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
            
            ElseIf strTipoDoc = "89" Then
                numcom = "Nde" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ')"
            
            ElseIf strTipoDoc = "08" Then
            
                numcom = "Deb" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'D', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
            
            Else
            
                numcom = "Atr" + txt_Serie.Text + "/" + txt_NumDoc.Text
                
                numCta_Dcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), True)
                
                csql = "insert into cta_dcto(idEmpresa, idSucursal, idCta_Dcto, idSucursalCobro, indViaIngreso, Nro_Comp, Fec_Comp, Fec_Vcto, idCliente, idClienteOri, idMoneda, idMonedaOri, ValTipoCambio, ValTipoCambioOri, ValTotal, ValTotalOri, ValSaldo, indDeb_Hab, glsReferencia, idCobrador, idPlanillaCob, NroDeposito, idBanco, idVendedor, CodCliAnt, CodVendAnt,idCentroCosto) " & _
                        "values('" & glsEmpresa & "', '" & glsSucursal & "', '" & numCta_Dcto & "', '" & glsSucursal & "', 1, '" & numcom & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Cliente.Text & "', '" & txtCod_Moneda.Text & "', '" & txtCod_Moneda.Text & "', " & txt_TipoCambio.Text & " " & _
                        ", " & txt_TipoCambio.Text & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", " & Format(txt_TotalNeto.Text, "0.00") & ", 'H', '" & strReferencia & "', '" & txtCod_VendedorCampo.Text & "', ' ', ' ', ' ', '" & txtCod_VendedorCampo.Text & "', ' ' , ' ','" & txtCod_CentroCosto.Text & "')"
                        
            End If
            Cn.Execute csql
            
            '----- actualiza  docventas
            
            dias_1 = right(txtGls_FormaPago.Text, 7)
            If Val(left(dias_1, 2)) > 0 Then
                fecvencimiento_1 = DateAdd("D", Val(left(dias_1, 2)), dtp_Emision.Value)
                csqludt_1 = "update  docventas  set glsformaspago = '" & txtGls_FormaPago.Text & "' , fecpago = '" & Format(fecvencimiento_1, "YYYY-MM-DD") & "' " & _
                            " where idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and iddocventas = '" & txt_NumDoc.Text & "'  and idempresa = '" & glsEmpresa & "'  and idsucursal = '" & glsSucursal & "' "
                Cn.Execute (csqludt_1)
                
            Else
                csqludt_1 = "update  docventas  set glsformaspago = '" & txtGls_FormaPago.Text & "' , fecpago = '" & Format(dtp_Emision.Value, "YYYY-MM-DD") & "' " & _
                            " where idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and iddocventas = '" & txt_NumDoc.Text & "'  and idempresa = '" & glsEmpresa & "'  and idsucursal = '" & glsSucursal & "' "
                Cn.Execute (csqludt_1)
            End If
        End If
        
        glsobservacionventas = ""
            
        ActualizaLineaCredito StrMsgError, txtCod_Cliente.Text
        If StrMsgError <> "" Then GoTo Err
        
        CSqlC = "Update DocVentas " & _
                "Set IndAtribucionNC = " & IndAtribucionNC & " " & _
                "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & strTipoDoc & "' " & _
                "And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'"
        
        Cn.Execute CSqlC
        
'        FacturacionEntreEmpresas StrMsgError, 0, txt_serie.Text, txt_numdoc.Text
'        If StrMsgError <> "" Then GoTo Err
'
'        FacturacionEntreEmpresasAsientoContable StrMsgError, False, txt_serie.Text, txt_numdoc.Text
'        If StrMsgError <> "" Then GoTo Err
    
        Cn.CommitTrans
        
        ListaTempLiquidaciones
                
        strMsg = "Modificó"
    End If
    
    fraGeneral.Enabled = False
    Activa_Desc_Grid True
    
    habilitaBotones 2, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    If strTipoDoc = "25" Then
        AsientoContableVentas StrMsgError, ""
        If StrMsgError <> "" Then GoTo Err
    End If
    
    listaDocVentas StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    Exit Sub
    
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    If indTrans Then Cn.RollbackTrans
    Exit Sub
    Resume
End Sub

Private Sub FacturacionEntreEmpresasElimina(StrMsgError As String, PIdSerie As String, PIdDocVentas As String)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
Dim RsC2                            As New ADODB.Recordset

    If leeParametro("FACTURACION_ENTRE_EMPRESAS") <> "S" Then Exit Sub
        
    CSqlC = "Select A.IdEmpresaCli,A.Annio_Mov,A.IdMesMov,A.IdNumMov,B.IdCorrelaDetrac1,B.IdCorrelaDetrac2,B.IdCorrela,B.IdProveedor,B.TipoDcto,B.IdSerieDcto," & _
            "B.NumDcto " & _
            "From DocVentasRegisDocFE A " & _
            "Inner Join RegisDoc B " & _
                "On A.IdEmpresaCli = B.IdEmpresa And A.Annio_Mov = B.Annio_Mov And A.IdMesMov = B.IdMesMov And A.IdNumMov = B.IdNumMov " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' And A.IdSerie = '" & PIdSerie & "' " & _
            "And A.IdDocVentas = '" & PIdDocVentas & "'"
    AbrirRecordset StrMsgError, Cn, RsC, CSqlC
    If Not RsC.EOF Then
        
        CSqlC = "Select A.IdCta_Dcto " & _
                "From Pag_Dcto A " & _
                "Inner Join Pag_Mvto B " & _
                    "On A.IdEmpresa = B.IdEmpresa And A.IdCta_Dcto = B.IdCta_Dcto " & _
                "Where A.IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And A.IdCta_Dcto = '" & Trim("" & RsC.Fields("IdCorrelaDetrac2")) & "'"
        AbrirRecordset StrMsgError, Cn, RsC2, CSqlC
        If Not RsC2.EOF Then
            
            StrMsgError = "La Detracción se encuentra Pagada. Verifique.": GoTo Err
            
        End If
        RsC2.Close: Set RsC2 = Nothing
        
        CSqlC = "Select A.IdCta_Dcto " & _
                "From Pag_Dcto A " & _
                "Inner Join Pag_Mvto B " & _
                    "On A.IdEmpresa = B.IdEmpresa And A.IdCta_Dcto = B.IdCta_Dcto " & _
                "Where A.IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And A.IdCta_Dcto = '" & Trim("" & RsC.Fields("IdCorrela")) & "' And B.IdCta_Comp Not In('" & Trim("" & RsC.Fields("IdCorrelaDetrac1")) & "')"
        AbrirRecordset StrMsgError, Cn, RsC2, CSqlC
        If Not RsC2.EOF Then
            
            StrMsgError = "El Documento se encuentra Pagado. Verifique.": GoTo Err
            
        End If
        RsC2.Close: Set RsC2 = Nothing
        
        FacturacionEntreEmpresasAsientoContable StrMsgError, True, txt_Serie.Text, txt_NumDoc.Text
        If StrMsgError <> "" Then GoTo Err
    
        CSqlC = "Delete A " & _
                "From Pag_Dcto A " & _
                "Where A.IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And A.IdCta_Dcto = '" & Trim("" & RsC.Fields("IdCorrelaDetrac2")) & "'"
        
        Cn.Execute CSqlC
        
        CSqlC = "Delete B,A " & _
                "From Pag_Dcto A " & _
                "Inner Join Pag_Mvto B " & _
                    "On A.IdEmpresa = B.IdEmpresa And A.IdCta_Dcto = B.IdCta_Comp " & _
                "Where A.IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And A.IdCta_Dcto = '" & Trim("" & RsC.Fields("IdCorrelaDetrac1")) & "'"
        
        Cn.Execute CSqlC
        
        CSqlC = "Delete A " & _
                "From Pag_Dcto A " & _
                "Where A.IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And A.IdCta_Dcto = '" & Trim("" & RsC.Fields("IdCorrela")) & "'"
        
        Cn.Execute CSqlC
        
        CSqlC = "Delete From Doc_Fac " & _
                "Where IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And IdProveedor = '" & Trim("" & RsC.Fields("IdProveedor")) & "' " & _
                "And TipoDcto = '" & Trim("" & RsC.Fields("TipoDcto")) & "' And IdSerieDcto =  '" & Trim("" & RsC.Fields("IdSerieDcto")) & "' " & _
                "And NumDcto = '" & Trim("" & RsC.Fields("NumDcto")) & "'"
    
        Cn.Execute CSqlC
                
        CSqlC = "Delete From RegisMov " & _
                "Where IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And Annio_Mov = '" & Trim("" & RsC.Fields("Annio_Mov")) & "' " & _
                "And IdMesMov = '" & Trim("" & RsC.Fields("IdMesMov")) & "' And IdNumMov = '" & Trim("" & RsC.Fields("IdNumMov")) & "'"

        Cn.Execute CSqlC
        
        CSqlC = "Delete From RegisOfi " & _
                "Where IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And Annio_Mov = '" & Trim("" & RsC.Fields("Annio_Mov")) & "' " & _
                "And IdMesMov = '" & Trim("" & RsC.Fields("IdMesMov")) & "' And IdNumMov = '" & Trim("" & RsC.Fields("IdNumMov")) & "'"
    
        Cn.Execute CSqlC
        
        CSqlC = "Delete From RegisDoc " & _
                "Where IdEmpresa = '" & Trim("" & RsC.Fields("IdEmpresaCli")) & "' And Annio_Mov = '" & Trim("" & RsC.Fields("Annio_Mov")) & "' " & _
                "And IdMesMov = '" & Trim("" & RsC.Fields("IdMesMov")) & "' And IdNumMov = '" & Trim("" & RsC.Fields("IdNumMov")) & "'"
    
        Cn.Execute CSqlC
        
        CSqlC = "Delete A " & _
                "From DocVentasRegisDocFE A " & _
                "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' And A.IdSerie = '" & PIdSerie & "' " & _
                "And A.IdDocVentas = '" & PIdDocVentas & "'"
            
        Cn.Execute CSqlC
        
    End If
    
    RsC.Close: Set RsC = Nothing
    
    Exit Sub
Err:
    If RsC2.State = 1 Then RsC2.Close: Set RsC2 = Nothing
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub FacturacionEntreEmpresas(StrMsgError As String, PIndNuevo As Integer, PIdSerie As String, PIdDocVentas As String)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
Dim CIdEmpresaCli                   As String
Dim CAnnio_Mov                      As String
Dim CIdMesMov                       As String
Dim CIdNumMov                       As String
Dim CIdGI                           As String
Dim CIdSucursalCli                  As String
Dim CIdTipoIGV                      As String
Dim NItem                           As Integer
Dim RsC2                            As New ADODB.Recordset
Dim CIdCta_Dcto_Doc                 As String
Dim CIdCta_Dcto_Det1                As String
Dim CIdCta_Dcto_Det2                As String
Dim NTotalAnt                       As Double
Dim IndPagoDoc                      As Boolean
Dim IndPagoDetra                    As Boolean
Dim CNro_Comp                       As String
Dim CIndDH                          As String
Dim CFechaPag                       As String
Dim CFechaVenPag                    As String
Dim NTotalDetra                     As Double
Dim NImputaSo                       As Double
Dim NImputaDo                       As Double
Dim CIdCtaContable                  As String
Dim CIdProveedor                    As String
Dim CGlsProveedor                   As String
Dim CRucProveedor                   As String
Dim CDirProveedor                   As String
Dim CIndRedondeaDet                 As String
Dim CIdSerieCompras                 As String
Dim CIdNumeroCompras                As String
Dim CIdProveedorAnt                 As String
Dim CTipoDctoAnt                    As String
Dim CIdSerieAnt                     As String
Dim CNumDctoAnt                     As String
Dim NLongitud                       As Integer

    If leeParametro("FACTURACION_ENTRE_EMPRESAS") <> "S" Then Exit Sub
    
    CIdEmpresaCli = ""
    NItem = 0
    
    CSqlC = "Select B.IdEmpresa,D.IdPersona,D.GlsPersona,D.Ruc,D.Direccion " & _
            "From DocVentas A " & _
            "Inner Join Empresas B " & _
                "On A.RucCliente = B.Ruc " & _
            "Inner Join Empresas C " & _
                "On A.IdEmpresa = C.IdEmpresa " & _
            "Inner Join Personas D " & _
                "On C.IdPersona = D.IdPersona " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdDocumento = '" & strTipoDoc & "' " & _
            "And A.IdSerie = '" & PIdSerie & "' And A.IdDocVentas = '" & PIdDocVentas & "'"
    AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
    If Not RsC.EOF Then
        
        CIdEmpresaCli = Trim("" & RsC.Fields("IdEmpresa"))
        CIdProveedor = Trim("" & RsC.Fields("IdPersona"))
        CGlsProveedor = Trim("" & RsC.Fields("GlsPersona"))
        CRucProveedor = Trim("" & RsC.Fields("Ruc"))
        CDirProveedor = Trim("" & RsC.Fields("Direccion"))
        
        CIndRedondeaDet = traerCampo("Parametros", "ValParametro", "GlsParametro", "REDONDEA_DETRACCION_COMPRAS", False, "IdEmpresa = '" & CIdEmpresaCli & "'")
        
    End If
    RsC.Close: Set RsC = Nothing
    
    CIdCta_Dcto_Doc = ""
    CIdCta_Dcto_Det1 = ""
    CIdCta_Dcto_Det2 = ""
    
    'CSqlCuent = "If(A.IdMoneda = 'PEN'," & _
                    "If(IfNull(B.IdPersona,'') <> ''," & _
                        "If(B.IndAsociada = '1'," & _
                            "DC.IdCtaVtaTerSoles" & _
                        "," & _
                            "If(B.IndSubSidiaria = '1'," & _
                                "DC.IdCtaVtaTerSubSiS" & _
                            "," & _
                                "DC.IdCtaVtaTerMatrizS" & _
                            ")" & _
                        ")" & _
                    "," & _
                        "If(IfNull(Z.IdPersona,'') <> ''," & _
                            "If(Z.IndPersonal = '1'," & _
                                "DC.IdCtaVtaPerS" & _
                            "," & _
                                "DC.IdCtaVtaSocS" & _
                            ")" & _
                        "," & _
                            "DC.IdCtaVtaSoles" & _
                        ")" & _
                    ")" & _
                "," & _
                    "If(IfNull(B.IdPersona,'') <> '',"
    'CSqlCuent = CSqlCuent & _
                        "If(B.IndAsociada = '1'," & _
                            "DC.IdCtaVtaTerDolares" & _
                        "," & _
                            "If(B.IndSubSidiaria = '1'," & _
                                "DC.IdCtaVtaTerSubSiD" & _
                            "," & _
                                "DC.IdCtaVtaTerMatrizD" & _
                            ")" & _
                        ")" & _
                    "," & _
                        "If(IfNull(Z.IdPersona,'') <> ''," & _
                            "If(Z.IndPersonal = '1'," & _
                                "DC.IdCtaVtaPerD" & _
                            "," & _
                                "DC.IdCtaVtaSocD" & _
                            ")" & _
                        "," & _
                            "DC.IdCtaVtaDolares" & _
                        ")" & _
                    ")" & _
                ") IdCuentaContable"
    
    CSqlC = "Select A.TipoCambio,A.FecEmision,A.FecPago,A.IdFormaPago,A.ObsDocVentas,A.IdMoneda,Year(A.FecEmision) Annio,A.GlsCliente," & _
            "Month(A.FecEmision) Mes,A.IdPerCliente,A.RucCliente,A.DirCliente,A.TotalIgvVenta * If(A.IdDocumento = '07',-1,1) TotalIgvVenta," & _
            "A.TotalBaseImponible * If(A.IdDocumento = '07',-1,1) TotalBaseImponible,A.TotalPrecioVenta * If(A.IdDocumento = '07',-1,1) TotalPrecioVenta," & _
            "A.TotalExonerado * If(A.IdDocumento = '07',-1,1) TotalExonerado,A.TotalDescuento * If(A.IdDocumento = '07',-1,1) TotalDescuento,E.CtaContable2," & _
            "C.GlsProducto GlsNombreCuenta,If(A.IdDocumento = '07','H','D') IndDH,Sum(C.TotalVVNeto) TotalVVNeto,If(C.Afecto = '1','*','') Afecto," & _
            "If(A.IdDocumento In('01','03'),If(IfNull(E.IdConceptoDetraccion,'') = '','','*'),'') IndDetraccion," & _
            "If(A.IdDocumento In('01','03'),E.IdConceptoDetraccion,'') IdConceptoDetraccion," & _
            "G.Porcentaje * If(A.IdDocumento In('01','03'),1,0) Porcentaje,IfNull(H.Annio_Mov,'') Annio_Mov,IfNull(H.IdMesMov,'') IdMesMov," & _
            "IfNull(H.IdNumMov,'') IdNumMov," & _
            "Round(If(IfNull(E.IdConceptoDetraccion,'') = '',0,A.TotalPrecioVenta * (G.Porcentaje / 100))," & IIf(CIndRedondeaDet = "S", "0", "2") & ") * If(A.IdDocumento In('01','03'),1,0) MtoDetraccion "
    CSqlC = CSqlC & _
            "From DocVentas A " & _
            "Left Join DocVentasRegisDocFE H " & _
                "On A.IdEmpresa = H.IdEmpresa And A.IdDocumento = H.IdDocumento And A.IdSerie = H.IdSerie And A.IdDocVentas = H.IdDocVentas " & _
            "Inner Join DocVentasDet C " & _
                "On A.IdEmpresa = C.IdEmpresa And A.IdSucursal = C.IdSucursal And A.IdDocumento = C.IdDocumento And A.IdSerie = C.IdSerie " & _
                "And A.IdDocVentas = C.IdDocVentas " & _
            "Inner Join ProductosClientes D " & _
                "On C.IdEmpresa = D.IdEmpresa And A.IdPerCliente = D.IdCliente And C.IdProducto = D.IdProducto " & _
            "Inner Join Productos E " & _
                "On '" & CIdEmpresaCli & "' = E.IdEmpresa And D.Codigo = E.IdProducto " & _
            "Inner Join " & leeParametro("DNSCONTABILIDAD") & ".PlanCuentas F " & _
                "On E.IdEmpresa = F.IdEmpresa And '2011' = F.IdAnno And E.CtaContable2 = F.IdCtaContable " & _
            "Left Join Tb_Concep_Detrac G " & _
                "On E.IdConceptoDetraccion = G.CodConcepto " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdDocumento = '" & strTipoDoc & "' " & _
            "And A.IdSerie = '" & PIdSerie & "' And A.IdDocVentas = '" & PIdDocVentas & "' " & _
            "Group By E.IdEmpresa,E.CtaContable2,C.Afecto"
            
    AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
    Do While Not RsC.EOF
        
        NItem = NItem + 1
        
        If NItem = 1 Then
            
            NLongitud = Val("" & traerCampo("Documentos", "Longitud", "IdDocumento", strTipoDoc, False))
            If NLongitud < 10 Then NLongitud = 10
            
            CIdSerieCompras = Format(PIdSerie, "0000")
            CIdNumeroCompras = right(Format(PIdDocVentas, "00000000000000000000"), NLongitud)
    
            CFechaPag = "" & Format("" & RsC.Fields("FecEmision"), "yyyy-mm-dd")
            CFechaVenPag = "" & Format("" & RsC.Fields("FecPago"), "yyyy-mm-dd")
            
            If Len(Trim("" & traerCampo("EmpresasRelacionadas", "IdPersona", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'"))) > 0 Then
                If Trim("" & traerCampo("EmpresasRelacionadas", "IndAsociada", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'")) = "1" Then
                    CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompTerSoles", "IdCtaCompTerDolares"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                ElseIf Trim("" & traerCampo("EmpresasRelacionadas", "IndSubSidiaria", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'")) = "1" Then
                    CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompTerSubSiS", "IdCtaCompTerSubSiD"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                ElseIf Trim("" & traerCampo("EmpresasRelacionadas", "IndMatriz", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'")) = "1" Then
                    CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompTerMatrizS", "IdCtaCompTerMatrizD"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                End If
            ElseIf Len(Trim("" & traerCampo("Personal", "IdPersona", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'"))) > 0 Then
                If Trim("" & traerCampo("Personal", "IndPersonal", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'")) = "1" Then
                    CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompPerS", "IdCtaCompPerD"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                ElseIf Trim("" & traerCampo("Personal", "IndSocio", "IdPersona", CIdProveedor, False, "IdEmpresa = '" & CIdEmpresaCli & "'")) = "1" Then
                    CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompSocS", "IdCtaCompSocD"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                End If
            Else
                CIdCtaContable = traerCampo("DocumentosCuentas", IIf(Trim("" & RsC.Fields("IdMoneda")) = "PEN", "IdCtaCompSoles", "IdCtaCompDolares"), "IdDocumento", strTipoDoc, False, "IdEmpresa = '" & CIdEmpresaCli & "'")
            End If
            
            CIdGI = traerCampo("GastosIngresos", "IdGastosIngresos", "IndTipo", "G", False, "IdEmpresa = '" & CIdEmpresaCli & "' And IdCtaContable = '" & CIdCtaContable & "'")
            CIdSucursalCli = traerCampo("Sucursales", "IdSucursal", "IdEmpresa", CIdEmpresaCli, False, "IndPrincipal = 1")
            CIdTipoIGV = leeParametro("TIPO_IGV")
            
            If PIndNuevo = 1 Then
                
                CAnnio_Mov = Trim("" & RsC.Fields("Annio"))
                CIdMesMov = Format(Trim("" & RsC.Fields("Mes")), "00")
                
                CIdNumMov = Format(Val("" & traerCampo("RegisDoc", "IdNumMov", "Annio_Mov", CAnnio_Mov, False, "IdEmpresa = '" & CIdEmpresaCli & "' And IdMesMov = '" & CIdMesMov & "' Order By IdNumMov Desc")) + 1, "00000000")
                
                CSqlC = "Insert Into RegisDoc(IdCodDistCosto,IndDistribucion,ValTipoCambio,FechaMov,Fec_vcto,FechaRecepcion,IdSerieDcto,NumDcto,TipoDcto," & _
                        "IdForma_Pago,IdCentro,Observacion,ValPorcIGV,ValPorc_NotaCredito,Indrevisado,MtoPercepcion,IndPercepcion,IdMoneda,IndRetencion," & _
                        "IdSerieGeneral,MontoFondoG,IdMesMov,IdNumMov,GlsProveedor,IdProveedor,RucProveedor,DireccionProveedor,IdGastosIngresos,IdCtaContable," & _
                        "Annio_Mov,IdEmpresa,IdSucursal,IndRetener,IndDetraccion,IdDetraccion,ValPorc_Detraccion,IdUsuarioReg,FechaReg,CodIGV,MtoRetencion," & _
                        "MtoIGV,MtoOtrosImp,MtoImponible,MtoTotal,NumOrdenCompra,IdCorrelaDetrac1,IdCorrelaDetrac2,MtoIES,MtoExonerado,MtoRedSuma,MtoRedResta," & _
                        "MtoDcto,FechaRegistro,HoraRegistro,MtoDetraccion,IndDetHC,GlsPc,GlsPcUsuario,RentaND)Values(" & _
                        "'','0'," & Val(Format("" & RsC.Fields("TipoCambio"), "0.000")) & ",'" & Format("" & RsC.Fields("FecEmision"), "yyyy-mm-dd") & "'," & _
                        "'" & Format("" & RsC.Fields("FecPago"), "yyyy-mm-dd") & "','" & Format("" & RsC.Fields("FecEmision"), "yyyy-mm-dd") & "'," & _
                        "'" & CIdSerieCompras & "','" & CIdNumeroCompras & "','" & strTipoDoc & "','" & Trim("" & RsC.Fields("IdFormaPago")) & "','" & TxtIdCentroCostoCliente.Text & "'," & _
                        "'" & Trim("" & RsC.Fields("ObsDocVentas")) & "'," & (glsIGV * 100) & ",0,1,0,0,'" & Trim("" & RsC.Fields("IdMoneda")) & "','','',0," & _
                        "'" & CIdMesMov & "','" & CIdNumMov & "','" & CGlsProveedor & "','" & CIdProveedor & "','" & CRucProveedor & "','" & CDirProveedor & "'," & _
                        "'" & CIdGI & "','" & CIdCtaContable & "','" & CAnnio_Mov & "','" & CIdEmpresaCli & "','" & CIdSucursalCli & "',''," & _
                        "'" & Trim("" & RsC.Fields("IndDetraccion")) & "','" & Trim("" & RsC.Fields("IdConceptoDetraccion")) & "'," & _
                        "" & Val("" & RsC.Fields("Porcentaje")) & ",'" & glsUser & "',SysDate(),'" & CIdTipoIGV & "',0," & Val("" & RsC.Fields("TotalIgvVenta")) & "," & _
                        "0," & Val("" & RsC.Fields("TotalBaseImponible")) & "," & Val("" & RsC.Fields("TotalPrecioVenta")) & ",0,'','',0," & _
                        "" & Val("" & RsC.Fields("TotalExonerado")) & ",0,0," & Val("" & RsC.Fields("TotalDescuento")) & ",Cast(SysDate() As Date)," & _
                        "Cast(SysDate() As Time)," & Val("" & RsC.Fields("MtoDetraccion")) & ",0,'" & ComputerName() & "','" & fpUsuarioActual() & "',0)"
                
                Cn.Execute CSqlC
                
                CSqlC = "Insert Into DocVentasRegisDocFE(IdEmpresa,IdDocumento,IdSerie,IdDocVentas,IdEmpresaCli,Annio_Mov,IdMesMov," & _
                        "IdNumMov,IdCentroCosto)Values" & _
                        "('" & glsEmpresa & "','" & strTipoDoc & "','" & PIdSerie & "','" & PIdDocVentas & "','" & CIdEmpresaCli & "'," & _
                        "'" & CAnnio_Mov & "','" & CIdMesMov & "','" & CIdNumMov & "','" & TxtIdCentroCostoCliente.Text & "')"
                
                Cn.Execute CSqlC
                
            Else
                
                CAnnio_Mov = Trim("" & RsC.Fields("Annio_Mov"))
                CIdMesMov = Trim("" & RsC.Fields("IdMesMov"))
                CIdNumMov = Trim("" & RsC.Fields("IdNumMov"))
                
                CSqlC = "Select IdCorrela,IdCorrelaDetrac1,IdCorrelaDetrac2,MtoTotal,IdProveedor,TipoDcto,IdSerieDcto,NumDcto " & _
                        "From RegisDoc " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_Mov = '" & CAnnio_Mov & "' And IdMesMov = '" & CIdMesMov & "' " & _
                        "And IdNumMov = '" & CIdNumMov & "'"
                AbrirRecordset StrMsgError, Cn, RsC2, CSqlC: If StrMsgError <> "" Then GoTo Err
                If Not RsC2.EOF Then
                
                    CIdCta_Dcto_Doc = "" & RsC2.Fields("IdCorrela")
                    CIdCta_Dcto_Det1 = "" & RsC2.Fields("IdCorrelaDetrac1")
                    CIdCta_Dcto_Det2 = "" & RsC2.Fields("IdCorrelaDetrac2")
                    NTotalAnt = Val("" & RsC2.Fields("MtoTotal"))
                    CIdProveedorAnt = "" & RsC2.Fields("IdProveedor")
                    CTipoDctoAnt = "" & RsC2.Fields("TipoDcto")
                    CIdSerieAnt = "" & RsC2.Fields("IdSerieDcto")
                    CNumDctoAnt = "" & RsC2.Fields("NumDcto")
                    
                End If
                
                RsC2.Close: Set RsC2 = Nothing
                
                CSqlC = "Select A.IdCta_Dcto " & _
                        "From Pag_Dcto A " & _
                        "Inner Join Pag_Mvto B " & _
                            "On A.IdEmpresa = B.IdEmpresa And A.IdCta_Dcto = B.IdCta_Dcto " & _
                        "Inner Join Pag_Dcto C " & _
                            "On B.IdEmpresa = C.IdEmpresa And B.IdCta_Comp = C.IdCta_Dcto " & _
                        "Where A.IdEmpresa = '" & CIdEmpresaCli & "' And A.IdCta_Dcto In('" & CIdCta_Dcto_Doc & "','" & CIdCta_Dcto_Det2 & "') " & _
                        "And B.IdCta_Comp Not In('" & CIdCta_Dcto_Det1 & "')"
                AbrirRecordset StrMsgError, Cn, RsC2, CSqlC: If StrMsgError <> "" Then GoTo Err
                If Not RsC2.EOF Then
                    
                    Do While Not RsC2.EOF
                    
                        If CIdCta_Dcto_Doc = "" & RsC2.Fields("IdCta_Dcto") Then
                            
                            IndPagoDoc = True
                            
                        ElseIf CIdCta_Dcto_Det2 = "" & RsC2.Fields("IdCta_Dcto") Then
                            
                            IndPagoDetra = True
                        
                        End If
                        
                        RsC2.MoveNext
                        
                    Loop
                    
                End If
                
                RsC2.Close: Set RsC2 = Nothing
                
                If IndPagoDoc Or IndPagoDetra Then
                    
                    If NTotalAnt <> Val(Format(Val("" & RsC.Fields("TotalPrecioVenta")), "0.00")) Then
                        
                        StrMsgError = "El Documento de Compras tiene un pago, no puede modificar el Monto.": GoTo Err
                        
                    End If
                    
                End If
        
                Graba_Log StrMsgError, True, CIdEmpresaCli, CIdSucursalCli, CAnnio_Mov, CIdMesMov, CIdNumMov
                If StrMsgError <> "" Then GoTo Err
                
                CSqlC = "Update DocVentasRegisDocFE Set IdCentroCosto = '" & TxtIdCentroCostoCliente.Text & "' Where IdEmpresa = '" & glsEmpresa & "' And IdDocumento = '" & strTipoDoc & "' And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'"
                
                Cn.Execute CSqlC
                
                CSqlC = "Update RegisDoc " & _
                        "Set ValTipoCambio = " & Val(Format("" & RsC.Fields("TipoCambio"), "0.000")) & "," & _
                        "FechaMov = '" & Format("" & RsC.Fields("FecEmision"), "yyyy-mm-dd") & "'," & _
                        "Fec_Vcto = '" & Format("" & RsC.Fields("FecPago"), "yyyy-mm-dd") & "'," & _
                        "FechaRecepcion = '" & Format("" & RsC.Fields("FecEmision"), "yyyy-mm-dd") & "',IdSerieDcto = '" & CIdSerieCompras & "'," & _
                        "NumDcto = '" & CIdNumeroCompras & "',TipoDcto = '" & strTipoDoc & "',IdForma_Pago = '" & Trim("" & RsC.Fields("IdFormaPago")) & "'," & _
                        "IdCentro = '" & TxtIdCentroCostoCliente.Text & "',Observacion = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "',ValPorcIGV = " & (glsIGV * 100) & "," & _
                        "IdMoneda = '" & Trim("" & RsC.Fields("IdMoneda")) & "',IdMesMov = '" & CIdMesMov & "',IdNumMov = '" & CIdNumMov & "'," & _
                        "GlsProveedor = '" & CGlsProveedor & "',IdProveedor = '" & CIdProveedor & "',RucProveedor = '" & CRucProveedor & "'," & _
                        "DireccionProveedor = '" & CDirProveedor & "',IdGastosIngresos = '" & CIdGI & "',IdCtaContable = '" & CIdCtaContable & "'," & _
                        "Annio_Mov = '" & CAnnio_Mov & "',IdEmpresa = '" & CIdEmpresaCli & "',IdSucursal = '" & CIdSucursalCli & "'," & _
                        "IndDetraccion = '" & Trim("" & RsC.Fields("IndDetraccion")) & "'," & _
                        "IdDetraccion = '" & Trim("" & RsC.Fields("IdConceptoDetraccion")) & "'," & _
                        "ValPorc_Detraccion = " & Val("" & RsC.Fields("Porcentaje")) & ",CodIGV = '" & CIdTipoIGV & "'," & _
                        "MtoIGV = " & Val("" & RsC.Fields("TotalIgvVenta")) & ",MtoImponible = " & Val("" & RsC.Fields("TotalBaseImponible")) & "," & _
                        "MtoTotal = " & Val("" & RsC.Fields("TotalPrecioVenta")) & ",MtoExonerado = " & Val("" & RsC.Fields("TotalExonerado")) & "," & _
                        "MtoDcto = " & Val("" & RsC.Fields("TotalDescuento")) & ",MtoDetraccion = " & Val("" & RsC.Fields("MtoDetraccion")) & " " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_Mov = '" & CAnnio_Mov & "' And IdMesMov = '" & CIdMesMov & "' " & _
                        "And IdNumMov = '" & CIdNumMov & "'"
                
                Cn.Execute CSqlC
                
                CSqlC = "Delete From RegisOfi " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_Mov = '" & CAnnio_Mov & "' " & _
                        "And IdMesMov = '" & CIdMesMov & "' And IdNumMov = '" & CIdNumMov & "'"
    
                Cn.Execute CSqlC
                
                CSqlC = "Delete From RegisMov " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_Mov = '" & CAnnio_Mov & "' " & _
                        "And IdMesMov = '" & CIdMesMov & "' And IdNumMov = '" & CIdNumMov & "'"
    
                Cn.Execute CSqlC
                
                CSqlC = "Delete From Doc_Fac " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdProveedor = '" & CIdProveedorAnt & "' And TipoDcto = '" & CTipoDctoAnt & "' " & _
                        "And IdSerieDcto =  '" & CIdSerieAnt & "' And NumDcto = '" & CNumDctoAnt & "'"
             
                Cn.Execute CSqlC
                
            End If
            
            CSqlC = "Insert Into RegisOfi(IdMesMov,IdNumMov,IdProveedor,GlsProveedor,DireccionProveedor,RucProveedor,TipoDcto,IdSerieDcto,NumDcto,FechaMov," & _
                    "IdMoneda,ValTipoCambio,Observacion,MtoImponible,MtoExonerado,MtoIGV,MtoOtrosImp,MtoTotal,IdForma_pago,Fec_Vcto,MtoRetencion,IndTransferido," & _
                    "NumPoliza,CodIGV,MtoRedSuma,MtoRedResta,MtoDcto,ValPorcIGV,IndDetraccion,IdDetraccion,ValPorc_Detraccion,MtoIES,IdEmpresa,IdSucursal," & _
                    "Annio_Mov,IdSerieGeneral)" & _
                    "Select IdMesMov,IdNumMov,IdProveedor,GlsProveedor,DireccionProveedor,RucProveedor,TipoDcto,IdSerieDcto,NumDcto,FechaMov,'PEN',ValTipoCambio," & _
                    "Observacion,Round(MtoImponible * If(IdMoneda = 'PEN',1,ValTipoCambio),2),Round(MtoExonerado * If(IdMoneda = 'PEN',1,ValTipoCambio),2)," & _
                    "Round(MtoIGV * If(IdMoneda = 'PEN',1,ValTipoCambio),2),Round(MtoOtrosImp * If(IdMoneda = 'PEN',1,ValTipoCambio),2)," & _
                    "Round(MtoTotal * If(IdMoneda = 'PEN',1,ValTipoCambio),2),IdForma_pago,Fec_Vcto,Round(MtoRetencion * If(IdMoneda = 'PEN',1,ValTipoCambio),2)," & _
                    "IndTransferido,NumPoliza,CodIGV,Round(MtoRedSuma * If(IdMoneda = 'PEN',1,ValTipoCambio),2)," & _
                    "Round(MtoRedResta * If(IdMoneda = 'PEN',1,ValTipoCambio),2),Round(MtoDcto * If(IdMoneda = 'PEN',1,ValTipoCambio),2),ValPorcIGV,IndDetraccion," & _
                    "IdDetraccion,ValPorc_Detraccion,Round(MtoIES * If(IdMoneda = 'PEN',1,ValTipoCambio),2),IdEmpresa,IdSucursal,Annio_Mov,IdSerieGeneral " & _
                    "From RegisDoc " & _
                    "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_Mov = '" & CAnnio_Mov & "' " & _
                    "And IdMesMov = '" & CIdMesMov & "' And IdNumMov = '" & CIdNumMov & "'"
            
            Cn.Execute CSqlC
            
            If strTipoDoc = "07" Or strTipoDoc = "08" Then
                
                gDocReferencia.Dataset.First
                Do While Not gDocReferencia.Dataset.EOF
                
                    If Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value) = "01" Then
                        
                        NLongitud = Val("" & traerCampo("Documentos", "Longitud", "IdDocumento", Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value), False))
                        If NLongitud < 10 Then NLongitud = 10
                        
                        CSqlC = "Insert Into Doc_Fac(IdEmpresa,IdSucursal,IdProveedor,TipoDcto,IdSerieDcto,NumDcto,Tipo_Fac,IdSerie_Fac,Num_Fac)Values" & _
                                "('" & CIdEmpresaCli & "','" & CIdSucursalCli & "','" & CIdProveedor & "','" & strTipoDoc & "','" & CIdSerieCompras & "'," & _
                                "'" & CIdNumeroCompras & "','" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value) & "'," & _
                                "'" & Format(Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdSerie").Value), "0000") & "'," & _
                                "'" & right(Format(Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocVentas").Value), "00000000000000000000"), NLongitud) & "')"
                                
                        Cn.Execute CSqlC
                        
                        Exit Do
                        
                    End If
                    
                    gDocReferencia.Dataset.Next
                    
                Loop
                
            End If
            
        End If
        
        CSqlC = "Insert Into RegisMov(Item,IdGastosIngresos,IdCtaContable,NumReferencia,IdCentro,GlsConcepto,IndDebHab,IdDocVentasPres,IdSucursalPres," & _
                "ValImporte,IdSeriePres,IdDocumentoPres,IdMesMov,IdNumMov,Annio_Mov,IdEmpresa,IdSucursal,IndAfecto)Values" & _
                "(" & NItem & ",'','" & Trim("" & RsC.Fields("CtaContable2")) & "','','" & TxtIdCentroCostoCliente.Text & "'," & _
                "'" & Trim("" & RsC.Fields("GlsNombreCuenta")) & "','" & Trim("" & RsC.Fields("IndDH")) & "','',''," & Val("" & RsC.Fields("TotalVVNeto")) & "," & _
                "'','','" & CIdMesMov & "','" & CIdNumMov & "','" & CAnnio_Mov & "','" & CIdEmpresaCli & "','" & CIdSucursalCli & "'," & _
                "'" & Trim("" & RsC.Fields("Afecto")) & "')"
        
        Cn.Execute CSqlC
        
        RsC.MoveNext
        
    Loop
    
    If NItem > 0 Then
        
        RsC.MovePrevious
        
        'Grabando Cuenta por Pagar
        If Not IndPagoDetra And Not IndPagoDoc Then
        
            CNro_Comp = traerCampo("Documentos", "AbreDocumento", "IdDocumento", strTipoDoc, False) & CIdSerieCompras & "/" & CIdNumeroCompras
            CIndDH = IIf(strTipoDoc = "07" Or strTipoDoc = "97", "D", "H")
            
            If CIdCta_Dcto_Doc = "" Then
            
                CIdCta_Dcto_Doc = GeneraCorrelativoAnoMesAdd("Pag_Dcto", "IdCta_Dcto", False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                
                CSqlC = "Insert Into Pag_Dcto(IdEmpresa,IdSucursal,IdCta_Dcto,IndViaIngreso,Nro_Comp,Fec_Comp,Fec_Vcto,IdProveedor,IdProveedorOri,IdMoneda," & _
                        "IdMonedaOri,ValTipoCambio,ValTipoCambioOri,ValTotal,ValTotalOri,ValSaldo,IndDeb_Hab,GlsReferencia,IdCentro,NroRegis_Com,Periodo," & _
                        "GlsProveedor,IdGastosIngresos)" & _
                        "Values('" & CIdEmpresaCli & "','" & CIdSucursalCli & "','" & CIdCta_Dcto_Doc & "',1, '" & CNro_Comp & "','" & CFechaPag & "'," & _
                        "'" & CFechaVenPag & "','" & CIdProveedor & "','" & CIdProveedor & "','" & Trim("" & RsC.Fields("IdMoneda")) & "'," & _
                        "'" & Trim("" & RsC.Fields("IdMoneda")) & "'," & Val("" & RsC.Fields("TipoCambio")) & "," & Val("" & RsC.Fields("TipoCambio")) & "," & _
                        "" & Val("" & RsC.Fields("TotalPrecioVenta")) & "," & Val("" & RsC.Fields("TotalPrecioVenta")) & "," & Val("" & RsC.Fields("TotalPrecioVenta")) & "," & _
                        "'" & CIndDH & "','" & Trim("" & RsC.Fields("ObsDocVentas")) & "','','" & CIdNumMov & "','" & CAnnio_Mov & CIdMesMov & "'," & _
                        "'" & CGlsProveedor & "','" & CIdGI & "')"
            
            Else
            
                CSqlC = "Update Pag_Dcto " & _
                        "Set Nro_Comp = '" & CNro_Comp & "',Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "'," & _
                        "IdProveedor = '" & CIdProveedor & "',IdProveedorOri = '" & CIdProveedor & "'," & _
                        "IdMoneda = '" & Trim("" & RsC.Fields("IdMoneda")) & "',IdMonedaOri = '" & Trim("" & RsC.Fields("IdMoneda")) & "'," & _
                        "ValTipoCambio = " & Val("" & RsC.Fields("TipoCambio")) & ",ValTipocambioOri = " & Val("" & RsC.Fields("TipoCambio")) & "," & _
                        "ValTotal = " & Val("" & RsC.Fields("TotalPrecioVenta")) & ",ValTotalOri = " & Val("" & RsC.Fields("TotalPrecioVenta")) & "," & _
                        "ValSaldo = " & Val("" & RsC.Fields("TotalPrecioVenta")) & ",IndDeb_Hab = '" & CIndDH & "'," & _
                        "GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "',NroRegis_Com = '" & CIdNumMov & "'," & _
                        "Periodo = '" & CAnnio_Mov & CIdMesMov & "',GlsProveedor = '" & CGlsProveedor & "',IdGastosIngresos = '" & CIdGI & "' " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "'"
                        
            End If
            
            Cn.Execute CSqlC
            
            CSqlC = "Update RegisDoc " & _
                    "Set IdCorrela = '" & CIdCta_Dcto_Doc & "' " & _
                    "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_mov = '" & CAnnio_Mov & "' And IdMesMov = '" & CIdMesMov & "' " & _
                    "And IdNumMov = '" & CIdNumMov & "'"
            
            Cn.Execute CSqlC
        
        Else
            
            CSqlC = "Update Pag_Dcto " & _
                    "Set Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "',GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "' " & _
                    "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "'"
            
            Cn.Execute CSqlC
            
        End If
        'Termina Grabación CxP-------------------------------------------------------------------------------------------------------------------------------------
        
        'Grabando Detracción
        If Not IndPagoDetra And Not IndPagoDoc Then
        
            If CIdCta_Dcto_Det1 = "" Then
                
                If Val("" & RsC.Fields("Porcentaje")) > 0 Then
                    
                    CNro_Comp = "Dt1" & CIdSerieCompras & "/" & CIdNumeroCompras
                    NTotalDetra = Val(Format(Val("" & RsC.Fields("MtoDetraccion")), "0.00"))
            
                    CIdCta_Dcto_Det1 = GeneraCorrelativoAnoMesAdd("Pag_Dcto", "IdCta_Dcto", False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                    
                    CSqlC = "Insert Into Pag_Dcto(IdEmpresa,IdSucursal,IdCta_Dcto,IndViaIngreso,Nro_Comp,Fec_Comp,Fec_Vcto,IdProveedor,IdProveedorOri,IdMoneda," & _
                            "IdMonedaOri,ValTipoCambio,ValTipoCambioOri,ValTotal,ValTotalOri,ValSaldo,IndDeb_Hab,GlsReferencia,IdCentro,NroRegis_Com,Periodo," & _
                            "GlsProveedor,IdGastosIngresos)" & _
                            "Values('" & CIdEmpresaCli & "','" & CIdSucursalCli & "','" & CIdCta_Dcto_Det1 & "',1,'" & CNro_Comp & "','" & CFechaPag & "'," & _
                            "'" & CFechaVenPag & "','" & CIdProveedor & "','" & CIdProveedor & "'," & _
                            "'" & Trim("" & RsC.Fields("IdMoneda")) & "','" & Trim("" & RsC.Fields("IdMoneda")) & "'," & Val("" & RsC.Fields("TipoCambio")) & "," & _
                            "" & Val("" & RsC.Fields("TipoCambio")) & "," & NTotalDetra & "," & NTotalDetra & ",0,'D'," & _
                            "'" & Trim("" & RsC.Fields("ObsDocVentas")) & "','','" & CIdNumMov & "','" & CAnnio_Mov & CIdMesMov & "'," & _
                            "'" & CGlsProveedor & "','" & CIdGI & "')"
                    
                    Cn.Execute CSqlC
                    
                    If Trim("" & RsC.Fields("IdMoneda")) = "PEN" Then
                        
                        NImputaSo = NTotalDetra
                        NImputaDo = 0
                    
                    Else
                    
                        NImputaSo = 0
                        NImputaDo = NTotalDetra
                    
                    End If
                    
                    CSqlC = "Insert Into Pag_Mvto(IdEmpresa,IdSucursal,IdCta_Dcto,IdCta_Comp,IdProveedor,ValImputaSo,ValImputaDo,ValTipoCambio,Fec_Mvto," & _
                            "Fec_Repo)Values" & _
                            "('" & CIdEmpresaCli & "','" & CIdSucursalCli & "','" & CIdCta_Dcto_Doc & "','" & CIdCta_Dcto_Det1 & "'," & _
                            "'" & CIdProveedor & "'," & NImputaSo & "," & NImputaDo & "," & Val("" & RsC.Fields("TipoCambio")) & "," & _
                            "'" & CFechaPag & "','" & CFechaPag & "')"
                    
                    Cn.Execute CSqlC
                
                    CNro_Comp = "Dt2" & CIdSerieCompras & "/" & CIdNumeroCompras
                    
                    CIdCta_Dcto_Det2 = GeneraCorrelativoAnoMesAdd("Pag_Dcto", "IdCta_Dcto", False, "IdEmpresa = '" & CIdEmpresaCli & "'")
                    
                    CSqlC = "Insert Into Pag_Dcto(IdEmpresa,IdSucursal,IdCta_Dcto,IndViaIngreso,Nro_Comp,Fec_Comp,Fec_Vcto,IdProveedor,IdProveedorOri,IdMoneda," & _
                            "IdMonedaOri,ValTipoCambio,ValTipoCambioOri,ValTotal,ValTotalOri,ValSaldo,IndDeb_Hab,GlsReferencia,IdCentro,NroRegis_Com,Periodo," & _
                            "GlsProveedor,IdGastosIngresos)" & _
                            "Values('" & CIdEmpresaCli & "','" & CIdSucursalCli & "','" & CIdCta_Dcto_Det2 & "',1,'" & CNro_Comp & "','" & CFechaPag & "'," & _
                            "'" & CFechaVenPag & "','" & CIdProveedor & "','" & CIdProveedor & "'," & _
                            "'" & Trim("" & RsC.Fields("IdMoneda")) & "','" & Trim("" & RsC.Fields("IdMoneda")) & "'," & Val("" & RsC.Fields("TipoCambio")) & "," & _
                            "" & Val("" & RsC.Fields("TipoCambio")) & "," & NTotalDetra & "," & NTotalDetra & "," & NTotalDetra & ",'H'," & _
                            "'" & Trim("" & RsC.Fields("ObsDocVentas")) & "','','" & CIdNumMov & "','" & CAnnio_Mov & CIdMesMov & "'," & _
                            "'" & CGlsProveedor & "','" & CIdGI & "')"
                            
                    Cn.Execute CSqlC
                    
                    CSqlC = "Update Pag_Dcto " & _
                            "Set ValSaldo = ValSaldo - " & NTotalDetra & " " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "'"
                    
                    Cn.Execute CSqlC
                    
                End If
                
            Else
                
                If Val("" & RsC.Fields("Porcentaje")) > 0 Then
                    
                    CNro_Comp = "Dt1" & CIdSerieCompras & "/" & CIdNumeroCompras
                    NTotalDetra = Val(Format(Val("" & RsC.Fields("MtoDetraccion")), "0.00"))
                    
                    CSqlC = "Update Pag_Dcto " & _
                            "Set Nro_Comp = '" & CNro_Comp & "',Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "'," & _
                            "IdProveedor = '" & CIdProveedor & "',IdProveedorOri = '" & CIdProveedor & "'," & _
                            "IdMoneda = '" & Trim("" & RsC.Fields("IdMoneda")) & "',IdMonedaOri = '" & Trim("" & RsC.Fields("IdMoneda")) & "'," & _
                            "ValTipoCambio = " & Val("" & RsC.Fields("TipoCambio")) & ",ValTipocambioOri = " & Val("" & RsC.Fields("TipoCambio")) & "," & _
                            "ValTotal = " & NTotalDetra & ",ValTotalOri = " & NTotalDetra & ",ValSaldo = 0,IndDeb_Hab = 'D'," & _
                            "GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "',IdCentro = '',NroRegis_Com = '" & CIdNumMov & "'," & _
                            "Periodo = '" & CAnnio_Mov & CIdMesMov & "',GlsProveedor = '" & CGlsProveedor & "'," & _
                            "IdGastosIngresos = '" & CIdGI & "' " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Det1 & "'"
                    
                    Cn.Execute CSqlC
                    
                    If Trim("" & RsC.Fields("IdMoneda")) = "PEN" Then
                        
                        NImputaSo = NTotalDetra
                        NImputaDo = 0
                    
                    Else
                    
                        NImputaSo = 0
                        NImputaDo = NTotalDetra
                    
                    End If
                    
                    CSqlC = "Update Pag_Mvto " & _
                            "Set IdProveedor = '" & CIdProveedor & "',ValImputaSo = " & NImputaSo & ",ValImputaDo = " & NImputaDo & "," & _
                            "ValTipoCambio = " & Val("" & RsC.Fields("TipoCambio")) & ",Fec_Mvto = '" & CFechaPag & "',Fec_Repo = '" & CFechaPag & "' " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "' And IdCta_Comp = '" & CIdCta_Dcto_Det1 & "'"
                    
                    Cn.Execute CSqlC
                    
                    CNro_Comp = "Dt2" & CIdSerieCompras & "/" & CIdNumeroCompras
                    
                    CSqlC = "Update Pag_Dcto " & _
                            "Set Nro_Comp = '" & CNro_Comp & "',Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "'," & _
                            "IdProveedor = '" & CIdProveedor & "',IdProveedorOri = '" & CIdProveedor & "'," & _
                            "IdMoneda = '" & Trim("" & RsC.Fields("IdMoneda")) & "',IdMonedaOri = '" & Trim("" & RsC.Fields("IdMoneda")) & "'," & _
                            "ValTipoCambio = " & Val("" & RsC.Fields("TipoCambio")) & ",ValTipocambioOri = " & Val("" & RsC.Fields("TipoCambio")) & "," & _
                            "ValTotal = " & NTotalDetra & ",ValTotalOri = " & NTotalDetra & ",ValSaldo = " & NTotalDetra & ",IndDeb_Hab = 'H'," & _
                            "GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "',IdCentro = '',NroRegis_Com = '" & CIdNumMov & "'," & _
                            "Periodo = '" & CAnnio_Mov & CIdMesMov & "',GlsProveedor = '" & CGlsProveedor & "'," & _
                            "IdGastosIngresos = '" & CIdGI & "' " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Det2 & "'"
                    
                    Cn.Execute CSqlC
                    
                    CSqlC = "Update Pag_Dcto " & _
                            "Set ValSaldo = ValSaldo - " & NTotalDetra & " " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "'"
                    
                    Cn.Execute CSqlC
                    
                Else
                    
                    CSqlC = "Delete From Pag_Mvto " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Comp In('" & CIdCta_Dcto_Det1 & "')"
                    
                    Cn.Execute CSqlC
                    
                    CSqlC = "Delete From Pag_Dcto " & _
                            "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto In('" & CIdCta_Dcto_Det1 & "','" & CIdCta_Dcto_Det2 & "')"
                    
                    Cn.Execute CSqlC
                    
                    CIdCta_Dcto_Det1 = ""
                    CIdCta_Dcto_Det2 = ""
                    
                End If
                
            End If
            
            CSqlC = "Update RegisDoc " & _
                    "Set IdCorrelaDetrac1 = '" & CIdCta_Dcto_Det1 & "',IdCorrelaDetrac2 = '" & CIdCta_Dcto_Det2 & "' " & _
                    "Where IdEmpresa = '" & CIdEmpresaCli & "' And Annio_mov = '" & CAnnio_Mov & "' And IdMesMov = '" & CIdMesMov & "' " & _
                    "And IdNumMov = '" & CIdNumMov & "'"
            
            Cn.Execute CSqlC
        
        Else
            
            If Val("" & RsC.Fields("Porcentaje")) > 0 Then
            
                CSqlC = "Update Pag_Dcto " & _
                        "Set Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "',GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "'," & _
                        "IdCentro = '' " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Det1 & "'"
                
                Cn.Execute CSqlC
                
                CSqlC = "Update Pag_Mvto " & _
                        "Set Fec_Mvto = '" & CFechaPag & "',Fec_Repo = '" & CFechaPag & "' " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Doc & "' And IdCta_Comp = '" & CIdCta_Dcto_Det1 & "'"
                
                Cn.Execute CSqlC
                
                CSqlC = "Update Pag_Dcto " & _
                        "Set Fec_Comp = '" & CFechaPag & "',Fec_Vcto = '" & CFechaVenPag & "',GlsReferencia = '" & Trim("" & RsC.Fields("ObsDocVentas")) & "'," & _
                        "IdCentro = '' " & _
                        "Where IdEmpresa = '" & CIdEmpresaCli & "' And IdCta_Dcto = '" & CIdCta_Dcto_Det2 & "'"
                
                Cn.Execute CSqlC
            
            End If
            
        End If
        'Termina Grabación Detracciones-------------------------------------------------------------------------------------------------------------------------------------
    
    End If
    
    Exit Sub
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If RsC2.State = 1 Then RsC2.Close: Set RsC2 = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub FacturacionEntreEmpresasAsientoContable(StrMsgError As String, PIndElimina As Boolean, PIdSerie As String, PIdDocVentas As String)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset

    If leeParametro("FACTURACION_ENTRE_EMPRESAS") <> "S" Then Exit Sub
    
    If Trim("" & traerCampo("Parametros", "Valparametro", "Glsparametro", "CONTABILIDAD_ONLINE", True)) <> "1" Then Exit Sub
    
    CSqlC = "Select B.IdEmpresaCli,B.Annio_Mov,B.IdMesMov,B.IdNumMov " & _
            "From DocVentas A " & _
            "Inner Join DocVentasRegisDocFE B " & _
                "On A.IdEmpresa = B.IdEmpresa And A.IdDocumento = B.IdDocumento And A.IdSerie = B.IdSerie And A.IdDocVentas = B.IdDocVentas " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' And A.IdSerie = '" & PIdSerie & "' " & _
            "And A.IdDocVentas = '" & PIdDocVentas & "'"
    AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
    Do While Not RsC.EOF
        
        CSqlC = "Call Spu_AsientoContableCompras('" & Trim("" & RsC.Fields("IdEmpresaCli")) & "'," & _
                "'" & Trim("" & RsC.Fields("Annio_Mov")) & Trim("" & RsC.Fields("IdMesMov")) & "','" & Trim("" & RsC.Fields("IdNumMov")) & "','" & IIf(PIndElimina, "2", "1") & "'," & _
                "'" & glsUser & "','" & fpComputerName & "','" & fpUsuarioActual & "')"
                
        Cn.Execute CSqlC
        
        'CuadraAsiento StrMsgError, Trim("" & RsC.Fields("IdEmpresaCli")), Trim("" & RsC.Fields("Annio_Mov")) & Trim("" & RsC.Fields("IdMesMov")), right(Trim("" & RsC.Fields("IdNumMov")), 7)
        'If StrMsgError <> "" Then GoTo Err
        
        RsC.MoveNext
        
    Loop
    
    RsC.Close: Set RsC = Nothing
    
    Exit Sub
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub CuadraAsiento(StrMsgError As String, PIdEmpresaCli As String, PIdPeriodo As String, PIdComprobante As String)
On Error GoTo Err
Dim xOrigen                     As String
Dim strDnsContable              As String
Dim CIdCtaGanancia              As String
Dim CIdCtaPerdida               As String
Dim CGlsCtaGanancia             As String
Dim CGlsCtaPerdida              As String
Dim CSqlC                       As String
Dim CIdPeriodo                  As String
Dim CIdComprobante              As String
Dim ccosto                      As String

    CIdCtaGanancia = traerCampoConta("ParamConta", "ValParametro", "GlsParametro", "CUENTAGANANCIA_DC", False, "IdEmpresa = '" & PIdEmpresaCli & "'")
    CIdCtaPerdida = traerCampoConta("ParamConta", "ValParametro", "GlsParametro", "CUENTAPERDIDA_DC", False, "IdEmpresa = '" & PIdEmpresaCli & "'")
    
    CGlsCtaGanancia = traerCampoConta("PlanCuentas", "GlsNombreCuenta", "IdCtaContable", CIdCtaGanancia, False, "IdEmpresa = '" & PIdEmpresaCli & "' And IdAnno = '" & IIf(left(PIdPeriodo, 4) <= "2010", "2010", "2011") & "'")
    CGlsCtaPerdida = traerCampoConta("PlanCuentas", "GlsNombreCuenta", "IdCtaContable", CIdCtaPerdida, False, "IdEmpresa = '" & PIdEmpresaCli & "' And IdAnno = '" & IIf(left(PIdPeriodo, 4) <= "2010", "2010", "2011") & "'")
    
    xOrigen = traerCampo("ParametrosCompras", "ValParametro", "GlsParametro", "ORIGEN", False, "IdEmpresa = '" & PIdEmpresaCli & "'")
    ccosto = traerCampo("ParametrosCompras", "ValParametro", "GlsParametro", "CCOSTO", False, "IdEmpresa = '" & PIdEmpresaCli & "'")
    
    CIdPeriodo = PIdPeriodo 'txt_Ano.Text & right(cbx_Mes.Text, 2)
    CIdComprobante = xOrigen & PIdComprobante 'xOrigen & right(TxtNumMov.Text, 7)
    
    CSqlC = "Insert Into AsientoContableDetalle(IdPeriodo,IdComprobante,ValItem,IdOrigen,GlsDetalle,IdCuentaContable,NumReferencia,TotalImporteS,TotalImporteD," & _
            "IdTipoDH,ValTC,IdMoneda,Destino,SerieDoc,Docum,IdEmpresa,FecCompro)" & _
            "Select A.IdPeriodo,A.IdComprobante," & _
            "(Select ValItem + 1 From AsientoContableDetalle " & _
                "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdPeriodo = '" & CIdPeriodo & "' And IdComprobante = '" & CIdComprobante & "'" & _
                "Order By ValItem Desc Limit 1 " & _
            ") Item,A.IdOrigen,If(A.Dif > 0,'" & CGlsCtaGanancia & "','" & CGlsCtaPerdida & "'),If(A.Dif > 0,'" & CIdCtaGanancia & "','" & CIdCtaPerdida & "')," & _
            "'',A.Dif * If(A.Dif > 0,1,-1),0,If(A.Dif > 0,'H','D'),A.ValTC,A.IdMoneda,'','','',A.IdEmpresa,A.FecCompro " & _
            "From(" & _
                "Select A.IdPeriodo,A.IdComprobante,A.IdOrigen,A.ValTC,A.IdMoneda,A.IdEmpresa,A.FecCompro," & _
                "(Sum(If(A.IdTipoDH = 'D',A.TotalImporteS,0)) - Sum(If(A.IdTipoDH = 'H',A.TotalImporteS,0))) Dif " & _
                "From AsientoContableDetalle A " & _
                "Where A.IdEmpresa = '" & PIdEmpresaCli & "' And A.IdComprobante = '" & CIdComprobante & "' " & _
                "And A.IdPeriodo = '" & CIdPeriodo & "' " & _
                "Group By A.IdEmpresa,A.IdComprobante,A.IdPeriodo,A.IdOrigen " & _
            ") A " & _
            "Where A.Dif <> 0"
            
    CnConta.Execute CSqlC
    
    CSqlC = "Delete From AsientoContableDetalle Where IdEmpresa = '" & PIdEmpresaCli & "' And IdComprobante = '" & CIdComprobante & "' And IdPeriodo = '" & CIdPeriodo & "' And Destino = '*'"
    
    CnConta.Execute CSqlC
    
    If ccosto = "2" Then
        CSqlC = "Call Spu_GenCuentaDestino_2('" & PIdEmpresaCli & "','" & CIdPeriodo & "','" & CIdComprobante & "','" & xOrigen & "')"
    Else
        CSqlC = "Call spu_genCuentaDestino('" & PIdEmpresaCli & "','" & CIdPeriodo & "','" & CIdComprobante & "','" & xOrigen & "')"
    End If
    
    CnConta.Execute CSqlC
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub Graba_Log(StrMsgError As String, PIndMod As Boolean, PIdEmpresaCli As String, PIdSucursalCli As String, PAnnio_Mov As String, PIdMesMov As String, PIdNumMov As String)
On Error GoTo Err
Dim cinsert                             As String
Dim cselect                             As String
Dim RsConsulta                          As New ADODB.Recordset
Dim i                                   As Long
Dim CCampos                             As String
Dim X                                   As Long
Dim NItem_Log                           As Long
    
    cselect = "Select Item_Log " & _
              "From RegisDoc_Log " & _
              "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdSucursal = '" & PIdSucursalCli & "' And Annio_Mov = '" & PAnnio_Mov & "' " & _
              "And IdMesMov = '" & PIdMesMov & "' And IdNumMov = '" & PIdNumMov & "' " & _
              "Order By Item_Log Desc"
    RsConsulta.Open cselect, Cn, adOpenStatic, adLockReadOnly
    If Not RsConsulta.EOF Then
        NItem_Log = Val("" & RsConsulta.Fields("Item_Log")) + 1
    Else
        NItem_Log = 1
    End If
    RsConsulta.Close: Set RsConsulta = Nothing

    cselect = "Select * " & _
              "From RegisDoc " & _
              "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdSucursal = '" & PIdSucursalCli & "' And Annio_Mov = '" & PAnnio_Mov & "' " & _
              "And IdMesMov = '" & PIdMesMov & "' And IdNumMov = '" & PIdNumMov & "'"
    With RsConsulta
        .Open cselect, Cn, adOpenStatic, adLockReadOnly
        If Not .EOF Then
            cinsert = ""
            cselect = ""
            cinsert = "Insert Into RegisDoc_Log(IdMesMov,IdNumMov,IdProveedor,GlsProveedor,DireccionProveedor,RucProveedor,TipoDcto,IdSerieDcto," & _
                      "NumDcto,FechaMov,IdMoneda,ValTipoCambio,Observacion,MtoImponible,MtoExonerado,MtoIGV,MtoOtrosImp,MtoTotal,IdForma_pago," & _
                      "Fec_vcto,IdGastosIngresos,IdCtaContable,NumOrdenCompra,MtoRetencion,IndTransferido,IdCorrela,NumPoliza,CodIGV,FechaReg," & _
                      "IdUsuarioReg,FechaMod,IdUsuarioMod,FechaRecepcion,MtoRedSuma,MtoRedResta,NumValeIngreso,MtoDcto,FechaImpresion," & _
                      "IdUsuarioImpresion,IdNumComprobante,IndRetener,ValPorcIGV,IdCentro,NumCompServicios,IndOrigen,IndDetraccion,IdDetraccion," & _
                      "ValPorc_Detraccion,IdCorrelaDetrac1,IdCorrelaDetrac2,IdEmpresa,IdSucursal,Annio_Mov,MtoIES,IndContable,ValPorc_NotaCredito," & _
                      "IndRevisado,IndDistribucion,IdCodDistCosto,IndTransferidoFin,IndPercepcion,MtoPercepcion,RentaND," & _
                      IIf(PIndMod, "IdUsuarioModificacion,FechaModificacion,HoraModificacion,", "IdUsuarioEliminacion,FechaEliminacion,HoraEliminacion,") & _
                      "Item_Log,IdSerieGeneral,GlsPc,GlsPcUsuario,GlsPcLog,GlsPcUsuarioLog)"
            
            cselect = "Select IdMesMov,IdNumMov,IdProveedor,GlsProveedor,DireccionProveedor,RucProveedor,TipoDcto,IdSerieDcto," & _
                      "NumDcto,FechaMov,IdMoneda,ValTipoCambio,Observacion,MtoImponible,MtoExonerado,MtoIGV,MtoOtrosImp,MtoTotal,IdForma_pago," & _
                      "Fec_vcto,IdGastosIngresos,IdCtaContable,NumOrdenCompra,MtoRetencion,IndTransferido,IdCorrela,NumPoliza,CodIGV,FechaReg," & _
                      "IdUsuarioReg,FechaMod,IdUsuarioMod,FechaRecepcion,MtoRedSuma,MtoRedResta,NumValeIngreso,MtoDcto,FechaImpresion," & _
                      "IdUsuarioImpresion,IdNumComprobante,IndRetener,ValPorcIGV,IdCentro,NumCompServicios,IndOrigen,IndDetraccion,IdDetraccion," & _
                      "ValPorc_Detraccion,IdCorrelaDetrac1,IdCorrelaDetrac2,IdEmpresa,IdSucursal,Annio_Mov,MtoIES,IndContable,ValPorc_NotaCredito," & _
                      "IndRevisado,IndDistribucion,IdCodDistCosto,IndTransferidoFin,IndPercepcion,MtoPercepcion,RentaND," & _
                      "'" & glsUser & "',Cast(SysDate() As Date),Cast(SysDate() As Time)," & _
                      "" & NItem_Log & ",IdSerieGeneral,GlsPc,GlsPcUsuario,'" & ComputerName() & "','" & fpUsuarioActual() & "' " & _
                      "From RegisDoc " & _
                      "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdSucursal = '" & PIdSucursalCli & "' And Annio_Mov = '" & PAnnio_Mov & "' " & _
                      "And IdMesMov = '" & PIdMesMov & "' And IdNumMov = '" & PIdNumMov & "'"
            
            Cn.Execute cinsert & cselect
            
            cinsert = "Insert Into RegisOfi_Log(idMesMov, idNumMov, idProveedor, GlsProveedor, DireccionProveedor, RucProveedor, TipoDcto, idSerieDcto, NumDcto, FechaMov, idMoneda, ValTipoCambio, Observacion, MtoImponible, MtoExonerado, MtoIGV, MtoOtrosImp, MtoTotal, idForma_pago, Fec_Vcto, MtoRetencion, indTransferido, NumPoliza, CodIGV, MtoRedSuma, MtoRedResta, MtoDcto, ValPorcIGV, F4AJUSTE_EXONERADO, NroCompServicios, WAL, indDetraccion, IdDetraccion, valPorc_Detraccion, MtoIES, idEmpresa, idSucursal, Annio_Mov,Item_Log)"
            cselect = "Select idMesMov, idNumMov, idProveedor, GlsProveedor, DireccionProveedor, RucProveedor, TipoDcto, idSerieDcto, NumDcto, FechaMov, idMoneda, ValTipoCambio, Observacion, MtoImponible, MtoExonerado, MtoIGV, MtoOtrosImp, MtoTotal, idForma_pago, Fec_Vcto, MtoRetencion, indTransferido, NumPoliza, CodIGV, MtoRedSuma, MtoRedResta, MtoDcto, ValPorcIGV, F4AJUSTE_EXONERADO, NroCompServicios, WAL, indDetraccion, IdDetraccion, valPorc_Detraccion, MtoIES, idEmpresa, idSucursal, Annio_Mov," & NItem_Log & " " & _
                      "From RegisOfi " & _
                      "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdSucursal = '" & PIdSucursalCli & "' And Annio_Mov = '" & PAnnio_Mov & "' " & _
                      "And IdMesMov = '" & PIdMesMov & "' And IdNumMov = '" & PIdNumMov & "'"
            
            Cn.Execute cinsert & cselect
            
            cinsert = "Insert Into RegisMov_Log(Item, idMesMov, idNumMov, idGastosIngresos, idCtaContable, GlsConcepto, ValImporte, indAfecto, indDebHab, idCentro, idEmpresa, idSucursal, Annio_Mov, NumReferencia,Item_Log)"
            cselect = "Select Item, idMesMov, idNumMov, idGastosIngresos, idCtaContable, GlsConcepto, ValImporte, indAfecto, indDebHab, idCentro, idEmpresa, idSucursal, Annio_Mov, NumReferencia," & NItem_Log & " " & _
                      "From RegisMov " & _
                      "Where IdEmpresa = '" & PIdEmpresaCli & "' And IdSucursal = '" & PIdSucursalCli & "' And Annio_Mov = '" & PAnnio_Mov & "' " & _
                      "And IdMesMov = '" & PIdMesMov & "' And IdNumMov = '" & PIdNumMov & "'"
            
            Cn.Execute cinsert & cselect
            
        End If
        .Close
    End With
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub nuevo(ByRef StrMsgError As String)
Dim rsg                     As New ADODB.Recordset
Dim RsD                     As New ADODB.Recordset
Dim strAno                  As String
Dim pmodificacorrelativo    As String
    
    indCargando = True
    
    NTotalBruto = 0#
    NTotalIGV = 0#
    NTotalIVAP = 0#
    NTotalDsctoVV = 0#
    NTotalDsctoPV = 0#
    NTotalBaseImponible = 0#
    NTotalExonerado = 0#

    If CIndEnviarCaja Then
        StrMsgError = "Debe enviar el documento a Caja": GoTo Err
    End If
    
    
    CIndEnviarCaja = False
    CIdPeriodoAux = ""
    CIdComprobanteAux = ""
        
    indGeneraVale = True
    
    If glsSoloGuiaMueveStock Then
        If strTipoDoc = "86" Then
            indGeneraVale = True
        Else
            indGeneraVale = False
        End If
    End If
    
    '--- Si es pedido o cotizacion no generamos vale
    If strTipoDoc = "40" Or strTipoDoc = "92" Then indGeneraVale = False

    strAno = txt_Ano.Text
    strEstDocVentas = "GEN"
    
    If glsModVendCampo = False Then
        txtCod_VendedorCampo.Locked = True
    Else
        txtCod_VendedorCampo.Locked = False
    End If
    
    limpiaForm Me
    
    TxtTipoDescuentoGlobal.Text = "P"
    
    txt_Ano.Text = strAno
    txtCod_Vendedor.Text = glsUser
    If Len(Trim(glsMotivoSalida)) > 0 And strTipoDoc = "86" Then
        'If Len(Trim(traerCampo("MotivosTraslados", "IdMotivoTraslado", "IdMotivoTraslado", glsMotivoSalida, False))) > 0 Then
            txtCod_MotivoTraslado.Text = glsMotivoSalida
            txtGls_MotivoTraslado.Text = traerCampo("motivostraslados", "GlsMotivoTraslado", "idMotivoTraslado", glsMotivoSalida, False)
        'End If
    End If
    'lblDoc.Caption = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDoc, False)
    lblDoc.ForeColor = &H0&
    txt_Serie.Enabled = True
    txt_NumDoc.Enabled = True
    
    fraGeneral.Enabled = True
    'fraDetalle.Enabled = True
    Activa_Desc_Grid False

    If strTipoDoc = "92" Then
      lbl_Llegada2.Caption = "Tiempo de Entrega"
      lbl_Llegada.Caption = "Lugar de Entrega"
    Else
      lbl_Llegada2.Caption = "Llegada2"
      lbl_Llegada.Caption = "Llegada"
    End If
    
    '--- Parametro que controla si el correlativo de la Factura se modifica
'    pmodificacorrelativo = traerCampo("Parametros", "Valparametro", "GlsParametro", "NO_MODIFICAR_CORRELATIVO", True)
'    If pmodificacorrelativo = "S" Then
'        If strTipoDoc = "01" Or strTipoDoc = "86" Then
'            txt_numdoc.Enabled = False
'        End If
'    End If
    
    '------ FORMATO GRILLA DE DOC REFERENCIA
    RsD.Fields.Append "Item", adInteger, , adFldRowID
    RsD.Fields.Append "idDocumento", adChar, 2, adFldIsNullable
    RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
    RsD.Fields.Append "idSerie", adChar, 4, adFldIsNullable
    RsD.Fields.Append "idNumDOc", adChar, 8, adFldIsNullable
    RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
    RsD.Open
    
    RsD.AddNew
    RsD.Fields("Item") = 1
    RsD.Fields("idDocumento") = ""
    RsD.Fields("GlsDocumento") = ""
    RsD.Fields("idSerie") = ""
    RsD.Fields("idNumDOc") = ""
    RsD.Fields("IndImportado") = "0"
    
    Set gDocReferencia.DataSource = Nothing
    mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    gDocReferencia.Columns.FocusedIndex = gDocReferencia.Columns.ColumnByFieldName("idDocumento").Index
    
    '------ FORMATO GRILLA DETALLE
    rsg.Fields.Append "Item", adInteger, , adFldRowID
    rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "GlsProducto", adVarChar, 8000, adFldIsNullable
    rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
    rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
    rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
    rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "itemPro", adInteger, , adFldRowID
    rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
    rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
    rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    rsg.Open
    
    rsg.AddNew
    rsg.Fields("Item") = 1
    rsg.Fields("idProducto") = ""
    rsg.Fields("idCodFabricante") = ""
    rsg.Fields("GlsProducto") = ""
    rsg.Fields("idMarca") = ""
    rsg.Fields("GlsMarca") = ""
    rsg.Fields("idUM") = ""
    rsg.Fields("GlsUM") = ""
    rsg.Fields("Factor") = 1
    rsg.Fields("Afecto") = 1
    rsg.Fields("Cantidad") = 0
    rsg.Fields("Cantidad2") = 0
    rsg.Fields("VVUnit") = 0
    rsg.Fields("IGVUnit") = 0
    rsg.Fields("PVUnit") = 0
    rsg.Fields("TotalVVBruto") = 0
    rsg.Fields("TotalPVBruto") = 0
    rsg.Fields("PorDcto") = "0"
    rsg.Fields("DctoVV") = 0
    rsg.Fields("DctoPV") = 0
    rsg.Fields("TotalVVNeto") = 0
    rsg.Fields("TotalIGVNeto") = 0
    rsg.Fields("TotalPVNeto") = 0
    rsg.Fields("VVUnitLista") = 0
    rsg.Fields("PVUnitLista") = 0
    rsg.Fields("VVUnitNeto") = 0
    rsg.Fields("PVUnitNeto") = 0
    rsg.Fields("CodigoRapido") = ""
    rsg.Fields("idTallaPeso") = 0
    rsg.Fields("CantidadAnt") = 0
    rsg.Fields("simbolo1") = ""
    rsg.Fields("simbolo2") = ""
    rsg.Fields("simbolo3") = ""
    rsg.Fields("itemPro") = 1
    rsg.Fields("IdCentroCosto") = ""
    rsg.Fields("GlsPlaca") = ""
    rsg.Fields("IdSucursalPres") = ""
    rsg.Fields("IdDocumentoPres") = ""
    rsg.Fields("IdSeriePres") = ""
    rsg.Fields("IdDocVentasPres") = ""
    rsg.Fields("IdUPCliente") = ""
    rsg.Fields("IvapUnit") = 0
    rsg.Fields("TotalIvapNeto") = 0
    rsg.Fields("GlsProveedor") = ""
    rsg.Fields("CostoS") = 0
    rsg.Fields("CostoSInc") = 0
    rsg.Fields("CostoD") = 0
    rsg.Fields("Margen") = 0
        
    Set gDetalle.DataSource = Nothing
    mostrarDatosGridSQL gDetalle, rsg, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("idProducto").Index
    
    Inicia_RecordSet RsDetProductos, 0, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    gDetalle.Dataset.Edit
    gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = lbl_SimbMonBruto.Caption
    gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = lbl_SimbMonBruto.Caption
    gDetalle.Dataset.Post
    
    chkVentaGratuita.Value = 0
    ChkTransferenciaGratuitaMP.Value = 0
    ChkTransferenciaGratuita.Value = 0
    
    TxtIdCentroCostoCliente.Text = ""
    
    indCargando = False
    ChkfContado.Value = 0
    
    'LUIS 17/10/2018 valida la forma de pago
    cmbAyudaFormaPago.Enabled = True
    '*****************************************
    
Exit Sub
Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub Form_Unload(Cancel As Integer)
On Error GoTo Err
Dim StrMsgError     As String
Dim rsEli           As New ADODB.Recordset

    If CIndEnviarCaja Then
        StrMsgError = "Debe enviar el documento a Caja": GoTo Err
    End If
    
'    If traerCampo("Empresas", "Ruc", "idEmpresa", glsEmpresa, False) = "20542001969" Then
'        Set rsEli = DataProcedimiento("Spu_EliminaTemporales", StrMsgError, "0a", "0a", "0a", "0a", "0a", "0a")
'        If StrMsgError <> "" Then GoTo Err
'    End If
    
    If Len(Trim(CTmpDocumentos)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpDocumentos
    
    End If
    
    If Len(Trim(CTmpGuiasNF)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpGuiasNF
    
    End If
    
    If Len(Trim(CTmpDocumentosGen)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpDocumentosGen
    
    End If
    
    If Len(Trim(CTmpStock)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpStock
    
    End If
    
    If Len(Trim(CTmpReferencia)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpReferencia
    
    End If
    
    If Len(Trim(CTmpProductosDesp)) > 0 Then
        
        Cn.Execute "Drop Table If Exists " & CTmpProductosDesp
    
    End If
    
    
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Cancel = 1
End Sub



Private Sub gdetalle_OnAfterDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction)

    If Action = daInsert Then
        gDetalle.Columns.ColumnByFieldName("item").Value = gDetalle.Count
        gDetalle.Columns.ColumnByFieldName("idProducto").Value = ""
        gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = ""
        gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = ""
        gDetalle.Columns.ColumnByFieldName("idMarca").Value = ""
        gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = ""
        gDetalle.Columns.ColumnByFieldName("idUM").Value = ""
        gDetalle.Columns.ColumnByFieldName("GlsUM").Value = ""
        gDetalle.Columns.ColumnByFieldName("Factor").Value = 1
        gDetalle.Columns.ColumnByFieldName("Afecto").Value = 1
        gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0
        gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0
        gDetalle.Columns.ColumnByFieldName("Cantidad2").Value = 0
        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = 0
        gDetalle.Columns.ColumnByFieldName("PVUnit").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value = 0
        gDetalle.Columns.ColumnByFieldName("PorDcto").Value = "0"
        gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
        gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = 0
        gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = 0
        gDetalle.Columns.ColumnByFieldName("VVUnitNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("PVUnitNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = ""
        gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = 0
        gDetalle.Columns.ColumnByFieldName("CantidadAnt").Value = 0
        gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = ""
        gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = ""
        gDetalle.Columns.ColumnByFieldName("itemPro").Value = gDetalle.Count
        gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value = ""
        gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = ""
        gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
        gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
        gDetalle.Columns.ColumnByFieldName("IdUPCliente").Value = ""
        gDetalle.Columns.ColumnByFieldName("IvapUnit").Value = 0
        gDetalle.Columns.ColumnByFieldName("TotalIvapNeto").Value = 0
        gDetalle.Columns.ColumnByFieldName("GlsProveedor").Value = ""
        gDetalle.Columns.ColumnByFieldName("CostoS").Value = 0
        gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = 0
        gDetalle.Columns.ColumnByFieldName("CostoD").Value = 0
        gDetalle.Columns.ColumnByFieldName("Margen").Value = 0
        gDetalle.Dataset.Post
    End If

End Sub

Private Sub gdetalle_OnBeforeDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction, Allow As Boolean)

    If Action = daInsert Then
        If (gDetalle.Columns.ColumnByFieldName("idProducto").Value = "" Or gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0) And indInserta = False Then
            Allow = False
        Else
            'Validamos cuanto es el nivel maximo de registros
            If intRegMax = 0 Or gDetalle.Count < intRegMax Then
                If gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = False Then
                    gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("idProducto").ColIndex
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = lbl_SimbMonBruto.Caption
                    gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = lbl_SimbMonBruto.Caption
                    gDetalle.Columns.ColumnByFieldName("Simbolo3").Value = "%"
                    gDetalle.Dataset.Post
                Else
                    Allow = False
                End If
            Else
                Allow = False
            End If
        End If
    End If
 
End Sub

Private Sub gDetalle_OnChangeColumn(ByVal Node As DXDBGRIDLibCtl.IdxGridNode, ByVal OldColumn As DXDBGRIDLibCtl.IdxGridColumn, ByVal Column As DXDBGRIDLibCtl.IdxGridColumn)

    If gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("GlsProducto").Index Or gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("PVUnit").Index Or gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("VVUnit").Index Then
        If gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = "06002" Then 'Servicios
            gDetalle.Columns.ColumnByFieldName("GlsProducto").DisableEditor = False
            gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = False
            gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = False
        Else
            gDetalle.Columns.ColumnByFieldName("GlsProducto").DisableEditor = True
        End If
    End If
    
End Sub

Private Sub gDetalle_OnChangeNode(ByVal OldNode As DXDBGRIDLibCtl.IdxGridNode, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
Dim StrMsgError                             As String
On Error GoTo Err
    
    If Not indCargando Then
    
        If gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("GlsProducto").Index Or gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("PVUnit").Index Or gDetalle.Columns.FocusedAbsoluteIndex = gDetalle.Columns.ColumnByFieldName("VVUnit").Index Then
            If gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = "06002" Then 'Servicios
                gDetalle.Columns.ColumnByFieldName("GlsProducto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = False
            Else
                gDetalle.Columns.ColumnByFieldName("GlsProducto").DisableEditor = True
            End If
        End If
        
        If traerCampo("DocVentasPres", "IdDocumento", "IdCentroCosto", gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, True, "IndAprobado = '1' And IdDocumento In('P1','P2')") = "P1" Then
            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
        Else
            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = False
            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = False
        End If
        
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDetalle_OnCheckEditToggleClick(ByVal Column As DXDBGRIDLibCtl.IdxGridColumn, ByVal Node As DXDBGRIDLibCtl.IdxGridNode, ByVal Text As String, ByVal State As DXDBGRIDLibCtl.ExCheckBoxState)
On Error GoTo Err
Dim StrMsgError                         As String
Dim dblVVUnit                           As Double, dblIGVUnit As Double, dblPVUnit As Double
Dim intFila                             As Integer
Dim DblPVUnitLista                      As Double

    intFila = Node.Index + 1
    If gDetalle.Dataset.State = dsEdit Then
        gDetalle.Dataset.Post
    End If
    gDetalle.Dataset.RecNo = intFila
    
    Select Case Column.Index
        Case gDetalle.Columns.ColumnByFieldName("Afecto").Index
            'procesaMoneda gDetalle.Columns.ColumnByFieldName("idMoneda").Value, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, DblVVUnit, DblIGVUnit, DblPVUnit
            
            'CALCULAMOS EL PRECIO DE LISTA Y VALIDAMOS
            procesaMoneda gDetalle.Columns.ColumnByFieldName("idMoneda").Value, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, DblPVUnitLista, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = DblPVUnitLista
            
            dblVVUnit = Val(Format(gDetalle.Columns.ColumnByFieldName("VVUnit").Value, "0.00"))
            dblIGVUnit = Val(Format(gDetalle.Columns.ColumnByFieldName("VVUnit").Value, "0.00")) * dblIgvNEw
            dblPVUnit = dblVVUnit + dblIGVUnit
            
            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
            
'            If DblPVUnitLista > Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value) Then
'                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
'                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
'                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = 0
'                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = 0
'            End If

            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
        
            gDetalle.Dataset.RecNo = intFila
    End Select
 
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub gDetalle_OnDblClick()
On Error GoTo Err
Dim StrMsgError As String
Dim strGlsProOrigen As String

    If gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = False Then
        
        If Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "MODIFICA_REGDOC_DESPROD", True)) = "N" Then
            Exit Sub
        End If
        
        Frame2(0).Visible = True
        CATTextBox1(0).Visible = True
        CATTextBox1(0).SetFocus
        
        strGlsProOrigen = traerCampo("Productos", "GlsProducto", "idProducto", gDetalle.Columns.ColumnByFieldName("idProducto").Value, True)
        If strParamModGlsPro = "S" Then
            If Trim(strGlsProOrigen) = Trim(gDetalle.Columns.ColumnByFieldName("glsProducto").Value) Then
                CATTextBox1(0).Text = ""
            Else
                CATTextBox1(0).Text = Replace(LTrim(gDetalle.Columns.ColumnByFieldName("glsProducto").Value), LTrim(strGlsProOrigen), "")
            End If
        Else
            CATTextBox1(0).Text = gDetalle.Columns.ColumnByFieldName("glsProducto").Value
        End If
        
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub gdetalle_OnEditButtonClick(ByVal Column As DXDBGRIDLibCtl.IdxGridColumn, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
On Error GoTo Err
Dim StrMsgError         As String
Dim strCod              As String
Dim strDes              As String
Dim dblTC               As Double
Dim strCodFabri         As String
Dim strCodMar           As String
Dim strDesMar           As String
Dim intAfecto           As Integer
Dim strTipoProd         As String
Dim strMoneda           As String
Dim strCodUM            As String
Dim strDesUM            As String
Dim dblVVUnit           As Double
Dim dblIGVUnit          As Double
Dim dblPVUnit           As Double
Dim dblFactor           As Double
Dim intFila             As Integer
Dim indPedido           As Boolean
Dim rscd                As New ADODB.Recordset
Dim rspa                As New ADODB.Recordset
Dim codigo              As String
Dim XCodLote            As String
Dim XDesLote            As String
Dim codproducto         As String
Dim codalmacen          As String
Dim CantDocVentas       As String
Dim ItemDocVentas       As String
Dim rsliquidacion       As New ADODB.Recordset
Dim CadMysqlLiq         As String
Dim CadMysqlLiqAct      As String
Dim indEstLiqui         As Integer
Dim DblCantidadLiq      As Double
Dim DblPesoLiq          As Double
Dim CIdCentroCosto      As String
Dim NTotHCosto          As Double
Dim RsC                 As New ADODB.Recordset
Dim CSqlC               As String
Dim NTotFacHC           As Double
Dim CArrays(6)           As String

    intFila = gDetalle.Dataset.RecNo
    
    If strTipoDoc <> "12" Then
        If Not Node Is Nothing Then intFila = Node.Index + 1
    Else
        If gDetalle.Dataset.RecNo = 0 Then
            intFila = 1
        Else
            intFila = gDetalle.Dataset.RecNo
        End If
    End If
    
    Select Case Column.Index
        Case gDetalle.Columns.ColumnByFieldName("idProducto").Index
            strCod = gDetalle.Columns.ColumnByFieldName("idProducto").Value
            strDes = gDetalle.Columns.ColumnByFieldName("GlsProducto").Value
            strCodUM = gDetalle.Columns.ColumnByFieldName("idUM").Value
            indPedido = False
            
            mostrarAyudaTextoProdAlm txtCod_Almacen.Text, rspa, strCod, strDes, strCodUM, glsValidaStock, txtCod_Lista.Text, False, True, indPedido, strTipoDoc, StrMsgError, "", True, 1, txtCod_Cliente.Text, Trim("" & txtCod_MotivoTraslado.Text)
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            If indEvaluaVacio = False Then
                If rspa.RecordCount <> 0 Then
                    mostrarProdImp rspa, StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            End If
            
            gDetalle.Dataset.RecNo = intFila
            'Comentado porque el calculo ya lo realiza en mostrarProdImp
            'GDetalle.Dataset.Edit
            'calculaTotalesFila GDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, GDetalle.Columns.ColumnByFieldName("PorDcto").Value, GDetalle.Columns.ColumnByFieldName("Afecto").Value
            'GDetalle.Dataset.Post
            
            If strCod <> "" Then
                gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("Cantidad").Index
            End If
            
            If Not gDetalle.Dataset.EOF Then
                gDetalle.Dataset.First
                Do While Not gDetalle.Dataset.EOF
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = lbl_SimbMonBruto.Caption
                    gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = lbl_SimbMonBruto.Caption
                    gDetalle.Columns.ColumnByFieldName("Simbolo3").Value = "%"
                    gDetalle.Dataset.Post
                    gDetalle.Dataset.Next
                Loop
            End If
                       
        Case gDetalle.Columns.ColumnByFieldName("idUM").Index
            strCod = gDetalle.Columns.ColumnByFieldName("idUM").Value
            strDes = gDetalle.Columns.ColumnByFieldName("GlsUM").Value
            dblFactor = gDetalle.Columns.ColumnByFieldName("Factor").Value
            
            mostrarAyudaTextoPrecios gDetalle.Columns.ColumnByFieldName("idProducto").Value, txtCod_Lista.Text, strCod, strDes, dblFactor
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            
            If leeParametro("EXTRAE_PRECIO_COMPRAS") = "1" Then
                If DatosPrecioCompras(gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                End If
            ElseIf leeParametro("EXTRAE_PRECIO_ULTIMA_VENTA") = "S" Then
                If DatosPrecioUltimaVenta(StrMsgError, gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                End If
            Else
                If DatosPrecio(gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                End If
            End If
            
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("idUM").Value = strCod
            gDetalle.Columns.ColumnByFieldName("GlsUM").Value = strDes
            gDetalle.Columns.ColumnByFieldName("Factor").Value = dblFactor
                        
            intAfecto = gDetalle.Columns.ColumnByFieldName("afecto").Value
            procesaMoneda gDetalle.Columns.ColumnByFieldName("idMoneda").Value, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
            gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
            gDetalle.Dataset.Post
        
            gDetalle.Dataset.RecNo = intFila
            gDetalle.Dataset.Edit
            
            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            
            If strCod <> "" Then
                    gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("Cantidad").Index
            End If
            
        Case gDetalle.Columns.ColumnByFieldName("idlote").Index
            codalmacen = Trim("" & txtCod_Almacen.Text)
            codproducto = Trim("" & gDetalle.Columns.ColumnByFieldName("idproducto").Value)
            CantDocVentas = gDetalle.Columns.ColumnByFieldName("Cantidad").Value
            ItemDocVentas = Trim("" & gDetalle.Columns.ColumnByFieldName("Item").Value)

            If CantDocVentas = "0" Then
                MsgBox "La Cantidad debe de ser mayor a cero Verifique.", vbInformation, App.Title
                Exit Sub
            
            Else
                If rscd.State = 1 Then rscd.Close: Set rscd = Nothing
                XDesLote = ""
                codigo = ""
                FrmAyudaLotes.mostrar_from XDesLote, codigo, codproducto, codalmacen, CantDocVentas, rscd, ItemDocVentas, StrMsgError
                If StrMsgError <> "" Then GoTo Err
    
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("idLote").Value = Trim("" & codigo)
                gDetalle.Columns.ColumnByFieldName("NumLote").Value = Trim("" & XDesLote)
                gDetalle.Dataset.Post
            
                llenaTempLotes rscd, StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        
'        Case gDetalle.Columns.ColumnByFieldName("IdFormula").Index
'            Detalle_Formula StrMsgError
'            If StrMsgError <> "" Then GoTo Err
            
        Case gDetalle.Columns.ColumnByFieldName("idLiquidacion").Index
            ItemDocVentas = Trim("" & gDetalle.Columns.ColumnByFieldName("Item").Value)
            codproducto = Trim("" & gDetalle.Columns.ColumnByFieldName("idproducto").Value)
            
            If Len(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value)) = 0 Then
                MsgBox "Debe Seleccionar un Producto Verifique ...  ", vbInformation, App.Title
                Exit Sub
            End If
            If rscd.State = 1 Then rscd.Close: Set rscd = Nothing
            
            indEstLiqui = 0
            
            DblCantidadLiq = Val(gDetalle.Columns.ColumnByFieldName("Cantidad2").Value)
            DblPesoLiq = Val(gDetalle.Columns.ColumnByFieldName("Cantidad").Value)
            
            FrmAyudaLiquidacion.mostrar_from codigo, codproducto, txtCod_UnidProd.Text, rscd, ItemDocVentas, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, Trim("" & gDetalle.Columns.ColumnByFieldName("GlsProducto").Value), indEstLiqui, DblCantidadLiq, DblPesoLiq, StrMsgError
            If StrMsgError <> "" Then GoTo Err

            llenaTempLiquidacion rscd, StrMsgError
            If StrMsgError <> "" Then GoTo Err
                                                                                                                                                                                
            If intBoton <> 1 Then
                If indEstLiqui = 1 Then
                    If strTipoDoc = "86" Or strTipoDoc = "03" Then
                        CadMysqlLiq = "Select * from docventasdetliquidacion " & _
                                      "where iddocventas = '" & txt_NumDoc.Text & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & txt_Serie.Text & "' " & _
                                      "and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
                        If rsliquidacion.State = 1 Then rsliquidacion.Close
                        rsliquidacion.Open CadMysqlLiq, strcn, adOpenStatic, adLockOptimistic
                        If Not rsliquidacion.EOF Then
                            rsliquidacion.MoveFirst
                            Do While Not rsliquidacion.EOF
                                CadMysqlLiqAct = "Update docventasliqcab set CantidadImp = (CantidadImp - " & rsliquidacion.Fields("Unidad") & ") ,PesoImp = (PesoImp - " & (rsliquidacion.Fields("Kg") + rsliquidacion.Fields("ReKg")) & ") " & _
                                                 "where IdEmpresa = '" & glsEmpresa & "' and  IdSucursal = '" & glsSucursal & "' and  IdLiquidacion = '" & Trim("" & rsliquidacion.Fields("IdLiquidacion")) & "' "
                                Cn.Execute (CadMysqlLiqAct)
                                rsliquidacion.MoveNext
                            Loop
                        End If
                        
                        csql = "Delete from docventasdetliquidacion " & _
                               "where iddocventas = '" & txt_NumDoc.Text & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & txt_Serie.Text & _
                               "' and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
                        Cn.Execute (csql)
                        
                        If rsTempLiquidacion.State = 1 Then
                            With rsTempLiquidacion
                                If Not .EOF Then
                                    .MoveFirst
                                    Do While Not .EOF
                                        csql = "Insert Into docventasdetliquidacion(IdDocumento, IdSerie, IdDocventas, IdProducto, Item, IdLiquidacion, IdUPP," & _
                                               "idCamal , FechaLiq, UnidadSaldo, Unidad, KgSaldo, ReKg,Kg, KgVivo, IdEmpresa, Idsucursal,KgEnv)Values(" & _
                                               "'" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & .Fields("IdProducto") & "'," & .Fields("ItemDocVentas") & "," & _
                                               "'" & .Fields("IdLiquidacion") & "','" & .Fields("IdUPP") & "','" & .Fields("idCamal") & "','" & Format(.Fields("FechaLiq"), "yyyy-mm-dd") & "'," & .Fields("UnidadSaldo") & "," & .Fields("Unidad") & "," & .Fields("KgSaldo") & "," & .Fields("ReKg") & "," & .Fields("Kg") & "," & .Fields("KgVivo") & ", " & _
                                               "'" & glsEmpresa & "','" & glsSucursal & "'," & .Fields("KgEnv") & ")"
                                        Cn.Execute (csql)
                                        
                                        CadMysqlLiqAct = "Update docventasliqcab set CantidadImp = (CantidadImp + " & .Fields("Unidad") & ") ,PesoImp = (PesoImp + " & (.Fields("Kg") + .Fields("ReKg")) & ") " & _
                                                         "where IdEmpresa = '" & glsEmpresa & "' and  IdSucursal = '" & glsSucursal & "' and  IdLiquidacion = '" & Trim("" & .Fields("IdLiquidacion")) & "' "
                                        Cn.Execute (CadMysqlLiqAct)
                                        .MoveNext
                                    Loop
                                End If
                            End With
                        End If
                    End If
                    
                    If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close: Set rsTempLiquidacion = Nothing
                                                    
                    rsTempLiquidacion.Fields.Append "Item", adInteger, , adFldRowID
                    rsTempLiquidacion.Fields.Append "IdLiquidacion", adVarChar, 8, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "IdUPP", adVarChar, 20, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "idCamal", adVarChar, 50, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "FechaLiq", adVarChar, 50, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "UnidadSaldo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "Unidad", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgSaldo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "Kg", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "ReKg", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgEnv", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgVivo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
                    rsTempLiquidacion.Open
                    
                    csql = "Select IdDocumento, IdSerie, IdDocventas, IdProducto, IdLiquidacion, IdUPP, idCamal, FechaLiq, UnidadSaldo, Unidad, KgSaldo, Kg, KgVivo, IdEmpresa, Idsucursal, Item,ReKg,KgEnv " & _
                           "from docventasdetliquidacion " & _
                           "where idDocventas = '" & Trim("" & gLista.Columns.ColumnByName("idDocVentas").Value) & "' " & _
                           "and idSerie = '" & Trim("" & gLista.Columns.ColumnByName("idSerie").Value) & "' " & _
                           "and idDocumento = '" & strTipoDoc & "' and idempresa = '" & glsEmpresa & "' " & _
                           "and idsucursal = '" & glsSucursal & "' "
            
                           
                    If rscd.State = 1 Then rscd.Close
                    rscd.Open csql, Cn, adOpenStatic, adLockReadOnly
                    
                    If Not rscd.EOF Then
                        rscd.MoveFirst
                        Do While Not rscd.EOF
                            rsTempLiquidacion.AddNew
                            rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
                            rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
                            rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
                            rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
                            rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
                            rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
                            rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
                            rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
                            rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
                            rsTempLiquidacion.Fields("reKg") = Val(Format((rscd.Fields("reKg")), "0.00"))
                            rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
                            rsTempLiquidacion.Fields("KgEnv") = Val(Format((rscd.Fields("KgEnv")), "0.00"))
                            rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                            rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("Item"))
                            rscd.MoveNext
                        Loop
                    End If
                ElseIf indEstLiqui = 2 Then
                    If strTipoDoc = "86" Or strTipoDoc = "03" Then
                    
                        CadMysqlLiq = "Select * from docventasdetliquidacion " & _
                                      "where iddocventas = '" & txt_NumDoc.Text & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & txt_Serie.Text & "' " & _
                                      "and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
                        If rsliquidacion.State = 1 Then rsliquidacion.Close
                        rsliquidacion.Open CadMysqlLiq, strcn, adOpenStatic, adLockOptimistic
                        
                        If Not rsliquidacion.EOF Then
                            rsliquidacion.MoveFirst
                            Do While Not rsliquidacion.EOF
                                CadMysqlLiqAct = "Update docventasliqcab set CantidadImp = (CantidadImp - " & rsliquidacion.Fields("Unidad") & ") ,PesoImp = (PesoImp - " & (rsliquidacion.Fields("Kg") + rsliquidacion.Fields("ReKg")) & ") " & _
                                                 "where IdEmpresa = '" & glsEmpresa & "' and  IdSucursal = '" & glsSucursal & "' and  IdLiquidacion = '" & Trim("" & rsliquidacion.Fields("IdLiquidacion")) & "' "
                                Cn.Execute (CadMysqlLiqAct)
                                rsliquidacion.MoveNext
                            Loop
                        End If
                        
                        csql = "Delete from docventasdetliquidacion where iddocventas = '" & txt_NumDoc.Text & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & txt_Serie.Text & "' and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
                        Cn.Execute (csql)
                        
                    End If
                     
                    If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close: Set rsTempLiquidacion = Nothing
                                                    
                    rsTempLiquidacion.Fields.Append "Item", adInteger, , adFldRowID
                    rsTempLiquidacion.Fields.Append "IdLiquidacion", adVarChar, 8, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "IdUPP", adVarChar, 20, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "idCamal", adVarChar, 50, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "FechaLiq", adVarChar, 50, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "UnidadSaldo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "Unidad", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgSaldo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "Kg", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "ReKg", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgEnv", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "KgVivo", adDouble, 14, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
                    rsTempLiquidacion.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
                    rsTempLiquidacion.Open
                    
                    csql = "Select IdDocumento, IdSerie, IdDocventas, IdProducto, IdLiquidacion, IdUPP, idCamal, FechaLiq, UnidadSaldo, Unidad, KgSaldo, Kg, KgVivo, IdEmpresa, Idsucursal, Item,ReKg,KgEnv " & _
                           "from docventasdetliquidacion " & _
                           "where idDocventas = '" & Trim("" & gLista.Columns.ColumnByName("idDocVentas").Value) & "' " & _
                           "and idSerie = '" & Trim("" & gLista.Columns.ColumnByName("idSerie").Value) & "' " & _
                           "and idDocumento = '" & strTipoDoc & "' and idempresa = '" & glsEmpresa & "' " & _
                           "and idsucursal = '" & glsSucursal & "' "
            
                           
                    If rscd.State = 1 Then rscd.Close
                    rscd.Open csql, Cn, adOpenStatic, adLockReadOnly
                    
                    If Not rscd.EOF Then
                        rscd.MoveFirst
                        Do While Not rscd.EOF
                            rsTempLiquidacion.AddNew
                            rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
                            rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
                            rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
                            rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
                            rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
                            rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
                            rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
                            rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
                            rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
                            rsTempLiquidacion.Fields("ReKg") = Val(Format((rscd.Fields("ReKg")), "0.00"))
                            rsTempLiquidacion.Fields("KgEnv") = Val(Format((rscd.Fields("KgEnv")), "0.00"))
                            rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
                            rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                            rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("Item"))
                            rscd.MoveNext
                        Loop
                    End If
                End If
            End If
        
        Case gDetalle.Columns.ColumnByFieldName("GlsProveedor").Index
             
            mostrarAyudaTexto "PROVEEDOR", strCod, strDes
        
            If strCod <> "" Then
            
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("GlsProveedor").Value = strDes
                gDetalle.Dataset.Post
            
            End If
                
        Case gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Index
            
            If leeParametro("AYUDA_CENTRO_COSTO_DETALLE") = "S" Then
                
                mostrarAyudaTexto "CENTROCOSTO", strCod, strDes
                If txtCod_CentroCosto.Text <> "" Then SendKeys "{tab}"
            
                If strCod <> "" Then
                
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value = strCod
                    gDetalle.Dataset.Post
                
                End If
                
            Else
            
                FrmAyudaHCosto.MostrarForm StrMsgError, txtCod_UnidProd.Text, "O", "", CIdCentroCosto, "", ""
                If StrMsgError <> "" Then GoTo Err
                
                If Len(Trim(CIdCentroCosto)) > 0 Then
                    
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value = CIdCentroCosto
                    
                    traerCampos "CentrosCosto A Left Join DocVentasPres B On A.IdEmpresa = B.IdEmpresa And A.IdCentroCosto = B.IdCentroCosto", "A.GlsCentroCosto,B.IdDocumento,B.IdSerie,B.IdDocVentas,B.IdSucursal,A.GlsPlaca,B.IdArea", "A.IdCentroCosto", CIdCentroCosto, 7, CArrays, False, "A.IdEmpresa = '" & glsEmpresa & "' And (B.IdDocumento In('P1','P2') Or B.IdDocumento Is Null)"
                        
                    If Len(Trim("" & CArrays(0))) > 0 Then
                        
                        gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = CArrays(0)
                        
                        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = CArrays(1)
                        
                        If CArrays(1) = "P1" Then
                        
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = CArrays(2)
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = CArrays(3)
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = CArrays(4)
                            gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = CArrays(5)
                            gDetalle.Columns.ColumnByFieldName("IdUPCliente").Value = CArrays(6)
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                            
                        ElseIf CArrays(1) = "P2" Then
                            
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = CArrays(5)
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = False
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = False
                            
                        Else
                            gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                        End If
                    
                    Else
                        gDetalle.Columns.ColumnByFieldName("idCentro").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                    End If
                    
                    If CArrays(1) = "P1" Then
                        gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
                        NTotHCosto = Val("" & traerCampo("CentrosCosto", "TotalValorVenta", "IdCentroCosto", CIdCentroCosto, True))
                        NTotFacHC = 0
                        
                        CSqlC = "Call Spu_CalculaFacturacionPorHC('" & glsEmpresa & "', '0a','''" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value & "''','1','" & glsSucursal & "','" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & txtCod_UnidProd.Text & "')"
                        RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                        
                        If Not RsC.EOF Then
                            NTotFacHC = Val("" & RsC.Fields("TotalVVNeto"))
                        End If
                        RsC.Close: Set RsC = Nothing
                        
                        Acumula_Facturado StrMsgError, CIdCentroCosto, Val("" & gDetalle.Columns.ColumnByFieldName("Item").Value), NTotFacHC
                        If StrMsgError <> "" Then GoTo Err
                        
                        If NTotFacHC > NTotHCosto Then
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
                        Else
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = NTotHCosto - NTotFacHC
                        End If
                        
                        procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                        If StrMsgError <> "" Then GoTo Err
                        
                        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                        gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                        
                        calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                        
                        gDetalle.Dataset.Post
                        
                        calcularTotales StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        gDetalle.SetFocus
                    
                    Else
                        gDetalle.Dataset.Post
                    End If
                        
                End If
            End If
            
    End Select
    
    calcularTotales StrMsgError
    If StrMsgError <> "" Then GoTo Err
                        
    gDetalle.Dataset.RecNo = intFila
    
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
    Resume
End Sub

'Private Sub Detalle_Formula(StrMsgError As String)
'On Error GoTo Err
'Dim SwIngreso                       As Boolean
'Dim NVVUnit                         As Double
'Dim dblVVUnit                       As Double
'Dim dblIGVUnit                      As Double
'Dim dblPVUnit                       As Double
'Dim intFila                         As Long
'
'    If gDetalle.Columns.ColumnByFieldName("IdTipoProducto").Value = "06004" Then
'        SwIngreso = False
'        NVVUnit = gDetalle.Columns.ColumnByFieldName("VVUnit").Value
'
'        Frm_Det_Formula.MostrarForm StrMsgError, gDetalle.Columns.ColumnByFieldName("IdProducto").Value, txtCod_Almacen.Text, txtCod_Lista.Text, RsDetProductos, SwIngreso, Val(gDetalle.Columns.ColumnByFieldName("Item").Value), NVVUnit
'        If StrMsgError <> "" Then GoTo Err
'
'        gDetalle.Dataset.Edit
'        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = NVVUnit
'        gDetalle.Dataset.Post
'
'        intFila = Val("" & gDetalle.Columns.ColumnByFieldName("Item").Value)
'
'        procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
'        If StrMsgError <> "" Then GoTo Err
'
'        gDetalle.Dataset.Edit
'        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
'        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
'        gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
'
'        calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
'        gDetalle.Dataset.Post
'
'        calcularTotales StrMsgError
'        If StrMsgError <> "" Then GoTo Err
'
'        gDetalle.SetFocus
'        gDetalle.Dataset.RecNo = intFila
'
'    Else
'        StrMsgError = "El Producto no es de tipo Producto Terminado": GoTo Err
'    End If
'
'    Exit Sub
'Err:
'    If StrMsgError = "" Then StrMsgError = Err.Description
'    MsgBox StrMsgError, vbInformation, App.Title
'    Exit Sub
'End Sub

Private Sub mostrarProdImp(ByVal rsdd As ADODB.Recordset, ByRef StrMsgError As String)
On Error GoTo Err
Dim rsg As New ADODB.Recordset
Dim RsD As New ADODB.Recordset
Dim strSerieDocventas As String
Dim dblTC           As Double
Dim strCodFabri     As String
Dim strCodMar       As String
Dim strDesMar       As String
Dim intAfecto       As Integer
Dim strTipoProd     As String
Dim strMoneda       As String
Dim strCodUM        As String
Dim strDesUM        As String
Dim dblVVUnit       As Double
Dim dblIGVUnit      As Double
Dim dblPVUnit       As Double
Dim dblFactor       As Double
Dim intFila         As Integer
Dim i               As Integer
Dim indExisteDocRef As Boolean
Dim primero         As Boolean
Dim strInserta      As Boolean

Dim StrCadSql   As String
Dim RsDatosC    As New ADODB.Recordset

    primero = True
    rsdd.MoveFirst
    Do While Not rsdd.EOF
        strInserta = True
        If strInserta = True Then
        
            If primero = True Then
                primero = False
            Else
                gDetalle.Dataset.Insert
            End If
        
            gDetalle.SetFocus
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("idProducto").Value = "" & rsdd.Fields("idProducto")
            gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = "" & rsdd.Fields("GlsProducto")
            gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = "" 'traerCampo("productos", "codigorapido", "idproducto", Trim("" & rsdd.Fields("idProducto")), True)
            gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = 0
            

            strCodUM = traerCampo("productos", "idUMCompra", "idProducto", "" & rsdd.Fields("idProducto"), True)
            If strDesUM = "" And strCodUM <> "" Then strDesUM = traerCampo("unidadMedida", "abreUM", "idUM", strCodUM, False)
            If Trim("" & rsdd.Fields("idProducto")) = "" Then Exit Sub
            
            If DatosProducto(Trim("" & rsdd.Fields("idProducto")), strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
            End If
            
            strMoneda = Trim("" & txtCod_Moneda.Text) 'traerCampo("Listaprecios", "idMoneda", "idLista", txtCod_Lista.Text, True)
            gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = strCodFabri
            gDetalle.Columns.ColumnByFieldName("idMarca").Value = strCodMar
            gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = strDesMar
            gDetalle.Columns.ColumnByFieldName("Afecto").Value = intAfecto
            gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = strTipoProd
            gDetalle.Columns.ColumnByFieldName("idMoneda").Value = strMoneda 'falta esta columna en el detalle de la grilla
            gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
            
'            If leeParametro("EXTRAE_PRECIO_COMPRAS") = "1" Then
'                If DatosPrecioCompras(Trim("" & rsdd.Fields("idProducto")), strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
'                End If
'            ElseIf leeParametro("EXTRAE_PRECIO_ULTIMA_VENTA") = "S" Then
'                If DatosPrecioUltimaVenta(StrMsgError, Trim("" & rsdd.Fields("idProducto")), strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
'                If StrMsgError <> "" Then GoTo Err
'                End If
'            Else
                If DatosPrecio(Trim("" & rsdd.Fields("idProducto")), strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
                End If
'            End If
            
            'lUIS 13/01/2025
            StrCadSql = "EXEC spu_Trae_Costo_Precio_Cotizacion '" & glsEmpresa & "','" & Trim("" & rsdd.Fields("idProducto")) & "','" & Trim("" & txtCod_Cliente.Text) & "'"
            If RsDatosC.State = 1 Then RsDatosC.Close: Set RsDatosC = Nothing
            RsDatosC.Open StrCadSql, Cn, adOpenStatic, adLockOptimistic
            
            If Not RsDatosC.EOF Then
               gDetalle.Columns.ColumnByFieldName("GlsProveedor").Value = Trim("" & RsDatosC.Fields("Proveedor"))
               gDetalle.Columns.ColumnByFieldName("CostoS").Value = Val(Format("" & RsDatosC.Fields("CostoS"), "0.00"))
               gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = Val(Format("" & RsDatosC.Fields("CostoSInc"), "0.00"))
               gDetalle.Columns.ColumnByFieldName("CostoD").Value = Val(Format("" & RsDatosC.Fields("CostoD"), "0.00"))
               
               If Val("" & RsDatosC.Fields("VvUnitario")) > 0 Then
                    If Trim("" & RsDatosC.Fields("Moneda")) = Trim("" & txtCod_Moneda.Text) Then
                        dblVVUnit = Val(Format("" & RsDatosC.Fields("VvUnitario"), "0.00"))
                    Else
                        If Val(txt_TipoCambio.Text) > 0 Then
                            If Trim("" & txtCod_Moneda.Text) = "PEN" Then
                                dblVVUnit = Val(Format("" & RsDatosC.Fields("VvUnitario") * txt_TipoCambio.Text, "0.00"))
                            Else
                                dblVVUnit = Val(Format("" & RsDatosC.Fields("VvUnitario") / txt_TipoCambio.Text, "0.00"))
                            End If
                        End If
                    End If
               End If
            End If
            
            
            If strDesUM = "" And strCodUM <> "" Then strDesUM = traerCampo("unidadMedida", "abreUM", "idUM", strCodUM, False)
                
            gDetalle.Columns.ColumnByFieldName("idUM").Value = strCodUM
            gDetalle.Columns.ColumnByFieldName("GlsUM").Value = strDesUM
            gDetalle.Columns.ColumnByFieldName("Factor").Value = dblFactor
            
            procesaMoneda strMoneda, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
            gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
            
            '------ Descuento especial por cliente
            If traerCampo("Productos", "afectoDctoEspecial", "idProducto", Trim("" & rsdd.Fields("idProducto")), True) = 1 Then
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = dblPorDsctoEspecial
            Else
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
            End If
            '-----------------------------------------------------------
            
            gDetalle.Dataset.Post
            gDetalle.Dataset.Edit
            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            If "" & rsdd.Fields("idProducto") <> "" Then
                gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("Cantidad").Index
            End If
            
'            LlenaFormulas StrMsgError, gDetalle.Columns.ColumnByFieldName("idProducto").Value
'            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            
            

        End If
        rsdd.MoveNext
    Loop

    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Function DatosProducto_Ayuda(strCodProd As String, ByRef strCodUM As String, ByRef strDesUM As String, ByRef dblFactor As Double) As Boolean
Dim rst As New ADODB.Recordset

    csql = "SELECT p.AfectoIGV,p.idMoneda,p.idUMCompra,u.abreUM " & _
            "FROM productos p,unidadmedida u " & _
            "WHERE p.idUMCompra = u.idUM " & _
            "AND p.idEmpresa = '" & glsEmpresa & "' " & _
            "AND p.idProducto = '" & strCodProd & "'"
    
    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
    
    If Not rst.EOF Then
        DatosProducto_Ayuda = True
        strCodUM = "" & rst.Fields("idUMCompra")
        strDesUM = "" & rst.Fields("abreUM")
        dblFactor = 1
     Else
        DatosProducto_Ayuda = False
        strCodUM = ""
        strDesUM = ""
        dblFactor = 0
    End If
    rst.Close: Set rst = Nothing

End Function

Private Sub llenaTempLotes(ByRef rscd As ADODB.Recordset, StrMsgError As String)
On Error GoTo Err
              
    If rsTempLotes.State = 1 Then
                                
        If rscd.RecordCount = 0 Then
            If rscd.State = 1 Then rscd.Close
            Set rscd = Nothing
        Else
            If rsTempLotes.RecordCount > 0 Then
                rsTempLotes.MoveFirst
                Do While Not rsTempLotes.EOF
                    If rsTempLotes.Fields("idProducto") = Trim("" & rscd.Fields("idproducto")) And rsTempLotes.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas")) Then
                        rsTempLotes.Delete adAffectCurrent
                        rsTempLotes.Update
                    End If
                    rsTempLotes.MoveNext
                Loop
            End If
                            
                            
            If rscd.RecordCount <> 0 Then
                rscd.MoveFirst
                Do While Not rscd.EOF
                    rsTempLotes.AddNew
                    rsTempLotes.Fields("Item") = rscd.Fields("Item")
                    rsTempLotes.Fields("idLote") = Trim("" & rscd.Fields("idLote"))
                    rsTempLotes.Fields("GlsLote") = Trim("" & rscd.Fields("GlsLote"))
                    rsTempLotes.Fields("CantidadStock") = Val(Format((rscd.Fields("CantidadStock")), "0.00"))
                    rsTempLotes.Fields("Cantidad") = Val(Format((rscd.Fields("Cantidad")), "0.00"))
                    rsTempLotes.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                    rsTempLotes.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas"))
                    rscd.MoveNext
                Loop
            End If
        End If
        
    Else
        rsTempLotes.Fields.Append "Item", adInteger, , adFldRowID
        rsTempLotes.Fields.Append "idLote", adVarChar, 10, adFldIsNullable
        rsTempLotes.Fields.Append "GlsLote", adVarChar, 255, adFldIsNullable
        rsTempLotes.Fields.Append "CantidadStock", adDouble, 14, adFldIsNullable
        rsTempLotes.Fields.Append "ok", adVarChar, 1, adFldIsNullable
        rsTempLotes.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
        rsTempLotes.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
        rsTempLotes.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
        rsTempLotes.Open
        
        If rscd.RecordCount > 0 Then
            rscd.MoveFirst
            Do While Not rscd.EOF
                rsTempLotes.AddNew
                rsTempLotes.Fields("Item") = rscd.Fields("Item")
                rsTempLotes.Fields("idLote") = Trim("" & rscd.Fields("idLote"))
                rsTempLotes.Fields("GlsLote") = Trim("" & rscd.Fields("GlsLote"))
                rsTempLotes.Fields("CantidadStock") = Val(Format((rscd.Fields("CantidadStock")), "0.00"))
                rsTempLotes.Fields("Cantidad") = Val(Format((rscd.Fields("Cantidad")), "0.00"))
                rsTempLotes.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                rsTempLotes.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas"))
                rscd.MoveNext
            Loop
        End If
        
    End If

    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub llenaTempLiquidacion(ByRef rscd As ADODB.Recordset, StrMsgError As String)
On Error GoTo Err
Dim cantidad  As Double
Dim cantidad2 As Double
              
    cantidad = 0#
    cantidad2 = 0#
    
    If rsTempLiquidacion.State = 1 Then
        If rscd.RecordCount = 0 Then
            If rscd.State = 1 Then rscd.Close
            Set rscd = Nothing
        Else
            If rsTempLiquidacion.RecordCount > 0 Then
                rsTempLiquidacion.MoveFirst
                Do While Not rsTempLiquidacion.EOF
                    If rsTempLiquidacion.Fields("idProducto") = Trim("" & rscd.Fields("idproducto")) And rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas")) Then
                        rsTempLiquidacion.Delete adAffectCurrent
                        rsTempLiquidacion.Update
                    End If
                    rsTempLiquidacion.MoveNext
                Loop
            End If
                            
            If rscd.RecordCount <> 0 Then
                rscd.MoveFirst
                Do While Not rscd.EOF
                    rsTempLiquidacion.AddNew
                    rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
                    rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
                    rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
                    rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
                    rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
                    rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
                    rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
                    cantidad = cantidad + Val(Format((rscd.Fields("Unidad")), "0.00"))
                    rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
                    rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
                    rsTempLiquidacion.Fields("ReKg") = Val(Format((rscd.Fields("ReKg")), "0.00"))
                    rsTempLiquidacion.Fields("KgEnv") = Val(Format((rscd.Fields("KgEnv")), "0.00"))
                    cantidad2 = cantidad2 + Val(Format((rscd.Fields("Kg")), "0.00"))
                    rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
                    rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                    rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas"))
                    rscd.MoveNext
                Loop
            End If
        End If
        
    Else
        rsTempLiquidacion.Fields.Append "Item", adInteger, , adFldRowID
        rsTempLiquidacion.Fields.Append "IdLiquidacion", adVarChar, 8, adFldIsNullable
        rsTempLiquidacion.Fields.Append "IdUPP", adVarChar, 20, adFldIsNullable
        rsTempLiquidacion.Fields.Append "idCamal", adVarChar, 50, adFldIsNullable
        rsTempLiquidacion.Fields.Append "FechaLiq", adVarChar, 50, adFldIsNullable
        rsTempLiquidacion.Fields.Append "UnidadSaldo", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "Unidad", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "KgSaldo", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "Kg", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "ReKg", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "KgEnv", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "KgVivo", adDouble, 14, adFldIsNullable
        rsTempLiquidacion.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
        rsTempLiquidacion.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
        rsTempLiquidacion.Open
        
        If rscd.RecordCount > 0 Then
            rscd.MoveFirst
            Do While Not rscd.EOF
                rsTempLiquidacion.AddNew
                rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
                rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
                rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
                rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
                rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
                rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
                rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
                cantidad = cantidad + Val(Format((rscd.Fields("Unidad")), "0.00"))
                rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
                rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
                rsTempLiquidacion.Fields("ReKg") = Val(Format((rscd.Fields("ReKg")), "0.00"))
                rsTempLiquidacion.Fields("KgEnv") = Val(Format((rscd.Fields("KgEnv")), "0.00"))
                cantidad2 = cantidad2 + Val(Format((rscd.Fields("Kg")), "0.00"))
                rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
                rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas"))
                rscd.MoveNext
            Loop
        End If
    End If

    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDetalle_OnEdited(ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
On Error GoTo Err
Dim rsp                     As New ADODB.Recordset
Dim sw_dcto                 As Boolean
Dim StrMsgError             As String
Dim strCod                  As String
Dim strDes                  As String
Dim strCodFabri             As String
Dim strCodMar               As String
Dim strDesMar               As String
Dim strTipoProd             As String
Dim strMoneda               As String
Dim strCodUM                As String
Dim strDesUM                As String
Dim strCodUsuarioAutorizacion As String
Dim ndcto                   As Double
Dim dblTC                   As Double
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim dblDcto                 As Double
Dim dblTotalBruto           As Double
Dim intAfecto               As Integer
Dim IndEvaluacion           As Integer
Dim i                       As Integer
Dim idUMCompra              As String
Dim dblDctoVer              As Double
Dim strDcto                 As String
Dim strPorDcto()            As String
Dim intFila                 As Integer
Dim StrCodRapido            As String
Dim NTotFacHC               As Double
Dim CSqlC                   As String
Dim RsC                     As New ADODB.Recordset
Dim NTotHCosto              As Double
Dim CArrays(6)               As String
Dim NIvapUnit               As Double

    StrCodRapido = ""
    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo

    If gDetalle.Dataset.Modified = False Then Exit Sub

    Select Case gDetalle.Columns.FocusedColumn.Index
        Case gDetalle.Columns.ColumnByFieldName("idProducto").Index
            
            With RsDetProductos
                If .RecordCount > 0 Then
                    .MoveFirst
                    .Filter = "ItemDocVentas = " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & ""
                    Do While Not .EOF
                        .Delete adAffectCurrent
                        .Update
                        .MoveNext
                    Loop
                    .Filter = ""
                    .Filter = adFilterNone
                End If
            End With
    
            strCod = gDetalle.Columns.ColumnByFieldName("idProducto").Value
            strDes = gDetalle.Columns.ColumnByFieldName("GlsProducto").Value

            csql = "SELECT idProducto,GlsProducto,idUMVenta,CodigoRapido FROM Productos " & _
                   "WHERE idempresa = '" & glsEmpresa & "' AND (idProducto = '" & strCod & "' OR idFabricante = '" & strCod & "' OR CodigoRapido = '" & strCod & "')"
            rsp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            If traerCampo("empresas", "glsempresa", "idempresa", glsEmpresa, False) <> "VERSAUS" Then
                If rsp.EOF Or rsp.BOF Then
                    StrMsgError = "No se encuentra registrado el producto"
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("idProducto").Value = ""
                    gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = ""
                    gDetalle.Dataset.Post
                    GoTo Err
                Else
                    strCod = "" & rsp.Fields("idProducto")
                    strDes = "" & rsp.Fields("GlsProducto")
                    strCodUM = "" & rsp.Fields("idUMVenta")
                    StrCodRapido = Trim("" & rsp.Fields("CodigoRapido"))
                End If
            
            Else
                If rsp.EOF Or rsp.BOF Then
                    csql = "SELECT idProducto,GlsProducto,idUMVenta FROM Productos " & _
                            "WHERE instr(CodigRapido,'" & strCod & "') > 0 and idEmpresa = '" & glsEmpresa & "' "
                    If rsp.State = 1 Then rsp.Close
                    rsp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                    If rsp.EOF Or rsp.BOF Then
                        StrMsgError = "No se encuentra registrado el producto"
                        gDetalle.Dataset.Edit
                        gDetalle.Columns.ColumnByFieldName("idProducto").Value = ""
                        gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = ""
                        gDetalle.Dataset.Post
                        GoTo Err
                    Else
                        strCod = "" & rsp.Fields("idProducto")
                        strDes = "" & rsp.Fields("GlsProducto")
                        strCodUM = "" & rsp.Fields("idUMVenta")
                        StrCodRapido = "" & rsp.Fields("CodigoRapido")
                    End If
                Else
                    strCod = "" & rsp.Fields("idProducto")
                    strDes = "" & rsp.Fields("GlsProducto")
                    strCodUM = "" & rsp.Fields("idUMVenta")
                    StrCodRapido = "" & rsp.Fields("CodigoRapido")
                End If
                
            End If
                
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("idProducto").Value = strCod
            gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = strDes
            gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = StrCodRapido
            
            '---- Trae datos producto
            If DatosProducto(strCod, strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
            End If
            strMoneda = traerCampo("Listaprecios", "idMoneda", "idLista", txtCod_Lista.Text, True)
            
            gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = strCodFabri
            gDetalle.Columns.ColumnByFieldName("idMarca").Value = strCodMar
            gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = strDesMar
            gDetalle.Columns.ColumnByFieldName("Afecto").Value = intAfecto
            gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = strTipoProd
            gDetalle.Columns.ColumnByFieldName("idMoneda").Value = strMoneda 'falta esta columna en el detalle de la grilla
            
            '---- Trae datos um - precio
            If leeParametro("EXTRAE_PRECIO_COMPRAS") = "1" Then
                If DatosPrecioCompras(strCod, strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
                End If
            ElseIf leeParametro("EXTRAE_PRECIO_ULTIMA_VENTA") = "S" Then
                If DatosPrecioUltimaVenta(StrMsgError, strCod, strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
                If StrMsgError <> "" Then GoTo Err
                End If
            Else
                If DatosPrecio(strCod, strTipoProd, strCodUM, strDesUM, dblVVUnit, dblFactor) = False Then
                End If
            End If
            
            gDetalle.Columns.ColumnByFieldName("idUM").Value = strCodUM
            gDetalle.Columns.ColumnByFieldName("GlsUM").Value = strDesUM
            gDetalle.Columns.ColumnByFieldName("Factor").Value = dblFactor
            
             'Comentado para Salguero
            'If strTipoProd = "06002" Then GDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
            gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
            procesaMoneda strMoneda, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
            gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
            gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
                    
            '----- Descuento especial por cliente
            If traerCampo("Productos", "afectoDctoEspecial", "idProducto", strCod, True) = 1 Then
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = dblPorDsctoEspecial
            Else
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
            End If
            '-----------------------------------------------------------
            gDetalle.Dataset.Post

            gDetalle.Dataset.Edit
            
            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            
            gDetalle.Dataset.Post
                    
            If strCod <> "" Then
                gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("Cantidad").ColIndex '.Index
            End If
                    
            If dblVVUnit = 0# Then
                MsgBox "El producto NO registra precio. Verifique.", vbCritical, App.Title
            End If
                
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            LlenaFormulas StrMsgError, gDetalle.Columns.ColumnByFieldName("idProducto").Value
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            
        Case gDetalle.Columns.ColumnByFieldName("VVUnit").Index
            
            If leeParametro("VALIDA_FACTURADO_HCOSTO") = "1" Then
                
                procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                If Len(Trim("" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value)) > 0 Then
                
                    If traerCampo("CentrosCosto", "IdDocumento", "IdCentroCosto", gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, True) = "P1" Then
                        NTotHCosto = Val("" & traerCampo("CentrosCosto", "TotalValorVenta", "IdCentroCosto", "" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, True))
                        CSqlC = "Call Spu_CalculaFacturacionPorHC('" & glsEmpresa & "', '0a','''" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value & "''','1','" & glsSucursal & "','" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & txtCod_UnidProd.Text & "')"
                
                        RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                        If Not RsC.EOF Then
                            NTotFacHC = Val("" & RsC.Fields("TotalVVNeto"))
                        End If
                        RsC.Close: Set RsC = Nothing
                    
                        NTotFacHC = NTotFacHC + Val("" & gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                        
                        Acumula_Facturado StrMsgError, "" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, Val("" & gDetalle.Columns.ColumnByFieldName("Item").Value), NTotFacHC
                        If StrMsgError <> "" Then GoTo Err
                        
                        If strTipoDoc <> "07" Then
                        
                            If NTotFacHC > NTotHCosto Then
                                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
                                procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                                If StrMsgError <> "" Then GoTo Err
                                
                                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                                gDetalle.Dataset.Post
                                
                                calcularTotales StrMsgError
                                If StrMsgError <> "" Then GoTo Err
                        
                                gDetalle.SetFocus
                                gDetalle.Dataset.RecNo = intFila
                                StrMsgError = "La Hoja de Costo " & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value & " tiene un total de facturado " & Trim(NTotFacHC) & " que supera lo presupuestado " & Trim(NTotHCosto): GoTo Err
                            End If
                        End If
                    End If
                End If
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                        
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
                
            Else
                procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, NIvapUnit, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                If StrMsgError <> "" Then GoTo Err
                
                If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                    gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                    gDetalle.Columns.ColumnByFieldName("IvapUnit").Value = NIvapUnit
                    gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                    
                    calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    
                    gDetalle.Dataset.Post
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    gDetalle.SetFocus
                    gDetalle.Dataset.RecNo = intFila
                
                Else
                    IndEvaluacion = 0
'                    frmAprobacionDoc.MostrarForm "10", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
'                    If StrMsgError <> "" Then GoTo Err
                    
                    If IndEvaluacion = 0 Then
                        strCodUsuarioAutorizacion = ""
                        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
                    Else
                        If "" & gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value <> "06002" Then
                            gDetalle.Dataset.Edit
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                            
                            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            
                            gDetalle.Dataset.Post
                            
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            
                            gDetalle.SetFocus
                            gDetalle.Dataset.RecNo = intFila
                        
                        Else
                            
                            gDetalle.Dataset.Edit
                            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            gDetalle.Dataset.Post
                                                    
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            
                            gDetalle.SetFocus
                            gDetalle.Dataset.RecNo = intFila
                            
                        End If
                    End If
    
                End If
            
            End If
            
        Case gDetalle.Columns.ColumnByFieldName("PVUnit").Index
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 1, gDetalle.Columns.ColumnByFieldName("PVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            'If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            
'            Else
'                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
'                gDetalle.Dataset.Edit
'                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value - gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value
'                gDetalle.Dataset.Post
'            End If
            
        Case gDetalle.Columns.ColumnByFieldName("Cantidad").Index
            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "BLOQUEA_DETALLE", True) & "") = "S" Then
                If Not gDocReferencia.Dataset.EOF Then
                    If Len(Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value)) > 0 Then
                        If Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value) > Val("" & gDetalle.Columns.ColumnByFieldName("CantidadAnt").Value) Then
                            MsgBox "La Cantidad no puede ser mayor a la cantidad importada.", vbInformation, App.Title
                            gDetalle.Dataset.Edit
                            gDetalle.Columns.ColumnByFieldName("Cantidad").Value = gDetalle.Columns.ColumnByFieldName("CantidadAnt").Value
                            gDetalle.Dataset.Post
                            Exit Sub
                        End If
                    End If
                End If
            End If
            
'            ValidaStock StrMsgError, strTipoDoc, txt_serie.Text, txt_numdoc.Text, "" & GDetalle.Columns.ColumnByFieldName("IdProducto").Value, Val("" & GDetalle.Columns.ColumnByFieldName("Cantidad").Value), dtp_Emision.Value
'            If StrMsgError <> "" Then
'
'                GDetalle.Dataset.Edit
'                GDetalle.Columns.ColumnByFieldName("Cantidad").Value = GDetalle.Columns.ColumnByFieldName("CantidadAnt").Value
'                GDetalle.Dataset.Post
'
'                calcularTotales
'
'                GDetalle.SetFocus
'                GDetalle.Dataset.RecNo = intFila
'
'                GoTo Err
'
'            End If
            
            If gDetalle.Dataset.State <> 2 Then gDetalle.Dataset.Edit
            
            calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), gDetalle.Columns.ColumnByFieldName("PorDcto").Value, Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = Val(Format((gDetalle.Columns.ColumnByFieldName("Cantidad").Value * Val(traerCampo("productos", "idTallaPeso", "idproducto", ("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))), "0.00"))
                        
            gDetalle.Dataset.Post
            
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            
        Case gDetalle.Columns.ColumnByFieldName("PorDcto").Index
            IndEvaluacion = 0
            If ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value) <> "0" Then
                If "" & traerCampo("Parametros", "ValParametro", "GlsParametro", "SOLOVALIDADCTOMAX", True) = "1" Then
                    idUMCompra = Trim("" & traerCampo("productos", "idUMVenta", "idProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))
                    If Val(Format(gDetalle.Columns.ColumnByFieldName("PorDcto").Value, "0.00")) > Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) Then
                        frmAprobacion.MostrarForm "02", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        If IndEvaluacion = 0 Then
                            strCodUsuarioAutorizacion = ""
                            gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
                        End If
                    End If
                    
                Else
                    strDcto = "" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value
                    If Trim(strDcto) <> "" And strDcto <> "0" Then
                        strPorDcto = Split(strDcto, "+")
                        For i = 0 To UBound(strPorDcto)
                            dblDctoVer = dblDctoVer + (Val("" & strPorDcto(i)))
                        Next
                    Else
                        dblDctoVer = 0
                    End If
                    
                    '-------------------------------------------------
                    If Val(dblDctoVer) > glsDctoMinValidacion Then
                        frmAprobacion.MostrarForm "02", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        If IndEvaluacion = 0 Then
                            strCodUsuarioAutorizacion = ""
                            gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
                        End If
                    End If
                
                End If
                
            End If
            idUMCompra = Trim("" & traerCampo("productos", "idUMVenta", "idProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))
                    
            If Val(Format(gDetalle.Columns.ColumnByFieldName("PorDcto").Value, "0.00")) <= Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) Then
            
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                gDetalle.Dataset.Post
                
            Else
                If "" & traerCampo("Parametros", "ValParametro", "GlsParametro", "SOLOVALIDADCTOMAX", True) <> "1" Then
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
                    gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
                    gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
                    calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                    MsgBox "El Descuento Asignado al Producto excede al permitido . Verifique ", vbInformation, App.Title
                
                Else
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                    calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                End If
            End If
            
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
            
        Case gDetalle.Columns.ColumnByFieldName("DctoVV").Index
            IndEvaluacion = 0
            If glsDsctoConClave = "S" Then
                If Val("" & gDetalle.Columns.ColumnByFieldName("DctoVV").Value) > 0 Then
                    frmAprobacion.MostrarForm "02", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    If IndEvaluacion = 0 Then
                        strCodUsuarioAutorizacion = ""
                        gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
                    End If
                End If
            Else
                IndEvaluacion = 1
            End If
            idUMCompra = Trim("" & traerCampo("productos", "idUMVenta", "idProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))
            
            dblDcto = Val("" & gDetalle.Columns.ColumnByFieldName("DctoVV").Value)
            dblTotalBruto = Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value) 'DCTO POR PRECIO UNITARIO
                                    
            If Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) = 0 Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = (dblDcto * 100) / dblTotalBruto
                gDetalle.Dataset.Post
                
            ElseIf Val(Format(((dblDcto * 100) / dblTotalBruto), "0.00")) <= Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = (dblDcto * 100) / dblTotalBruto
                gDetalle.Dataset.Post
            
            Else
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
                gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
                gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
                gDetalle.Dataset.Post
                dblDcto = 0#
                MsgBox "El Descuento Asignado al Producto excede al permitido . Verifique ", vbInformation, App.Title
            End If
            gDetalle.Dataset.Edit
            calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            
            calcularTotales StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            gDetalle.SetFocus
            gDetalle.Dataset.RecNo = intFila
        
        Case gDetalle.Columns.ColumnByFieldName("DctoPV").Index
            valdscto = Val("" & gDetalle.Columns.ColumnByFieldName("DctoPV").Value)
            valcant = Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value)
            IndEvaluacion = 0
            
            If glsDsctoConClave = "S" Then
'                If Val("" & gDetalle.Columns.ColumnByFieldName("DctoPV").Value) > 0 Then
'                    frmAprobacionDoc.MostrarForm "02", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
'                    If StrMsgError <> "" Then GoTo Err
'
'                    If IndEvaluacion = 0 Then
'                        strCodUsuarioAutorizacion = ""
'                        gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
'                    End If
'                End If
            Else
                IndEvaluacion = 1
            End If
                                        
            dblDcto = Val("" & gDetalle.Columns.ColumnByFieldName("DctoPV").Value)
            dblTotalBruto = Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value)  'DCTO POR PRECIO UNITARIO
            
            If glsDctoMinMonto > 0 Then
                sw_dcto = True
                ndcto = dblTotalBruto * (glsDctoMinMonto / 100)
                If dblDcto > ndcto Then
                    sw_dcto = False
                    MsgBox "El monto del descuento es mayor al " & Format$(glsDctoMinMonto, "00") & "%", vbCritical, App.Title
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
                    gDetalle.Dataset.Post
                End If
            Else
                sw_dcto = True
            End If
            
            If sw_dcto = True Then
                idUMCompra = Trim("" & traerCampo("productos", "idUMVenta", "idProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))
                If Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) = 0 Then
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                    gDetalle.Columns.ColumnByFieldName("PorDcto").Value = (dblDcto * 100) / dblTotalBruto
                    gDetalle.Dataset.Post
                    
                    gDetalle.Dataset.Edit
                    calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    gDetalle.SetFocus
                    gDetalle.Dataset.RecNo = intFila
                
                ElseIf Val(Format(((dblDcto * 100) / dblTotalBruto), "0.00")) <= Val(Format(traerCampo("preciosventa", "MaxDcto", "idLista", Trim("" & txtCod_Lista.Text), True, "idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' and idUM = '" & Trim("" & idUMCompra) & "' "), "0.00")) Then
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = strCodUsuarioAutorizacion
                    gDetalle.Columns.ColumnByFieldName("PorDcto").Value = (dblDcto * 100) / dblTotalBruto
                    gDetalle.Dataset.Post
                    
                    gDetalle.Dataset.Edit
                    calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    gDetalle.SetFocus
                    gDetalle.Dataset.RecNo = intFila
                    
                Else
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("PorDcto").Value = 0
                    gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
                    gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
                    gDetalle.Dataset.Post
                    
                    dblDcto = 0#
                    
                    gDetalle.Dataset.Edit
                    calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), ("" & gDetalle.Columns.ColumnByFieldName("PorDcto").Value), Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    gDetalle.SetFocus
                    gDetalle.Dataset.RecNo = intFila
                    
                    MsgBox "El Descuento Asignado al Producto excede al permitido . Verifique ", vbInformation, App.Title
                End If
            End If

        Case gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Index
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFilaPVNeto gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            End If
        
        Case gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Index
            
            If leeParametro("VALIDA_FACTURADO_HCOSTO") = "1" Then
                
                If Len(Trim("" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value)) > 0 Then
                    
                    traerCampos "CentrosCosto A Left Join DocVentasPres B On A.IdEmpresa = B.IdEmpresa And A.IdCentroCosto = B.IdCentroCosto", "A.GlsCentroCosto,B.IdDocumento,B.IdSerie,B.IdDocVentas,B.IdSucursal,A.GlsPlaca,B.IdArea", "A.IdCentroCosto", gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, 7, CArrays, False, "A.IdEmpresa = '" & glsEmpresa & "' And (B.IdDocumento In('P1','P2') Or B.IdDocumento Is Null)"
                    
                    If Len(Trim("" & CArrays(0))) > 0 Then
                        
                        gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = CArrays(0)
                        
                        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = CArrays(1)
                        
                        If CArrays(1) = "P1" Then
                        
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = CArrays(2)
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = CArrays(3)
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = CArrays(4)
                            gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = CArrays(5)
                            gDetalle.Columns.ColumnByFieldName("IdUPCliente").Value = CArrays(6)
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                            
                        ElseIf CArrays(1) = "P2" Then
                            
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = CArrays(5)
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = False
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = False
                            
                        Else
                            
                            gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                            gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                            gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                            
                        End If
                    
                    Else
                    
                        gDetalle.Columns.ColumnByFieldName("idCentro").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = True
                        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = True
                    
                    End If
                        
                    If CArrays(1) = "P1" Then
                        NTotHCosto = Val("" & traerCampo("CentrosCosto", "TotalValorVenta", "IdCentroCosto", "" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, True))
                        CSqlC = "Call Spu_CalculaFacturacionPorHC('" & glsEmpresa & "','0a','''" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value & "''','1','" & glsSucursal & "','" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & txtCod_UnidProd.Text & "')"
                
                        RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                        If Not RsC.EOF Then
                            NTotFacHC = Val("" & RsC.Fields("TotalVVNeto"))
                        End If
                        RsC.Close: Set RsC = Nothing
                        
                        Acumula_Facturado StrMsgError, "" & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value, Val("" & gDetalle.Columns.ColumnByFieldName("Item").Value), NTotFacHC
                        If StrMsgError <> "" Then GoTo Err
                        
                        If NTotFacHC > NTotHCosto Then
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
                            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            If StrMsgError <> "" Then GoTo Err
                
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                            
                            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            gDetalle.Dataset.Post
                            
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            
                            gDetalle.SetFocus
                            gDetalle.Dataset.RecNo = intFila
                
                            StrMsgError = "La Hoja de Costo " & gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value & " tiene un total de facturado " & Trim(NTotFacHC) & " que supera lo presupuestado " & Trim(NTotHCosto): GoTo Err
                        
                        Else
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = NTotHCosto - NTotFacHC
                            
                            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            If StrMsgError <> "" Then GoTo Err
                
                            gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                            gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                            gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                            
                            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                            
                            gDetalle.Dataset.Post
                            
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            
                            gDetalle.SetFocus
                            gDetalle.Dataset.RecNo = intFila
                        End If
                    End If
                End If
                If gDetalle.Dataset.State = dsEdit Then gDetalle.Dataset.Post
            End If
            
        Case gDetalle.Columns.ColumnByFieldName("CostoSInc").Index
            
            If Val(Format(gDetalle.Columns.ColumnByFieldName("CostoSInc").Value, "0.00")) > 0 Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("CostoS").Value = gDetalle.Columns.ColumnByFieldName("CostoSInc").Value / (1 + glsIGV)
                gDetalle.Dataset.Post
            Else
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("CostoS").Value = 0#
                gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = 0#
                gDetalle.Dataset.Post
            End If
            
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
           ' If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            
'            Else
'                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
'                gDetalle.Dataset.Edit
'                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value - gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value
'                gDetalle.Dataset.Post
'            End If
            
        Case gDetalle.Columns.ColumnByFieldName("CostoS").Index
        
            If Val(Format(gDetalle.Columns.ColumnByFieldName("CostoS").Value, "0.00")) > 0 Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = gDetalle.Columns.ColumnByFieldName("CostoS").Value * (1 + glsIGV)
                gDetalle.Dataset.Post
            Else
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("CostoS").Value = 0#
                gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = 0#
                gDetalle.Dataset.Post
            End If
            
            
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            'If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            
'            Else
'                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
'                gDetalle.Dataset.Edit
'                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value - gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value
'                gDetalle.Dataset.Post
'            End If
            
        Case gDetalle.Columns.ColumnByFieldName("CostoD").Index
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
   '         If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            
'            Else
''                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
''                gDetalle.Dataset.Edit
''                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
''                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value - gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
''                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value
''                gDetalle.Dataset.Post
''            End If
            
        Case gDetalle.Columns.ColumnByFieldName("Margen").Index
            procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            If StrMsgError <> "" Then GoTo Err
            
            'If Val("" & gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value) <= dblPVUnit Then
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                
                gDetalle.Dataset.Post
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
            
'            Else
'                MsgBox "El precio ingresado es menor al precio lista", vbInformation, App.Title
'                gDetalle.Dataset.Edit
'                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value - gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value
'                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value
'                gDetalle.Dataset.Post
'            End If
            
    End Select
    
    gDetalle.Dataset.Edit
    gDetalle.Columns.ColumnByFieldName("IvapUnit").Value = Val("" & gDetalle.Columns.ColumnByFieldName("IvapUnit").Value)
    gDetalle.Dataset.Post
    
    If rsp.State = 1 Then rsp.Close: Set rsp = Nothing
    Exit Sub

Err:
    If rsp.State = 1 Then rsp.Close: Set rsp = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
    Resume
End Sub

Private Sub LlenaFormulas(StrMsgError As String, PIdProducto As String)
On Error GoTo Err
Dim CSqlC                       As String
Dim RsTabla                     As New ADODB.Recordset
Dim X                           As Integer
Dim NVVUnit                     As Double
Dim intFila                     As Long
Dim dblVVUnit  As Double
Dim dblIGVUnit  As Double
Dim dblPVUnit  As Double

    X = 0
    NVVUnit = 0
                    
    CSqlC = "Select A.IdProducto,A.GlsProducto,A.Cantidad,A.VVUnit,A.PorcDcto,A.TotalVVNeto " & _
            "From ComboDet A " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdComboCab = '" & PIdProducto & "'"
    With RsTabla
        .Open CSqlC, Cn, adOpenStatic, adLockReadOnly
        Do While Not .EOF
            X = X + 1
            RsDetProductos.AddNew
            RsDetProductos.Fields("Item") = X
            RsDetProductos.Fields("IdProducto") = .Fields("IdProducto")
            RsDetProductos.Fields("GlsProducto") = .Fields("GlsProducto")
            RsDetProductos.Fields("CantidadStock") = 0
            RsDetProductos.Fields("Cantidad") = Val(.Fields("Cantidad"))
            RsDetProductos.Fields("ItemDocVentas") = Val(gDetalle.Columns.ColumnByFieldName("Item").Value)
            RsDetProductos.Fields("IdComboCab") = PIdProducto
            RsDetProductos.Fields("VVUnit") = Val("" & .Fields("VVUnit"))
            RsDetProductos.Fields("PorcDcto") = Val("" & .Fields("PorcDcto"))
            RsDetProductos.Fields("TotalVVenta") = Val("" & .Fields("TotalVVNeto"))
            NVVUnit = NVVUnit + Val("" & .Fields("TotalVVNeto"))
            .MoveNext
        Loop
        .Close
    End With
    If NVVUnit <> 0 Then
        gDetalle.Dataset.Edit
        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = NVVUnit
        gDetalle.Dataset.Post
        
        intFila = Val("" & gDetalle.Columns.ColumnByFieldName("Item").Value)
        
        procesaMoneda txtCod_Moneda.Text, txtCod_Moneda.Text, 0, Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), gDetalle.Columns.ColumnByFieldName("Afecto").Value, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
        If StrMsgError <> "" Then GoTo Err
        
        gDetalle.Dataset.Edit
        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
        gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
        
        calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
        gDetalle.Dataset.Post
        
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        gDetalle.SetFocus
        gDetalle.Dataset.RecNo = intFila
    End If
    
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    
End Sub

Private Sub gdetalle_OnKeyDown(KeyCode As Integer, ByVal Shift As Long)
Dim i               As Integer
Dim intFila         As Integer
Dim StrMsgError     As String

On Error GoTo Err

    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo

    If KeyCode = 46 Then
        If gDetalle.Count > 0 Then
            If gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = False Then
                If MsgBox("¿Seguro de eliminar el registro?", vbInformation + vbYesNo, App.Title) = vbYes Then
                    If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
                        If rsTempLotes.State = 1 Then
                            If Not rsTempLotes.EOF Then
                                rsTempLotes.MoveFirst
                                Do While Not rsTempLotes.EOF
                                    If rsTempLotes.Fields("idProducto") = Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) And rsTempLotes.Fields("ItemDocVentas") = Trim("" & gDetalle.Columns.ColumnByFieldName("item").Value) Then
                                        rsTempLotes.Delete adAffectCurrent
                                        rsTempLotes.Update
                                    End If
                                    rsTempLotes.MoveNext
                                Loop
                            End If
                        End If
                    End If
                    
                    With RsDetProductos
                        If .RecordCount > 0 Then
                            .MoveFirst
                            .Filter = "ItemDocVentas = " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & ""
                            Do While Not .EOF
                                .Delete adAffectCurrent
                                .Update
                                .MoveNext
                            Loop
                            .Filter = ""
                            .Filter = adFilterNone
                        End If
                    End With
                    
                    If gDetalle.Count = 1 Then
                        gDetalle.Dataset.Edit
                        gDetalle.Columns.ColumnByFieldName("item").Value = 1
                        gDetalle.Columns.ColumnByFieldName("idProducto").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = ""
                        gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idMarca").Value = ""
                        gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idUM").Value = ""
                        gDetalle.Columns.ColumnByFieldName("GlsUM").Value = ""
                        gDetalle.Columns.ColumnByFieldName("Factor").Value = 1
                        gDetalle.Columns.ColumnByFieldName("Afecto").Value = 1
                        gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0
                        gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 0
                        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = 0
                        gDetalle.Columns.ColumnByFieldName("PVUnit").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("PorDcto").Value = "0"
                        gDetalle.Columns.ColumnByFieldName("DctoVV").Value = 0
                        gDetalle.Columns.ColumnByFieldName("DctoPV").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("idMoneda").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idDocumentoImp").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idDocVentasImp").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idSerieImp").Value = ""
                        gDetalle.Columns.ColumnByFieldName("NumLote").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdLote").Value = ""
                        gDetalle.Columns.ColumnByFieldName("FecVencProd").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").Value = ""
                        gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = 0
                        gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = 0
                        gDetalle.Columns.ColumnByFieldName("VVUnitNeto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("PVUnitNeto").Value = 0
                        gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = ""
                        gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = 0
                        gDetalle.Columns.ColumnByFieldName("Simbolo1").Value = ""
                        gDetalle.Columns.ColumnByFieldName("Simbolo2").Value = ""
                        gDetalle.Columns.ColumnByFieldName("itemPro").Value = 1
                        gDetalle.Columns.ColumnByFieldName("IdCentroCosto").Value = ""
                        gDetalle.Columns.ColumnByFieldName("GlsPlaca").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSucursalPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocumentoPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdSeriePres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IdUPCliente").Value = ""
                        gDetalle.Columns.ColumnByFieldName("IvapUnit").Value = 0
                        gDetalle.Columns.ColumnByFieldName("TotalIvapNeto").Value = 0
                        
                        gDetalle.Columns.ColumnByFieldName("GlsProveedor").Value = ""
                        gDetalle.Columns.ColumnByFieldName("CostoS").Value = 0
                        gDetalle.Columns.ColumnByFieldName("CostoSInc").Value = 0
                        gDetalle.Columns.ColumnByFieldName("CostoD").Value = 0
                        gDetalle.Columns.ColumnByFieldName("Margen").Value = 0
                        
                        gDetalle.Dataset.Post
                    
                    Else
                        gDetalle.Dataset.Delete
                        gDetalle.Dataset.First
                        Do While Not gDetalle.Dataset.EOF
                            i = i + 1
                            With RsDetProductos
                                If .RecordCount > 0 Then
                                    .MoveFirst
                                    .Filter = "ItemDocVentas = " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & ""
                                    Do While Not .EOF
                                        .Fields("ItemDocVentas") = i
                                        .Update
                                        .MoveNext
                                    Loop
                                    .Filter = ""
                                    .Filter = adFilterNone
                                End If
                            End With
                            gDetalle.Dataset.Edit
                            gDetalle.Columns.ColumnByFieldName("Item").Value = i
                            gDetalle.Dataset.Post
                            
                            gDetalle.Dataset.Next
                        Loop
                        If gDetalle.Dataset.State = dsEdit Or gDetalle.Dataset.State = dsInsert Then
                            gDetalle.Dataset.Post
                        End If
                    End If
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                End If
                
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
                
            End If
        End If
    End If
    
    If KeyCode = 13 Then
        If gDetalle.Dataset.State = dsEdit Or gDetalle.Dataset.State = dsInsert Then
              gDetalle.Dataset.Post
        End If
        If strTipoDoc = "12" Then
'            Select Case gDetalle.Columns.FocusedColumn.Index
'                 Case gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Index
'                    If MsgBox("Desea Enviar a Caja", vbQuestion + vbYesNo, App.Title) = vbYes Then
'                        Grabar StrMsgError
'                        If StrMsgError <> "" Then GoTo Err
'
'                        frmPagosDocVentas.MostrarForm strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, dtp_Emision.Value, StrMsgError, CIndEnviarCaja
'                        If StrMsgError <> "" Then GoTo Err
'
'                        Toolbar1_ButtonClick Toolbar1.Buttons(7)
'
'                    Else
'                        gDetalle.Dataset.Insert
'                    End If
'            End Select
        End If
        
    End If
    
    Exit Sub
Err:
If StrMsgError = "" Then StrMsgError = Err.Description
MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDetalle_OnKeyPress(Key As Integer)
On Error GoTo Err
Dim StrMsgError As String
Dim strCod As String
Dim strDes As String
Dim dblTC  As Double
Dim strCodFabri As String
Dim strCodMar As String
Dim strDesMar As String
Dim intAfecto As Integer
Dim strTipoProd As String
Dim strMoneda As String
Dim strCodUM   As String
Dim strDesUM   As String
Dim dblVVUnit  As Double
Dim dblIGVUnit  As Double
Dim dblPVUnit  As Double
Dim dblFactor  As Double
Dim intFila As Integer
    
    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo
    intFila = gDetalle.Dataset.RecNo
        
    If Key <> 9 And Key <> 13 And Key <> 27 Then
        Select Case gDetalle.Columns.FocusedColumn.Index
            Case gDetalle.Columns.ColumnByFieldName("idProducto").Index
                If glsLeeCodigoBarras = "N" Then
                End If

            Case gDetalle.Columns.ColumnByFieldName("idUM").Index
                strCod = gDetalle.Columns.ColumnByFieldName("idUM").Value
                strDes = gDetalle.Columns.ColumnByFieldName("GlsUM").Value
                mostrarAyudaKeyasciiTextoPrecios Key, gDetalle.Columns.ColumnByFieldName("idProducto").Value, txtCod_Lista.Text, strCod, strDes
                Key = 0
                gDetalle.SetFocus
                gDetalle.Dataset.RecNo = intFila
                
                '----- Trae datos um - precio
                
                If leeParametro("EXTRAE_PRECIO_COMPRAS") = "1" Then
                    If DatosPrecioCompras(gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                    End If
                ElseIf leeParametro("EXTRAE_PRECIO_ULTIMA_VENTA") = "S" Then
                    If DatosPrecioUltimaVenta(StrMsgError, gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                    If StrMsgError <> "" Then GoTo Err
                    End If
                Else
                    If DatosPrecio(gDetalle.Columns.ColumnByFieldName("idProducto").Value, gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value, strCod, strDes, dblVVUnit, dblFactor) = False Then
                    End If
                End If
                
                gDetalle.Dataset.Edit
                gDetalle.Columns.ColumnByFieldName("idUM").Value = strCod
                gDetalle.Columns.ColumnByFieldName("GlsUM").Value = strDes
                
                intAfecto = gDetalle.Columns.ColumnByFieldName("Afecto").Value
                procesaMoneda gDetalle.Columns.ColumnByFieldName("idMoneda").Value, txtCod_Moneda.Text, 0, dblVVUnit, intAfecto, dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                If StrMsgError <> "" Then GoTo Err
                    
                gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
                gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
                gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
                gDetalle.Dataset.Post
        
                gDetalle.Dataset.RecNo = intFila
                gDetalle.Dataset.Edit
                
                calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                gDetalle.Dataset.Post
                
                If strCod <> "" Then
                    gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("Cantidad").Index
                End If
                
                calcularTotales StrMsgError
                If StrMsgError <> "" Then GoTo Err
                        
                gDetalle.Dataset.RecNo = intFila
        End Select
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDocReferencia_OnAfterDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction)

    If Action = daInsert Then
        gDocReferencia.Columns.ColumnByFieldName("item").Value = gDocReferencia.Count
        gDocReferencia.Dataset.Post
    End If
    
End Sub

Private Sub gDocReferencia_OnBeforeDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction, Allow As Boolean)

    If Action = daInsert Then
        If (gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "" Or gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = "" Or gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value = "") And indInsertaDocRef = False Then
            Allow = False
        Else
            gDocReferencia.Columns.FocusedIndex = gDocReferencia.Columns.ColumnByFieldName("idDocumento").Index
        End If
    End If

End Sub

Private Sub gDocReferencia_OnChangeNode(ByVal OldNode As DXDBGRIDLibCtl.IdxGridNode, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
On Error GoTo Err
Dim StrMsgError                         As String
    
    If gDocReferencia.Columns.ColumnByFieldName("IndImportado").Value = "1" Then
        gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").DisableEditor = True
        gDocReferencia.Columns.ColumnByFieldName("IdSerie").ReadOnly = True
        gDocReferencia.Columns.ColumnByFieldName("IdNumDoc").ReadOnly = True
    Else
        gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").DisableEditor = False
        gDocReferencia.Columns.ColumnByFieldName("IdSerie").ReadOnly = False
        gDocReferencia.Columns.ColumnByFieldName("IdNumDoc").ReadOnly = False
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDocReferencia_OnEditButtonClick(ByVal Column As DXDBGRIDLibCtl.IdxGridColumn, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
Dim strCod As String
Dim strDes As String
    
    Select Case Column.Index
        Case gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Index
            strCod = gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value
            strDes = gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value
            mostrarAyudaTexto "DOCUMENTOS", strCod, strDes
            gDocReferencia.Dataset.Edit
            gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = strCod
            gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value = strDes
            gDocReferencia.Dataset.Post
            gDocReferencia.SetFocus
    End Select

End Sub

Private Sub gDocReferencia_OnEdited(ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
On Error GoTo Err
Dim StrMsgError As String
    
    If gDocReferencia.Dataset.Modified = False Then Exit Sub
    Select Case gDocReferencia.Columns.FocusedColumn.Index
        Case gDocReferencia.Columns.ColumnByFieldName("idSerie").Index
            gDocReferencia.Dataset.Edit
            'gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = Format(gDocReferencia.Columns.ColumnByFieldName("idSerie").Value, "000")
            '***************** Luis 20/03/2018 **********************
            If Len(Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value)) > 4 Then
                gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = ""
            Else
                If UCase(left(Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value), 1)) = "F" Or UCase(left(Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value), 1)) = "B" Then
                    gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                Else
                    gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = Format(gDocReferencia.Columns.ColumnByFieldName("idSerie").Value, "0000")
                End If
            End If
            '*********************************************************
            
            gDocReferencia.Dataset.Post
        
        Case gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Index
            gDocReferencia.Dataset.Edit
            gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value = Format(gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value, "00000000")
            gDocReferencia.Dataset.Post
    End Select
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gDocReferencia_OnKeyDown(KeyCode As Integer, ByVal Shift As Long)
Dim i As Integer

    If KeyCode = 46 Then
        If gDocReferencia.Count > 0 Then
            If gDocReferencia.Columns.ColumnByFieldName("IndImportado").Value <> "1" Then
            
                If MsgBox("Está seguro(a) de eliminar el registro?", vbInformation + vbYesNo, App.Title) = vbYes Then
                    If gDocReferencia.Count = 1 Then
                        gDocReferencia.Dataset.Edit
                        gDocReferencia.Columns.ColumnByFieldName("Item").Value = 1
                        gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = ""
                        gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value = ""
                        gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = ""
                        gDocReferencia.Columns.ColumnByFieldName("idNumDOc").Value = ""
                        gDocReferencia.Dataset.Post
                    
                    Else
                        gDocReferencia.Dataset.Delete
                        gDocReferencia.Dataset.First
                        Do While Not gDocReferencia.Dataset.EOF
                            i = i + 1
                            gDocReferencia.Dataset.Edit
                            gDocReferencia.Columns.ColumnByFieldName("Item").Value = i
                            gDocReferencia.Dataset.Post
                            gDocReferencia.Dataset.Next
                        Loop
                        If gDocReferencia.Dataset.State = dsEdit Or gDocReferencia.Dataset.State = dsInsert Then
                            gDocReferencia.Dataset.Post
                        End If
                    End If
                End If
            End If
            
        End If
    End If
    
    If KeyCode = 13 Then
        If gDocReferencia.Dataset.State = dsEdit Or gDocReferencia.Dataset.State = dsInsert Then
              gDocReferencia.Dataset.Post
        End If
    End If

End Sub

Private Sub gDocReferencia_OnKeyPress(Key As Integer)
Dim strCod As String
Dim strDes As String
    
    If Key <> 9 And Key <> 13 And Key <> 27 Then
        Select Case gDocReferencia.Columns.FocusedColumn.Index
            Case gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Index
                strCod = gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value
                strDes = gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value
                mostrarAyudaKeyasciiTexto Key, "DOCUMENTOS", strCod, strDes
                Key = 0
                gDocReferencia.Dataset.Edit
                gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = strCod
                gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value = strDes
                gDocReferencia.Dataset.Post
                gDocReferencia.SetFocus
        End Select
    End If

End Sub

Private Sub gLista_OnChangeNode(ByVal OldNode As DXDBGRIDLibCtl.IdxGridNode, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
    
'    ListaDetalle

End Sub

Private Sub gLista_OnDblClick()
On Error GoTo Err
Dim StrMsgError     As String
Dim rscd            As New ADODB.Recordset
Dim csql            As String

    If strTipoDoc = "92" Then
        lbl_Llegada2.Caption = "Tiempo de Entrega"
        lbl_Llegada.Caption = "Lugar de Entrega"
    Else
        lbl_Llegada2.Caption = "Llegada2"
        lbl_Llegada.Caption = "Llegada"
    End If
    
'    mostrarDocVentas gLista.Columns.ColumnByName("idDocVentas").Value, gLista.Columns.ColumnByName("idSerie").Value, StrMsgError
'    If StrMsgError <> "" Then GoTo Err
    
'    'If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
'    If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
'        If rsTempLotes.State = 1 Then rsTempLotes.Close
'        Set rsTempLotes = Nothing
'
'        rsTempLotes.Fields.Append "Item", adInteger, , adFldRowID
'        rsTempLotes.Fields.Append "idLote", adVarChar, 10, adFldIsNullable
'        rsTempLotes.Fields.Append "GlsLote", adVarChar, 255, adFldIsNullable
'        rsTempLotes.Fields.Append "CantidadStock", adDouble, 14, adFldIsNullable
'        rsTempLotes.Fields.Append "ok", adVarChar, 1, adFldIsNullable
'        rsTempLotes.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
'        rsTempLotes.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
'        rsTempLotes.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
'        rsTempLotes.Open
'
'        csql = "Select Item, idLote, GlsLote, CantidadStock, Cantidad, idProducto, ItemDocVentas " & _
'               "from docventasdetlote " & _
'               "where idDocventas = '" & Trim("" & gLista.Columns.ColumnByName("idDocVentas").Value) & "' " & _
'               "and idSerie = '" & Trim("" & gLista.Columns.ColumnByName("idSerie").Value) & "' " & _
'               "and idDocumento = '" & strTipoDoc & "' and idempresa = '" & glsEmpresa & "'"
'
'        If rscd.State = 1 Then rscd.Close
'        rscd.Open csql, Cn, adOpenStatic, adLockReadOnly
'
'        If Not rscd.EOF Then
'            rscd.MoveFirst
'            Do While Not rscd.EOF
'                rsTempLotes.AddNew
'                rsTempLotes.Fields("Item") = rscd.Fields("Item")
'                rsTempLotes.Fields("idLote") = Trim("" & rscd.Fields("idLote"))
'                rsTempLotes.Fields("GlsLote") = Trim("" & rscd.Fields("GlsLote"))
'                rsTempLotes.Fields("CantidadStock") = Val(Format((rscd.Fields("CantidadStock")), "0.00"))
'                rsTempLotes.Fields("Cantidad") = Val(Format((rscd.Fields("Cantidad")), "0.00"))
'                rsTempLotes.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
'                rsTempLotes.Fields("ItemDocVentas") = Trim("" & rscd.Fields("ItemDocVentas"))
'                rscd.MoveNext
'            Loop
'        End If
'        Toolbar1.Buttons(15).Visible = False
'    End If

    'If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "LIQUIDACIONES", True) & "") = "S" Then
'    If Trim(STR_LIQUIDACIONES & "") = "S" Then
'        If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close
'        Set rsTempLiquidacion = Nothing
'
'        rsTempLiquidacion.Fields.Append "Item", adInteger, , adFldRowID
'        rsTempLiquidacion.Fields.Append "IdLiquidacion", adVarChar, 8, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "IdUPP", adVarChar, 20, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "idCamal", adVarChar, 50, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "FechaLiq", adVarChar, 50, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "UnidadSaldo", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "Unidad", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "KgSaldo", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "Kg", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "ReKg", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "KgEnv", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "KgVivo", adDouble, 14, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
'        rsTempLiquidacion.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
'        rsTempLiquidacion.Open
'
'        csql = "Select IdDocumento, IdSerie, IdDocventas, IdProducto, IdLiquidacion, IdUPP, idCamal, FechaLiq, UnidadSaldo, Unidad, KgSaldo, Kg, KgVivo, IdEmpresa, Idsucursal, Item,ReKg,KgEnv " & _
'               "from docventasdetliquidacion " & _
'               "where idDocventas = '" & Trim("" & gLista.Columns.ColumnByName("idDocVentas").Value) & "' " & _
'               "and idSerie = '" & Trim("" & gLista.Columns.ColumnByName("idSerie").Value) & "' " & _
'               "and idDocumento = '" & strTipoDoc & "' and idempresa = '" & glsEmpresa & "' " & _
'               "and idsucursal = '" & glsSucursal & "' "
'        If rscd.State = 1 Then rscd.Close
'        rscd.Open csql, Cn, adOpenStatic, adLockReadOnly
'
'        If Not rscd.EOF Then
'            rscd.MoveFirst
'            Do While Not rscd.EOF
'                rsTempLiquidacion.AddNew
'                rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
'                rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
'                rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
'                rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
'                rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
'                rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
'                rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
'                rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
'                rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
'                rsTempLiquidacion.Fields("ReKg") = Val(Format((rscd.Fields("ReKg")), "0.00"))
'                rsTempLiquidacion.Fields("KgEnv") = Val(Format((rscd.Fields("KgEnv")), "0.00"))
'                rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
'                rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
'                rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("Item"))
'                rscd.MoveNext
'            Loop
'
'        End If
'    End If

    If StrMsgError <> "" Then GoTo Err
    fraListado.Visible = False
    fraGeneral.Visible = True
    fraDetalle.Visible = True
    fraTotales.Visible = True
    
    fraGeneral.Enabled = False
    'fraDetalle.Enabled = False
    Activa_Desc_Grid True
    
'    'If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_SEPARACION", True) & "") = "S" Then
'    If Trim(STR_VALIDA_SEPARACION & "") = "S" Then
'        If strTipoDoc = "40" Then
'            Dim RstaValidacion   As String
'
'            Valida_Aprobacion RstaValidacion
'
'            If RstaValidacion = "1" Then
'                Toolbar1.Buttons(16).Visible = False
'                Toolbar1.Buttons(17).Visible = True
'            Else
'                Toolbar1.Buttons(16).Visible = True
'                Toolbar1.Buttons(17).Visible = False
'            End If
'
'        End If
'    End If
    
    intBoton = 3
    habilitaBotones 2, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
'    'If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_SEPARACION", True) & "") = "S" Then
'    If Trim(STR_VALIDA_SEPARACION & "") = "S" Then
'        If strTipoDoc = "40" Then
'            RstaValidacion = ""
'            Valida_Aprobacion RstaValidacion
'
'            If RstaValidacion = "1" Then
'                Toolbar1.Buttons(2).Visible = False 'GRABAR
'                Toolbar1.Buttons(3).Visible = False 'MODIFICAR
'                Toolbar1.Buttons(5).Visible = False 'ELIMINAR
'                Toolbar1.Buttons(6).Visible = True 'ANULAR
'                Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
'                If strTipoDoc = "86" Then
'                    Toolbar1.Buttons(8).Visible = True
'                Else
'                    Toolbar1.Buttons(8).Visible = False
'                End If
'                Toolbar1.Buttons(11).Visible = True 'PAGOS
'                Toolbar1.Buttons(12).Visible = True 'Letra
'            End If
'
'        End If
'    End If
    
    Exit Sub
    
Err:
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub ListaTempLiquidaciones()
On Error GoTo Err
Dim StrMsgError     As String
Dim rscd            As New ADODB.Recordset
Dim csql            As String

    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "LIQUIDACIONES", True) & "") = "S" Then
        If strTipoDoc = "86" Then
            If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close
            Set rsTempLiquidacion = Nothing
                                            
            rsTempLiquidacion.Fields.Append "Item", adInteger, , adFldRowID
            rsTempLiquidacion.Fields.Append "IdLiquidacion", adVarChar, 8, adFldIsNullable
            rsTempLiquidacion.Fields.Append "IdUPP", adVarChar, 20, adFldIsNullable
            rsTempLiquidacion.Fields.Append "idCamal", adVarChar, 50, adFldIsNullable
            rsTempLiquidacion.Fields.Append "FechaLiq", adVarChar, 50, adFldIsNullable
            rsTempLiquidacion.Fields.Append "UnidadSaldo", adDouble, 14, adFldIsNullable
            rsTempLiquidacion.Fields.Append "Unidad", adDouble, 14, adFldIsNullable
            rsTempLiquidacion.Fields.Append "KgSaldo", adDouble, 14, adFldIsNullable
            rsTempLiquidacion.Fields.Append "Kg", adDouble, 14, adFldIsNullable
            rsTempLiquidacion.Fields.Append "KgVivo", adDouble, 14, adFldIsNullable
            rsTempLiquidacion.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
            rsTempLiquidacion.Fields.Append "ItemDocVentas", adVarChar, 3, adFldIsNullable
            rsTempLiquidacion.Open
            
            csql = "Select IdDocumento, IdSerie, IdDocventas, IdProducto, IdLiquidacion, IdUPP, idCamal, FechaLiq, UnidadSaldo, Unidad, KgSaldo, Kg, KgVivo, IdEmpresa, Idsucursal, Item " & _
                   "from docventasdetliquidacion " & _
                   "where idDocventas = '" & Trim("" & txt_NumDoc.Text) & "' " & _
                   "and idSerie = '" & Trim("" & txt_Serie.Text) & "' " & _
                   "and idDocumento = '" & strTipoDoc & "' and idempresa = '" & glsEmpresa & "' " & _
                   "and idsucursal = '" & glsSucursal & "' "
                
            If rscd.State = 1 Then rscd.Close
            rscd.Open csql, Cn, adOpenStatic, adLockReadOnly
            
            If Not rscd.EOF Then
                rscd.MoveFirst
                Do While Not rscd.EOF
                    rsTempLiquidacion.AddNew
                    rsTempLiquidacion.Fields("Item") = Trim("" & rscd.Fields("Item"))
                    rsTempLiquidacion.Fields("IdLiquidacion") = Trim("" & rscd.Fields("IdLiquidacion"))
                    rsTempLiquidacion.Fields("IdUPP") = Trim("" & rscd.Fields("IdUPP"))
                    rsTempLiquidacion.Fields("idCamal") = Trim("" & rscd.Fields("idCamal"))
                    rsTempLiquidacion.Fields("FechaLiq") = Format(Trim("" & rscd.Fields("FechaLiq")), "dd/mm/yyyy")
                    rsTempLiquidacion.Fields("UnidadSaldo") = Val(Format((rscd.Fields("UnidadSaldo")), "0.00"))
                    rsTempLiquidacion.Fields("Unidad") = Val(Format((rscd.Fields("Unidad")), "0.00"))
                    rsTempLiquidacion.Fields("KgSaldo") = Val(Format((rscd.Fields("KgSaldo")), "0.00"))
                    rsTempLiquidacion.Fields("Kg") = Val(Format((rscd.Fields("Kg")), "0.00"))
                    rsTempLiquidacion.Fields("KgVivo") = Val(Format((rscd.Fields("KgVivo")), "0.00"))
                    rsTempLiquidacion.Fields("idproducto") = Trim("" & rscd.Fields("idproducto"))
                    rsTempLiquidacion.Fields("ItemDocVentas") = Trim("" & rscd.Fields("Item"))
                    rscd.MoveNext
                Loop
                    
            End If
        End If
    End If

    Exit Sub
    
Err:
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub gListaDetalle_OnDblClick()
On Error GoTo Err
Dim StrMsgError As String
Dim strGlsProOrigen As String

    If gListaDetalle.Columns.ColumnByFieldName("CantidadImp").Visible = True Then
        
        FraAtencionPed.Visible = True
        txtItmProducto.Text = gListaDetalle.Columns.ColumnByFieldName("item").Value
        TxtCodProducto.Text = gListaDetalle.Columns.ColumnByFieldName("idProducto").Value
        TxtDesproducto.Text = gListaDetalle.Columns.ColumnByFieldName("GlsProducto").Value
        TxtcantProducto.Text = Val(Format(gListaDetalle.Columns.ColumnByFieldName("Cantidad").Value, "0.00"))
        TxtcantProducto_Atn.Text = Val(Format(gListaDetalle.Columns.ColumnByFieldName("CantidadImp").Value, "0.00"))
        
        TxtcantProducto_Atn.SetFocus
        
    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub OptTipoDecuentoGlobal_Click(Index As Integer)
On Error GoTo Err
Dim StrMsgError                             As String
    
    TxtTipoDescuentoGlobal.Text = IIf(OptTipoDecuentoGlobal(0).Value, "P", "M")
    
    calcularTotales StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub ValidaLista_de_Precio(StrMsgError As String)
Dim CodListaAnt            As String
Dim strMoneda               As String
Dim strCodUM                As String
Dim strDesUM                As String
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim intAfecto               As Integer
Dim strCodFabri             As String
Dim strCodMar               As String
Dim strDesMar               As String
Dim strTipoProd             As String
Dim RstValidaLP     As New ADODB.Recordset
Dim StrCadSql       As String
On Error GoTo Err
           
           
    gDetalle.Dataset.First
    If Not gDetalle.Dataset.EOF Then
        
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            
            If DatosProducto(Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
            End If
                
            If strTipoProd = "06002" Then
            
                StrCadSql = "SELECT '' as GlsUM,v.VVUnit,1 AS Factor " & _
                        "FROM preciosventa v " & _
                        "WHERE v.idEmpresa = '" & glsEmpresa & "' " & _
                          "AND v.idLista = '" & Trim("" & txtCod_Lista.Text) & "'" & _
                          "AND v.idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' "
            Else
            
                StrCadSql = "SELECT u.abreUM as GlsUM,v.VVUnit,r.Factor " & _
                            "FROM presentaciones r,unidadMedida u,preciosventa v " & _
                            "WHERE r.idUM = u.idUM " & _
                            "AND r.idEmpresa = '" & glsEmpresa & "' " & _
                            "AND r.idProducto = v.idProducto " & _
                            "AND r.idUM = v.idUM " & _
                            "AND v.idEmpresa = '" & glsEmpresa & "' " & _
                            "AND v.idLista = '" & Trim("" & txtCod_Lista.Text) & "'" & _
                            "AND r.idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' " & _
                            "AND r.idUM = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idUM").Value) & "' "
            End If
        
    
            If RstValidaLP.State = 1 Then RstValidaLP.Close: Set RstValidaLP = Nothing
            RstValidaLP.Open StrCadSql, Cn, adOpenStatic, adLockOptimistic
            If RstValidaLP.EOF Then
                
              StrMsgError = "Producto no tiene lista de pecio, Verifique."
              gDetalle.Dataset.First
              GoTo Err
                
            Else
               
              If Val(Trim("" & RstValidaLP.Fields("VVUnit"))) = 0 Then
                StrMsgError = "Producto no tiene un precio de lista valido, Verifique"
                gDetalle.Dataset.First
                GoTo Err
              End If
              
            End If
            
        gDetalle.Dataset.Next
        Loop
    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub


Private Sub Toolbar1_ButtonClick(ByVal Button As MSComctlLib.Button)
On Error GoTo Err
Dim rscd As ADODB.Recordset
Dim rsdd As ADODB.Recordset
Dim numGuia As String
Dim serieGuia As String
Dim strEDV As String
Dim StrMsgError As String
Dim CIdTipoFormaPago        As String
Dim NPagos                  As Integer
Dim RstaValidacion          As String
Dim rsp                     As New ADODB.Recordset
Dim Cadmysql                As String
Dim strTipoDocImportado     As String
Dim ImpSerie                As String
Dim impNum                  As String
Dim StrImp                  As New ADODB.Recordset
Dim PeriodoImp              As String
Dim CIdProducto             As String
Dim CIdAtencion             As String
Dim Sw_Guia                 As Boolean
Dim StrFechaDoc As String
Dim rsValida    As New ADODB.Recordset
Dim StrCadSql   As String

    StrFechaDoc = ""
    
    Select Case Button.Index
        Case 1: 'Nuevo
            intBoton = Button.Index
            
            nuevo StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            habilitaBotones Button.Index, StrMsgError
            If StrMsgError <> "" Then GoTo Err
        
            valoresIniciales
            
            intRegMax = 50 'Val("" & traerCampo("seriesdocumento", "numRegMaximo", "idSucursal", glsSucursal, True, "idDocumento = '" & strTipoDoc & "' AND idSerie = '" & txt_serie.Text & "'"))
            
            txtCod_TipoTicket.Text = "08002"
                
            fraListado.Visible = False
            fraGeneral.Visible = True
            fraDetalle.Visible = True
            fraTotales.Visible = True
            
            '--Deshabilita los botones de las transferencia entre sucursales
            lbl_SucursalDestino.Visible = False
            txtCod_SucursalDestino.Visible = False
            txtGls_SucursalDestino.Visible = False
            cmbAyudaSucursalDestino.Visible = False
            lbl_AlmacenDestino.Visible = False
            txtCod_AlmacenDestino.Visible = False
            txtGls_AlmacenDestino.Visible = False
            cmbAyudaAlmacenDestino.Visible = False
                
            If rsTempLotes.State = 1 Then rsTempLotes.Close
            Set rsTempLotes = Nothing
            
            If rsTempLiquidacion.State = 1 Then rsTempLiquidacion.Close
            Set rsTempLiquidacion = Nothing
            
            If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
                Toolbar1.Buttons(15).Visible = False
            End If
            
            If Trim("" & STR_PERIODO_CAMBIO_IGV) > Format(dtp_Emision.Value, "yyyymm") Then
                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
            Else
                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
            End If
            
            If Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "BLOQUEA_DETALLE", True) & "") = "S" Then
                gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("Cantidad").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("IGVUnit").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("TotalVVBruto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("TotalPVBruto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("PorDcto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("DctoVV").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("DctoPV").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("TotalVVNeto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("TotalPVNeto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("VVUnitLista").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("PVUnitLista").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("VVUnitNeto").DisableEditor = False
                gDetalle.Columns.ColumnByFieldName("PVUnitNeto").DisableEditor = False
            End If
            
            '--- Si el doc es Ticket por defecto el foco pinta en el detalle
            If strTipoDoc = "12" Then
                gDetalle.Columns.FocusedIndex = gDetalle.Columns.ColumnByFieldName("idProducto").ColIndex
                gDetalle.SetFocus
            End If
            
            'CIdProducto = leeParametro("CODIGO_SERVICIO_AUTOMATICO")
            
            If Len(Trim(CIdProducto)) > 0 Then
            
                InsertaItemAutomatico StrMsgError, CIdProducto
                If StrMsgError <> "" Then GoTo Err
            
            End If
            
            ''If Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "MODIFICA_REGDOC_CORRELA", True)) = "N" Then
            '    txt_numdoc.Locked = True
            'Else
                txt_NumDoc.Locked = False
            'End If
            
'            '******************** 24/03/2019 Luis ***********************
'            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'                cmbAyudaLista.Enabled = False
'                txtCod_Lista.Locked = True
'                txtGls_Lista.Locked = True
'                txtCod_Lista.Text = ""
'                txtGls_Lista.Text = ""
'                txtCod_Lista.Enabled = False
'            End If
'            '*************************************************************
            
        Case 2: 'Grabar
        
            txt_Serie.Text = Format(txt_Serie.Text, "0000")
'            If Len(txtCod_VendedorCampo.Text) = 0 Then
'                StrMsgError = "El Cliente no tiene Vendedor. Verifique."
'                If StrMsgError <> "" Then GoTo Err
'            End If
                                
            StrFechaDoc = Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "IND_DOC_FECHA_ACTUAL", True))
            If Trim("" & StrFechaDoc) = "S" And strTipoDoc = "86" Then
                
                If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
                StrCadSql = "select sysdate() Fecha  "
                rsValida.Open StrCadSql, Cn, adOpenStatic, adLockOptimistic
                
                If Not rsValida.EOF Then
                    If Format(rsValida.Fields("Fecha"), "dd/mm/yyyy") <> Format(dtp_Emision.Value, "dd/mm/yyyy") Then
                        StrMsgError = "Solo está permitido registros con la fecha actual"
                        If StrMsgError <> "" Then GoTo Err
                    End If
                End If
                
            End If
             
             
            '******** LUIS 17/10/2018 VALIDA FORMA DE PAGO EN EL DOC DE REFERENCIA *********
            If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
                Dim StrFPagoval     As String
                If gDocReferencia.Count > 0 Then
                
                    If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_ACTIVO_FACTURA", True) <> "S" Then
                    
                        gDocReferencia.Dataset.First
                        Do While Not gDocReferencia.Dataset.EOF
                            
                            If Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "86" Then
                                StrFPagoval = traerCampo("docventas", "idformapago", "iddocventas", Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value), True, " idserie = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value) & "' and iddocumento = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) & "' ")
                                If StrFPagoval <> Trim("" & txtCod_FormaPago.Text) Then
                                    StrMsgError = "La forma de pago debe ser igual al documento de referencia, verifique": GoTo Err
                                End If
                            End If
                            
                            If Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "01" Then
                                StrFPagoval = traerCampo("docventas", "idformapago", "iddocventas", Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value), True, " idserie = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value) & "' and iddocumento = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) & "' ")
                                If StrFPagoval <> Trim("" & txtCod_FormaPago.Text) Then
                                    StrMsgError = "La forma de pago debe ser igual al documento de referencia, verifique": GoTo Err
                                End If
                            End If
                            
                            If Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "92" Then
                                StrFPagoval = traerCampo("docventas", "idformapago", "iddocventas", Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value), True, " idserie = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value) & "' and iddocumento = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) & "' ")
                                If StrFPagoval <> Trim("" & txtCod_FormaPago.Text) Then
                                    StrMsgError = "La forma de pago debe ser igual al documento de referencia, verifique": GoTo Err
                                End If
                            End If
                            
                            If Me.strTipoDoc <> "40" Then
                                If Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "40" Then
                                    StrFPagoval = traerCampo("docventas", "idformapago", "iddocventas", Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value), True, " idserie = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value) & "' and iddocumento = '" & Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) & "' ")
                                    If StrFPagoval <> Trim("" & txtCod_FormaPago.Text) Then
                                        StrMsgError = "La forma de pago debe ser igual al documento de referencia, verifique": GoTo Err
                                    End If
                                End If
                            End If
                            
                            gDocReferencia.Dataset.Next
                        Loop
                    
                    End If
                End If
            End If
            '****************************************************************
            
            '***************** lUIS 25/03/2017 ***********************
            Sw_Guia = False
            If strTipoDoc = "01" Then
                
                If gDocReferencia.Count > 0 Then
                    gDocReferencia.Dataset.First
                    Do While Not gDocReferencia.Dataset.EOF
                        If Trim("" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "86" Then
                            Sw_Guia = True
                            Exit Do
                        End If
                        gDocReferencia.Dataset.Next
                    Loop
                End If
                
                If Sw_Guia = False And Trim("" & traerCampo("empresas", "ruc", "idempresa", glsEmpresa, True)) = "20305948277" Then
                     StrMsgError = "Debe tener una guía de remisión de referencia. Verifique."
                     If StrMsgError <> "" Then GoTo Err
                 End If
            
            End If
            '************************************************************
            
            If gDetalle.Columns.ColumnByFieldName("idProducto").Value = "" Then
                StrMsgError = "Falta ingresar detalle. Verifique."
                If StrMsgError <> "" Then GoTo Err
            End If
                        
'            '************ Luis 24/03/2019 *******************
'            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'                '************ Luis 30/03/2019 *******************
'                If Val(Trim(traerCampo("motivostraslados", "indlprecio", "idmotivotraslado", Trim("" & txtCod_MotivoTraslado.Text), False) & "")) = 1 Then
'                    ValidaLista_de_Precio StrMsgError
'                    If StrMsgError <> "" Then GoTo Err
'                End If
'                '************************************************
'            End If
'            '************************************************
                        
            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_REFERENCIA", True) & "") = "S" Then
                If Trim(traerCampo("sucursales", "indReferencia", "idSucursal", glsSucursal, True) & "") = "S" Then
                    If strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "86" Then
                      If Trim(traerCampo("MotivosTraslados", "GlsMotivoTraslado", "GlsMotivoTraslado", txtGls_MotivoTraslado.Text, False)) = "COMPRA" Or Trim(traerCampo("MotivosTraslados", "GlsMotivoTraslado", "GlsMotivoTraslado", txtGls_MotivoTraslado.Text, False)) = "DEVOLUCION" Then
                            Grabar StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            intBoton = 3
                       Else
                            If Trim(STR_CLIENTE_ANULA & "") = "S" Then
                                Grabar StrMsgError
                                If StrMsgError <> "" Then GoTo Err
                                intBoton = 3
                            Else
                                gDocReferencia.Dataset.First
                                If Not gDocReferencia.Dataset.EOF Then
                                    If Len(Trim(gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value)) > 0 Then
                                        Grabar StrMsgError
                                        If StrMsgError <> "" Then GoTo Err
                                        intBoton = 3
                                    Else
                                        MsgBox "No se puede grabar el documento, tiene que ser importado.", vbInformation, App.Title
                                    End If
                                End If
                            End If
                       End If
                    Else
                        Grabar StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        intBoton = 3
                    End If
                Else
                    Grabar StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    intBoton = 3
                End If
            Else
                Grabar StrMsgError
                If StrMsgError <> "" Then GoTo Err
                intBoton = 3
            End If
            
            If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
                Toolbar1.Buttons(15).Visible = False
            End If
            
            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_SEPARACION", True) & "") = "S" Then
                If strTipoDoc = "40" Then
                    Valida_Aprobacion RstaValidacion
                    If RstaValidacion = "1" Then
                        Toolbar1.Buttons(16).Visible = False
                        Toolbar1.Buttons(17).Visible = False
                    Else
                        Toolbar1.Buttons(16).Visible = False
                        Toolbar1.Buttons(17).Visible = False
                    End If
                End If
            End If
            
            If Trim("" & STR_PERIODO_CAMBIO_IGV) > Format(dtp_Emision.Value, "yyyymm") Then
                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
            Else
                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
            End If
            
            If Len(Trim(traerCampo("docventas", "idMovCaja", "idDocumento", strTipoDoc, True, " idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "' AND idSucursal = '" & glsSucursal & "'"))) > 0 Then
                CIndEnviarCaja = True
            End If
                    
'            '******************** 24/03/2019 Luis ***********************
'            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'                cmbAyudaLista.Enabled = False
'                txtCod_Lista.Locked = True
'                txtGls_Lista.Locked = True
'                txtCod_Lista.Enabled = False
'            End If
'            '*************************************************************
            
        Case 3: 'Modificar
        
            If Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "MODIFICA_REGDOC_VENTAS", True)) = "N" Then
                MsgBox "La opción se encuentra deshabilitada, Verifique ", vbInformation, Me.Caption
                Exit Sub
            End If
            
            CIdTipoFormaPago = traerCampo("PagosDocVentas", "IdTipoFormaPago", "IdSucursal", glsSucursal, True, "IdDocumento = '" & strTipoDoc & "' And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'")
            
            If Len(Trim(CIdTipoFormaPago)) > 0 Then
            
                If CIdTipoFormaPago <> "06090001" And CIdTipoFormaPago <> "06090004" Then
                    NPagos = Val(traerCampo("Cta_Mvto", "count(*)", "idCta_Dcto", traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False) & Format(txt_Serie.Text, "000") & "/" & Format(txt_NumDoc.Text, "00000000"), True), True))
                    If NPagos <> 0 Then
                        StrMsgError = "No se puede Modificar el Pago del Documento"
                        GoTo Err
                    End If
                End If
            End If
            
            If strEstDocVentas = "GEN" Or strEstDocVentas = "CAN" Then
                If EstadoCajaDocVentas(strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError) <> "C" Then
                    ValidaModificacionAsientoContable StrMsgError, "modificar"
                    If StrMsgError <> "" Then GoTo Err
                    
                    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    If glsModVendCampo = False Then
                        txtCod_VendedorCampo.Locked = True
                    Else
                        txtCod_VendedorCampo.Locked = False
                    End If

                    fraGeneral.Enabled = True
                    Activa_Desc_Grid False
                    
                    habilitaBotones Button.Index, StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                
                Else
                    StrMsgError = "No se puede Modificar el Documento, la caja que se uso se encuentra cerrada"
                    GoTo Err
                End If
            Else
                StrMsgError = "No se puede Modificar el Documento"
                GoTo Err
            End If
            
            If Trim("" & STR_PERIODO_CAMBIO_IGV) > Format(dtp_Emision.Value, "yyyymm") Then
                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
            Else
                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
            End If
             
        Case 4: 'Cancelar
            fraGeneral.Enabled = False
            Activa_Desc_Grid True
            
            habilitaBotones Button.Index, StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
        Case 5: 'Eliminar
            ValidaModificacionAsientoContable StrMsgError, "eliminar"
            If StrMsgError <> "" Then GoTo Err
                        
            If ccodparamemp = "S" Then
                If Len(Trim(traerCampo("docreferenciaempresas", "numDocOrigen", "numDocOrigen", Trim(txt_NumDoc.Text), False, "idEmpresaOrigen = '" & glsEmpresa & "' And idSucursalOrigen = '" & glsSucursal & "' And tipoDocOrigen = '" & strTipoDoc & "' And SerieDocOrigen= '" & txt_Serie.Text & "'"))) > 0 Then
                    eliminardocEmpresas StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                Else
                    eliminar StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            Else
                eliminar StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
            
            If Trim("" & STR_PERIODO_CAMBIO_IGV) > Format(dtp_Emision.Value, "yyyymm") Then
                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
            Else
                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
            End If
                        
        Case 6: 'Anular
            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_SEPARACION", True) & "") = "S" Then
                If strTipoDoc = "40" Then
                    QuitarAprobacion StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            End If
            
            ValidaModificacionAsientoContable StrMsgError, "anular"
            If StrMsgError <> "" Then GoTo Err
            
            If ccodparamemp = "S" Then
                If Len(Trim(traerCampo("docreferenciaempresas", "numDocOrigen", "numDocOrigen", Trim(txt_NumDoc.Text), False, "idEmpresaOrigen = '" & glsEmpresa & "' And idSucursalOrigen = '" & glsSucursal & "' And tipoDocOrigen = '" & strTipoDoc & "' And SerieDocOrigen= '" & txt_Serie.Text & "'"))) > 0 Then
                    anularDocEmpresas StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                Else
                    anularDoc StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            Else
                anularDoc StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
            
        Case 7: 'Imprimir
            If CIndEnviarCaja Then
                StrMsgError = "Debe enviar el documento a Caja": GoTo Err
            End If
            
            If strTipoDoc <> "03" And strTipoDoc <> "01" And strTipoDoc <> "92" And strTipoDoc <> "86" And strTipoDoc <> "56" And strTipoDoc <> "40" Then
                If strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "90" Or strTipoDoc = "12" Then
                    Cadmysql = "SELECT idTipoFormaPago,fecVctos  " & _
                                "FROM pagosdocventas m " & _
                                "WHERE m.idempresa ='" & glsEmpresa & "' AND m.idsucursal = '" & glsSucursal & _
                                "' AND m.iddocumento = '" & strTipoDoc & "' AND idserie='" & txt_Serie.Text & "' AND iddocventas = '" & txt_NumDoc.Text & "'"
                    If rsp.State = adStateOpen Then rsp.Close
                    rsp.Open Cadmysql, Cn, adOpenKeyset, adLockOptimistic
                    
                    If Not rsp.EOF Then
                        strEDV = traerCampo("Docventas", "estDocVentas", "idDocventas", txt_NumDoc.Text, True, "idSerie= '" & txt_Serie.Text & "' And idDocumento = '" & strTipoDoc & "' And idSucursal ='" & glsSucursal & "' ")
                        If (strTipoDoc = "01" And strEDV = "GEN") Then
                            mostrarReporte "rptImpPrevioImp.rpt", "parEmpresa|parSucursal|parTipoDoc|parSerie|parDocVentas", glsEmpresa & "|" & glsSucursal & "|" & strTipoDoc & "|" & txt_Serie.Text & "|" & txt_NumDoc.Text, "Factura Venta", StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                          Exit Sub
                        End If
                    
                        imprimeDocVentas strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        csql = "UPDATE docventas " & _
                               "SET estDocventas = 'IMP' where idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
                               "' and idSerie = '" & Trim(txt_Serie.Text) & "' and idEmpresa = '" & glsEmpresa & "'"
                        Cn.Execute csql
                        strEstDocVentas = "IMP"
                        
                        ''Si es factura revisamos si tiene como referencia una guia para modificar su estado
                        If strTipoDoc = "01" Then
                            If gDocReferencia.Count > 0 Then
                                gDocReferencia.Dataset.First
                                Do While Not gDocReferencia.Dataset.EOF
                                    If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                                        numGuia = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                                        serieGuia = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                                        csql = "update docventas set estDocventas = 'IMP' where idDocumento = '86' and idDocVentas = '" & numGuia & "' and idSerie = '" & serieGuia & "' and idEmpresa = '" & glsEmpresa & "' "
                                        Cn.Execute csql
                                        Exit Do
                                    End If
                                    gDocReferencia.Dataset.Next
                                Loop
                            End If
                        End If
                        listaDocVentas StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        If strTipoDoc = "12" Then
                            Toolbar1_ButtonClick Toolbar1.Buttons(1)
                        End If
                    Else
                        StrMsgError = "No se puede Imprimir el documento, necesita enviar a caja el documento. Verifique."
                        If StrMsgError <> "" Then GoTo Err
                    End If
                
                Else
                    strEDV = traerCampo("Docventas", "estDocVentas", "idDocventas", txt_NumDoc.Text, True, "idSerie= '" & txt_Serie.Text & "' And idDocumento = '" & strTipoDoc & "' And idSucursal ='" & glsSucursal & "' ")
                    If (strTipoDoc = "01" And strEDV = "GEN") Then
                        mostrarReporte "rptImpPrevioImp.rpt", "parEmpresa|parSucursal|parTipoDoc|parSerie|parDocVentas", glsEmpresa & "|" & glsSucursal & "|" & strTipoDoc & "|" & txt_Serie.Text & "|" & txt_NumDoc.Text, "Factura Venta", StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                      Exit Sub
                    End If
                
                    imprimeDocVentas strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                    
                    csql = "UPDATE docventas " & _
                           "SET estDocventas = 'IMP' where idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
                           "' and idSerie = '" & Trim(txt_Serie.Text) & "' and idEmpresa = '" & glsEmpresa & "'"
                    Cn.Execute csql
                    strEstDocVentas = "IMP"
                    
                    ''Si es factura revisamos si tiene como referencia una guia para modificar su estado
                    If strTipoDoc = "01" Then
                        If gDocReferencia.Count > 0 Then
                            gDocReferencia.Dataset.First
                            Do While Not gDocReferencia.Dataset.EOF
                                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                                    numGuia = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                                    serieGuia = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                                    csql = "update docventas set estDocventas = 'IMP' where idDocumento = '86' and idDocVentas = '" & numGuia & "' and idSerie = '" & serieGuia & "' and idEmpresa = '" & glsEmpresa & "' "
                                    Cn.Execute csql
                                    Exit Do
                                End If
                                gDocReferencia.Dataset.Next
                            Loop
                        End If
                    End If
                    listaDocVentas StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
    
            Else
                imprimePedidoCotizacion StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
            
            AsientoContableVentas StrMsgError, "I"
            If StrMsgError <> "" Then GoTo Err
            'Si es Ticket Habilitamos los botones x defecto nuevo
            If strTipoDoc = "12" Then
                habilitaBotones 1, StrMsgError
                If StrMsgError <> "" Then GoTo Err
            Else
                habilitaBotones Button.Index, StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        
        Case 8: 'Imprimir Guia Abierta
            imprimeGuiaAbierta strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            habilitaBotones Button.Index, StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
        Case 9: 'Lista
            If CIndEnviarCaja Then
                StrMsgError = "Debe enviar el documento a Caja": GoTo Err
            End If
            
            fraListado.Visible = True
            fraGeneral.Visible = False
            fraDetalle.Visible = False
            fraTotales.Visible = False
            
            habilitaBotones Button.Index, StrMsgError
            If StrMsgError <> "" Then GoTo Err
        
            If Trim(STR_STOCK_POR_LOTE & "") = "S" Then
                Toolbar1.Buttons(15).Visible = False
            End If
            
            listaDocVentas StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
        Case 10: 'Excel
            gLista.m.ExportToXLS App.Path & "\Temporales\Listado.xls"
            ShellEx App.Path & "\Temporales\Listado.xls", essSW_MAXIMIZE, , , "open", Me.hwnd
            
        Case 11: 'Caja
'            stridseriedocREF = "" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
'            strGlsDocREF = "" & gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value
'            stridNumDocREF = "" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
'
'            frmPagosDocVentas.MostrarForm strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, dtp_Emision.Value, StrMsgError, CIndEnviarCaja
'            If StrMsgError <> "" Then GoTo Err
'
'            strEstDocVentas = traerCampo("docventas", "estDocVentas", "idDocumento", strTipoDoc, True, " idSucursal = '" & glsSucursal & "' AND idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "'")
'
'            listaDocVentas StrMsgError
'            If StrMsgError <> "" Then GoTo Err
'
'            habilitaBotones Button.Index, StrMsgError
'            If StrMsgError <> "" Then GoTo Err
            
        Case 12: 'Letras
            frmLetras.MostrarForm strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
            If StrMsgError <> "" Then GoTo Err
        
        Case 13: 'Importar
            frmListaDocExportar.MostrarForm strTipoDoc, txtCod_Cliente.Text, rscd, rsdd, strTipoDocImportado, StrMsgError
            If StrMsgError <> "" Then GoTo Err
            If strTipoDocImportado <> "" Then
                If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "AGRUPAPRODUCTOS", True) = "S" Then
                    mostrarDocImportado rscd, rsdd, strTipoDocImportado, StrMsgError
                Else
                    mostrarDocImportado_SinAgrupar rscd, rsdd, strTipoDocImportado, StrMsgError
                End If
                If StrMsgError <> "" Then GoTo Err
                            
                If frmListaDocExportar.txtCod_Documento.Text <> "40" And frmListaDocExportar.txtCod_Documento.Text <> "92" Then
                    indGeneraVale = False
                Else
                    If frmListaDocExportar.txtCod_Documento.Text = "40" Or frmListaDocExportar.txtCod_Documento.Text = "92" Then
                        indGeneraVale = True
                    End If
                End If
                
                If strTipoDoc = "40" Or strTipoDoc = "92" Then
                    indGeneraVale = False
                Else
                    If strTipoDoc = "07" Then
                        indGeneraVale = True
                    End If
                End If
                    
                If glsSoloGuiaMueveStock Then
                    If strTipoDoc = "86" Then
                        indGeneraVale = True
                    Else
                        indGeneraVale = False
                    End If
                End If
                
                If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "BLOQUEA_DETALLE", True) & "") = "S" Then
                    gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("Cantidad").DisableEditor = False
                    gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("IGVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalVVBruto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalPVBruto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PorDcto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("DctoVV").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("DctoPV").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalVVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalPVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("VVUnitLista").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnitLista").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("VVUnitNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnitNeto").DisableEditor = True
                End If
            End If
            
            '--- Agregado Parametro de IGV
            If strTipoDoc = "07" Then
                If frmListaDocExportar.txtCod_Documento.Text = "01" Then
                    gDocReferencia.Dataset.First
                    If Not gDocReferencia.Dataset.EOF Then
                        ImpSerie = Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value)
                        impNum = Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value)
                                                                                                        
                        csql = "SELECT FecEmision " & _
                               "FROM docventas " & _
                               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                               "AND idDocumento = '01' AND iddocventas = '" & impNum & "' and idSerie = '" & ImpSerie & "' "
                        StrImp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                        If Not StrImp.EOF And Not StrImp.BOF Then
                            PeriodoImp = Format(Trim("" & StrImp.Fields("FecEmision")), "yyyymm")
                            If Trim("" & STR_PERIODO_CAMBIO_IGV) > PeriodoImp Then
                                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
                            Else
                                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
                            End If
                                                                                    
                            gDetalle.Dataset.First
                            Do While Not gDetalle.Dataset.EOF
                                gDetalle.Dataset.Edit
                                calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), gDetalle.Columns.ColumnByFieldName("PorDcto").Value, Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                                gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = Val(Format((gDetalle.Columns.ColumnByFieldName("Cantidad").Value * Val(traerCampo("productos", "idTallaPeso", "idproducto", ("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))), "0.00"))
                                gDetalle.Dataset.Post
                                gDetalle.Dataset.Next
                            Loop
                            
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                        
                        End If
                    End If
                End If
            End If
            Unload frmListaDocExportar
            
        Case 14: 'GRABA TODO
            Graba_Pago_Imprime
             
        Case 15: 'imprimir declaracion jurada
            'procesar_DecJurada StrMsgError
            'If StrMsgError <> "" Then GoTo Err
            
        Case 16: 'Aprobacion
            Aprobacion StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "VALIDA_SEPARACION", True) & "") = "S" Then
                If strTipoDoc = "40" Then
                    RstaValidacion = ""
                    Valida_Aprobacion RstaValidacion
                    If RstaValidacion = "1" Then
                        Toolbar1.Buttons(2).Visible = False 'GRABAR
                        Toolbar1.Buttons(3).Visible = False 'MODIFICAR
                        Toolbar1.Buttons(5).Visible = False 'ELIMINAR
                        Toolbar1.Buttons(6).Visible = True 'ANULAR
                        Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
                        If strTipoDoc = "86" Then
                            Toolbar1.Buttons(8).Visible = True
                        Else
                            Toolbar1.Buttons(8).Visible = False
                        End If
                        Toolbar1.Buttons(11).Visible = True 'PAGOS
                        Toolbar1.Buttons(12).Visible = True 'Letra
                    End If
                End If
            End If
                
        Case 17: 'Quitar Aprobacion
            QuitarAprobacion StrMsgError
            If StrMsgError <> "" Then GoTo Err
            
            habilitaBotones 2, StrMsgError
            If StrMsgError <> "" Then GoTo Err
                
        Case 18: 'Preliminar guia
            If strTipoDoc = "86" Then
                mostrarReporte "rptImpPrevioGuia.rpt", "parEmpresa|parSucursal|parTipoDoc|parSerie|parDocVentas", glsEmpresa & "|" & glsSucursal & "|" & strTipoDoc & "|" & txt_Serie.Text & "|" & txt_NumDoc.Text, "Factura Venta", StrMsgError
                If StrMsgError <> "" Then GoTo Err
            End If
        Case 19: 'Importar Documentos Entre Empresas
            frmListaDocExportarEntreEmpresas.MostrarForm strTipoDoc, txtCod_Cliente.Text, rscd, rsdd, strTipoDocImportado, StrMsgError
            If StrMsgError <> "" Then GoTo Err
            If strTipoDocImportado <> "" Then
                If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "AGRUPAPRODUCTOS", True) = "S" Then
                    mostrarDocImportado_Empresas rscd, rsdd, strTipoDocImportado, StrMsgError
                Else
                    mostrarDocImportado_SinAgrupar rscd, rsdd, strTipoDocImportado, StrMsgError
                End If
                If StrMsgError <> "" Then GoTo Err
                            
                If frmListaDocExportarEntreEmpresas.txtCod_Documento.Text <> "40" And frmListaDocExportar.txtCod_Documento.Text <> "92" Then
                    indGeneraVale = False
                Else
                    If frmListaDocExportarEntreEmpresas.txtCod_Documento.Text = "40" Or frmListaDocExportar.txtCod_Documento.Text = "92" Then
                        indGeneraVale = True
                    End If
                End If
                
                If strTipoDoc = "40" Or strTipoDoc = "92" Then
                    indGeneraVale = False
                Else
                    If strTipoDoc = "07" Then
                        indGeneraVale = True
                    End If
                End If
                    
                If glsSoloGuiaMueveStock Then
                    If strTipoDoc = "86" Then
                        indGeneraVale = True
                    Else
                        indGeneraVale = False
                    End If
                End If
                
                If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "BLOQUEA_DETALLE", True) & "") = "S" Then
                    gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("Cantidad").DisableEditor = False
                    gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("IGVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalVVBruto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalPVBruto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PorDcto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("DctoVV").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("DctoPV").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalVVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("TotalPVNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("VVUnitLista").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnitLista").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("VVUnitNeto").DisableEditor = True
                    gDetalle.Columns.ColumnByFieldName("PVUnitNeto").DisableEditor = True
                End If
            End If
            
            '--- Agregado Parametro de IGV
            If strTipoDoc = "07" Then
                If frmListaDocExportarEntreEmpresas.txtCod_Documento.Text = "01" Then
                    gDocReferencia.Dataset.First
                    If Not gDocReferencia.Dataset.EOF Then
                        ImpSerie = Trim("" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value)
                        impNum = Trim("" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value)
                                                                                                        
                        csql = "SELECT FecEmision " & _
                               "FROM docventas " & _
                               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                               "AND idDocumento = '01' AND iddocventas = '" & impNum & "' and idSerie = '" & ImpSerie & "' "
                        
                        StrImp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                        If Not StrImp.EOF And Not StrImp.BOF Then
                            PeriodoImp = Format(Trim("" & StrImp.Fields("FecEmision")), "yyyymm")
                            If Trim("" & STR_PERIODO_CAMBIO_IGV) > PeriodoImp Then
                                dblIgvNEw = Format(Val(Format(STR_IGV_ANT, "0.00")) / 100, "0.00")
                            Else
                                dblIgvNEw = Format(Val(Format(STR_IGV, "0.00")) / 100, "0.00")
                            End If
                            gDetalle.Dataset.First
                            
                            Do While Not gDetalle.Dataset.EOF
                                gDetalle.Dataset.Edit
                                calculaTotalesFila Val("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value), Val("" & gDetalle.Columns.ColumnByFieldName("VVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("IGVUnit").Value), Val("" & gDetalle.Columns.ColumnByFieldName("PVUnit").Value), gDetalle.Columns.ColumnByFieldName("PorDcto").Value, Val("" & gDetalle.Columns.ColumnByFieldName("Afecto").Value), Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                                gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = Val(Format((gDetalle.Columns.ColumnByFieldName("Cantidad").Value * Val(traerCampo("productos", "idTallaPeso", "idproducto", ("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True))), "0.00"))
                                gDetalle.Dataset.Post
                                gDetalle.Dataset.Next
                            Loop
                            
                            calcularTotales StrMsgError
                            If StrMsgError <> "" Then GoTo Err
                            
                        End If
                    End If
                End If
            End If
            Unload frmListaDocExportarEntreEmpresas
          
        Case 20: 'Preliminar
            'si es electronica
            If Mid(txt_Serie.Text, 1, 1) = "F" Or Mid(txt_Serie.Text, 1, 1) = "B" Then
                'Si es Usuario Jefe
                If traerCampo("usuarios", "indJefe", "idUsuario", glsUser, True) = "1" Then
                    ShellEx leeParametro("CARPETA_XML_VE") & "_LOG\" & strTipoDoc & "-" & txt_Serie.Text & "-" & txt_NumDoc.Text & ".pdf", essSW_MAXIMIZE, , , "open", Me.hwnd
                End If
            Else
                If (strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "07" Or strTipoDoc = "08") Then
                    mostrarReporte "rptPreliminarDocumento.rpt", "parEmpresa|parSucursal|parTipoDoc|parSerie|parDocVentas", glsEmpresa & "|" & glsSucursal & "|" & strTipoDoc & "|" & txt_Serie.Text & "|" & txt_NumDoc.Text, "Preliminar", StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            End If
            
        Case 21:  'Imprime Hoja Blanco
            imprimeDocVentas strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
            If StrMsgError <> "" Then GoTo Err
        
        Case 22:  'Importar Atenciones
            CIdAtencion = ""
            
            FrmImportaAtenciones.MostrarForm StrMsgError, CIdAtencion, txtCod_Cliente.Text
            If StrMsgError <> "" Then GoTo Err
            
            Unload FrmImportaAtenciones
            
            If Len(Trim(CIdAtencion)) > 0 Then
            
                MostrarAtencion StrMsgError, CIdAtencion
                If StrMsgError <> "" Then GoTo Err
            
            End If
        Case 23:  'Documento Electrónico
            If leeParametro("FACTURA_ELECTRONICA_ACEPTA") = "S" Then
                DocumentoElectronicoAceptaFacturaBoleta Me, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, StrMsgError
            Else
                If strTipoDoc = "86" Then
                    DocumentoElectronicoGuia Me, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, StrMsgError
                Else
                    'DocumentoElectronico Me, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, StrMsgError
                    DocumentoElectronico21 Me, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, StrMsgError
                End If
            End If
            If StrMsgError <> "" Then GoTo Err
            
            Toolbar1_ButtonClick Toolbar1.Buttons(9)
            
        Case 24:  'Salir
            If CIndEnviarCaja Then
                StrMsgError = "Debe enviar el documento a Caja": GoTo Err
            End If
            Unload Me
        
    End Select
    
    If TypeName(rscd) <> "Nothing" Then
        If rscd.State = 1 Then rscd.Close: Set rscd = Nothing
        If rsdd.State = 1 Then rsdd.Close: Set rsdd = Nothing
    End If
    
    If Button.Index <> 23 And Button.Index <> 24 Then
    
        If Button.Index = 2 And Toolbar1.Buttons(11).Visible Then
            
            Toolbar1_ButtonClick Toolbar1.Buttons(11)
            
        End If
    
    End If
    
    Exit Sub
    
Err:
    If TypeName(rscd) <> "Nothing" Then
        If rscd.State = 1 Then rscd.Close: Set rscd = Nothing
        If rsdd.State = 1 Then rsdd.Close: Set rsdd = Nothing
    End If
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub QuitarAprobacion(StrMsgError As String)
On Error GoTo Err
Dim rsValida        As New ADODB.Recordset
Dim Cadmysql        As String
Dim indTrans        As Boolean
Dim CodDocventas    As String
Dim SerDocventas    As String
Dim DocDocventas    As String
Dim indDevuelve     As Boolean
Dim strEstreq       As String
Dim indEvaluaEstado As Boolean
    
    indDevuelve = False

    indTrans = True
    Cn.BeginTrans
    
    CodDocventas = ""
    SerDocventas = ""
    DocDocventas = ""
        
    Cadmysql = "Select tipoDocOrigen, numDocOrigen, serieDocOrigen  from docreferencia " & _
               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND tipoDocReferencia = '" & strTipoDoc & "' AND numDocReferencia = '" & Trim("" & txt_NumDoc.Text) & "' AND serieDocReferencia = '" & Trim("" & txt_Serie.Text) & "' "
    rsValida.Open Cadmysql, Cn, adOpenStatic, adLockReadOnly
    If Not rsValida.EOF Then
        rsValida.MoveFirst
        Do While Not rsValida.EOF
            CodDocventas = Trim("" & rsValida.Fields("numDocOrigen"))
            SerDocventas = Trim("" & rsValida.Fields("serieDocOrigen"))
            DocDocventas = Trim("" & rsValida.Fields("tipoDocOrigen"))
            
            indDevuelve = True
            strEstreq = Trim("" & traerCampo("docVentas", "estDocVentas", "idDocventas ", CodDocventas, True, " iDserie= '" & SerDocventas & "' And idDocumento= '" & DocDocventas & "'  And idSucursal = '" & glsSucursal & "'"))
        
            If (strEstreq = "CER" Or strEstreq = "PAR") Then
                indEvaluaEstado = True
            Else
                indEvaluaEstado = False
            End If
            
            If DocDocventas = "87" And indEvaluaEstado = False Then
                Cadmysql = "Delete From Docventas " & _
                           "where iddocventas = '" & Trim("" & rsValida.Fields("numDocOrigen")) & "' and iddocumento = '" & Trim("" & rsValida.Fields("tipoDocOrigen")) & "' and idserie = '" & Trim("" & rsValida.Fields("serieDocOrigen")) & "' " & _
                           "and idempresa = '" & glsEmpresa & "' and idSucursal = '" & glsSucursal & "' "
                Cn.Execute (Cadmysql)
                
                Cadmysql = "Delete From DocventasDet " & _
                           "where iddocventas = '" & Trim("" & rsValida.Fields("numDocOrigen")) & "' and iddocumento = '" & Trim("" & rsValida.Fields("tipoDocOrigen")) & "' and idserie = '" & Trim("" & rsValida.Fields("serieDocOrigen")) & "' " & _
                           "and idempresa = '" & glsEmpresa & "' and idSucursal = '" & glsSucursal & "' "
                Cn.Execute (Cadmysql)
            
                Cadmysql = "UPDATE docventas SET indAprobado = '0' " & _
                            "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' AND idSerie = '" & Trim("" & txt_Serie.Text) & "' "
                Cn.Execute (Cadmysql)
            
                Cadmysql = "DELETE FROM docreferencia " & _
                            "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND tipoDocOrigen = '" & Trim("" & rsValida.Fields("tipoDocOrigen")) & "' AND numDocOrigen = '" & Trim("" & rsValida.Fields("numDocOrigen")) & "' AND serieDocOrigen = '" & Trim("" & rsValida.Fields("serieDocOrigen")) & "' "
                Cn.Execute (Cadmysql)
            End If
            rsValida.MoveNext
        Loop
    End If
    
    If Trim("" & traerCampo("Docventas", "indAprobado", "idDocventas", txt_NumDoc.Text, True, "idSucursal ='" & glsSucursal & "' And idSerie='" & txt_Serie.Text & "' ") = "1") Then
        Cadmysql = "UPDATE docventas SET indAprobado = '0' " & _
                   "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' AND idSerie = '" & Trim("" & txt_Serie.Text) & "' "
        Cn.Execute (Cadmysql)
    End If
    rsValida.Close: Set rsValida = Nothing
    
    If indDevuelve = False Then
        gDetalle.Dataset.First
        If Not gDetalle.Dataset.EOF Then
            Do While Not gDetalle.Dataset.EOF
                If (Val(Format(traerCampo("productosalmacen", "Separacion", "idProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value), True, " idAlmacen = '" & Trim(txtCod_Almacen.Text) & "' and idSucursal = '" & glsSucursal & "' "), "0.00"))) >= Val(Format("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value, "0.00")) Then
                    Cadmysql = "Update productosalmacen Set Separacion  = (Separacion - " & Val(Format("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value, "0.00")) & " )   " & _
                               "where idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' " & _
                               "and idEmpresa = '" & glsEmpresa & "' " & _
                               "and idAlmacen = '" & Trim(txtCod_Almacen.Text) & "' " & _
                               "and idSucursal = '" & glsSucursal & "' "
                    Cn.Execute (Cadmysql)
                End If
                gDetalle.Dataset.Next
            Loop
        End If
    End If
    Toolbar1.Buttons(16).Visible = True
    Toolbar1.Buttons(17).Visible = False
    
    Cn.CommitTrans
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    If indTrans Then Cn.RollbackTrans
End Sub

Private Sub Valida_Aprobacion(RstaValidacion As String)
Dim Cadmysql        As String
Dim rsValida        As New ADODB.Recordset

    RstaValidacion = "0"
    Cadmysql = "Select ifnull(indAprobado,'0') as indAprobado  from docventas " & _
               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' AND idSerie = '" & Trim("" & txt_Serie.Text) & "' "
    rsValida.Open Cadmysql, Cn, adOpenStatic, adLockReadOnly
    If Not rsValida.EOF Then
        RstaValidacion = Trim("" & rsValida.Fields("indAprobado"))
    End If
    rsValida.Close: Set rsValida = Nothing
    
    If RstaValidacion = "0" Then
        Cadmysql = "Select tipoDocOrigen, numDocOrigen, serieDocOrigen  from docreferencia " & _
                   "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND tipoDocReferencia = '" & strTipoDoc & "' AND numDocReferencia = '" & Trim("" & txt_NumDoc.Text) & "' AND serieDocReferencia = '" & Trim("" & txt_Serie.Text) & "' "
        rsValida.Open Cadmysql, Cn, adOpenStatic, adLockReadOnly
        If Not rsValida.EOF Then
            RstaValidacion = "1"
        End If
        rsValida.Close: Set rsValida = Nothing
    End If

End Sub

Private Sub Aprobacion(StrMsgError As String)
On Error GoTo Err
Dim swGenera        As Boolean
Dim cantidad        As Boolean
Dim item            As Integer
Dim rsa             As New ADODB.Recordset
Dim Cadmysql        As String
Dim CodDocventas    As String
Dim rst             As New ADODB.Recordset
Dim csql            As String
Dim indTrans        As Boolean
Dim VVUnit          As Double
Dim IGVUnit         As Double
Dim PVUnit          As Double
Dim TotBruto        As Double
Dim TotIGV          As Double
Dim TotVenta        As String
Dim strGlsDocREF    As String
Dim strEstreq       As String
Dim cComproPro      As String
Dim ncantidad       As Double
Dim rstemp          As New ADODB.Recordset

    indTrans = True
    Cn.BeginTrans
    
    cantidad = False
    item = 0
     
    If rsa.State = 1 Then rsa.Close
    rsa.Fields.Append "Item", adInteger, , adFldRowID
    rsa.Fields.Append "idProducto", adVarChar, 8, adFldIsNullable
    rsa.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsa.Fields.Append "Separacion", adDouble, 14, adFldIsNullable
    rsa.Fields.Append "idAlmacen", adChar, 8, adFldIsNullable
    rsa.Fields.Append "idSucursal", adChar, 8, adFldIsNullable
    rsa.Open

    If MsgBox("Está Seguro de la Aprobación", vbQuestion + vbYesNo, App.Title) = vbYes Then
    
    csql = "Select idAlmacen,dd.idDocumento , dd.idDocventas,dd.idSerie, dd.idEmpresa,dd.idSucursal,dd.idProducto,dd.Cantidad From DocventasDet dd Inner Join Docventas d On dd.idEmpresa = d.idEmpresa  And dd.idSucursal = d.idSucursal And dd.idSerie = d.idSerie And dd.idDocventas = d.idDocventas And dd.idDocumento = d.idDocumento " & _
           "Where d.idEmpresa = '" & glsEmpresa & "' And d.idSucursal ='" & glsSucursal & "'  And d.idDocventas = '" & Trim(txt_NumDoc.Text) & "' And d.idSerie ='" & Trim(txt_Serie.Text) & "'  And d.idDocumento = '" & strTipoDoc & "'     "
        If rstemp.State = 1 Then rstemp.Close
        rstemp.Open csql, Cn, adOpenStatic, adLockReadOnly
        If Not rstemp.EOF Then
            rstemp.MoveFirst
            rstemp.Sort = "idProducto"
            Do While Not rstemp.EOF
                cComproPro = rstemp.Fields("idProducto").Value
                Do While cComproPro = rstemp.Fields("idProducto").Value & ""
                    ncantidad = ncantidad + rstemp.Fields("Cantidad").Value
                    rstemp.MoveNext
                    If rstemp.EOF Then Exit Do
                    If cComproPro <> rstemp.Fields("idProducto").Value & "" Then Exit Do
                Loop
                If Val(Format(traerCantSaldo(cComproPro, Trim(txtCod_Almacen.Text), Format(dtp_Emision.Value, "yyyy-mm-dd"), StrMsgError), "0.00")) < Val(Format(ncantidad, "0.00")) Then
                    cantidad = True
                    item = item + 1
                    rsa.AddNew
                    rsa.Fields("Item") = item
                    rsa.Fields("idProducto") = cComproPro
                    rsa.Fields("Cantidad") = ncantidad
                    rsa.Fields("Separacion") = Val(Format(ncantidad, "0.00")) - Val(Format("" & traerCantSaldo(cComproPro, Trim(txtCod_Almacen.Text), Format(dtp_Emision.Value, "yyyy-mm-dd"), StrMsgError), "0.00"))
                    rsa.Fields("idAlmacen") = Trim(txtCod_Almacen.Text)
                    rsa.Fields("idSucursal") = glsSucursal
                    ncantidad = 0
                End If
                ncantidad = 0
            Loop
        Else
            MsgBox ("No hay Detalle Verifique."), vbInformation, App.Title
            Exit Sub
        End If

        If cantidad = True Then
            If Not rsa.EOF Then
                csql = "SELECT MAX(idDocVentas) FROM docventas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '87' AND idSerie = '999' "
                rst.Open csql, Cn, adOpenStatic, adLockReadOnly
                If Not rst.EOF Then
                    CodDocventas = Format(Val("" & rst.Fields(0)) + 1, "00000000")
                Else
                    CodDocventas = "00000001"
                End If
                rst.Close: Set rst = Nothing
                
                TotBruto = 0#
                TotIGV = 0#
                TotVenta = 0#
                        
                rsa.MoveFirst
                Do While Not rsa.EOF
                    VVUnit = 0#
                    IGVUnit = 0#
                    PVUnit = 0#
                
                    Cadmysql = "select a.idmoneda,b.VVUnit, b.IGVUnit, b.PVUnit  from docventas a " & _
                               "inner join docventasdet b " & _
                               "on a.iddocventas = b.iddocventas " & _
                               "and a.idserie = b.idserie " & _
                               "and a.iddocumento = b.iddocumento " & _
                               "and a.idempresa = b.idempresa " & _
                               "and a.idsucursal = b.idsucursal " & _
                               "where a.idempresa = '" & glsEmpresa & "' " & _
                               "and a.idsucursal = '" & glsSucursal & "' " & _
                               "and a.iddocumento = '94' " & _
                               "and idproducto = '" & ("" & rsa.Fields("idProducto")) & "'  " & _
                               "order by a.fecemision desc  Limit 1 "
                    rst.Open Cadmysql, Cn, adOpenStatic, adLockReadOnly
                    If Not rst.EOF Then
                        If txtCod_Moneda.Text = "PEN" Then
                            If Trim("" & rst.Fields("idMoneda")) = "PEN" Then
                                VVUnit = Val(Format(rst.Fields("VVUnit"), "0.00"))
                                IGVUnit = Val(Format(rst.Fields("IGVUnit"), "0.00"))
                                PVUnit = Val(Format(rst.Fields("PVUnit"), "0.00"))
                            Else
                                VVUnit = Val(Format((Val(Format(rst.Fields("VVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                                IGVUnit = Val(Format((Val(Format(rst.Fields("IGVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                                PVUnit = Val(Format((Val(Format(rst.Fields("PVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                            End If
                        Else
                            If Trim("" & rst.Fields("idMoneda")) = "USD" Then
                                VVUnit = Val(Format(rst.Fields("VVUnit"), "0.00"))
                                IGVUnit = Val(Format(rst.Fields("IGVUnit"), "0.00"))
                                PVUnit = Val(Format(rst.Fields("PVUnit"), "0.00"))
                            Else
                                VVUnit = Val(Format((Val(Format(rst.Fields("VVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                                IGVUnit = Val(Format((Val(Format(rst.Fields("IGVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                                PVUnit = Val(Format((Val(Format(rst.Fields("PVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                            End If
                        End If
                                 
                    Else
                        VVUnit = 0#
                        IGVUnit = 0#
                        PVUnit = 0#
                    End If
                    rst.Close: Set rst = Nothing
                    
                    TotBruto = TotBruto + Val(Format((Val(Format(rsa.Fields("Separacion"), "0.00")) * VVUnit), "0.00"))
                    TotIGV = TotIGV + Val(Format((Val(Format(rsa.Fields("Separacion"), "0.00")) * IGVUnit), "0.00"))
                    TotVenta = TotVenta + Val(Format((Val(Format(rsa.Fields("Separacion"), "0.00")) * PVUnit), "0.00"))
                                       
                    Cadmysql = "Insert Into DocventasDet (idDocumento, idDocVentas, idSerie, idProducto, GlsProducto, idMarca, idUM, Factor, Afecto, cantidad, VVUnit, IGVUnit, PVUnit, TotalVVBruto, TotalPVBruto, PorDcto, DctoVV, DctoPV, TotalVVNeto, TotalIGVNeto, TotalPVNeto, item, GlsMarca, GlsUM, idTipoProducto, idMoneda, idCodFabricante, idEmpresa, idSucursal, estDocImportado, idDocumentoImp, idDocVentasImp, idSerieImp, NumLote, FecVencProd, idUsuarioDcto, VVUnitLista, PVUnitLista, CantidadImp, VVUnitNeto, PVUnitNeto, Cantidad2, CodigoRapido, idTallaPeso,cantidadAnt) " & _
                               "Select '87' as idDocumento ,'" & CodDocventas & "' as idDocVentas, '999' as idSerie," & _
                               "idProducto , GlsProducto, idMarca, idUM, Factor, " & _
                               "Afecto, " & Val(Format(rsa.Fields("Separacion"), "0.00")) & " as cantidad," & _
                               " " & VVUnit & " as VVUnit, " & IGVUnit & " as IGVUnit, " & PVUnit & " as PVUnit, " & _
                               " " & Val(Format(rsa.Fields("Separacion"), "0.00")) * VVUnit & "  as TotalVVBruto, " & Val(Format(rsa.Fields("Separacion"), "0.00")) * PVUnit & " as TotalPVBruto, 0 as PorDcto, 0 as DctoVV, 0 as DctoPV, " & _
                               " " & Val(Format(rsa.Fields("Separacion"), "0.00")) * VVUnit & " as TotalVVNeto, " & (Val(Format(rsa.Fields("Separacion"), "0.00")) * VVUnit) * dblIgvNEw & " as TotalIGVNeto, " & Val(Format(rsa.Fields("Separacion"), "0.00")) * PVUnit & " as TotalPVNeto, '" & rsa.Fields("item") & "' as   item , GlsMarca, GlsUM, idTipoProducto, idMoneda, idCodFabricante, idEmpresa, idSucursal, estDocImportado, idDocumentoImp, idDocVentasImp, idSerieImp, NumLote, FecVencProd, idUsuarioDcto, VVUnitLista, PVUnitLista, CantidadImp, " & VVUnit & " as VVUnitNeto, " & PVUnit & " as PVUnitNeto, Cantidad2, CodigoRapido, idTallaPeso,0 " & _
                               "From DocventasDet " & _
                               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' " & _
                               "AND idSerie = '" & Trim("" & txt_Serie.Text) & "'  and idproducto = '" & ("" & rsa.Fields("idProducto")) & "'   LIMIT 1"
                   Cn.Execute (Cadmysql)
                                
                    rsa.MoveNext
                Loop
                
                strGlsDocREF = traerCampo("Documentos", "AbreDocumento", "idDocumento", strTipoDoc, False) & Space(1) & Trim(txt_Serie.Text) & "-" & Trim(txt_NumDoc.Text)
                
                Cadmysql = "Insert Into Docventas(idDocumento, idDocVentas, idSerie, idPerCliente, GlsCliente, RUCCliente, dirCliente, idAlmacen, idPerVendedor, " & _
                           "FecEmision, estDocVentas, TotalValorVenta, TotalIGVVenta, TotalPrecioVenta, idMoneda, TipoCambio, ObsDocVentas, " & _
                           "Partida, llegada, idPerChofer, glsChofer, idPerEmpTrans, GlsEmpTrans, idVehiculo, GlsVehiculo, Placa, Marca, Color, " & _
                           "Modelo, CodInsCrip, Bultos, Brevete, idLista, GlsVendedor, idMotivoTraslado, GlsFormasPago, GlsFecVectos, " & _
                           "idMotivoNCD, GlsMotivoNCD, totalLetras, FecIniTraslado, rucEmpTrans, FecPago, GlsDocReferencia, simboloMonBruto, " & _
                           "simboloMonIGV, simboloMonNeto, indVale, idValesCab, idEmpresa, idSucursal, idCentroCosto, GlsCentroCosto, " & _
                           "estDocImportado, idMovCaja, idPerVendedorCampo, GlsVendedorCampo, TotalDsctoVV, TotalDsctoPV, TotalExonerado, " & _
                           "TotalBaseImponible, estGuiaImportado, idTipoTicket, idUsuarioAnulacion, FecRegistro, idUsuarioReg, Partida2, " & _
                           "Llegada2, numOrdenCompra, idValeCabRec, indAprobado, ComisionVtas, indLetra, idupp, idFormaPago, indTrasladoConta, " & _
                           "glsFormaPago, vtercerosCliente, vtercerosdireccion, vterceroCodigo, vterceroRuc, IndReq, IdContacto, GlsMoneda, " & _
                           "indTrasladoContaFin, IdPerVendedorCampo_Ant, idProvCliente, ObsDocVentas2, idtienda ) " & _
                           "Select '87' as idDocumento ,'" & CodDocventas & "' as idDocVentas, '999' as idSerie, idPerCliente, GlsCliente, RucCliente, dirCliente, idAlmacen, idPerVendedor, " & _
                           "fecEmision , estDocVentas, " & _
                           " " & TotBruto & " as TotalValorVenta, " & TotIGV & " as TotalIGVVenta, " & TotVenta & " as TotalPrecioVenta, idMoneda, TipoCambio, obsdocventas, Partida, llegada, idPerChofer, glsChofer, idPerEmpTrans, GlsEmpTrans, idVehiculo, GlsVehiculo, Placa, Marca, Color, Modelo, CodInsCrip, Bultos, Brevete, idLista, GlsVendedor, idMotivoTraslado, GlsFormasPago, GlsFecVectos, idMotivoNCD, GlsMotivoNCD, totalLetras, FecIniTraslado, rucEmpTrans, FecPago, '" & strGlsDocREF & "', simboloMonBruto, simboloMonIGV, simboloMonNeto, indVale, idValesCab, idEmpresa, idSucursal, idCentroCosto, GlsCentroCosto, estDocImportado, idmovcaja, idPerVendedorCampo, GlsVendedorCampo, " & _
                           " 0 as TotalDsctoVV, 0 as TotalDsctoPV, 0 as TotalExonerado, " & TotBruto & " as  TotalBaseImponible, estGuiaImportado, idTipoTicket, idUsuarioAnulacion, FecRegistro, idUsuarioReg, Partida2, Llegada2, numOrdenCompra, idValeCabRec, indAprobado, ComisionVtas, indLetra, idupp, idFormaPago, " & _
                           "indTrasladoConta , glsFormaPago, vtercerosCliente, vtercerosdireccion, vterceroCodigo, vterceroRuc, IndReq, IdContacto, GlsMoneda,indTrasladoContaFin,IdPerVendedorCampo_Ant,idProvCliente,ObsDocVentas2,idtienda " & _
                           "From Docventas " & _
                           "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' AND idSerie = '" & Trim("" & txt_Serie.Text) & "' "
                           
                Cn.Execute (Cadmysql)
            End If
            
            Cadmysql = "Insert Into docreferencia(tipoDocOrigen, numDocOrigen, serieDocOrigen, tipoDocReferencia, numDocReferencia, serieDocReferencia, " & _
                       "Item, idEmpresa, idSucursal, idSucursalReferencia )" & _
                       "Select '87' as tipoDocOrigen,'" & CodDocventas & "' AS numDocOrigen,'999' as serieDocOrigen,'" & Trim("" & strTipoDoc) & "' as tipoDocReferencia, " & _
                       "'" & Trim("" & txt_NumDoc.Text) & "' as numDocReferencia,'" & Trim("" & txt_Serie.Text) & "' as serieDocReferencia, " & _
                       "'1' as item,'" & glsEmpresa & "','" & glsSucursal & "','' "
            Cn.Execute (Cadmysql)
            
            MsgBox ("Su pedido no ha sido Aceptado. Se ha generado el Requerimiento de Compra Nº " & CodDocventas & " por la Cantidad Restante."), vbInformation, App.Title
            
        Else
            gDetalle.Dataset.First
            If Not gDetalle.Dataset.EOF Then
                gDetalle.Dataset.First
                Do While Not gDetalle.Dataset.EOF
                    
                    Cadmysql = "Update productosalmacen Set Separacion  =(Separacion + " & Val(Format("" & gDetalle.Columns.ColumnByFieldName("Cantidad").Value, "0.00")) & ") " & _
                               "where idProducto = '" & Trim("" & gDetalle.Columns.ColumnByFieldName("idProducto").Value) & "' " & _
                               "and idEmpresa = '" & glsEmpresa & "' " & _
                               "and idAlmacen = '" & Trim(txtCod_Almacen.Text) & "' " & _
                               "and idSucursal = '" & glsSucursal & "' "
                    Cn.Execute (Cadmysql)
                
                    gDetalle.Dataset.Next
                Loop
                
                Cadmysql = "UPDATE docventas SET indAprobado = '1' " & _
                           "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' AND idSerie = '" & Trim("" & txt_Serie.Text) & "' "
                Cn.Execute (Cadmysql)
                
                MsgBox ("Su pedido ha sido Aceptado."), vbInformation, App.Title
            End If
        End If
    End If
    
    Toolbar1.Buttons(16).Visible = False
    Toolbar1.Buttons(17).Visible = True
    
    Cn.CommitTrans
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    If indTrans Then Cn.RollbackTrans
    Exit Sub
End Sub

'Private Sub procesar_DecJurada(ByRef StrMsgError As String)
'On Error GoTo Err
'Dim xl          As Word.Application
'Dim rsTemp      As New ADODB.Recordset
'Dim rsTemp1     As New ADODB.Recordset
'Dim varGlsEmpresa           As String
'Dim varGlsDireccion         As String
'Dim varGlsRepresentante     As String
'Dim varGlsCargo             As String
'Dim varGlsRuc               As String
'Dim varidpersona            As String
'Dim VarDniRepresentante     As String
'Dim item                    As Integer
'
'    On Error GoTo wordNoAbierto
'    Set xl = GetObject(, "Word.Application")
'    GoTo YaEstabaAbierto
'wordNoAbierto:
'    Set xl = New Word.Application
'YaEstabaAbierto:
'    xl.Documents.Add Template:= _
'    App.Path & "\Temporales\declaracionjurada.dot" _
'    , NewTemplate:=False, DocumentType:=0
'
'    varGlsEmpresa = traerCampo("empresas", "glsempresa", "idempresa", glsEmpresa, False)
'    varGlsDireccion = traerCampo("personas", "Direccion", "idpersona", "08090001", False)
'    varGlsRepresentante = traerCampo("Empresas", "GlsRepresentante", "idempresa", glsEmpresa, False)
'    varGlsCargo = traerCampo("Empresas", "GlsCargo", "idempresa", glsEmpresa, False)
'    varGlsRuc = traerCampo("Empresas", "ruc", "idempresa", glsEmpresa, False)
'    varidpersona = traerCampo("Empresas", "idRepresentante", "idempresa", glsEmpresa, False)
'    VarDniRepresentante = traerCampo("personas", "ruc", "idpersona", varidpersona, False)
'
'    csql = " Select d.RUCCliente,d.GlsCliente,p.GlsProducto,Concat(d.idserie,'-',d.iddocventas) as NumDcto, " & _
'           " DATE_FORMAT(d.FecEmision,'%d/%m/%Y') as FecEmision,Sum(v.cantidad) as Cantidad,u.abreUM " & _
'           " from docventas d " & _
'           " inner join docreferencia r on d.idempresa = r.idempresa  and d.iddocventas = r.numDocOrigen and d.idserie =  r.serieDocOrigen " & _
'           " and d.iddocumento = r.tipoDocOrigen inner join docventas d2 " & _
'           " on d.idempresa = r.idempresa and d.idsucursal = r.idsucursal and d2.iddocventas = r.numDocReferencia " & _
'           " and d2.idserie = r.serieDocReferencia and d2.iddocumento = r.tipoDocReferencia inner join valesdet v " & _
'           " on v.idempresa = d2.idempresa and v.idsucursal = d2.idsucursal and v.idvalescab = d2.idvalescab " & _
'           " inner join productos p on p.idproducto = v.idproducto and p.idempresa = v.idempresa " & _
'           " inner join unidadmedida u on u.idum = p.idumVenta Where D.iddocventas = '" & txt_numdoc.Text & "' " & _
'           " and d.iddocumento = '" & strTipoDoc & "' and d.idserie = '" & txt_serie.Text & "' and d.idempresa = '" & glsEmpresa & "' " & _
'           " and d.idsucursal = '" & glsSucursal & _
'           "' group by v.idproducto "
'
'    If rsTemp.State = 1 Then rsTemp.Close
'    rsTemp.Open csql, Cn, adOpenStatic, adLockReadOnly
'
'    item = 0
'    If Not rsTemp.EOF Then
'        rsTemp.MoveFirst
'        Do While Not rsTemp.EOF
'
'            xl.Selection.Find.ClearFormatting
'            xl.Selection.Find.Replacement.ClearFormatting
'            With xl.Selection.Find
'                .Text = "<<GlsCliente>>"
'                .Replacement.Text = Trim("" & rsTemp.Fields("GlsCliente"))
'                .Forward = True
'                .Wrap = wdFindAsk
'                .Format = False
'                .MatchCase = False
'                .MatchWholeWord = False
'                .MatchWildcards = False
'                .MatchSoundsLike = False
'                .MatchAllWordForms = False
'            End With
'            xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'            xl.Selection.Find.ClearFormatting
'            xl.Selection.Find.Replacement.ClearFormatting
'            With xl.Selection.Find
'                .Text = "<<RUCcliente>>"
'                .Replacement.Text = Trim("" & rsTemp.Fields("RUCCliente"))
'                .Forward = True
'                .Wrap = wdFindAsk
'                .Format = False
'                .MatchCase = False
'                .MatchWholeWord = False
'                .MatchWildcards = False
'                .MatchSoundsLike = False
'                .MatchAllWordForms = False
'            End With
'            xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'            xl.Selection.Find.ClearFormatting
'            With xl.Selection.Find
'                .Text = "<<D>>"
'                .Replacement.Text = ""
'                .Forward = True
'                .Wrap = wdFindContinue
'                .Format = False
'                .MatchCase = False
'                .MatchWholeWord = False
'                .MatchWildcards = False
'                .MatchSoundsLike = False
'                .MatchAllWordForms = False
'            End With
'
'            item = item + 1
'            xl.Selection.Find.Execute
'            xl.Selection.TypeText Text:=item
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp.Fields("glsproducto"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp.Fields("NumDcto"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp.Fields("FecEmision"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Format(Trim("" & rsTemp.Fields("Cantidad")), "0.00")
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp.Fields("Abreum"))
'
'            rsTemp.MoveNext
'            If rsTemp.EOF Then
'                Exit Do
'            Else
'                xl.Selection.InsertRowsBelow 1
'                xl.Selection.MoveLeft Unit:=wdCharacter, Count:=1
'            End If
'        Loop
'    End If
'
'    csql = " Select p.GlsProducto,u.abreUM,id.Cantidad as Cantidad, ic.OrdDespacho as NumDcto, " & _
'         " l.GlsLote,DATE_FORMAT(ic.Fec_Numeracion,'%d/%m/%Y') as FecEmision " & _
'         " from docventas d inner join docreferencia r on d.idempresa = r.idempresa and d.iddocventas = r.numDocOrigen " & _
'         " and d.idserie =  r.serieDocOrigen and d.iddocumento = r.tipoDocOrigen inner join docventas d2 on d.idempresa = r.idempresa " & _
'         " and d.idsucursal = r.idsucursal and d2.iddocventas = r.numDocReferencia and d2.idserie = r.serieDocReferencia " & _
'         " and d2.iddocumento = r.tipoDocReferencia inner join valesdet v on v.idempresa = d2.idempresa and v.idsucursal = d2.idsucursal " & _
'         " and v.idvalescab = d2.idvalescab inner join productos p on p.idproducto = v.idproducto and p.idempresa = v.idempresa " & _
'         " inner join unidadmedida u on u.idum = p.idumVenta inner join lotes l on v.idlote = l.idlote and v.idempresa = l.idempresa " & _
'         " and v.idsucursal = l.idsucursal " & _
'         "inner join importacionescab ic " & _
'         " on ic.NroDua = l.GlsLote " & _
'         " and ic.idempresa = l.idempresa " & _
'         " inner join importacionesdet id " & _
'         " on id.NroImportacion = ic.NroImportacion " & _
'         " and id.idempresa = ic.idempresa " & _
'         " and id.idproducto = v.idproducto " & _
'         " Where D.iddocventas = '" & txt_numdoc.Text & "' " & _
'         " and d.iddocumento = '" & strTipoDoc & "' " & _
'         " and d.idserie = '" & txt_serie.Text & "' " & _
'         " and d.idempresa = '" & glsEmpresa & "' " & _
'         " and d.idsucursal = '" & glsSucursal & "' " & _
'         " group by v.idlote,v.idproducto "
'    If rsTemp1.State = 1 Then rsTemp1.Close
'    rsTemp1.Open csql, Cn, adOpenStatic, adLockReadOnly
'
'    item = 0
'    If Not rsTemp1.EOF Then
'        rsTemp1.MoveFirst
'        Do While Not rsTemp1.EOF
'            xl.Selection.Find.ClearFormatting
'            With xl.Selection.Find
'                .Text = "<<F>>"
'                .Replacement.Text = ""
'                .Forward = True
'                .Wrap = wdFindContinue
'                .Format = False
'                .MatchCase = False
'                .MatchWholeWord = False
'                .MatchWildcards = False
'                .MatchSoundsLike = False
'                .MatchAllWordForms = False
'            End With
'
'            item = item + 1
'            xl.Selection.Find.Execute
'            xl.Selection.TypeText Text:=item
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp1.Fields("glsproducto"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp1.Fields("abreum"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Format(Trim("" & rsTemp1.Fields("Cantidad")), "0.00")
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp1.Fields("Glslote"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp1.Fields("NumDcto"))
'            xl.Selection.MoveRight Unit:=wdCell
'            xl.Selection.TypeText Text:=Trim("" & rsTemp1.Fields("FecEmision"))
'
'            rsTemp1.MoveNext
'            If rsTemp1.EOF Then
'                Exit Do
'            Else
'                xl.Selection.InsertRowsBelow 1
'                xl.Selection.MoveLeft Unit:=wdCharacter, Count:=1
'            End If
'        Loop
'    End If
'
'    varGlsEmpresa = traerCampo("empresas", "glsempresa", "idempresa", glsEmpresa, False)
'    varGlsDireccion = traerCampo("personas", "Direccion", "idpersona", "08090001", False)
'    varGlsRepresentante = traerCampo("Empresas", "GlsRepresentante", "idempresa", glsEmpresa, False)
'    varGlsCargo = traerCampo("Empresas", "GlsCargo", "idempresa", glsEmpresa, False)
'    varGlsRuc = traerCampo("Empresas", "ruc", "idempresa", glsEmpresa, False)
'    varidpersona = traerCampo("Empresas", "idRepresentante", "idempresa", glsEmpresa, False)
'    VarDniRepresentante = traerCampo("personas", "ruc", "idpersona", varidpersona, False)
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<RUC>>"
'        .Replacement.Text = varGlsRuc
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<GlsEmpresa>>"
'        .Replacement.Text = varGlsEmpresa
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<Direccion>>"
'        .Replacement.Text = varGlsDireccion
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<GlsRepresentante>>"
'        .Replacement.Text = varGlsRepresentante
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<GlsDni>>"
'        .Replacement.Text = VarDniRepresentante
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Selection.Find.ClearFormatting
'    xl.Selection.Find.Replacement.ClearFormatting
'    With xl.Selection.Find
'        .Text = "<<Cargo>>"
'        .Replacement.Text = varGlsCargo
'        .Forward = True
'        .Wrap = wdFindAsk
'        .Format = False
'        .MatchCase = False
'        .MatchWholeWord = False
'        .MatchWildcards = False
'        .MatchSoundsLike = False
'        .MatchAllWordForms = False
'    End With
'    xl.Selection.Find.Execute Replace:=wdReplaceAll
'
'    xl.Visible = True
'
'    Exit Sub
'
'Err:
'    If StrMsgError = "" Then StrMsgError = Err.Description
'End Sub

Private Sub habilitaBotones(indexBoton As Integer, StrMsgError As String)
On Error GoTo Err

    Select Case indexBoton
        Case 1 'Nuevo Modificar ' ES LO CONTRARIO DE 2
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(13).Visible = False ''graba todo
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            Toolbar1.Buttons(8).Visible = False
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(19).Visible = False
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            If STR_IMPORTA_ATENCIONES = "1" Then Toolbar1.Buttons(22).Visible = False
            If ccodparamemp = "S" Then
                Toolbar1.Buttons(19).Visible = False
            End If
            
        Case 2, 7 'Grabar
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = True
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
                Toolbar1.Buttons(18).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            If strTipoDoc = "86" Then 'Guia------Or strTipoDoc = "40" Pedido
                Toolbar1.Buttons(11).Visible = False 'Caja
                Toolbar1.Buttons(12).Visible = False
            Else
                Toolbar1.Buttons(11).Visible = False
                If strTipoDoc = "92" Then
                    Toolbar1.Buttons(11).Visible = False
                End If 'Caja
                Toolbar1.Buttons(12).Visible = False
                Toolbar1.Buttons(7).Visible = False
                Toolbar1.Buttons(20).Visible = False
                Toolbar1.Buttons(21).Visible = False
                
            End If
            Toolbar1.Buttons(13).Visible = False
            
            If ccodparamemp = "S" Then
                Toolbar1.Buttons(19).Visible = False
            Else
                Toolbar1.Buttons(19).Visible = False
            End If
            ocultarColumnasEstado
            
            If strTipoDoc = "40" And STR_APRUEBA_PEDIDO_AUTOMATICO = "1" Then
                Toolbar1.Buttons(3).Visible = False
                Toolbar1.Buttons(5).Visible = False
                Toolbar1.Buttons(6).Visible = False
            End If
            
            Toolbar1.Buttons(22).Visible = False
            
        Case 3 'Modificar
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            Toolbar1.Buttons(19).Visible = False
            If ccodparamemp = "S" Then
                Toolbar1.Buttons(19).Visible = False
            End If
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            If STR_IMPORTA_ATENCIONES = "1" Then Toolbar1.Buttons(22).Visible = False
            ocultarColumnasEstado
            
        Case 4 'Cancelar
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(13).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            If strTipoDoc = "92" Then
                Toolbar1.Buttons(11).Visible = False
            End If
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            If ccodparamemp = "S" Then
                Toolbar1.Buttons(19).Visible = False
            Else
                Toolbar1.Buttons(19).Visible = False
            End If
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            Toolbar1.Buttons(22).Visible = False
            ocultarColumnasEstado
            
        Case 5 'Eliminar
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            Toolbar1.Buttons(8).Visible = False
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(18).Visible = False
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            If STR_IMPORTA_ATENCIONES = "1" Then Toolbar1.Buttons(22).Visible = False
            ocultarColumnasEstado
            
        Case 6 'Anular
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            Toolbar1.Buttons(8).Visible = False
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            Toolbar1.Buttons(22).Visible = False
            ocultarColumnasEstado
'        Case 7 'Imprimir
'            Toolbar1.Buttons(1).Visible = False
'            Toolbar1.Buttons(2).Visible = False
'            If glsGrabaTodo = "S" Then
'                Toolbar1.Buttons(14).Visible = False
'            End If
'            Toolbar1.Buttons(3).Visible = False
'            Toolbar1.Buttons(4).Visible = False
'            Toolbar1.Buttons(5).Visible = False
'            Toolbar1.Buttons(6).Visible = False
'            Toolbar1.Buttons(7).Visible = False
'            If strTipoDoc = "86" Then
'                Toolbar1.Buttons(8).Visible = False
'                Toolbar1.Buttons(18).Visible = False
'            Else
'                Toolbar1.Buttons(8).Visible = False
'            End If
'            Toolbar1.Buttons(9).Visible = False
'            Toolbar1.Buttons(10).Visible = False
'            Toolbar1.Buttons(11).Visible = False
'            Toolbar1.Buttons(12).Visible = False
'            Toolbar1.Buttons(20).Visible = False
'            Toolbar1.Buttons(21).Visible = False
'            Toolbar1.Buttons(22).Visible = False
            
        Case 8 'Imprimir Guia Abierta
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
                Toolbar1.Buttons(18).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            Toolbar1.Buttons(22).Visible = False
            
        Case 9 'Lista
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            Toolbar1.Buttons(8).Visible = False
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            If strTipoDoc = "92" Then
                Toolbar1.Buttons(11).Visible = False
            End If
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(13).Visible = False
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(18).Visible = False
            If ccodparamemp = "S" Then
                Toolbar1.Buttons(19).Visible = False
            Else
                Toolbar1.Buttons(19).Visible = False
            End If
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            Toolbar1.Buttons(22).Visible = False
            
        Case 11, 12
            Toolbar1.Buttons(1).Visible = False
            Toolbar1.Buttons(2).Visible = False
            If glsGrabaTodo = "S" Then
                Toolbar1.Buttons(14).Visible = False ' GRABA TODO
            End If
            Toolbar1.Buttons(3).Visible = False
            Toolbar1.Buttons(4).Visible = False
            Toolbar1.Buttons(5).Visible = False
            Toolbar1.Buttons(6).Visible = False
            Toolbar1.Buttons(7).Visible = False
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
                Toolbar1.Buttons(18).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(9).Visible = False
            Toolbar1.Buttons(10).Visible = False
            Toolbar1.Buttons(11).Visible = False
            If strTipoDoc = "92" Then
                Toolbar1.Buttons(11).Visible = False
            End If
            Toolbar1.Buttons(12).Visible = False
            Toolbar1.Buttons(20).Visible = False
            Toolbar1.Buttons(21).Visible = False
            Toolbar1.Buttons(22).Visible = False
            ocultarColumnasEstado
    End Select

    Select Case strTipoDoc
        Case "86"
            Toolbar1.Buttons(11).Visible = False
            Toolbar1.Buttons(12).Visible = False
    End Select
    
'    If STR_VENTA_ELECTRONICA = "S" Then
'        If (strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "07" Or strTipoDoc = "08" Or strTipoDoc = "12" Or strTipoDoc = "86") And Not IsNumeric(left(txt_Serie.Text, 1)) Then
'            Toolbar1.Buttons(23).Visible = Toolbar1.Buttons(7).Visible
'            If Toolbar1.Buttons(23).Visible Then
'                If Val("" & traerCampo("DocVentas", "IndAceptadoSunat", "IdDocumento", strTipoDoc, True, "IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'")) = 1 Or Val("" & traerCampo("DocVentas", "IndEnviadoSunat", "IdDocumento", strTipoDoc, True, "IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'")) = 1 Then
'                    Toolbar1.Buttons(23).Visible = False
'
'                    Toolbar1.Buttons(2).Visible = False 'GRABAR
'                    Toolbar1.Buttons(3).Visible = False 'MODIFICAR
'                    Toolbar1.Buttons(5).Visible = False 'ELIMINAR
'                    Toolbar1.Buttons(6).Visible = True 'ANULAR
'                    Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
'                    Toolbar1.Buttons(8).Visible = False
'                    Toolbar1.Buttons(11).Visible = True 'PAGOS
'                    Toolbar1.Buttons(12).Visible = True 'Letra
'                    Toolbar1.Buttons(16).Visible = False
'                    Toolbar1.Buttons(17).Visible = False
'                    Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
'                    Toolbar1.Buttons(21).Visible = False 'IMPRIME HOJA BLANCO
'                End If
'            End If
'
'        Else
'            Toolbar1.Buttons(23).Visible = False
'        End If
'    Else
'        Toolbar1.Buttons(23).Visible = False
'    End If
'    ValidaPermisos StrMsgError, indexBoton
'    If StrMsgError <> "" Then GoTo Err
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub ValidaPermisos(StrMsgError As String, PIndexBoton As Integer)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
Dim IndRegistra                     As Boolean

    '2 Grabar,4 Cancelar,9 Lista
    
    IndRegistra = False
    
    If leeParametro("VALIDA_PERMISOS") = "S" And strTipoDoc = "07" Then 'Por mientras sólo para Nota de Crédito
        
        If PIndexBoton = 1 Or PIndexBoton = 2 Or PIndexBoton = 3 Or PIndexBoton = 4 Or PIndexBoton = 5 Or PIndexBoton = 6 Or PIndexBoton = 9 Then
            
            Toolbar1.Buttons(1).Visible = False 'Nuevo
            Toolbar1.Buttons(2).Visible = False 'Grabar
            Toolbar1.Buttons(3).Visible = False 'Modificar
            Toolbar1.Buttons(5).Visible = False 'Eliminar
            Toolbar1.Buttons(6).Visible = False 'Anular
            Toolbar1.Buttons(7).Visible = False 'Imprimir
        
        End If
        
        CSqlC = "Select A.IdPermiso " & _
                "From PermisosUsuarios A " & _
                "Where A.IdEmpresa = '" & glsEmpresa & "' And A.CodSistema = '" & StrcodSistema & "' And A.IdUsuario = '" & glsUser & "'"
        AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
        Do While Not RsC.EOF
            
            If PIndexBoton = 1 Then
                
                Select Case Trim("" & RsC.Fields("IdPermiso"))
                    Case "23"
                        Toolbar1.Buttons(2).Visible = True
                End Select
                
            ElseIf PIndexBoton = 2 Or PIndexBoton = 4 Then
                
                Select Case Trim("" & RsC.Fields("IdPermiso"))
                    Case "23"
                        Toolbar1.Buttons(1).Visible = True
                        Toolbar1.Buttons(3).Visible = True
                    Case "24"
                        Toolbar1.Buttons(5).Visible = True
                    Case "25"
                        Toolbar1.Buttons(6).Visible = True
                    Case "26"
                        Toolbar1.Buttons(7).Visible = True
                End Select
            
            ElseIf PIndexBoton = 3 Then
                
                Select Case Trim("" & RsC.Fields("IdPermiso"))
                    Case "23"
                        Toolbar1.Buttons(2).Visible = True
                End Select
                
            ElseIf PIndexBoton = 9 Then
                
                Select Case Trim("" & RsC.Fields("IdPermiso"))
                    Case "23"
                        Toolbar1.Buttons(1).Visible = True
                End Select
                
            End If
            
            RsC.MoveNext
        
        Loop
        
        RsC.Close: Set RsC = Nothing
        
    End If
    
    Exit Sub
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub txt_Ano_Change()
On Error GoTo Err
Dim StrMsgError As String
    
    If Not indCargando Then
    
        If indNuevoDoc = False Then
            listaDocVentas StrMsgError
            If StrMsgError <> "" Then GoTo Err
        End If
        
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txt_Direccion_Change()

    If Trim("" & txt_Direccion.Text) = "" Then Exit Sub
    
    If strTipoDoc = "86" Then
        If Len(Trim(traerCampo("Personas", "direccionEntrega", "idPersona", txtCod_Cliente.Text, False))) > 0 Then
            If Len(Trim("" & txt_Direccion.Text)) = 0 Then
                txt_Llegada.Text = traerCampo("Personas", "direccionEntrega", "idPersona", txtCod_Cliente.Text, False)
            End If
        End If
     End If

End Sub

Private Sub txt_NumDoc_Change()
    
    If Len(Trim(txt_NumDoc.Text)) = 8 And (Len(Trim(txt_Serie.Text)) = 3 Or Len(Trim(txt_Serie.Text)) = 4) Then
        Me.Caption = strGlsTipoDoc & " (" & txt_Serie.Text & " - " & Format(txt_NumDoc.Text, "00000000") & ")"
    Else
        Me.Caption = strGlsTipoDoc
    End If

End Sub

Private Sub txt_numdoc_LostFocus()
    
    txt_NumDoc.Text = Format(txt_NumDoc.Text, "00000000")

End Sub

Private Sub txt_OrdenCompra_LostFocus()
On Error GoTo Err
Dim rst As New ADODB.Recordset
Dim rst2 As New ADODB.Recordset
Dim StrMsgError As String
Dim csMysql As String
   
   If Trim(txt_OrdenCompra.Text) <> "" Then
        csMysql = "Select TOP 1 (B.AbreDocumento + A.IdSerie + '/' + A.IdDocVentas) As Documento,A.NumOrdenCompra " & _
                  "From DocVentas A " & _
                  "Inner Join Documentos B " & _
                     "On A.IdDocumento = B.IdDocumento " & _
                  "Where A.IdEmpresa= '" & glsEmpresa & "' And A.IdPerCliente = '" & Trim(txtCod_Cliente.Text) & "' " & _
                  "And A.IdDocumento <> '" & strTipoDoc & "' And A.IdSerie <> '" & txt_Serie.Text & "' And A.IdDocVentas <> '" & txt_NumDoc.Text & "' And  A.NumOrdenCompra = '" & Trim("" & txt_OrdenCompra.Text) & "' " & _
                  "Order By A.FecRegistro Desc"
                      
        rst.Open csMysql, Cn, adOpenStatic, adLockReadOnly
           
        If Not rst.EOF Then
            StrMsgError = "La Orden de Compra ya fue Registrada en el Documento ." & rst.Fields("Documento"): GoTo Err
        End If
        
        rst.Close
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txt_ruc_KeyPress(KeyAscii As Integer)
Dim idCliente As String

    If KeyAscii = 13 Then
        If txt_RUC.Text = "" Then
            txtCod_Cliente.Text = ""
        Else
            idCliente = traerCampo("personas", "idPersona", "ruc", txt_RUC.Text, False)
            txtCod_Cliente.Text = idCliente
        End If
    End If

End Sub

Private Sub txt_Serie_Change()
    
    If Len(Trim(txt_NumDoc.Text)) = 8 And (Len(Trim(txt_Serie.Text)) = 3 Or Len(Trim(txt_Serie.Text)) = 4) Then
        Me.Caption = strGlsTipoDoc & " * (" & strNumitmlogDocVentas & ") (" & txt_Serie.Text & " - " & Format(txt_NumDoc.Text, "00000000") & ")"
    Else
        Me.Caption = strGlsTipoDoc
    End If

End Sub

Private Sub txt_Serie_KeyPress(KeyAscii As Integer)
    
    If KeyAscii = 13 Then
        txt_Serie.Text = UCase(Format(txt_Serie.Text, "0000"))
    End If

End Sub

Private Sub txt_Serie_LostFocus()
    
    txt_Serie_KeyPress 13

End Sub

Private Sub txt_TextoBuscar_Change()
Dim FILTRO As String
Dim StrMsgError As String
Dim strBusca    As String
On Error GoTo Err
    
'    If Trim(txt_TextoBuscar.Text) <> "" Then
'        gLista.Dataset.Filtered = True
'        FILTRO = txt_TextoBuscar.Text
'        FILTRO = Replace(FILTRO, "'", "*")
'        FILTRO = "*" & Trim(FILTRO) & "*"
'        strBusca = "idDocVentas LIKE '" & FILTRO & "' OR GlsCliente LIKE '" & FILTRO & "'"
'        gLista.Dataset.Filter = strBusca
'    Else
'        gLista.Dataset.Filtered = False
'        gLista.Dataset.Filter = "idDocVentas <> ''"
'    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txt_TextoBuscar_KeyDown(KeyCode As Integer, Shift As Integer)
    
    If KeyCode = vbKeyDown Then gLista.SetFocus

End Sub

Private Sub listaDocVentas(ByRef StrMsgError As String)
On Error GoTo Err
Dim strCond         As String
Dim Vizualiza_Docum As String
Dim Orden           As String
Dim FILTRO          As String

    FILTRO = txt_TextoBuscar.Text
    FILTRO = Replace(FILTRO, "'", "")
    FILTRO = Replace(FILTRO, "*", "")
    FILTRO = Replace(FILTRO, "%", "")

    Set gLista.DataSource = Nothing
    txt_TextoBuscar.Text = ""
    csql = "EXEC spu_Docventas_Listacab '" & glsEmpresa & "','" & glsSucursal & "','" & strTipoDoc & "'," & Val(txt_Ano.Text) & "," & Val(cbx_Mes.ListIndex + 1) & ",'" & FILTRO & "'," & Val(CbxGanadas.ListIndex) & ""
    
    If RsListaCab.State = 1 Then RsListaCab.Close: Set RsListaCab = Nothing
    RsListaCab.Open csql, Cn, adOpenStatic, adLockOptimistic
        
    Set gLista.DataSource = RsListaCab
    
    ListaDetalle
    Me.Refresh
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub mostrarDocVentas(strNum As String, strSerie As String, stritm As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rst                             As New ADODB.Recordset
Dim rsg                             As New ADODB.Recordset
Dim RsD                             As New ADODB.Recordset
Dim RsTabla                         As New ADODB.Recordset
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
    
    strTipoDoc = "92"
    indCargando = True
    CSqlC = "SELECT idDocumento , idDocVentas, idSerie, idPerCliente, GlsCliente, RucCliente, dirCliente, idAlmacen, idPerVendedor, fecEmision, estDocVentas," & _
            "TotalValorVenta , TotalIGVVenta, TotalPrecioVenta, idMoneda, TipoCambio, obsdocventas, Partida, llegada, idPerChofer, glsChofer, idPerEmpTrans, " & _
            "GlsEmpTrans, idVehiculo, GlsVehiculo, Placa, Marca, Color, Modelo, CodInsCrip, Bultos, Brevete, idLista, GlsVendedor, idMotivoTraslado, " & _
            "GlsFormasPago, GlsFecVectos, idMotivoNCD, GlsMotivoNCD, totalLetras, FecIniTraslado, rucEmpTrans, FecPago, GlsDocReferencia, simboloMonBruto, " & _
            "simboloMonIGV, simboloMonNeto, indVale, idValesCab, idEmpresa, idSucursal, idCentroCosto, GlsCentroCosto, estDocImportado, idmovcaja, " & _
            "idPerVendedorCampo, GlsVendedorCampo, TotalDsctoVV, TotalDsctoPV, TotalExonerado, TotalBaseImponible, estGuiaImportado, idTipoTicket, " & _
            "idUsuarioAnulacion, FechaAnulacion, FecRegistro, idUsuarioReg, Partida2, Llegada2, numOrdenCompra, idValeCabRec, indAprobado, ComisionVtas, " & _
            "indLetra, idupp, idFormaPago, indTrasladoConta,"
    CSqlC = CSqlC & "" & _
            "glsFormapago , vtercerosCliente, vtercerosdireccion, vterceroCodigo, vterceroRuc, IndReq, IdContacto, GlsMoneda, indTrasladoContaFin, idProvCliente," & _
            "ObsDocVentas2 , idtienda, Tipovale, IdPeriodo, IdComprobante, GlsContacto, totalTallaPeso, IDArea, GlsTrabajo, GlsPlaca, GlsAreaCliente, " & _
            "IdUsuarioAprueba, FechaAprueba, IdUsuarioDesaprueba, FechaDesaprueba, DiasEntrega, FechaEntrega, IndTerminado, indVtaGratuita, ObsRegVentas, " & _
            "SucursalDestino, AlmacenDestino, GlsSucursalDestino, GlsAlmacenDestino, idValesCabIng, TipoValeIng, IndValeIng, GlsObsAnula, " & _
            "FechaTermino, FechaTerminoSistema, idAreaCli, Prioridad, IndCerrado, IdUsuarioCierre, FechaCierre, IdUsuarioAbre, FechaAbre, ObsCierre, ObsAbre, " & _
            "PeriodoAD, IdCtaCorrienteOriAD, IdMovBancosCabOriAD, IdCtaCorrienteDesAD, IdMovBancosCabDesAD, IdSucursalDestino, " & _
            "FechaPT, IdUsuarioPT, IndTransGratuitaMP, IndTransGratuita, PeriodoRec, indPeriodoRecEstado, IndAfectoPerc, TotalIvap, " & _
            "TipoDescuentoGlobal, DescuentoGlobal, TotalPorcentajeDescuentoGlobal, TotalDescuentoGlobalGravado, TotalDescuentoGlobalExonerado, TotalDescuento, " & _
            "IndAceptadoSunat, IndBajaSunat, IndEnviadoSunat, IndAtribucionNC,IndVContado,iddirrecojo,TotalCosto " & _
            "FROM docventas_Log d " & _
            "WHERE ItemLog = " & Val(stritm) & " and d.idEmpresa = '" & glsEmpresa & "' AND d.idSucursal = '" & glsSucursal & "' AND d.idDocumento = '" & strTipoDoc & "' AND d.idDocVentas = '" & strNum & "' AND d.idSerie = '" & strSerie & "' "
    rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
    
    'lblDoc.Caption = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDoc, False)
    'lblDoc.ForeColor = &H0&
    txt_Serie.Enabled = False
    txt_NumDoc.Enabled = False
    
    If Not rst.EOF Then
        strEstDocVentas = Trim("" & rst.Fields("estDocventas"))
        If strEstDocVentas = "ANU" Then
            lblDoc.ForeColor = &HFF&
            lblDoc.Caption = lblDoc.Caption & " - ANULADA"
            fraGeneral.Enabled = False
            'fraDetalle.Enabled = False
            Activa_Desc_Grid True
        ElseIf strEstDocVentas = "IMP" Then
            fraGeneral.Enabled = False
            'fraDetalle.Enabled = False
            Activa_Desc_Grid True
        Else
            txt_Serie.Enabled = False
            txt_NumDoc.Enabled = False
            fraGeneral.Enabled = True
            'fraDetalle.Enabled = True
            Activa_Desc_Grid False
        End If
        
        indGeneraVale = IIf(("" & rst.Fields("indVale")) = "S", True, False)
        
        CIdPeriodoAux = "" & rst.Fields("IdPeriodo")
        CIdComprobanteAux = "" & rst.Fields("IdComprobante")
        
        If Trim("" & rst.Fields("TipoDescuentoGlobal")) = "P" Then
            OptTipoDecuentoGlobal(0).Value = True
        Else
            OptTipoDecuentoGlobal(1).Value = True
        End If
        
        NTotalBruto = Val("" & rst.Fields("TotalValorVenta"))
        NTotalIGV = Val("" & rst.Fields("TotalIGVVenta"))
        NTotalIVAP = Val("" & rst.Fields("TotalIvap"))
        NTotalDsctoVV = Val("" & rst.Fields("TotalDsctoVV"))
        NTotalDsctoPV = Val("" & rst.Fields("TotalDsctoPV"))
        NTotalBaseImponible = Val("" & rst.Fields("TotalBaseImponible"))
        NTotalExonerado = Val("" & rst.Fields("TotalExonerado"))
        
        txt_TotalBruto.Text = Val(Format(NTotalBruto, "0.00"))
        txt_TotalIGV.Text = Val(Format(NTotalIGV, "0.00"))
        TxtTotalIvap.Text = Val(Format(NTotalIVAP, "0.00"))
        txt_TotalDsctoVV.Text = Val(Format(NTotalDsctoVV, "0.00"))
        txt_TotalDsctoPV.Text = Val(Format(NTotalDsctoPV, "0.00"))
        txt_TotalBaseImponible.Text = Val(Format(NTotalBaseImponible, "0.00"))
        txt_TotalExonerado.Text = Val(Format(NTotalExonerado, "0.00"))
        
    End If
    
    mostrarDatosFormSQL Me, rst, StrMsgError
    
    If StrMsgError <> "" Then GoTo Err
    
    CSqlC = "SELECT idDocumento, idDocVentas, idSerie, idProducto, glsProducto, idMarca, idUM, Factor, Afecto, Cantidad, VVUnit, IGVUnit, PVUnit, TotalVVBruto, " & _
            "TotalPVBruto, PorDcto, DctoVV, DctoPV, TotalVVNeto, TotalIGVNeto, TotalPVNeto, item, GlsMarca, GlsUM, idTipoProducto, idMoneda, idCodFabricante, " & _
            "idEmpresa, idSucursal, estDocImportado, idDocumentoImp, idDocVentasImp, idSerieImp, IdLote,NumLote, FecVencProd, idUsuarioDcto, VVUnitLista, PVUnitLista, " & _
            "CantidadImp, VVUnitNeto, PVUnitNeto, Cantidad2, CodigoRapido, idTallaPeso, CantidadAnt, Simbolo1, Simbolo2, Simbolo3, itemPro, PorcUtilidad, " & _
            "IdCentroCosto, IdSucursalPres, IdDocumentoPres, IdSeriePres, IdDocVentasPres, GlsPlaca, IdUPCliente,IvapUnit,TotalIvapNeto,GlsProveedor,CostoS,CostoSInc,CostoD,Margen " & _
           "FROM docventasdet_log " & _
           "WHERE ItemLog = " & Val(stritm) & " and idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & _
           "' AND idDocVentas = '" & strNum & "' AND idSerie = '" & strSerie & _
           "' ORDER BY ITEM"
    
    rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
    rsg.Fields.Append "Item", adInteger, , adFldRowID
    rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "GlsProducto", adVarChar, 8000, adFldIsNullable
    rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
    rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
    rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
    rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "ItemPro", adInteger, , adFldRowID
    rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
    rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
    rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    rsg.Open
    
    If rst.RecordCount = 0 Then
        rsg.AddNew
        rsg.Fields("Item") = 1
        rsg.Fields("idProducto") = ""
        rsg.Fields("idCodFabricante") = ""
        rsg.Fields("GlsProducto") = ""
        rsg.Fields("idMarca") = ""
        rsg.Fields("GlsMarca") = ""
        rsg.Fields("idUM") = ""
        rsg.Fields("GlsUM") = ""
        rsg.Fields("Factor") = 1
        rsg.Fields("Afecto") = 1
        rsg.Fields("Cantidad") = 0
        rsg.Fields("Cantidad2") = 0
        rsg.Fields("VVUnit") = 0
        rsg.Fields("IGVUnit") = 0
        rsg.Fields("PVUnit") = 0
        rsg.Fields("TotalVVBruto") = 0
        rsg.Fields("TotalPVBruto") = 0
        rsg.Fields("PorDcto") = "0"
        rsg.Fields("DctoVV") = 0
        rsg.Fields("DctoPV") = 0
        rsg.Fields("TotalVVNeto") = 0
        rsg.Fields("TotalIGVNeto") = 0
        rsg.Fields("TotalPVNeto") = 0
        rsg.Fields("idTipoProducto") = ""
        rsg.Fields("idMoneda") = ""
        rsg.Fields("VVUnitLista") = 0
        rsg.Fields("PVUnitLista") = 0
        rsg.Fields("VVUnitNeto") = 0
        rsg.Fields("PVUnitNeto") = 0
        rsg.Fields("CantidadAnt") = 0
        rsg.Fields("Simbolo1") = ""
        rsg.Fields("Simbolo2") = ""
        rsg.Fields("Simbolo3") = ""
        rsg.Fields("ItemPro") = 1
        rsg.Fields("IdCentroCosto") = ""
        rsg.Fields("GlsPlaca") = ""
        rsg.Fields("IdSucursalPres") = ""
        rsg.Fields("IdDocumentoPres") = ""
        rsg.Fields("IdSeriePres") = ""
        rsg.Fields("IdDocVentasPres") = ""
        rsg.Fields("IdUPCliente") = ""
        rsg.Fields("IvapUnit") = 0
        rsg.Fields("TotalIvapNeto") = 0
        rsg.Fields("GlsProveedor") = ""
        rsg.Fields("CostoS") = 0
        rsg.Fields("CostoSInc") = 0
        rsg.Fields("CostoD") = 0
        rsg.Fields("Margen") = 0
        
    Else
        Do While Not rst.EOF
            rsg.AddNew
            rsg.Fields("Item") = "" & rst.Fields("Item")
            rsg.Fields("idProducto") = "" & rst.Fields("idProducto")
            rsg.Fields("idCodFabricante") = "" & rst.Fields("idCodFabricante")
            rsg.Fields("GlsProducto") = "" & rst.Fields("GlsProducto")
            rsg.Fields("idMarca") = "" & rst.Fields("idMarca")
            rsg.Fields("GlsMarca") = "" & rst.Fields("GlsMarca")
            rsg.Fields("idUM") = "" & rst.Fields("idUM")
            rsg.Fields("GlsUM") = "" & rst.Fields("GlsUM")
            rsg.Fields("Factor") = "" & rst.Fields("Factor")
            rsg.Fields("Afecto") = "" & rst.Fields("Afecto")
            rsg.Fields("Cantidad") = "" & rst.Fields("Cantidad")
            rsg.Fields("Cantidad2") = "" & rst.Fields("Cantidad2")
            rsg.Fields("VVUnit") = "" & rst.Fields("VVUnit")
            rsg.Fields("IGVUnit") = "" & rst.Fields("IGVUnit")
            rsg.Fields("PVUnit") = "" & rst.Fields("PVUnit")
            rsg.Fields("TotalVVBruto") = "" & rst.Fields("TotalVVBruto")
            rsg.Fields("TotalPVBruto") = "" & rst.Fields("TotalPVBruto")
            rsg.Fields("PorDcto") = "" & rst.Fields("PorDcto")
            rsg.Fields("DctoVV") = "" & rst.Fields("DctoVV")
            rsg.Fields("DctoPV") = "" & rst.Fields("DctoPV")
            rsg.Fields("TotalVVNeto") = "" & rst.Fields("TotalVVNeto")
            rsg.Fields("TotalIGVNeto") = "" & rst.Fields("TotalIGVNeto")
            rsg.Fields("TotalPVNeto") = "" & rst.Fields("TotalPVNeto")
            rsg.Fields("idTipoProducto") = "" & rst.Fields("idTipoProducto")
            rsg.Fields("idMoneda") = "" & rst.Fields("idMoneda")
            rsg.Fields("idDocumentoImp") = "" & rst.Fields("idDocumentoImp")
            rsg.Fields("idDocVentasImp") = "" & rst.Fields("idDocVentasImp")
            rsg.Fields("idSerieImp") = "" & rst.Fields("idSerieImp")
            rsg.Fields("NumLote") = "" & rst.Fields("NumLote")
            rsg.Fields("IdLote") = "" & rst.Fields("IdLote")
            
            rsg.Fields("FecVencProd") = "" & rst.Fields("FecVencProd")
            rsg.Fields("idUsuarioDcto") = "" & rst.Fields("idUsuarioDcto")
            rsg.Fields("VVUnitLista") = "" & rst.Fields("VVUnitLista")
            rsg.Fields("PVUnitLista") = "" & rst.Fields("PVUnitLista")
            rsg.Fields("VVUnitNeto") = "" & rst.Fields("VVUnitNeto")
            rsg.Fields("PVUnitNeto") = "" & rst.Fields("PVUnitNeto")
            rsg.Fields("CodigoRapido") = "" & rst.Fields("CodigoRapido")
            rsg.Fields("idTallaPeso") = Val("" & rst.Fields("idTallaPeso"))
            rsg.Fields("CantidadAnt") = "" & rst.Fields("CantidadAnt")
            
            rsg.Fields("Simbolo1") = "" & rst.Fields("Simbolo1")
            rsg.Fields("Simbolo2") = "" & rst.Fields("Simbolo2")
            rsg.Fields("Simbolo3") = "" & rst.Fields("Simbolo3")
            
            rsg.Fields("ItemPro") = "" & rst.Fields("ItemPro")
            rsg.Fields("IdCentroCosto") = "" & rst.Fields("IdCentroCosto")
            rsg.Fields("GlsPlaca") = "" & rst.Fields("GlsPlaca")
            rsg.Fields("IdSucursalPres") = "" & rst.Fields("IdSucursalPres")
            rsg.Fields("IdDocumentoPres") = "" & rst.Fields("IdDocumentoPres")
            rsg.Fields("IdSeriePres") = "" & rst.Fields("IdSeriePres")
            rsg.Fields("IdDocVentasPres") = "" & rst.Fields("IdDocVentasPres")
            rsg.Fields("IdUPCliente") = "" & rst.Fields("IdUPCliente")
            rsg.Fields("IvapUnit") = Val("" & rst.Fields("IvapUnit"))
            rsg.Fields("TotalIvapNeto") = Val("" & rst.Fields("TotalIvapNeto"))
            rsg.Fields("GlsProveedor") = "" & rst.Fields("GlsProveedor")
            rsg.Fields("CostoS") = Val(Format("" & rst.Fields("CostoS"), "0.00"))
            rsg.Fields("CostoSInc") = Val(Format("" & rst.Fields("CostoSInc"), "0.00"))
            rsg.Fields("CostoD") = Val(Format("" & rst.Fields("CostoD"), "0.00"))
            rsg.Fields("Margen") = Val("" & rst.Fields("Margen"))
            rst.MoveNext
        Loop
    End If
    rst.Close: Set rst = Nothing
    
    mostrarDatosGridSQL gDetalle, rsg, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    '----- Muestra doc referencia
    If ccodparamemp = "S" Then
    
        If Len(Trim(traerCampo("docreferenciaempresas", "numDocOrigen", "numDocOrigen", Trim(txt_NumDoc.Text), False, "idEmpresaOrigen = '" & glsEmpresa & "' And idSucursalOrigen = '" & glsSucursal & "' And tipoDocOrigen = '" & strTipoDoc & "' And SerieDocOrigen= '" & txt_Serie.Text & "'"))) > 0 Then
                 
            CSqlC = "SELECT item,idEmpresaOrigen,idSucursalOrigen,tipoDocOrigen,numDocOrigen,serieDocOrigen,idEmpresaReferencia,idSucursalReferencia," & _
                    "tipoDocReferencia idDocumento,numDocReferencia idNumDOc,serieDocReferencia idSerie,d.GlsDocumento " & _
                    "FROM docreferenciaempresas r , documentos d " & _
                    "WHERE r.idEmpresaOrigen = '" & glsEmpresa & "' AND r.idSucursalOrigen = '" & glsSucursal & _
                    "' AND r.tipoDocReferencia = d.idDocumento AND tipoDocOrigen = '" & strTipoDoc & "' AND numDocOrigen = '" & strNum & _
                    "' AND serieDocOrigen = '" & strSerie & _
                    "' ORDER BY ITEM"
                    
            If rst.State = 1 Then rst.Close
            rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
            RsD.Fields.Append "Item", adInteger, , adFldRowID
            RsD.Fields.Append "idDocumento", adChar, 2, adFldIsNullable
            RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
            RsD.Fields.Append "idSerie", adChar, 4, adFldIsNullable
            RsD.Fields.Append "idNumDOc", adChar, 8, adFldIsNullable
            RsD.Fields.Append "EmpresaReferencia", adChar, 2, adFldIsNullable
            RsD.Fields.Append "SucursalReferencia", adChar, 8, adFldIsNullable
            RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
            RsD.Open
            If rst.RecordCount = 0 Then
                RsD.AddNew
                RsD.Fields("Item") = 1
                RsD.Fields("idDocumento") = ""
                RsD.Fields("GlsDocumento") = ""
                RsD.Fields("idSerie") = ""
                RsD.Fields("idNumDOc") = ""
                RsD.Fields("EmpresaReferencia") = ""
                RsD.Fields("SucursalReferencia") = ""
                RsD.Fields("IndImportado") = "0"
            Else
                Do While Not rst.EOF
                    RsD.AddNew
                    RsD.Fields("Item") = "" & rst.Fields("Item")
                    RsD.Fields("idDocumento") = "" & rst.Fields("idDocumento")
                    RsD.Fields("GlsDocumento") = "" & rst.Fields("GlsDocumento")
                    RsD.Fields("idSerie") = "" & rst.Fields("idSerie")
                    RsD.Fields("idNumDOc") = "" & rst.Fields("idNumDOc")
                    RsD.Fields("EmpresaReferencia") = "" & rst.Fields("idEmpresaReferencia")
                    RsD.Fields("SucursalReferencia") = "" & rst.Fields("idSucursalReferencia")
                    RsD.Fields("IndImportado") = "0"
                    rst.MoveNext
                Loop
            End If
        Else
            
            CSqlC = "Select R.Item,R.TipoDocReferencia IdDocumento,D.GlsDocumento,R.NumDocReferencia IdNumDoc,R.SerieDocReferencia IdSerie,R.IndImportado " & _
                    "From DocReferencia R " & _
                    "Inner Join Documentos D " & _
                        "On R.TipoDocReferencia = D.IdDocumento " & _
                    "Where R.IdEmpresa = '" & glsEmpresa & "' And R.IdSucursal = '" & glsSucursal & "' And R.TipoDocOrigen = '" & strTipoDoc & "' " & _
                    "And R.SerieDocOrigen = '" & strSerie & "' And R.NumDocOrigen = '" & strNum & "' " & _
                    "Order By Item"
            
            If rst.State = 1 Then rst.Close
            rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
            RsD.Fields.Append "Item", adInteger, , adFldRowID
            RsD.Fields.Append "IdDocumento", adChar, 2, adFldIsNullable
            RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
            RsD.Fields.Append "IdSerie", adChar, 4, adFldIsNullable
            RsD.Fields.Append "IdNumDOc", adChar, 8, adFldIsNullable
            RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
            RsD.Open
            
            If rst.RecordCount = 0 Then
                RsD.AddNew
                RsD.Fields("Item") = 1
                RsD.Fields("IdDocumento") = ""
                RsD.Fields("GlsDocumento") = ""
                RsD.Fields("IdSerie") = ""
                RsD.Fields("IdNumDoc") = ""
                RsD.Fields("IndImportado") = "0"
            Else
                Do While Not rst.EOF
                    RsD.AddNew
                    RsD.Fields("Item") = "" & rst.Fields("Item")
                    RsD.Fields("IdDocumento") = "" & rst.Fields("IdDocumento")
                    RsD.Fields("GlsDocumento") = "" & rst.Fields("GlsDocumento")
                    RsD.Fields("IdSerie") = "" & rst.Fields("IdSerie")
                    RsD.Fields("IdNumDOc") = "" & rst.Fields("IdNumDOc")
                    RsD.Fields("IndImportado") = "" & rst.Fields("IndImportado")
                    
                    rst.MoveNext
                Loop
            End If
        End If
    
    Else
        
        CSqlC = "Select R.Item,R.TipoDocReferencia IdDocumento,D.GlsDocumento,R.NumDocReferencia IdNumDoc,R.SerieDocReferencia IdSerie,R.IndImportado " & _
                "From DocReferencia R " & _
                "Inner Join Documentos D " & _
                    "On R.TipoDocReferencia = D.IdDocumento " & _
                "Where R.IdEmpresa = '" & glsEmpresa & "' And R.IdSucursal = '" & glsSucursal & "' And R.TipoDocOrigen = '" & strTipoDoc & "' " & _
                "And R.SerieDocOrigen = '" & strSerie & "' And R.NumDocOrigen = '" & strNum & "' " & _
                "Order By Item"
                    
        If rst.State = 1 Then rst.Close
        rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
        RsD.Fields.Append "Item", adInteger, , adFldRowID
        RsD.Fields.Append "IdDocumento", adChar, 2, adFldIsNullable
        RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
        RsD.Fields.Append "IdSerie", adChar, 4, adFldIsNullable
        RsD.Fields.Append "IdNumDOc", adChar, 8, adFldIsNullable
        RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
        RsD.Open
        
        If rst.RecordCount = 0 Then
            RsD.AddNew
            RsD.Fields("Item") = 1
            RsD.Fields("IdDocumento") = ""
            RsD.Fields("GlsDocumento") = ""
            RsD.Fields("IdSerie") = ""
            RsD.Fields("IdNumDoc") = ""
            RsD.Fields("IndImportado") = "0"
        Else
            Do While Not rst.EOF
                RsD.AddNew
                RsD.Fields("Item") = "" & rst.Fields("Item")
                RsD.Fields("IdDocumento") = "" & rst.Fields("IdDocumento")
                RsD.Fields("GlsDocumento") = "" & rst.Fields("GlsDocumento")
                RsD.Fields("IdSerie") = "" & rst.Fields("IdSerie")
                RsD.Fields("IdNumDOc") = "" & rst.Fields("IdNumDOc")
                RsD.Fields("IndImportado") = "" & rst.Fields("IndImportado")
                
                rst.MoveNext
            Loop
        End If
            
    End If
    
    rst.Close: Set rst = Nothing
    
    mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    txt_Serie.Text = strSerie
    
    'If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    'Else
        'lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    'End If
        
    '--- Habilita los controles que muestran lo botones realizados para la transferencia
    'If traerCampo("seriesdocumento", "indtransferencia", "idserie", gLista.Columns.ColumnByFieldName("idserie").Value, True, " iddocumento = '" & strTipoDoc & "'") = "S" Then
    '    lbl_SucursalDestino.Visible = True
    '    txtCod_SucursalDestino.Visible = True
    '    txtGls_SucursalDestino.Visible = True
    '    cmbAyudaSucursalDestino.Visible = True
    '    lbl_AlmacenDestino.Visible = True
    '    txtCod_AlmacenDestino.Visible = True
    '    txtGls_AlmacenDestino.Visible = True
    '    cmbAyudaAlmacenDestino.Visible = True
    'Else
        lbl_SucursalDestino.Visible = False
        txtCod_SucursalDestino.Visible = False
        txtGls_SucursalDestino.Visible = False
        cmbAyudaSucursalDestino.Visible = False
        lbl_AlmacenDestino.Visible = False
        txtCod_AlmacenDestino.Visible = False
        txtGls_AlmacenDestino.Visible = False
        cmbAyudaAlmacenDestino.Visible = False
    'End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    
    If RsDetProductos.State = 1 Then RsDetProductos.Close
    Jala_Formula_Documento strTipoDoc, strSerie, strNum, StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    'If leeParametro("FACTURACION_ENTRE_EMPRESAS") = "S" Then
    '    If traerCampo("Empresas", "IdEmpresa", "IdPersona", txtCod_Cliente.Text, False) <> "" Then
    '        FraCentroCostoCliente.Visible = True
    '    Else
            FraCentroCostoCliente.Visible = False
    '   End If
    'End If
    
    'CSqlC = "Select A.IdCentroCosto " & _
    '        "From DocVentasRegisDocFE A " & _
    '        "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' " & _
    '        "And A.IdSerie = '" & txt_serie.Text & "' And A.IdDocVentas = '" & txt_numdoc.Text & "'"
    'AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
    'If Not RsC.EOF Then
        
    '    TxtIdCentroCostoCliente.Text = Trim("" & RsC.Fields("IdCentroCosto"))
    '    TxtGlsCentroCostoCliente.Text = traerCampo("CentrosCosto", "GlsCentroCosto", "IdCentroCosto", TxtIdCentroCostoCliente.Text, False, "IdEmpresa = '" & traerCampo("Empresas", "IdEmpresa", "IdPersona", txtCod_Cliente.Text, False) & "'")
        
    'End If
    
    'RsC.Close: Set RsC = Nothing
        
    indCargando = False
    Me.Refresh
    
    Exit Sub
Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub cmbAyudaCliente_Click()
Dim rst             As New ADODB.Recordset
Dim StrMsgError     As String
Dim strVenTien      As String
On Error GoTo Err
    
    mostrarAyudaClientes txtCod_Cliente, txtGls_Cliente, txt_RUC, txt_Direccion, txtCod_Tienda
    
    strVenTien = traerCampo("TiendasCliente", "idVendedor", "idtdacli", txtCod_Tienda.Text, True, "idPersona = '" & Trim(txtCod_Cliente.Text) & "'")
    
'''''''    csql = "SELECT p.ruc,concat(p.direccion,' ',u.glsUbigeo,' ',d.glsUbigeo) as direccion,p.GlsPersona,p.direccionEntrega " & _
'''''''           "FROM personas p " & _
'''''''           "LEFT JOIN ubigeo u ON P.IdPais = U.IdPais And P.idDistrito = u.idDistrito " & _
'''''''           "LEFT JOIN ubigeo d ON u.IdPais = d.IdPais And left(u.idDistrito,2) = d.idDpto AND d.idProv = '00' AND d.idDist = '00' " & _
'''''''           "Where p.idPersona = '" & txtCod_Cliente.Text & "'"
    
    'PQS 13-1-15
    If Len(Trim(txtCod_Tienda.Text)) = 0 Then
    
'        '--- MODIFICADO 10/06/14  NSE
'        csql = "SELECT p.ruc, (p.direccion + ' ' + IsNull(u.glsUbigeo,'') + ' ' + IsNull(prov.glsubigeo,'') + ' ' + IsNull(d.glsUbigeo,'')) as direccion," & _
'               "p.GlsPersona,p.direccionEntrega " & _
'               "FROM personas p " & _
'               "LEFT JOIN ubigeo u ON P.idDistrito = u.idDistrito AND p.idPais = u.idPais " & _
'               "LEFT JOIN ubigeo d ON left(u.idDistrito,2) = d.idDpto AND d.idProv = '00' AND d.idDist = '00' AND p.idPais = d.idPais " & _
'               "LEFT JOIN ubigeo prov ON left(d.idDistrito,2) = prov.idDpto AND SUBSTRING(u.idDistrito,3,2) = prov.idProv AND prov.idDist = '00' AND prov.idPais = d.idPais " & _
'               "Where p.idPersona = '" & txtCod_Cliente.Text & "'"
        csql = "EXECUTE spu_Recupera_Direccion_Cliente 1 , '" & glsEmpresa & "' , '" & txtCod_Cliente.Text & "' , '" & txtCod_Cliente.Text & "' "
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            txt_Direccion.Text = "" & rst.Fields("direccion")
        End If
        
        rst.Close: Set rst = Nothing
    Else
    
        csql = "EXECUTE spu_Recupera_Direccion_Cliente 2 , '" & glsEmpresa & "','" & txtCod_Cliente.Text & "' , '" & txtCod_Tienda.Text & "' "
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            txt_Direccion.Text = "" & rst.Fields("direccion")
        End If
        
        rst.Close: Set rst = Nothing
        
    End If
    
'    If txtCod_Cliente.Text <> "" Then
'        If Len(Trim(txtCod_Tienda.Text)) = 0 Then
'            'If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "VISUALIZA_DIRECCION_SIN_PROVINCIA", True) = "S" Then
'                txt_Direccion.Text = traerCampo("PERSONAS", "DIRECCION", "IDPERSONA", txtCod_Cliente.Text, False)
'           ' End If
'        End If
'
'    End If
    
    If (Trim(txtCod_Tienda.Text) <> "" And Trim(strVenTien) <> "" And Trim(txtCod_Cliente.Text) <> "") Then
        txtCod_VendedorCampo.Text = strVenTien
    End If
    
'    If traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20566047668" Then
'
'        txt_Llegada.Text = traerCampo("PERSONAS", "DIRECCION", "IDPERSONA", txtCod_Cliente.Text, False)
'
'    Else
        If strTipoDoc <> "92" Then
            txt_Llegada.Text = "" & txt_Direccion.Text
        End If
'    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Function traerControl(strName As String) As Object
On Error GoTo Err
Dim pCtrl As Control

    For Each pCtrl In Me
        If pCtrl.Name = strName Then
            Set traerControl = pCtrl
            Exit For
        End If
    Next
    Exit Function

Err:
    Exit Function
End Function

Private Sub muestraControlesCabecera()
Dim rst As New ADODB.Recordset
Dim pCtrl As Object
Dim strSerie As String
Dim intRegistros As Integer
On Error GoTo Err

    'strSerie = traerCampo("seriexusuario", "idSerie", "idUsuario", glsUser, True, " idDocumento = '" & strTipoDoc & "'")
    'intRegistros = Val(traerCampo("objdocventas", "count(*)", "idDocumento", strTipoDoc, True, "idSerie = '" & strSerie & "' and (tipoObj = 'C' or tipoObj = 'T') and indVisible = 'V'"))
    
'    If rst.State = 1 Then rst.Close: Set rst = Nothing
'    rst.Open "EXEC seriexusuario '" & glsEmpresa & "','" & glsUser & "','" & strTipoDoc & "'", Cn, adOpenStatic, adLockOptimistic
'    If Not rst.EOF Then
'        strSerie = rst.Fields("idSerie")
'        intRegistros = rst.Fields("cantidad")
'    Else
'        strSerie = ""
'        intRegistros = 1
'    End If
    
'    If intRegistros = 1 Then
'        csql = "SELECT GlsObj,intLeft,intTop,tipoDato,Decimales,intTabIndex  FROM objdocventas " & _
'                "where idEmpresa = '" & glsEmpresa & "' and idDocumento = '" & strTipoDoc & "' AND idSerie = '999' and (tipoObj = 'C' or tipoObj = 'T') and indVisible = 'V' ORDER BY intTabIndex"
'        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
'    Else
'        csql = "SELECT GlsObj,intLeft,intTop,tipoDato,Decimales,intTabIndex  FROM objdocventas " & _
'                "where idEmpresa = '" & glsEmpresa & "' and idDocumento = '" & strTipoDoc & "' AND idSerie = '" & strSerie & "' and (tipoObj = 'C' or tipoObj = 'T') and indVisible = 'V' ORDER BY intTabIndex"
'        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
'    End If
    
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    rst.Open "EXEC spu_Lista_Obj '" & glsEmpresa & "','" & strTipoDoc & "','" & glsUser & "'", Cn, adOpenStatic, adLockOptimistic
    
    
    Do While Not rst.EOF
        Set pCtrl = traerControl(rst.Fields("GlsObj"))
        pCtrl.left = Val(rst.Fields("intLeft") & "")
        pCtrl.top = Val(rst.Fields("intTop") & "")
        If (rst.Fields("tipoDato") & "") = "N" And TypeOf pCtrl Is CATTextBox Then
            pCtrl.Decimales = Val(rst.Fields("Decimales") & "")
        End If
        
        '******** CAMBIA LA ETIQUETA A LOS CAPTIÓN ************
        If (rst.Fields("tipoDato") & "") = "T" And TypeOf pCtrl Is Label Then
            If Trim(rst.Fields("Etiqueta") & "") <> "" Then
                pCtrl.Caption = Trim(rst.Fields("Etiqueta") & "")
                pCtrl.Width = Len(Trim(rst.Fields("Etiqueta") & "")) * 100
            End If
        End If
        '******************************************************
        
        pCtrl.TabIndex = Val(rst.Fields("intTabIndex") & "")
        pCtrl.Visible = True
        rst.MoveNext
    Loop
    
    lblvtcliente.Visible = False
    lblvtruc.Visible = False
    lvlvtdireccion.Visible = False
    txtvtcodigo.Visible = False
    txtvtglscliente.Visible = False
    txtvtruc.Visible = False
    txtvtdireccion.Visible = False
    btnvt.Visible = False
    
Exit Sub
Err:
    MsgBox Err.Description
    Exit Sub
    Resume
    
End Sub

Private Sub muestraColumnasDetalle()
On Error GoTo Err
Dim rst As New ADODB.Recordset
Dim pCtrl As Object
Dim strSerie As String
Dim intRegistros As Integer

'    strSerie = traerCampo("seriexusuario", "idSerie", "idUsuario", glsUser, True, " idDocumento = '" & strTipoDoc & "'")
'    intRegistros = Val(traerCampo("objdocventas", "count(*)", "idDocumento", strTipoDoc, True, "idSerie = '" & strSerie & "' and tipoObj = 'D' and indVisible = 'V'"))
'    'intRegistros = Val(traerCampo("objdocventas", "count(*)", "idDocumento", strTipoDoc, True, "idSerie = '" & strSerie & "' and tipoObj = 'D' and indVisible = 'V' ORDER BY NUMCOL"))
'
'    If intRegistros = 0 Then
'        csql = "SELECT GlsObj,etiqueta,numCol,ancho,Tipodato,Decimales  FROM objdocventas " & _
'            "where idEmpresa = '" & glsEmpresa & "' and idDocumento = '" & strTipoDoc & "' and idserie = '999' and tipoObj = 'D' " & _
'            "and indVisible = 'V' " & _
'            "ORDER BY NUMCOL"
'        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
'    Else
'        csql = "SELECT GlsObj,etiqueta,numCol,ancho,Tipodato,Decimales  FROM objdocventas " & _
'                "where idEmpresa = '" & glsEmpresa & "' and idDocumento = '" & strTipoDoc & "' and idserie = '" & strSerie & "' and tipoObj = 'D' " & _
'                "and indVisible = 'V' " & _
'                "ORDER BY NUMCOL"
'        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
'    End If
    
    
    csql = "EXEC spu_Lista_Obj_Det '" & glsEmpresa & "','" & strTipoDoc & "','" & glsUser & "'"
    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
    Do While Not rst.EOF
        gDetalle.Columns.ColumnByFieldName(rst.Fields("GlsObj") & "").Caption = rst.Fields("etiqueta") & ""
        gDetalle.Columns.ColumnByFieldName(rst.Fields("GlsObj") & "").ColIndex = Val(rst.Fields("numCol") & "")
        gDetalle.Columns.ColumnByFieldName(rst.Fields("GlsObj") & "").Width = Val(rst.Fields("ancho") & "")
        gDetalle.Columns.ColumnByFieldName(rst.Fields("GlsObj") & "").Visible = True
        If (rst.Fields("Tipodato") & "") = "N" Then
            gDetalle.Columns.ColumnByFieldName(rst.Fields("GlsObj") & "").DecimalPlaces = Val(rst.Fields("Decimales") & "")
        End If
        rst.MoveNext
    Loop
    
    Exit Sub

Err:
    MsgBox Err.Description
End Sub

Private Function DatosPrecioCompras(ByVal strCodProd As String, ByVal strTipoProd As String, ByVal strCodUM As String, ByRef strglsum As String, ByRef dblVVUnit As Double, ByRef dblFactor As Double) As Boolean
Dim rst As New ADODB.Recordset
    
    If strTipoProd = "06002" Then
        csql = "SELECT '' as GlsUM,v.VVUnit,1 AS Factor " & _
                "FROM preciosventa v " & _
                "WHERE v.idEmpresa = '" & glsEmpresa & "' " & _
                "AND v.idLista = '" & txtCod_Lista.Text & "'" & _
                "AND v.idProducto = '" & strCodProd & "'"
                  
    Else
        csql = "Select U.AbreUM GlsUM,If(P.IdMoneda = 'PEN',P.ValorVenta,P.ValorVenta * " & txt_TipoCambio.Text & ") VVUnit,R.Factor " & _
                "From Presentaciones R " & _
                "Inner Join UnidadMedida U " & _
                    "On R.IdUM = U.IdUM " & _
                "Inner Join (" & _
                    "Select A.IdEmpresa,A.IdProducto,A.IdMoneda,A.ValorVenta " & _
                    "From ProductosProveedor A " & _
                    "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdProducto = '" & strCodProd & "' " & _
                    "Order By A.Fecha Desc Limit 1" & _
                ") P " & _
                    "On R.IdEmpresa = P.IdEmpresa And R.IdProducto = P.IdProducto " & _
                "Where R.IdEmpresa = '" & glsEmpresa & "' And R.IdProducto = '" & strCodProd & "' And R.IdUM = '" & strCodUM & "'"
    End If
    
    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
    If Not rst.EOF Then
        DatosPrecioCompras = True
        strglsum = "" & rst.Fields("GlsUM")
        dblVVUnit = "" & rst.Fields("VVUnit")
        dblFactor = "" & rst.Fields("Factor")
    Else
        DatosPrecioCompras = False
        strglsum = ""
        dblVVUnit = 0
        dblFactor = 1
    End If
    rst.Close: Set rst = Nothing
    
End Function

Private Function DatosPrecio(ByVal strCodProd As String, ByVal strTipoProd As String, ByVal strCodUM As String, ByRef strglsum As String, ByRef dblVVUnit As Double, ByRef dblFactor As Double) As Boolean
Dim rst As New ADODB.Recordset

    If strTipoProd = "06002" Then
        csql = "SELECT '' as GlsUM,v.VVUnit,1 AS Factor " & _
                "FROM preciosventa v " & _
                "WHERE v.idEmpresa = '" & glsEmpresa & "' " & _
                  "AND v.idLista = '" & txtCod_Lista.Text & "'" & _
                  "AND v.idProducto = '" & strCodProd & "'"
    Else
        csql = "SELECT u.abreUM as GlsUM,v.VVUnit,r.Factor " & _
                "FROM presentaciones r,unidadMedida u,preciosventa v " & _
                "WHERE r.idUM = u.idUM " & _
                "AND r.idEmpresa = '" & glsEmpresa & "' " & _
                "AND r.idProducto = v.idProducto " & _
                "AND r.idUM = v.idUM " & _
                "AND v.idEmpresa = '" & glsEmpresa & "' " & _
                "AND v.idLista = '" & txtCod_Lista.Text & "'" & _
                "AND r.idProducto = '" & strCodProd & "' " & _
                "AND r.idUM = '" & strCodUM & "'"
    End If
    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
    
    If Not rst.EOF Then
        DatosPrecio = True
        strglsum = "" & rst.Fields("GlsUM")
        dblVVUnit = "" & rst.Fields("VVUnit")
        dblFactor = "" & rst.Fields("Factor")
    Else
        DatosPrecio = False
        strglsum = ""
        dblVVUnit = 0
        dblFactor = 1
    End If
    rst.Close: Set rst = Nothing

End Function

Private Function DatosProducto(strCodProd As String, ByRef strCodFabri As String, ByRef strCodMar As String, ByRef strGlsMarca As String, ByRef intAfecto As Integer, ByRef strTipoProd As String) As Boolean
Dim rst As New ADODB.Recordset

    csql = "SELECT p.idFabricante,p.idMarca,m.GlsMarca,p.AfectoIGV,p.idTipoProducto " & _
            "FROM productos p LEFT JOIN marcas m ON p.idEmpresa = m.idEmpresa AND p.idMarca = m.idMarca AND m.idEmpresa = '" & glsEmpresa & "' " & _
            "WHERE p.idEmpresa = '" & glsEmpresa & "' " & _
            "AND p.idProducto = '" & strCodProd & "'"
    
    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
    
    If Not rst.EOF Then
        DatosProducto = True
        strCodFabri = "" & rst.Fields("idFabricante")
        strCodMar = "" & rst.Fields("idMarca")
        strGlsMarca = "" & rst.Fields("GlsMarca")
        intAfecto = "" & rst.Fields("AfectoIGV")
        strTipoProd = "" & rst.Fields("idTipoProducto")
     Else
        DatosProducto = False
        strCodFabri = ""
        strCodMar = ""
        strGlsMarca = ""
        intAfecto = 1
        strTipoProd = ""
    End If
    rst.Close: Set rst = Nothing

End Function

Private Sub procesaMoneda(strMonProd As String, strMonDoc As String, intTipoValor As Integer, dblValor As Double, intAfecto As Integer, ByRef dblVVUnit As Double, ByRef dblIGVUnit As Double, ByRef dblPVUnit As Double, PIvapUnit As Double, StrMsgError As String, PIdProducto As String)
On Error GoTo Err
Dim dblIGV                          As Double
Dim dblTC                           As Double
Dim NPorcIvap                       As Double
Dim DblCostoS                       As Double
Dim DblCostoD                       As Double
Dim DblMargen                       As Integer
Dim DblvvunitCostoS                 As Double
Dim DblvvunitCostoD                 As Double

    dblIGV = dblIgvNEw
    dblTC = txt_TipoCambio.Value
    If intAfecto = 0 Then dblIGV = 0
    NPorcIvap = Val("" & leeParametro("PORCENTAJE_IVAP"))
    
    
    'Luis Costo soles y Dolares Para Cotizaciones
    DblCostoS = Val(Format(gDetalle.Columns.ColumnByFieldName("CostoS").Value, "0.00"))
    DblCostoD = Val(Format(gDetalle.Columns.ColumnByFieldName("CostoD").Value, "0.00"))
    DblMargen = Val("" & gDetalle.Columns.ColumnByFieldName("Margen").Value)
    DblvvunitCostoS = 0
    DblvvunitCostoD = 0
    
    If DblMargen > 0 And Trim("" & txtCod_Moneda.Text) <> "" Then
        If Trim("" & txtCod_Moneda.Text) = "PEN" Then
            If DblCostoS > 0 Then
                DblvvunitCostoS = (DblCostoS)
            ElseIf DblCostoD > 0 Then
                DblvvunitCostoS = (DblCostoD * Val(Format(txt_TipoCambio.Text, "0.000")))
            End If
        Else
            If DblCostoS > 0 Then
                DblvvunitCostoD = (DblCostoS / Val(Format(txt_TipoCambio.Text, "0.000")))
            ElseIf DblCostoD > 0 Then
                DblvvunitCostoD = (DblCostoD)
            End If
        End If
        
        If Trim("" & txtCod_Moneda.Text) = "PEN" And DblvvunitCostoS > 0 Then
            dblValor = Val(Format(DblvvunitCostoS / (1 - DblMargen / 100), "0.00"))
        ElseIf Trim("" & txtCod_Moneda.Text) = "USD" And DblvvunitCostoD > 0 Then
            dblValor = Val(Format(DblvvunitCostoD / (1 - DblMargen / 100), "0.00"))
        End If
    End If
    '*******************************************
    
    If strMonDoc = "USD" Then 'dolares
        If strMonProd = "PEN" Then 'soles
            dblValor = dblValor / dblTC
        End If
    Else 'soles
        If strMonProd = "USD" Then 'dolares
            dblValor = dblValor * dblTC
        End If
    End If
    
    If intTipoValor = 0 Then 'valor venta
        dblVVUnit = dblValor
        dblIGVUnit = dblValor * dblIGV
        PIvapUnit = 0
        
        If NPorcIvap > 0 Then
            If traerCampo("Productos", "IndAfectoIvap", "IdProducto", PIdProducto, True) = "1" Then
                PIvapUnit = dblValor * (NPorcIvap / 100)
            End If
        End If
        
        dblPVUnit = dblVVUnit + dblIGVUnit + PIvapUnit
    Else 'precio venta
        
        dblIGVUnit = 0
        PIvapUnit = 0
        
        If NPorcIvap > 0 And traerCampo("Productos", "IndAfectoIvap", "IdProducto", PIdProducto, True) = "1" Then
            dblVVUnit = dblValor / ((NPorcIvap / 100) + 1)
            PIvapUnit = dblValor - dblVVUnit
        Else
            dblVVUnit = dblValor / (dblIGV + 1)
            dblIGVUnit = dblValor - dblVVUnit
        End If
        
        
        dblPVUnit = dblValor
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub calculaTotalesFilaPVNeto(dblCantidad As Double, dblVVUnit As Double, dblIGVUnit As Double, dblPVUnit As Double, strDcto As String, intAfecto As Integer)
Dim dblTotalVVBruto     As Double
Dim dblTotalPVBruto     As Double
Dim dblDctoVV           As Double
Dim dblDctoPV           As Double
Dim dblTotalVVNeto      As Double
Dim dblTotalIGVNeto     As Double
Dim dblTotalPVNeto      As Double
Dim dblDctoVVT          As Double
Dim dblDctoPVT          As Double
Dim strPorDcto()        As String
Dim strPorDctoRpt       As String
Dim i As Integer
      
    dblTotalPVNeto = Val("" & gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value) 'Val(Format(GDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value, "0.00"))
    dblTotalVVNeto = Val((dblTotalPVNeto / (Val(1 & "." & right(dblIgvNEw, 2))))) 'Val(Format((DblTotalPVNeto / (Val(1 & "." & right(dblIgvNEw, 2)))), "0.00"))
    
    If intAfecto = 1 Then
        dblTotalIGVNeto = Val(dblTotalVVNeto * dblIgvNEw) 'Val(Format((DblTotalVVNeto * dblIgvNEw), "0.00"))
    Else
        dblTotalIGVNeto = 0#
    End If
           
    dblTotalPVBruto = Val("" & gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
    dblTotalVVBruto = Val((dblTotalPVNeto / (Val(1 & "." & right(dblIgvNEw, 2))))) 'Val(Format((DblTotalPVNeto / (Val(1 & "." & right(dblIgvNEw, 2)))), "0.00"))
    
    gDetalle.Columns.ColumnByFieldName("VVUnit").Value = Val((dblTotalVVNeto / dblCantidad)) 'Val(Format((DblTotalVVNeto / dblCantidad), "0.00"))
    If intAfecto = 1 Then
        gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = Val((Val((dblTotalVVNeto / dblCantidad)) * dblIgvNEw)) 'Val(Format((Val(Format((DblTotalVVNeto / dblCantidad), "0.00")) * dblIgvNEw), "0.00"))
    Else
        dblTotalIGVNeto = 0#
    End If
    gDetalle.Columns.ColumnByFieldName("PVUnit").Value = Val((dblTotalPVNeto / dblCantidad))
    
    gDetalle.Columns.ColumnByFieldName("VVUnitNeto").Value = Val((dblTotalVVNeto / dblCantidad)) 'Val(Format((DblTotalVVNeto / dblCantidad), "0.00"))
    gDetalle.Columns.ColumnByFieldName("PVUnitNeto").Value = Val((dblTotalPVNeto / dblCantidad))
    
    gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value = dblTotalVVBruto
    gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value = dblTotalPVBruto
    gDetalle.Columns.ColumnByFieldName("DctoVV").Value = dblDctoVV
    gDetalle.Columns.ColumnByFieldName("DctoPV").Value = dblDctoPV
    gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value = dblTotalVVNeto
    gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").Value = dblTotalIGVNeto
    gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value = dblTotalPVNeto
    
    gDetalle.Columns.ColumnByFieldName("porDcto").Value = strPorDctoRpt
    
End Sub

Private Sub calculaTotalesFila(dblCantidad As Double, dblVVUnit As Double, dblIGVUnit As Double, dblPVUnit As Double, strDcto As String, intAfecto As Integer, PIdProducto As String)
Dim dblTotalVVBruto                 As Double
Dim dblTotalPVBruto                 As Double
Dim dblDctoVV                       As Double
Dim dblDctoPV                       As Double
Dim dblTotalVVNeto                  As Double
Dim dblTotalIGVNeto                 As Double
Dim dblTotalPVNeto                  As Double
Dim dblDctoVVT                      As Double
Dim dblDctoPVT                      As Double
Dim strPorDcto()                    As String
Dim strPorDctoRpt                   As String
Dim i                               As Integer
Dim NPorcIvap                       As Double
Dim NTotalIvapNeto                  As Double
    
    dblTotalVVBruto = Val(dblCantidad * dblVVUnit) 'Val(Format((dblCantidad * dblVVUnit), "0.00"))
    dblTotalPVBruto = Val(dblCantidad * dblPVUnit) 'Val(Format((dblCantidad * dblPVUnit), "0.00"))

    '---- DESCUENTO EN BASE AL PRECIO UNITARIO
    If Trim(strDcto) <> "" And strDcto <> "0" Then
        strPorDcto = Split(strDcto, "+")
        dblDctoVV = 0
        strPorDctoRpt = ""
        For i = 0 To UBound(strPorDcto)
            dblDctoVVT = (dblVVUnit - dblDctoVV) * (Val(strPorDcto(i)) / 100)
            dblDctoPVT = (dblPVUnit - dblDctoPV) * (Val(strPorDcto(i)) / 100)

            dblDctoVV = dblDctoVV + dblDctoVVT
            dblDctoPV = dblDctoPV + dblDctoPVT
            strPorDctoRpt = strPorDctoRpt & CStr(Val(strPorDcto(i))) & "+"
        Next
    Else
        dblDctoVV = 0
        dblDctoPV = 0
        strPorDctoRpt = "0"
    End If
    '--------------------------------------------------------
    
    If Len(strPorDctoRpt) > 1 Then strPorDctoRpt = left(strPorDctoRpt, Len(strPorDctoRpt) - 1)
    gDetalle.Columns.ColumnByFieldName("VVUnitNeto").Value = Val(dblVVUnit - dblDctoVV) 'Val(Format((dblVVUnit - DblDctoVV), "0.00"))
    gDetalle.Columns.ColumnByFieldName("PVUnitNeto").Value = Val(dblPVUnit - dblDctoPV) 'Val(Format((dblPVUnit - DblDctoPV), "0.00"))
    
    dblTotalVVNeto = Val((dblCantidad * (dblVVUnit - dblDctoVV))) 'DCTO PRECIO UNITARIO  CAMBIO
    NTotalIvapNeto = 0
    
    If intAfecto = 1 Then
        dblTotalIGVNeto = Val((dblTotalVVNeto * dblIgvNEw))
    Else
        NPorcIvap = Val("" & leeParametro("PORCENTAJE_IVAP"))
        dblTotalIGVNeto = 0
        
        If NPorcIvap > 0 Then
            
            If traerCampo("Productos", "IndAfectoIvap", "IdProducto", PIdProducto, True) = "1" Then
                NTotalIvapNeto = Val((dblTotalVVNeto * (NPorcIvap / 100)))
            End If
        
        End If
        
    End If
    
    dblTotalPVNeto = Val(dblTotalVVNeto + dblTotalIGVNeto + NTotalIvapNeto) 'Val(Format((DblTotalVVNeto + DblTotalIGVNeto + NTotalIvapNeto), "0.00"))
    
    gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value = dblTotalVVBruto
    gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value = dblTotalPVBruto
    gDetalle.Columns.ColumnByFieldName("DctoVV").Value = dblDctoVV
    gDetalle.Columns.ColumnByFieldName("DctoPV").Value = dblDctoPV
    gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value = dblTotalVVNeto
    gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").Value = dblTotalIGVNeto
    gDetalle.Columns.ColumnByFieldName("TotalIvapNeto").Value = NTotalIvapNeto
    gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value = dblTotalPVNeto
    gDetalle.Columns.ColumnByFieldName("porDcto").Value = strPorDctoRpt
    
End Sub

Private Sub ListaDetalle()
Dim rsdatos         As New ADODB.Recordset
Dim StrMsgError     As String
On Error GoTo Err

    Set gListaDetalle.DataSource = Nothing
    If gLista.Count = 0 Then Exit Sub
    
    csql = "EXEC spu_Docventas_ListaDet '" & glsEmpresa & "','" & glsSucursal & "','" & strTipoDoc & "','" & gLista.Columns.ColumnByFieldName("idDocVentas").Value & "','" & gLista.Columns.ColumnByFieldName("idSerie").Value & "'"
    If rsdatos.State = 1 Then rsdatos.Close: Set rsdatos = Nothing
    rsdatos.Open csql, Cn, adOpenStatic, adLockOptimistic
    
    Set gListaDetalle.DataSource = rsdatos

Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub txt_TextoBuscar_KeyPress(KeyAscii As Integer)
On Error GoTo Err
Dim StrMsgError As String
    
    If KeyAscii = 13 Then
        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub TxtcantProducto_Atn_KeyPress(KeyAscii As Integer)
Dim StrMsgError As String
On Error GoTo Err
    
    If InStr("0123456789.", Chr(KeyAscii)) = 0 Then
        KeyAscii = 0
    End If
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub


Private Sub txtCod_Almacen_Change()
    If Trim("" & txtCod_Almacen.Text) = "" Then Exit Sub
    txtGls_Almacen.Text = traerCampo("almacenes", "GlsAlmacen", "idAlmacen", txtCod_Almacen.Text, True)

End Sub

Private Sub txtCod_Almacen_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "ALMACEN", txtCod_Almacen, txtGls_Almacen
        KeyAscii = 0
        If txtCod_Almacen.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_CentroCosto_Change()
    If Trim("" & txtCod_CentroCosto.Text) = "" Then Exit Sub
    txtGls_CentroCosto.Text = traerCampo("centroscosto", "GlsCentroCosto", "idCentroCosto", txtCod_CentroCosto.Text, True)

End Sub

Private Sub txtCod_CentroCosto_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "CENTROCOSTO", txtCod_CentroCosto, txtGls_CentroCosto
        KeyAscii = 0
        If txtCod_CentroCosto.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_Chofer_Change()
    If Trim("" & txtCod_Chofer.Text) = "" Then Exit Sub
    If indCargando = False And txtCod_Chofer.Text <> "" Then
        txt_Brevete.Text = traerCampo("choferes", "NroBrevete", "idChofer", Trim(txtCod_Chofer.Text), True)
    End If

End Sub

Private Sub txtCod_Chofer_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "CHOFER", txtCod_Chofer, txtGls_Chofer
        KeyAscii = 0
        If txtCod_Chofer.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_Cliente_Change()
On Error GoTo Err
Dim StrMsgError As String
Dim rst As New ADODB.Recordset
Dim rst2 As New ADODB.Recordset
Dim terceros As String
Dim csMysql  As String
Dim rsp                     As New ADODB.Recordset
Dim strCod                  As String
Dim strDes                  As String
Dim strCodFabri             As String
Dim strCodMar               As String
Dim strDesMar               As String
Dim strTipoProd             As String
Dim strMoneda               As String
Dim strCodUM                As String
Dim strDesUM                As String
Dim ndcto                   As Double
Dim dblTC                   As Double
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim dblDcto                 As Double
Dim dblTotalBruto           As Double
Dim intAfecto               As Integer
Dim IndEvaluacion           As Integer
Dim i                       As Integer
Dim idUMCompra              As String
Dim dblDctoVer              As Double
Dim strDcto                 As String
Dim StrCodRapido            As String
Dim rsValida                As New ADODB.Recordset

    If indCargando = False And txtCod_Cliente.Text <> "" Then
        
'        csql = "SELECT p.ruc,(p.direccion + ' ' + IsNull(u.glsUbigeo,'') + ' ' + IsNull(d.glsUbigeo,'')) direccion,p.GlsPersona,p.direccionEntrega " & _
'               "FROM personas p " & _
'               "LEFT JOIN ubigeo u ON P.IdPais = U.IdPais And P.idDistrito = u.idDistrito " & _
'               "LEFT JOIN ubigeo d ON u.IdPais = d.IdPais And left(u.idDistrito,2) = d.idDpto AND d.idProv = '00' AND d.idDist = '00' " & _
'               "Where p.idPersona = '" & txtCod_Cliente.Text & "'"
        csql = "EXEC spu_traDatos_Cliente '" & glsEmpresa & "','" & txtCod_Cliente.Text & "'"
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            txt_RUC.Text = "" & rst.Fields("ruc")
            txt_Direccion.Text = "" & rst.Fields("direccion")
            
'            '--- AGREGADO 06/10/14 NSE
'            If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "VISUALIZA_DIRECCION_SIN_PROVINCIA", True) = "S" Then
'                txt_Direccion.Text = traerCampo("PERSONAS", "DIRECCION", "IDPERSONA", txtCod_Cliente.Text, False)
'            End If
            
            txtGls_Cliente.Text = "" & rst.Fields("GlsPersona")
            txtCod_VendedorCampo.Text = Trim("" & rst.Fields("idVendedorCampo")) 'traerCampo("clientes", "idVendedorCampo", "idCliente", txtCod_Cliente.Text, True)
            txtCod_EmpTrans.Text = Trim("" & rst.Fields("idEmpTrans")) 'traerCampo("clientes", "idEmpTrans", "idCliente", txtCod_Cliente.Text, True)
            dblPorDsctoEspecial = Val("" & rst.Fields("Val_Dscto")) 'Val(traerCampo("clientes", "Val_Dscto", "idCliente", txtCod_Cliente.Text, True))
            
            'LUIS 17/10/2018 valida la forma de pago
            txtCod_FormaPago.Text = ""
            'If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
            '    txtCod_FormaPago.Text = traerCampo("clientesformapagos", "idFormaPago", "idCliente", txtCod_Cliente.Text, True, " indprincipal = 1 ")
            'Else
                txtCod_FormaPago.Text = Trim("" & rst.Fields("idFormaPago")) 'traerCampo("clientesformapagos", "idFormaPago", "idCliente", txtCod_Cliente.Text, True)
            'End If
            '****************************************
            'txtCod_FormaPago.Text = traerCampo("clientesformapagos", "idFormaPago", "idCliente", txtCod_Cliente.Text, True)
            
            terceros = "0" 'traerCampo("clientes", "indventasterceros", "idCliente", txtCod_Cliente.Text, True)
            
            'If traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20566047668" Or traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20505322674" Then
            '    txt_Llegada.Text = traerCampo("PERSONAS", "DIRECCION", "IDPERSONA", txtCod_Cliente.Text, False)
            'Else
            If strTipoDoc <> "92" Then
                txt_Llegada.Text = "" & rst.Fields("direccionEntrega")
            End If
            'End If
            
            Txt_ProvCliente.Text = "" 'Trim("" & traerCampo("clientes", "idProvCliente", "idCliente", txtCod_Cliente.Text, True))
            
            If terceros = "0" Then
                lblvtcliente.Visible = False
                lblvtruc.Visible = False
                lvlvtdireccion.Visible = False
                txtvtcodigo.Visible = False
                txtvtglscliente.Visible = False
                txtvtruc.Visible = False
                txtvtdireccion.Visible = False
                btnvt.Visible = False
            Else
                lblvtcliente.Visible = True
                lblvtruc.Visible = True
                lvlvtdireccion.Visible = True
                txtvtcodigo.Visible = True
                txtvtglscliente.Visible = True
                txtvtruc.Visible = True
                txtvtdireccion.Visible = True
                btnvt.Visible = True
            End If
            
            If Trim(STR_CLIENTE_ANULA & "") = "S" Then
                If traerCampo("Clientes", "IndAnula", "idCliente", txtCod_Cliente.Text, True) = 1 Then
                    strCod = Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "PRODUCTO_ANULA", True) & "")
                    strDes = "ANULADO"
        
                    csql = "SELECT idProducto,GlsProducto,idUMVenta,CodigoRapido FROM Productos " & _
                           "WHERE idempresa = '" & glsEmpresa & "' AND (idProducto = '" & strCod & "' )"
                    rsp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                    If rsp.EOF Or rsp.BOF Then
                        csql = "SELECT idProducto,GlsProducto,idUMVenta FROM Productos " & _
                                "WHERE idProducto = '" & strCod & "' and idEmpresa = '" & glsEmpresa & "' "
                        If rsp.State = 1 Then rsp.Close
                        rsp.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                        If rsp.EOF Or rsp.BOF Then
                            StrMsgError = "No se encuentra registrado el producto"
                            gDetalle.Dataset.Edit
                            gDetalle.Columns.ColumnByFieldName("idProducto").Value = ""
                            gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = ""
                            gDetalle.Dataset.Post
                            GoTo Err
                        Else
                            strCod = "" & rsp.Fields("idProducto")
                            strDes = "" & rsp.Fields("GlsProducto")
                            strCodUM = "" & rsp.Fields("idUMVenta")
                            StrCodRapido = "" & rsp.Fields("CodigoRapido")
                        End If
                    Else
                        strCod = "" & rsp.Fields("idProducto")
                        strDes = "" & rsp.Fields("GlsProducto")
                        strCodUM = "" & rsp.Fields("idUMVenta")
                        StrCodRapido = "" & rsp.Fields("CodigoRapido")
                    End If
                        
                    gDetalle.Dataset.Edit
                    gDetalle.Columns.ColumnByFieldName("idProducto").Value = strCod
                    gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = strDes
                    gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = StrCodRapido
                    
                    '---- Trae datos producto
                    If DatosProducto(strCod, strCodFabri, strCodMar, strDesMar, intAfecto, strTipoProd) = False Then
                    End If
                    gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = strCodFabri
                    gDetalle.Columns.ColumnByFieldName("idMarca").Value = strCodMar
                    gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = strDesMar
                    gDetalle.Columns.ColumnByFieldName("Afecto").Value = intAfecto
                    gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = strTipoProd
                    gDetalle.Columns.ColumnByFieldName("idMoneda").Value = strMoneda
                    gDetalle.Columns.ColumnByFieldName("idUM").Value = strCodUM
                    gDetalle.Columns.ColumnByFieldName("GlsUM").Value = strDesUM
                    gDetalle.Columns.ColumnByFieldName("Factor").Value = dblFactor
                    gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
                    gDetalle.Columns.ColumnByFieldName("VVUnit").Value = 1
                    gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = 0.18
                    gDetalle.Columns.ColumnByFieldName("PVUnit").Value = 1.18
                    gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = 1
                    gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = 1.18
                    gDetalle.Dataset.Post
                    
                    gDetalle.Dataset.Edit
                    calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, 1#, 0.18, 1.18, "0", 1, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
                    gDetalle.Dataset.Post
                    
                    calcularTotales StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                        
                End If
            End If
        End If
        rst.Close: Set rst = Nothing
        
        traerListaPrecios StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
'        If ChkfContado.Value = 0 Then 'Luis 25/03/2017
            
        'Luis 17/10/2018 forma de pago********************************
'            Dim StrCadSqlx   As String
'
'            If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
'
'            StrCadSqlx = "SELECT a.idtipoformapago FROM formaspagos a inner join tipoformaspago b " & _
'                         "on a.idtipoformapago  = b.idtipoformapago " & _
'                         "where a.idformapago = '" & Trim("" & txtCod_FormaPago.Text) & "' and a.idempresa  = '01' and b.TipoFormaPago  = 'C' "
'
'            rsValida.Open StrCadSqlx, Cn, adOpenStatic, adLockOptimistic
'            If rsValida.EOF Then
'
'                If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
'                rsValida.Open "select idCliente from ClientesEspecial where idCliente = '" & Trim("" & txtCod_Cliente.Text) & "'", Cn, adOpenStatic, adLockOptimistic
'                If rsValida.EOF Then
'                    ActualizaLineaCredito StrMsgError, txtCod_Cliente.Text
'                    VerificaLineaCredito StrMsgError, txtCod_Cliente.Text, False, ""
'                    If StrMsgError <> "" Then GoTo Err
'
'                End If
'
'            End If
'        End If
        
'        If leeParametro("FACTURACION_ENTRE_EMPRESAS") = "S" Then
'            If traerCampo("Empresas", "IdEmpresa", "IdPersona", txtCod_Cliente.Text, False) <> "" Then
'                FraCentroCostoCliente.Visible = True
'            Else
'                FraCentroCostoCliente.Visible = False
'            End If
'        End If
        
    Else
        txtGls_Cliente.Text = ""
        txt_RUC.Text = ""
        txt_Direccion.Text = ""
        If txt_Llegada.Visible Then txt_Llegada.Text = ""
        txtGls_Cliente.Text = ""
        txtCod_VendedorCampo.Text = ""
        txtCod_EmpTrans.Text = ""
        txtCod_FormaPago.Text = ""
        dblPorDsctoEspecial = 0
        
        FraCentroCostoCliente.Visible = False
    End If
  
'     '******************** 24/03/2019 Luis ***********************
'    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'        cmbAyudaLista.Enabled = False
'        txtCod_Lista.Locked = True
'        txtGls_Lista.Locked = True
'        txtCod_Lista.Enabled = False
'    End If
'    '*************************************************************
            
Exit Sub
Err:
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
    Resume
End Sub

Private Sub txtCod_Cliente_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaClientesKeyascii KeyAscii, txtCod_Cliente, txtGls_Cliente, txt_RUC, txt_Direccion
        KeyAscii = 0
        If txtCod_Cliente.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_contacto_Change()
    If Trim("" & txtCod_contacto.Text) = "" Then Exit Sub
    txtgls_contacto.Text = traerCampo("PERSONAS", "GLSPERSONA", "IDPERSONA", txtCod_contacto.Text, False)

End Sub

Private Sub txtCod_EmpTrans_Change()
    If Trim("" & txtCod_EmpTrans.Text) = "" Then Exit Sub
    If txtCod_EmpTrans.Text <> "" Then
        txtGls_EmpTrans.Text = traerCampo("personas", "GlsPersona", "idPersona", txtCod_EmpTrans.Text, False)
        txt_RUCEmp.Text = traerCampo("personas", "ruc", "idPersona", txtCod_EmpTrans.Text, False)
        
        If glsPersonaEmpresa <> "" Then
            If glsPersonaEmpresa <> txtCod_EmpTrans.Text Then
                If txt_Partida2.Text = "" Then txt_Partida2.Text = txt_Llegada.Text
                If txt_Llegada2.Text = "" Then txt_Llegada2.Text = txt_Direccion.Text
            End If
        End If
    Else
        txtGls_EmpTrans.Text = ""
        txt_RUCEmp.Text = ""
    End If

End Sub

Private Sub txtCod_EmpTrans_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "EMPTRANS", txtCod_EmpTrans, txtGls_EmpTrans
        KeyAscii = 0
        If txtCod_EmpTrans.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_FormaPago_Change()
    If Trim("" & txtCod_FormaPago.Text) = "" Then Exit Sub
    If txtCod_FormaPago.Text = "" Then
        txtGls_FormaPago.Text = ""
    Else
        txtGls_FormaPago.Text = traerCampo("formaspagos", "glsFormaPago", "idFormaPago", txtCod_FormaPago.Text, False)
    End If

End Sub

Private Sub txtCod_Lista_Change()
On Error GoTo Err
Dim StrMsgError      As String
Dim CArray(1)        As String

    If Trim("" & txtCod_Lista.Text) = "" Then Exit Sub
    
    traerCampos "listaprecios", "GlsLista,IdMoneda", "idLista", txtCod_Lista.Text, 2, CArray, True
    
    'txtGls_Lista.Text = traerCampo("listaprecios", "GlsLista", "idLista", txtCod_Lista.Text, True)
    txtGls_Lista.Text = CArray(0)
    
    If Not indCargando Then
        'txtCod_Moneda.Text = traerCampo("listaprecios", "IdMoneda", "idLista", txtCod_Lista.Text, True)
        txtCod_Moneda.Text = CArray(1)
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txtCod_Lista_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "LISTAPRECIOS", txtCod_Lista, txtGls_Lista
        KeyAscii = 0
        If txtCod_Lista.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_Moneda_Change()
    
    txtGls_Moneda.Text = traerCampo("monedas", "GlsMoneda", "idMoneda", txtCod_Moneda.Text, False)
    lbl_SimbMonBruto.Caption = traerCampo("monedas", "Simbolo", "idMoneda", txtCod_Moneda.Text, False)
    lbl_SimbMonIGV.Caption = lbl_SimbMonBruto.Caption
    lbl_SimbMonNeto.Caption = lbl_SimbMonBruto.Caption
    txt_SimboloMonBruto.Text = lbl_SimbMonBruto.Caption
    txt_SimboloMonIGV.Text = lbl_SimbMonBruto.Caption
    txt_SimboloMonNeto.Text = lbl_SimbMonBruto.Caption
    
    If Len(Trim(txtCod_Moneda.Text)) > 0 Then
        'If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
            lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        'Else
        '    lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        'End If
        txt_MontoLetras.Text = lbl_TotalLetras.Caption
    End If

End Sub

Private Sub txtCod_Moneda_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "MONEDA", txtCod_Moneda, txtGls_Moneda
        KeyAscii = 0
        If txtCod_Moneda.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_MotivoNCD_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "MOTIVONCD", txtCod_MotivoNCD, txtGls_MotivoNCD, "And IdDocumento = '" & strTipoDoc & "'"
        KeyAscii = 0
        If txtCod_MotivoNCD.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_MotivoTraslado_Change()
Dim StrDirRecojo                As String
On Error GoTo Err
Dim StrMsgError                 As String

    If Trim("" & txtCod_MotivoTraslado.Text) = "" Then Exit Sub
    
    If txtCod_MotivoTraslado.Text <> "" Then
    
        txtGls_MotivoTraslado.Text = traerCampo("motivostraslados", "GlsMotivoTraslado", "idMotivoTraslado", txtCod_MotivoTraslado.Text, False)
        
        'If leeParametro("RECEPCIONA_MERCADERIA") = "S" Then
        '
        '    If Len(Trim("" & traerCampo("MotivosTraslados", "IdConceptoI", "IdMotivoTraslado", txtCod_MotivoTraslado.Text, False))) > 0 Then
        '
        '        LblSucursalDestino.Visible = True
        '        TxtCodSucursalDestino.Visible = True
        '        TxtGlsSucursalDestino.Visible = True
        '        CmdAyudaSucursalDestino.Visible = True
        '
        '    Else
        '
        '        LblSucursalDestino.Visible = False
        '        TxtCodSucursalDestino.Visible = False
        '        TxtGlsSucursalDestino.Visible = False
        '        CmdAyudaSucursalDestino.Visible = False
        '
        '    End If
          
        'Else
            
            LblSucursalDestino.Visible = False
            TxtCodSucursalDestino.Visible = False
            TxtGlsSucursalDestino.Visible = False
            CmdAyudaSucursalDestino.Visible = False
                
        'End If
                
        'Luis 15/04/2018
        StrDirRecojo = Val(Trim("" & traerCampo("motivostraslados", "IndDirRecojo", "idMotivoTraslado", txtCod_MotivoTraslado.Text, False)))
        If Val(StrDirRecojo) = 1 Then
            TxtCodDir_Recojo.Visible = True
            TxtGlsDir_Recojo.Visible = True
            lblDirRecojo.Visible = True
            cmbAyudaDirRecojo.Visible = True
        Else
            TxtCodDir_Recojo.Visible = False
            TxtGlsDir_Recojo.Visible = False
            lblDirRecojo.Visible = False
            cmbAyudaDirRecojo.Visible = False
        End If
        
    Else
        
        txtGls_MotivoTraslado.Text = ""
        LblSucursalDestino.Visible = False
        TxtCodSucursalDestino.Text = ""
        TxtCodSucursalDestino.Visible = False
        TxtGlsSucursalDestino.Visible = False
        CmdAyudaSucursalDestino.Visible = False
            
    End If
    
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txtCod_MotivoTraslado_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "MOTIVOTRASLADO", txtCod_MotivoTraslado, txtGls_MotivoTraslado
        KeyAscii = 0
        If txtCod_MotivoTraslado.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_Tienda_Change()
On Error GoTo Err
Dim StrMsgError                     As String

    If Trim("" & txtCod_Tienda.Text) = "" Then Exit Sub
    
'    If traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20544632192" Then
'        txt_Llegada.Text = "" & traerCampo("TiendasCliente", "GlsDireccion", "IdEmpresa", "01", False, "IdTdaCli = '" & txtCod_Tienda.Text & "'")
'    Else
        txt_Llegada.Text = "" & traerCampo("TiendasCliente", "GlsDireccion", "IdPersona", txtCod_Cliente.Text, True, "IdTdaCli = '" & txtCod_Tienda.Text & "'")
'    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txtCod_TipoTicket_Change()
    If Trim("" & txtCod_TipoTicket.Text) = "" Then Exit Sub
    txtGls_TipoTicket.Text = traerCampo("datos", "GlsDato", "idDato", txtCod_TipoTicket.Text, False)

End Sub

Private Sub txtCod_TipoTicket_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "TIPOTICKET", txtCod_TipoTicket, txtGls_TipoTicket
        KeyAscii = 0
        If txtCod_TipoTicket.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_UnidProd_Change()
    
    If Trim("" & txtCod_UnidProd.Text) = "" Then
        txtGls_UnidProd.Text = ""
    Else
        txtGls_UnidProd.Text = traerCampo("unidadproduccion", "Descunidad", "CodUnidProd", txtCod_UnidProd.Text, True)
        
        If Not indCargando Then
            
            If Len(Trim("" & traerCampo("unidadproduccion", "SerieFac", "CodUnidProd", txtCod_UnidProd.Text, False))) > 0 Then
            
                txt_Serie.Text = traerCampo("unidadproduccion", "SerieFac", "CodUnidProd", txtCod_UnidProd.Text, False)
                
            End If
            
            If Len(Trim("" & traerCampo("unidadproduccion", "IdAlmacen", "CodUnidProd", txtCod_UnidProd.Text, True))) > 0 Then
            
                txtCod_Almacen.Text = Trim("" & traerCampo("unidadproduccion", "IdAlmacen", "CodUnidProd", txtCod_UnidProd.Text, True))
            
            End If
            
        End If
        
    End If

End Sub

Private Sub txtCod_Vehiculo_Change()
Dim rst As New ADODB.Recordset
    
    If indCargando = False And Trim("" & txtCod_Vehiculo.Text) <> "" Then
        csql = "SELECT GlsPlaca,GlsDato as Marca, GlsModelo, GlsColor, GlsCodInscripcion, idEmpTrans " & _
               "FROM vehiculos,datos " & _
               "WHERE idEmpresa = '" & glsEmpresa & "' AND idMarcaVehi = idDato AND idVehiculo = '" & txtCod_Vehiculo.Text & "'"
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            txt_Placa.Text = "" & rst.Fields("GlsPlaca")
            txt_Marca.Text = "" & rst.Fields("Marca")
            txt_Modelo.Text = "" & rst.Fields("GlsModelo")
            txt_Color.Text = "" & rst.Fields("GlsColor")
            txt_CodInscripcion.Text = "" & rst.Fields("GlsCodInscripcion")
            'txtCod_EmpTrans.Text = "" & rst.Fields("idEmpTrans")
        End If
        rst.Close
    Else
        txtGls_Vehiculo.Text = ""
        txt_Placa.Text = ""
        txt_Marca.Text = ""
        txt_Modelo.Text = ""
        txt_Color.Text = ""
        txt_CodInscripcion.Text = ""
        'txtCod_EmpTrans.Text = ""
    End If
    Set rst = Nothing

End Sub

Private Sub txtCod_Vehiculo_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "VEHICULO", txtCod_Vehiculo, txtGls_Vehiculo
        KeyAscii = 0
        If txtCod_Vehiculo.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_Vendedor_Change()
On Error GoTo Err
Dim StrMsgError As String

    If Trim("" & txtCod_Vendedor.Text) = "" Then Exit Sub
    
    txtGls_Vendedor.Text = traerCampo("personas", "GlsPersona", "idPersona", txtCod_Vendedor.Text, False)
    
    traerListaPrecios StrMsgError
    If StrMsgError <> "" Then GoTo Err

Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title

End Sub

Private Sub txtCod_VendedorCampo_Change()

    If Trim("" & txtCod_VendedorCampo.Text) = "" Then Exit Sub
    txtGls_VendedorCampo.Text = traerCampo("personas", "GlsPersona", "idPersona", txtCod_VendedorCampo.Text, False)
    
End Sub

Private Sub valoresIniciales()
Dim rst As New ADODB.Recordset
    
    csql = "EXEC spu_Docventas_VariableIni '" & glsEmpresa & "','" & strTipoDoc & "','" & glsUser & "','" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "'"
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
    If Not rst.EOF Then
        txt_Serie.Text = "" & rst.Fields("idserie")
        txt_TipoCambio.Text = Val("" & rst.Fields("TcVenta"))
        
        If Trim("" & rst.Fields("idVendedor")) <> "" Then
            txtCod_Vendedor.Text = "" & rst.Fields("idVendedor")
        End If
    End If
        
    txt_Serie.Text = traerCampo("seriexusuario", "idSerie", "idUsuario", glsUser, True, " idDocumento = '" & strTipoDoc & "'")
    txt_TipoCambio.Text = Val(traerCampo("TiposDeCambio", "TcVenta", "Fecha", Format(dtp_Emision.Value, "yyyy-mm-dd"), False))
    
    txtCod_Almacen.Text = glsAlmVentas
    txtCod_Lista.Text = glsListaVentas
    txtCod_Moneda.Text = glsMonVentas
    
    If strTipoDoc = "03" Or strTipoDoc = "12" Or strTipoDoc = "90" Then
        txtCod_Cliente.Text = glsClienteVentas
    End If
    
    If strTipoDoc = "86" Then 'Guia
    
        If rst.State = 1 Then rst.Close: Set rst = Nothing
        
        csql = "SELECT " & IIf(traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20566047668" Or traerCampo("Empresas", "Ruc", "IdEmpresa", glsEmpresa, False) = "20505322674", "p.Direccion", "concat(p.direccion,' ',u.glsUbigeo,' ',d.glsUbigeo)") & " direccion " & _
               "FROM personas p LEFT JOIN ubigeo u ON P.idDistrito = u.idDistrito LEFT JOIN ubigeo d ON left(u.idDistrito,2) = d.idDpto AND d.idProv = '00' AND d.idDist = '00' " & _
               "Where p.idPersona = '" & glsSucursal & "'"
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            txt_Partida.Text = "" & rst.Fields("direccion")
        End If
    End If
    
    If traerCampo("vendedores", "idVendedor", "idVendedor", glsUser, True) <> "" Then
        txtCod_Vendedor.Text = glsUser
    End If
    
    If strTipoDoc = "40" Then txtCod_FormaPago.Text = leeParametro("FORMAPAGO_PEDIDO")
    
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    
    TxtDescuentoGlobal.Text = "0"
    
End Sub

Private Sub anularDoc(ByRef StrMsgError As String)
On Error GoTo Err
Dim rst                 As New ADODB.Recordset
Dim rsCta_Mvto          As New ADODB.Recordset
Dim rs                  As New ADODB.Recordset
Dim RScTA_dCTO          As New ADODB.Recordset
Dim rstcab              As New ADODB.Recordset
Dim iniTrans            As Boolean
Dim strNumVale          As String
Dim strMovCaja          As String
Dim strCodUsuarioAutorizacion As String
Dim cabrev              As String
Dim cdocumento          As String
Dim Cta_Dcto            As String
Dim numFactura          As String
Dim serieFactura        As String
Dim estFactura          As String
Dim idmovcaja           As String
Dim idFormaPago         As String
Dim IndEvaluacion       As Integer
Dim idValeDocventas     As String
Dim strTipoVale         As String
Dim Pagos               As Integer
Dim rsliquidacion       As New ADODB.Recordset
Dim CadMysqlLiq         As String
Dim CadMysqlLiqAct      As String
Dim idValescabIngreso   As String
Dim strTipoValeIngreso  As String
Dim strSucursalDes      As String
Dim cobservacion        As String
Dim codanula            As String
Dim CSqlC               As String
Dim RsC                 As New ADODB.Recordset

    '---- Verificamos si el mes esta cerrado
    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    '--- Parametro que evaluará la liberación del detalle de un documento de  referencia por el item del producto
    strParamItemPro = Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "EVALUA_ITEM_DETALLE_PRODUCTO", True))
    
    idValeDocventas = Trim("" & traerCampo("docventas", "idValesCab", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoVale = Trim("" & traerCampo("docventas", "tipoVale", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    
    idValescabIngreso = Trim("" & traerCampo("docventas", "idValesCabing", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoValeIngreso = Trim("" & traerCampo("docventas", "tipoValeing", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strSucursalDes = Trim("" & traerCampo("docventas", "SucursalDestino", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))

    If MsgBox("Está seguro(a) de Anular el Documento?", vbQuestion + vbYesNo, App.Title) = vbYes Then
        
        If strTipoDoc = "86" Then
            
            '************* Luis 16/01/2018 **********************
            'MsgBox "SI ANULA ESTA GUIA NO PODRA HACER USO DEL STOCK HASTA DENTRO DE 24 HORAS", vbInformation, Me.Caption
            '****************************************************
            
            '---- Buscamos la factura q esta amarrada
            If gDocReferencia.Count > 0 Then
                gDocReferencia.Dataset.First
                Do While Not gDocReferencia.Dataset.EOF
                    If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                        numFactura = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                        serieFactura = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                        Exit Do
                    End If
                    gDocReferencia.Dataset.Next
                Loop
            End If
            
            '---- Verificamos el estado de la factura
            estFactura = traerCampo("docventas", "estDocVentas", "iddocventas", numFactura, True, " iddocumento = '01' and idSerie = '" & serieFactura & "' ")
            If estFactura = "IMP" Then
                StrMsgError = "La factura ya fue impresa, no se puede anular la Guía."
                GoTo Err
            End If
            
            '---- Verificamos si la factura tiene pagos
            idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and idDocumento = '01' and idTipoMovCaja = '99990002'")
            cabrev = "Fac"
            cdocumento = cabrev & serieFactura & "/" & numFactura
            Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
            Pagos = 0
            If Cta_Dcto <> "" Then Pagos = Val(traerCampo("Cta_Mvto", "count(*)", "idCta_Dcto", Cta_Dcto, True))
            idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
            If idFormaPago <> "06090001" And idFormaPago <> "06090004" And Pagos <> 0 Then
               StrMsgError = "No se puede anular el documento porque esta cancelado en cuentas por cobrar"
               GoTo Err
            End If
        End If
        IndEvaluacion = 0
    
        frmAprobacion.MostrarForm "01", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        If IndEvaluacion = 0 Then Exit Sub
        
        If leeParametro("VENTA_ELECTRONICA") = "S" And Not IsNumeric(left(txt_Serie.Text, 1)) Then
    
            CSqlC = "Select A.IndAceptadoSunat,A.IndRechazadoSunat,IIf(A.IndAceptadoSunat = 1,DATEDIFF(day,A.FechaAceptacionSunat,GETDATE()),0) Dias  " & _
                    "From DocVentas A " & _
                    "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdDocumento = '" & strTipoDoc & "' " & _
                    "And A.IdSerie = '" & txt_Serie.Text & "' And A.IdDocVentas = '" & txt_NumDoc.Text & "'"
            AbrirRecordset StrMsgError, Cn, RsC, CSqlC: If StrMsgError <> "" Then GoTo Err
            If Not RsC.EOF Then
                
                If Val("" & RsC.Fields("IndAceptadoSunat")) = 1 Then
                    If Val("" & RsC.Fields("Dias")) > Val("" & leeParametro("DIAS_ANULACION_FE")) Then
                        StrMsgError = "El documento no puede ser anulado, han pasado más de " & Val("" & leeParametro("DIAS_ANULACION_FE")) & " días, verifique.": GoTo Err
                    End If
                'ElseIf Val("" & RsC.Fields("IndRechazadoSunat")) = 0 Then
                '    StrMsgError = "El Documento debe estar aceptado o Rechazado para ser anulado. Verifique.": GoTo Err
                End If
                
            End If
            RsC.Close: Set RsC = Nothing
            
        End If
        
        cobservacion = ""
        If strTipoDoc = "01" Then
            frmMotivosAnula.Motivos_Anulacion codanula, cobservacion
            'If Len(Trim(cobservacion)) = 0 Then Exit Sub
            If StrMsgError <> "" Then GoTo Err
        End If
        
        Cn.BeginTrans
        iniTrans = True
    
'        FacturacionEntreEmpresasElimina StrMsgError, txt_serie.Text, txt_numdoc.Text
'        If StrMsgError <> "" Then GoTo Err
        
        If strTipoDoc = "86" Then
            '---- Anulamos la factura de ctas por cobrar
            csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
            If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
            rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            Do While Not rsCta_Mvto.EOF
                csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                         "from cta_dcto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
                If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
                RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                Do While Not RScTA_dCTO.EOF
                    If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                        csql = "delete from cta_dcto " & _
                               "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                    Else
                        If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                            If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                            If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        End If
                    End If
                    Cn.Execute (csql)
                    RScTA_dCTO.MoveNext
                Loop
                
                csql = "delete from cta_mvto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
                Cn.Execute csql
                
                rsCta_Mvto.MoveNext
            Loop
            csql = "UPDATE CTA_DCTO SET VALTOTAL = 0, VALTOTALORI = 0,VALSALDO = 0 " & _
                     "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
                     "and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            
            '---- Anulamos la factura de Docventas
            csql = "UPDATE docventas SET estDocventas = 'ANU', idUsuarioAnulacion = '" & strCodUsuarioAutorizacion & _
                    "' WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
                    "' AND idDocumento = '01' AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
            Cn.Execute csql
            
            '---- Anulando el ingreso a caja
            csql = "UPDATE movcajasdet SET estMovCajaDet = 'ANU' " & _
                   "WHERE idMovCaja = '" & idmovcaja & "' " & _
                     "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '01' " & _
                     "AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
            Cn.Execute csql
        
            '---- Eliminamos del pagosDocVentas
            csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                    "AND idDocumento = '01' and idDocVentas = '" & numFactura & "' and idSerie = '" & serieFactura & "'"
            Cn.Execute csql
        End If
        
        '---- Anulando el Documento
        csql = "UPDATE docventas SET estDocventas = 'ANU',  FechaAnulacion = '" & Format(Date, "yyyy-mm-dd") & Space(2) & Format(Time, "h:mm:ss") & _
                "' ,idUsuarioAnulacion = '" & strCodUsuarioAutorizacion & "', GlsObsAnula='" & cobservacion & _
                "' WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
                "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
                "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
        
        '----------------------------------------------------------------------------------
        '---- ANULAR DE CTASXCOBRAR MYSQL
        cabrev = traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False)
        '******* lUIS 25/02/2018 **************
        cdocumento = cabrev & Trim("" & txt_Serie.Text) & "/" & Format(txt_NumDoc.Text, "00000000")
        '**************************************
        'cdocumento = cabrev & Format(txt_Serie.Text, "000") & "/" & Format(txt_NumDoc.Text, "00000000")
        Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
            
        If cabrev = "Cre" Then
            csql = "select idCta_Comp as idCta_Dcto, idCta_Dcto as idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Comp = '" & Cta_Dcto & "' And IdCta_Comp <> '' and idEmpresa = '" & glsEmpresa & "' "
        Else
            csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' And IdCta_Dcto <> '' and idEmpresa = '" & glsEmpresa & "' "
        End If
        If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
        rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
        If Not rsCta_Mvto.EOF Then
            idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", txt_NumDoc.Text, True, "idSerie = '" & txt_Serie.Text & "' and idDocumento = '" & strTipoDoc & "' and idTipoMovCaja = '99990002'")
            idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
            
            If idFormaPago <> "06090001" And idFormaPago <> "06090004" Then
               StrMsgError = "No se puede anular el documento porque esta cancelado en cuentas por cobrar"
               GoTo Err
            End If
            
            Do While Not rsCta_Mvto.EOF
                csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                         "from cta_dcto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "'"
                If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
                RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                
                Do While Not RScTA_dCTO.EOF
                    If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                        csql = "delete from cta_dcto " & _
                                 "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "'"
                    Else
                        If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                            If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                            If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        End If
                    End If
                    Cn.Execute (csql)
                    RScTA_dCTO.MoveNext
                Loop
                
                If cabrev = "Cre" Then
                    csql = "delete from cta_mvto " & _
                             "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                             "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                             "and idEmpresa = '" & glsEmpresa & "' "
                Else
                    csql = "delete from cta_mvto " & _
                             "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                             "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                             "and idEmpresa = '" & glsEmpresa & "' "
                End If
                Cn.Execute csql
                rsCta_Mvto.MoveNext
            Loop
        End If
        
        csql = "UPDATE CTA_DCTO SET VALTOTAL = 0, VALTOTALORI = 0,VALSALDO = 0 " & _
                 "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
                 "and idEmpresa = '" & glsEmpresa & "' "
        Cn.Execute csql
        '----------------------------------------------------------------------------------
        If traerCampo("seriesdocumento", "IndTransferencia", "idDocumento", strTipoDoc, True, " idserie = '" & Trim(txt_Serie.Text) & "' ") <> "S" Then
            '---- Anulamos los vales q se generaron
            csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                     "from docReferencia " & _
                     "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                     "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '99' " & _
                     "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal = '" & glsSucursal & "' "
            If rs.State = 1 Then rs.Close
            rs.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            If Len(Trim("" & idValeDocventas)) > 0 Then
                actualizaStock idValeDocventas, 1, StrMsgError, strTipoVale, False
                If StrMsgError <> "" Then GoTo Err
                
                actualizaStock_Lote idValeDocventas, 1, StrMsgError, strTipoVale, False
                If StrMsgError <> "" Then GoTo Err
                
                csql = "UPDATE valescab set estValeCab = 'ANU' " & _
                       "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
                Cn.Execute csql
            End If
      
        Else
            '---- Anulamos los vales q se generaron "Salida"
            csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                     "from docReferencia " & _
                     "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                     "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '99' " & _
                     "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal = '" & glsSucursal & "' "
            If rs.State = 1 Then rs.Close
            rs.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            If Len(Trim("" & idValeDocventas)) > 0 Then
                actualizaStock idValeDocventas, 1, StrMsgError, strTipoVale, False
                If StrMsgError <> "" Then GoTo Err
                
                actualizaStock_Lote idValeDocventas, 1, StrMsgError, strTipoVale, False
                If StrMsgError <> "" Then GoTo Err
                
                csql = "UPDATE valescab set estValeCab = 'ANU' " & _
                       "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
                Cn.Execute csql
            End If
        
            '---- Anulamos los vales q se generaron "Ingreso"
            csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                 "from docReferencia " & _
                 "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                 "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '88' " & _
                 "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal = '" & glsSucursal & "' "
                 
            If rs.State = 1 Then rs.Close
            rs.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            If Len(Trim("" & idValescabIngreso)) > 0 Then
                actualizaStockTransferencia idValescabIngreso, 1, strSucursalDes, StrMsgError, strTipoValeIngreso, False
                If StrMsgError <> "" Then GoTo Err
                
                actualizaStock_LoteTransferencia idValescabIngreso, 1, strSucursalDes, StrMsgError, strTipoValeIngreso, False
                If StrMsgError <> "" Then GoTo Err
                
                csql = "UPDATE valescab set estValeCab = 'ANU' " & _
                       "WHERE idValesCab = '" & idValescabIngreso & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoValeIngreso & "' "
                Cn.Execute csql
            End If
        End If
    
        If traerCampo("Parametros", "ValParametro", "GlsParametro", "AGRUPAPRODUCTOS", True) = "N" Then
            '---- Cambiamos el estado a Importado
            csql = "SELECT d.idDocumentoImp,d.idDocVentasImp,d.idSerieImp,d.idProducto,d.idUM,d.Cantidad,d.Cantidad2,d.ItemPro " & _
                    "FROM docventasdet d " & _
                    "WHERE d.idEmpresa = '" & glsEmpresa & "'" & _
                    "AND d.idSucursal = '" & glsSucursal & "'" & _
                    "AND d.idDocumento = '" & strTipoDoc & "'" & _
                    "AND d.idDocVentas = '" & Trim(txt_NumDoc.Text) & "'" & _
                    "AND d.idSerie = '" & Trim(txt_Serie.Text) & "'" & _
                    "AND d.idDocVentasImp <> ''"
            If rst.State = 1 Then rst.Close
            rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            If Not rst.EOF Then
                rst.MoveFirst
                rst.Sort = "idProducto"
                Do While Not rst.EOF
                    '---- ACTUALIZAMOS CANTIDAD IMPORTADA
                    If strParamItemPro = "S" Then
                        csql = "UPDATE docventasdet dd  " & _
                                 "SET dd.CantidadImp = dd.CantidadImp - " & CStr(rst.Fields("Cantidad")) & ", dd.estDocImportado = 'N' " & _
                                 "WHERE dd.idEmpresa = '" & glsEmpresa & "' " & _
                                 "AND dd.idSucursal = '" & glsSucursal & "' " & _
                                 "AND dd.idDocumento = '" & rst.Fields("idDocumentoImp") & "' " & _
                                 "AND dd.idDocVentas = '" & rst.Fields("idDocVentasImp") & "' " & _
                                 "AND dd.idSerie = '" & rst.Fields("idSerieImp") & "' " & _
                                 "AND dd.idProducto = '" & rst.Fields("idProducto") & "' " & _
                                 "AND dd.idUM = '" & rst.Fields("idUM") & "' " & _
                                 "AND dd.ItemPro ='" & rst.Fields("ItemPro") & "' "
                    Else
                        csql = "UPDATE docventasdet dd  " & _
                                 "SET dd.CantidadImp = dd.CantidadImp - " & CStr(rst.Fields("Cantidad")) & ", dd.estDocImportado = 'N' " & _
                                 "WHERE dd.idEmpresa = '" & glsEmpresa & "' " & _
                                 "AND dd.idSucursal = '" & glsSucursal & "' " & _
                                 "AND dd.idDocumento = '" & rst.Fields("idDocumentoImp") & "' " & _
                                 "AND dd.idDocVentas = '" & rst.Fields("idDocVentasImp") & "' " & _
                                 "AND dd.idSerie = '" & rst.Fields("idSerieImp") & "' " & _
                                 "AND dd.idProducto = '" & rst.Fields("idProducto") & "' " & _
                                 "AND dd.idUM = '" & rst.Fields("idUM") & "' "
                    End If
                    Cn.Execute csql
                    rst.MoveNext
                Loop
            End If
        
            '---- Marcamos la Cabecera
            csql = "SELECT DISTINCT idDocumentoImp,idDocVentasImp,idSerieImp,idProducto  FROM docventasdet " & _
                     "WHERE idEmpresa = '" & glsEmpresa & "' " & _
                     "AND idSucursal = '" & glsSucursal & "' " & _
                     "AND idDocumento = '" & strTipoDoc & "' " & _
                     "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
                     "AND idSerie = '" & Trim(txt_Serie.Text) & "' " & _
                     "AND idDocVentasImp <> '' AND idDocVentasImp IS not null"
            If rstcab.State = 1 Then rstcab.Close
            rstcab.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            If Not rstcab.EOF Then
                rstcab.MoveFirst
                Do While Not rstcab.EOF
                    csql = "UPDATE docVentas c  SET c.estDocImportado = 'N' " & _
                             "WHERE c.idEmpresa = '" & glsEmpresa & "' " & _
                             "AND c.idSucursal = '" & glsSucursal & "' " & _
                             "AND c.idDocumento = '" & rstcab.Fields("idDocumentoImp") & "' " & _
                             "AND c.idDocVentas = '" & rstcab.Fields("idDocVentasImp") & "' " & _
                             "AND c.idSerie = '" & rstcab.Fields("idSerieImp") & "' "
                    Cn.Execute csql
                    rstcab.MoveNext
                Loop
            End If
      
        Else
            '--- Devolver cantidades a cada documento importado
            csql = "select idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia,idproducto,cantidad from docreferenciadet " & _
                   "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "'"
            If RstDet.State = 1 Then RstDet.Close
            RstDet.Open csql, Cn, adOpenStatic, adLockReadOnly
    
            If RstDet.RecordCount > 0 Then
                RstDet.MoveFirst
                Do While Not RstDet.EOF
                    csql = "update docventasdet set cantidadimp = cantidadimp - " & CStr(RstDet.Fields("Cantidad")) & " " & _
                            "where idempresa = '" & Trim(RstDet.Fields("idempresa")) & "' and iddocumento =  '" & Trim(RstDet.Fields("tipodocreferencia")) & "' " & _
                            "and idserie = '" & Trim(RstDet.Fields("seriedocreferencia")) & "' and iddocventas = '" & Trim(RstDet.Fields("numdocreferencia")) & "' and idproducto = '" & Trim(RstDet.Fields("idproducto")) & "'"
                    Cn.Execute csql
                    RstDet.MoveNext
                Loop
            End If
            If RstDet.State = 1 Then RstDet.Close: Set RstDet = Nothing
                    
            '--- Actualizamos los producto importados(detalle) docventasdet
            csql = "select idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia from docreferencia " & _
                    "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "' "
            If rstdocref.State = 1 Then rstdocref.Close
            rstdocref.Open csql, Cn, adOpenStatic, adLockReadOnly
            If rstdocref.RecordCount > 0 Then
                rstdocref.MoveFirst
                Do While Not rstdocref.EOF
                    If Len(Trim("" & rstdocref.Fields("numdocreferencia"))) = 8 Then
                        csql = "select idempresa,iddocumento,idserie,iddocventas,idproducto,cantidad,cantidadimp from docventasdet " & _
                                "where idempresa = '" & Trim(rstdocref.Fields("idempresa")) & "'and iddocumento = '" & Trim(rstdocref.Fields("tipodocreferencia")) & "' " & _
                                "and idserie = '" & Trim(rstdocref.Fields("seriedocreferencia")) & "' and iddocventas = '" & Trim(rstdocref.Fields("numdocreferencia")) & "' "
                        If rst.State = 1 Then rst.Close
                        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
                        If rst.RecordCount > 0 Then
                            rst.MoveFirst
                            Do While Not rst.EOF
                                If CDbl(Trim("" & rst.Fields("cantidad"))) = CDbl(Trim("" & rst.Fields("cantidadimp"))) Then
                                    csql = "Update docventasdet set  estdocimportado = 'S' " & _
                                            "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("iddocumento")) & "' and idserie = '" & Trim(rst.Fields("idserie")) & "'  and iddocventas = '" & Trim(rst.Fields("iddocventas")) & "' and idproducto = '" & Trim(rst.Fields("idproducto")) & "' "
                                    Cn.Execute csql
                                ElseIf CDbl(Trim("" & rst.Fields("cantidad"))) > CDbl(Trim("" & rst.Fields("cantidadimp"))) Then
                                    csql = "Update docventasdet set estdocimportado = 'N' " & _
                                            "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("iddocumento")) & "' and idserie = '" & Trim(rst.Fields("idserie")) & "'  and iddocventas = '" & Trim(rst.Fields("iddocventas")) & "' and idproducto = '" & Trim(rst.Fields("idproducto")) & "' "
                                    Cn.Execute csql
                                End If
                                rst.MoveNext
                            Loop
                        End If
                    End If
                    rstdocref.MoveNext
                Loop
            End If

            '--- Actualizamos la cabecera docventas
            csql = "select distinct idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia from docreferencia " & _
                    "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "'"
            If rst.State = 1 Then rst.Close
            rst.Open csql, Cn, adOpenStatic, adLockReadOnly
            
            If rst.RecordCount > 0 Then
                rst.MoveFirst
                Do While Not rst.EOF
                    If Len(Trim("" & rst.Fields("numdocreferencia"))) = 8 Then
                        csql = "select distinct estdocimportado from docventasdet " & _
                                "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                        If rsh.State = 1 Then rsh.Close
                        rsh.Open csql, Cn, adOpenStatic, adLockReadOnly
                        If Not rsh.EOF Then
                            If rsh.RecordCount > 1 Then
                                csql = "Update docventas set  estdocimportado = 'N' " & _
                                        "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                                Cn.Execute csql
                            ElseIf rsh.RecordCount = 1 And (Trim("" & rsh.Fields("estdocimportado"))) = "N" Then
                                csql = "Update docventas set  estdocimportado = 'N' " & _
                                        "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                                Cn.Execute csql
                            ElseIf rsh.RecordCount = 1 And (Trim("" & rsh.Fields("estdocimportado"))) = "S" Then
                                csql = "Update docventas set  estdocimportado = 'S' " & _
                                        "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "' "
                            End If
                        End If
                    End If
                    rst.MoveNext
                Loop
            End If
        End If
        
        '-------PQS 06/01/15
        '--- Eliminando docreferenciadet
        csql = "DELETE FROM docreferenciadet " & _
                "WHERE idEmpresa = '" & glsEmpresa & "' AND tipoDocOrigen = '" & strTipoDoc & "' AND numDocOrigen = '" & Trim(txt_NumDoc.Text) & "' AND serieDocOrigen = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
    
        csql = "DELETE FROM docreferenciadet " & _
                "WHERE idEmpresa = '" & glsEmpresa & "' AND tipoDocreferencia = '" & strTipoDoc & "' AND numDocreferencia = '" & Trim(txt_NumDoc.Text) & "' AND serieDocreferencia = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
        '-------------------
        
        '---- Anulando el ingreso a caja
        strMovCaja = traerCampo("movcajasdet", "idMovCaja", "idSucursal", glsSucursal, True, "idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & "' and idSerie = '" & Trim(txt_Serie.Text) & "'")
        csql = "UPDATE movcajasdet SET estMovCajaDet = 'ANU' " & _
                 "WHERE idMovCaja = '" & strMovCaja & "' " & _
                 "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' " & _
                 "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' AND idSerie = '" & Trim(txt_Serie.Text) & "' "
        Cn.Execute csql

        '---- Eliminamos del pagosDocVentas
        csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                "AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
                "AND idSerie = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
        
        If strTipoDoc = "01" Then
            '---- Buscamos la factura q esta amarrada
            If gDocReferencia.Count > 0 Then
                gDocReferencia.Dataset.First
                Do While Not gDocReferencia.Dataset.EOF
                    If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                        csql = "update docventas set estDocVentas = 'GEN' " & _
                                 "where idEmpresa = '" & glsEmpresa & "' and iddocumento = '86' " & _
                                 "and idserie = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' " & _
                                 "and iddocventas = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' "
                        Cn.Execute csql
                        Exit Do
                    End If
                    gDocReferencia.Dataset.Next
                Loop
            End If
        End If
        
        If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "LIQUIDACIONES", True) & "") = "S" Then
            If strTipoDoc = "86" Then
                CadMysqlLiq = "Select * from docventasdetliquidacion " & _
                              "where iddocventas = '" & Trim("" & txt_NumDoc.Text) & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & Trim("" & txt_Serie.Text) & "' " & _
                              "and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
                If rsliquidacion.State = 1 Then rsliquidacion.Close
                rsliquidacion.Open CadMysqlLiq, strcn, adOpenStatic, adLockOptimistic
                If Not rsliquidacion.EOF Then
                    rsliquidacion.MoveFirst
                    Do While Not rsliquidacion.EOF
                        CadMysqlLiqAct = "Update docventasliqcab set CantidadImp = (CantidadImp - " & rsliquidacion.Fields("Unidad") & ") ,PesoImp = (PesoImp - " & rsliquidacion.Fields("Kg") & ") " & _
                                         "where IdEmpresa = '" & glsEmpresa & "' and  IdSucursal = '" & glsSucursal & "' and  IdLiquidacion = '" & Trim("" & rsliquidacion.Fields("IdLiquidacion")) & "' "
                        Cn.Execute (CadMysqlLiqAct)
                        rsliquidacion.MoveNext
                    Loop
                End If
            End If
        End If
        Cn.CommitTrans
        
        AsientoContableVentas StrMsgError, "A"
        If StrMsgError <> "" Then GoTo Err
            
        '---- Cambiando valores a variables
        strEstDocVentas = "ANU"
        lblDoc.ForeColor = &HFF&
        lblDoc.Caption = lblDoc.Caption & " - ANULADA"
        fraGeneral.Enabled = False
        Activa_Desc_Grid True

        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        habilitaBotones 6, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
    End If
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    If rstcab.State = 1 Then rstcab.Close: Set rstcab = Nothing
    
    Exit Sub
    
Err:
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If rs.State = 1 Then rs.Close: Set rs = Nothing
    If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close: Set rsCta_Mvto = Nothing
    If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close: Set RScTA_dCTO = Nothing
    If rstcab.State = 1 Then rstcab.Close: Set rstcab = Nothing
    If iniTrans Then Cn.RollbackTrans
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub txtCod_Vendedor_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "VENDEDOR", txtCod_Vendedor, txtGls_Vendedor
        KeyAscii = 0
        If txtCod_Vendedor.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub txtCod_VendedorCampo_KeyPress(KeyAscii As Integer)

    If KeyAscii <> 13 Then
        If glsModVendCampo = False Then
            KeyAscii = 0
            Exit Sub
        End If
        mostrarAyudaKeyascii KeyAscii, "VENDEDOR", txtCod_VendedorCampo, txtGls_VendedorCampo
        KeyAscii = 0
        If txtCod_VendedorCampo.Text <> "" Then SendKeys "{tab}"
    End If

End Sub

Private Sub calcularTotales_Ant240516(StrMsgError As String)
On Error GoTo Err
Dim DblImponible                        As Double
Dim DblExonerado                        As Double
Dim DblTotIgv                           As Double
Dim DblTotIncIgv                        As Double
Dim DblTotIncIvap                       As Double
Dim NPorcIvap                           As Double
Dim DblBaseIVAP                         As Double
Dim DblTotVVIgv                         As Double
Dim DblTotVVIVAP                        As Double
Dim DblTotVVExo                         As Double
Dim DblTotBaseIgv                       As Double
Dim DblTotBaseIVAP                      As Double
Dim DblTotDescIgv                       As Double
Dim DblTotDescIVAP                      As Double
    
    If gDetalle.Dataset.RecordCount = 0 Then Exit Sub
    
    NPorcIvap = Val("" & leeParametro("PORCENTAJE_IVAP"))
    
    
    
    txt_TotalBruto.Text = 0#
    txt_TotalIGV.Text = 0#
    txt_TotalNeto.Text = 0#
    TxtTotalIvap.Text = 0#
    
    txt_TotalDsctoVV.Text = 0#
    txt_TotalDsctoPV.Text = 0#
    txt_TotalBaseImponible.Text = 0#
    txt_TotalExonerado.Text = 0#
    
    DblImponible = 0#
    DblExonerado = 0#
    DblTotIgv = 0#
    DblTotIncIgv = 0#
    DblTotIncIvap = 0#
    
    gDetalle.Dataset.DisableControls
    
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        txt_TotalBruto.Text = Val(Format(txt_TotalBruto.Value, "0.00")) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        '---- CALCULO DEL PRECIO UNITARIO
        txt_TotalDsctoVV.Text = Val(txt_TotalDsctoVV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)))
        txt_TotalDsctoPV.Text = Val(txt_TotalDsctoPV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)))
        
        If gDetalle.Columns.ColumnByFieldName("Afecto").Value = 0 Then
            
            If traerCampo("Productos", "IndAfectoIvap", "IdProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value), True) = "1" Then
                
                'DblTotIncIvap = Val(DblTotIncIvap + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
                DblTotVVIVAP = Val(DblTotVVIVAP + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                
            Else
            
                'txt_TotalExonerado.Text = Val(txt_TotalExonerado.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                'DblExonerado = Val(DblExonerado + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                DblTotVVExo = Val(DblTotVVExo + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                
            End If
            
        Else
            
            'txt_TotalBaseImponible.Text = Val(txt_TotalBaseImponible.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            'DblImponible = Val(DblImponible + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            'DblTotIncIgv = Val(DblTotIncIgv + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
            DblTotVVIgv = Val(DblTotVVIgv + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            
        End If
        
        gDetalle.Dataset.Next
        
    Loop
    
    TxtTotalDescuentolobalGrabado.Text = 0
    TxtTotalDescuentolobalExonerado.Text = 0
    
    If Val("" & TxtDescuentoGlobal.Text) > 0 Then
        If OptTipoDecuentoGlobal(0).Value Then
            TxtTotalPorcentajeDescuentoGlobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(txt_TotalNeto.Text, "0.00")) * (Val(Format(TxtDescuentoGlobal.Text, "0.00")) / 100)
        Else
            TxtTotalPorcentajeDescuentoGlobal.Text = (Val(Format(TxtDescuentoGlobal.Text, "0.00")) * 100) / Val(Format(txt_TotalBruto.Value, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
        End If
        
        DblTotDescIgv = Val(Format(DblTotVVIgv, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        DblTotDescIVAP = Val(Format(DblTotVVIVAP, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        TxtTotalDescuentolobalGrabado.Text = Val(Format(DblTotVVIgv + DblTotVVIVAP, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        TxtTotalDescuentolobalExonerado.Text = Val(Format(DblTotVVExo, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
                
    End If
    
    txt_TotalBaseImponible.Text = Val(Format(DblTotVVIgv + DblTotVVIVAP, "0.00")) - Val(Format(TxtTotalDescuentolobalGrabado.Text, "0.00"))
    
    txt_TotalExonerado.Text = Val(Format(DblTotVVExo, "0.00")) - Val(Format(TxtTotalDescuentolobalExonerado.Text, "0.00"))
    txt_TotalIGV.Text = Val(Format(DblTotVVIgv - DblTotDescIgv, "0.00")) * dblIgvNEw
    TxtTotalIvap.Text = Val(Format(DblTotVVIVAP - DblTotDescIVAP, "0.00")) * (NPorcIvap / 100)
    txt_TotalNeto.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(txt_TotalExonerado.Text, "0.00")) + Val(Format(txt_TotalIGV.Text, "0.00")) + Val(Format(TxtTotalIvap.Text, "0.00"))
    TxtTotalDescuento.Text = Val(Format(txt_TotalDsctoVV.Text, "0.00")) + Val(Format(TxtTotalDescuentolobalGrabado.Text, "0.00")) + Val(Format(TxtTotalDescuentolobalExonerado.Text, "0.00"))
    
'    txt_TotalNeto.Text = Val(Format(DblTotIncIgv, "0.00")) + Val(Format(DblExonerado, "0.00")) + Val(Format(DblTotIncIvap, "0.00"))
'
'    txt_TotalBaseImponible.Text = Val(Format(Val(Format(DblTotIncIgv, "0.00")) / (dblIgvNEw + 1), "0.00"))
'    txt_TotalIGV.Text = Val(Format(DblTotIncIgv, "0.00")) - Val(Format(txt_TotalBaseImponible.Text, "0.00"))
'
'    If DblTotIncIvap > 0 Then
'        DblBaseIVAP = Val(Format(Val(Format(DblTotIncIvap, "0.00")) / ((NPorcIvap / 100) + 1), "0.00"))
'        txt_TotalBaseImponible.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + DblBaseIVAP
'        TxtTotalIvap.Text = Val(Format(DblTotIncIvap, "0.00")) - Val(Format(DblBaseIVAP, "0.00"))
'    End If
'
'
'    txt_TotalBruto.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(DblExonerado, "0.00"))
    
    gDetalle.Dataset.EnableControls
    If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    Else
        lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub
Private Sub calcularTotales(StrMsgError As String)
On Error GoTo Err
Dim DblImponible                        As Double
Dim DblExonerado                        As Double
Dim DblTotIgv                           As Double
Dim DblTotIncIgv                        As Double
Dim DblTotIncIvap                       As Double
Dim NPorcIvap                           As Double
Dim DblBaseIVAP                         As Double
Dim DblTotVVIgv                         As Double
Dim DblTotVVIVAP                        As Double
Dim DblTotVVExo                         As Double
Dim DblTotBaseIgv                       As Double
Dim DblTotBaseIVAP                      As Double
Dim DblTotDescIgv                       As Double
Dim DblTotDescIVAP                      As Double
Dim DblTotalCostosol                    As Double

    If gDetalle.Dataset.RecordCount = 0 Then Exit Sub
    
    NPorcIvap = 0 'Val("" & leeParametro("PORCENTAJE_IVAP"))
    
    NTotalBruto = 0#
    NTotalIGV = 0#
    NTotalIVAP = 0#
    NTotalDsctoVV = 0#
    NTotalDsctoPV = 0#
    NTotalBaseImponible = 0#
    NTotalExonerado = 0#
    
    txt_TotalBruto.Text = 0#
    txt_TotalIGV.Text = 0#
    txt_TotalNeto.Text = 0#
    TxtTotalIvap.Text = 0#
    txt_TotalDsctoVV.Text = 0#
    txt_TotalDsctoPV.Text = 0#
    txt_TotalBaseImponible.Text = 0#
    txt_TotalExonerado.Text = 0#
    
    DblImponible = 0#
    DblExonerado = 0#
    DblTotIgv = 0#
    DblTotIncIgv = 0#
    DblTotIncIvap = 0#
    DblTotalCostosol = 0#
    
    gDetalle.Dataset.DisableControls
    
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        
        NTotalBruto = NTotalBruto + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        '---- CALCULO DEL PRECIO UNITARIO
        NTotalDsctoVV = NTotalDsctoVV + (Val("" & gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value) - Val("" & gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value))
        NTotalDsctoPV = NTotalDsctoPV + (Val("" & gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value) - Val("" & gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value))
        
        If gDetalle.Columns.ColumnByFieldName("Afecto").Value = 0 Then
            
            If traerCampo("Productos", "IndAfectoIvap", "IdProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value), True) = "1" Then
                
                'DblTotIncIvap = Val(DblTotIncIvap + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
                DblTotVVIVAP = Val(DblTotVVIVAP + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                
            Else
            
                'txt_TotalExonerado.Text = Val(txt_TotalExonerado.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                'DblExonerado = Val(DblExonerado + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                DblTotVVExo = Val(DblTotVVExo + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                
            End If
            
        Else
            
            txt_TotalBaseImponible.Text = Val(txt_TotalBaseImponible.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            DblImponible = Val(DblImponible + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            DblTotIncIgv = Val(DblTotIncIgv + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
            DblTotVVIgv = Val(DblTotVVIgv + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            
        End If
        
        If Val(gDetalle.Columns.ColumnByFieldName("CostoS").Value) > 0 Then
            DblTotalCostosol = DblTotalCostosol + Val(Format((gDetalle.Columns.ColumnByFieldName("CostoS").Value * gDetalle.Columns.ColumnByFieldName("Cantidad").Value), "0.00"))
        Else
            DblTotalCostosol = DblTotalCostosol + Val(Format(((gDetalle.Columns.ColumnByFieldName("CostoD").Value * Val(Format(txt_TipoCambio.Text, "0.000"))) * gDetalle.Columns.ColumnByFieldName("Cantidad").Value), "0.00"))
        End If
        
        gDetalle.Dataset.Next
        
    Loop
    
    TxtTotalDescuentolobalGrabado.Text = 0
    TxtTotalDescuentolobalExonerado.Text = 0
    
    If Val("" & TxtDescuentoGlobal.Text) > 0 Then
        If OptTipoDecuentoGlobal(0).Value Then
            TxtTotalPorcentajeDescuentoGlobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(txt_TotalNeto.Text, "0.00")) * (Val(Format(TxtDescuentoGlobal.Text, "0.00")) / 100)
        Else
            TxtTotalPorcentajeDescuentoGlobal.Text = (Val(Format(TxtDescuentoGlobal.Text, "0.00")) * 100) / NTotalBruto ' Val(Format(txt_TotalBruto.Value, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
        End If
        
        DblTotDescIgv = DblTotVVIgv * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100) 'Val(Format(DblTotVVIgv, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        DblTotDescIVAP = DblTotVVIVAP * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100) 'Val(Format(DblTotVVIVAP, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        TxtTotalDescuentolobalGrabado.Text = (DblTotVVIgv + DblTotVVIVAP) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100) 'Val(Format(DblTotVVIgv + DblTotVVIVAP, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
        TxtTotalDescuentolobalExonerado.Text = DblTotVVExo * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100) 'Val(Format(DblTotVVExo, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
                
    End If
    
    txt_TotalBruto.Text = Val(Format(NTotalBruto, "0.00"))
    txt_TotalDsctoVV.Text = Val(Format(NTotalDsctoVV, "0.00"))
    txt_TotalDsctoPV.Text = Val(Format(NTotalDsctoPV, "0.00"))
    
    NTotalBaseImponible = (DblTotVVIgv + DblTotVVIVAP) - Val(Format(TxtTotalDescuentolobalGrabado.Text, "0.00"))
    txt_TotalBaseImponible.Text = Val(Format(NTotalBaseImponible, "0.00")) 'Val(Format(DblTotVVIgv + DblTotVVIVAP, "0.00")) - Val(Format(TxtTotalDescuentolobalGrabado.Text, "0.00"))
    
    NTotalExonerado = DblTotVVExo - Val(Format(TxtTotalDescuentolobalExonerado.Text, "0.00"))
    txt_TotalExonerado.Text = Val(Format(NTotalExonerado, "0.00"))
    
    NTotalIGV = (DblTotVVIgv - DblTotDescIgv) * dblIgvNEw
    txt_TotalIGV.Text = Val(Format(NTotalIGV, "0.00"))
    
    NTotalIVAP = (DblTotVVIVAP - DblTotDescIVAP) * (NPorcIvap / 100)
    TxtTotalIvap.Text = Val(Format(DblTotalCostosol, "0.00"))
    
    txt_TotalNeto.Text = Val(Format(NTotalBaseImponible + NTotalExonerado + NTotalIGV + NTotalIVAP, "0.00")) 'Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(txt_TotalExonerado.Text, "0.00")) + Val(Format(txt_TotalIGV.Text, "0.00")) + Val(Format(TxtTotalIvap.Text, "0.00"))
    TxtTotalDescuento.Text = Val(Format(txt_TotalDsctoVV.Text, "0.00")) + Val(Format(TxtTotalDescuentolobalGrabado.Text, "0.00")) + Val(Format(TxtTotalDescuentolobalExonerado.Text, "0.00"))
    
'    txt_TotalNeto.Text = Val(Format(DblTotIncIgv, "0.00")) + Val(Format(DblExonerado, "0.00")) + Val(Format(DblTotIncIvap, "0.00"))
'
'    txt_TotalBaseImponible.Text = Val(Format(Val(Format(DblTotIncIgv, "0.00")) / (dblIgvNEw + 1), "0.00"))
'    txt_TotalIGV.Text = Val(Format(DblTotIncIgv, "0.00")) - Val(Format(txt_TotalBaseImponible.Text, "0.00"))
'
'    If DblTotIncIvap > 0 Then
'        DblBaseIVAP = Val(Format(Val(Format(DblTotIncIvap, "0.00")) / ((NPorcIvap / 100) + 1), "0.00"))
'        txt_TotalBaseImponible.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + DblBaseIVAP
'        TxtTotalIvap.Text = Val(Format(DblTotIncIvap, "0.00")) - Val(Format(DblBaseIVAP, "0.00"))
'    End If
'
'
'    txt_TotalBruto.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(DblExonerado, "0.00"))
    
    gDetalle.Dataset.EnableControls
    'If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    'Else
    '    lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    'End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub calcularTotalesAnt2(StrMsgError As String)
On Error GoTo Err
Dim DblImponible                        As Double
Dim DblExonerado                        As Double
Dim DblTotIgv                           As Double
Dim DblTotIncIgv                        As Double
Dim DblTotIncIvap                       As Double
Dim NPorcIvap                           As Double
Dim DblBaseIVAP                         As Double

    NPorcIvap = Val("" & leeParametro("PORCENTAJE_IVAP"))
    
    txt_TotalBruto.Text = 0#
    txt_TotalIGV.Text = 0#
    txt_TotalNeto.Text = 0#
    TxtTotalIvap.Text = 0#
    
    txt_TotalDsctoVV.Text = 0#
    txt_TotalDsctoPV.Text = 0#
    txt_TotalBaseImponible.Text = 0#
    txt_TotalExonerado.Text = 0#
    
    DblImponible = 0#
    DblExonerado = 0#
    DblTotIgv = 0#
    DblTotIncIgv = 0#
    DblTotIncIvap = 0#
    
    gDetalle.Dataset.DisableControls
    
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        txt_TotalBruto.Text = Val(Format(txt_TotalBruto.Value, "0.00")) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        '---- CALCULO DEL PRECIO UNITARIO
        txt_TotalDsctoVV.Text = Val(txt_TotalDsctoVV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)))
        txt_TotalDsctoPV.Text = Val(txt_TotalDsctoPV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)))
        
        If gDetalle.Columns.ColumnByFieldName("Afecto").Value = 0 Then
            
            If traerCampo("Productos", "IndAfectoIvap", "IdProducto", Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value), True) = "1" Then
                
                DblTotIncIvap = Val(DblTotIncIvap + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
                
            Else
            
                txt_TotalExonerado.Text = Val(txt_TotalExonerado.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
                DblExonerado = Val(DblExonerado + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            
            End If
            
        Else
            
            'txt_TotalBaseImponible.Text = Val(txt_TotalBaseImponible.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            'DblImponible = Val(DblImponible + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            DblTotIncIgv = Val(DblTotIncIgv + gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)
            
        End If
        
        gDetalle.Dataset.Next
        
    Loop
    
    
    If Val("" & TxtDescuentoGlobal.Text) > 0 Then
        If OptTipoDecuentoGlobal(0).Value Then
            TxtTotalPorcentajeDescuentoGlobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(txt_TotalNeto.Text, "0.00")) * (Val(Format(TxtDescuentoGlobal.Text, "0.00")) / 100)
        Else
            TxtTotalPorcentajeDescuentoGlobal.Text = (Val(Format(TxtDescuentoGlobal.Text, "0.00")) * 100) / Val(Format(txt_TotalBruto.Value, "0.00"))
            'TxtTotalDescuentolobal.Text = Val(Format(TxtDescuentoGlobal.Text, "0.00"))
        End If
        
        TxtTotalDescuentolobalGrabado.Text = Val(Format(txt_TotalBruto.Value, "0.00")) * (Val(Format(TxtTotalPorcentajeDescuentoGlobal.Text, "0.00")) / 100)
                
    End If
    
    
    
    txt_TotalNeto.Text = Val(Format(DblTotIncIgv, "0.00")) + Val(Format(DblExonerado, "0.00")) + Val(Format(DblTotIncIvap, "0.00"))
    
    txt_TotalBaseImponible.Text = Val(Format(Val(Format(DblTotIncIgv, "0.00")) / (dblIgvNEw + 1), "0.00"))
    txt_TotalIGV.Text = Val(Format(DblTotIncIgv, "0.00")) - Val(Format(txt_TotalBaseImponible.Text, "0.00"))
        
    If DblTotIncIvap > 0 Then
        DblBaseIVAP = Val(Format(Val(Format(DblTotIncIvap, "0.00")) / ((NPorcIvap / 100) + 1), "0.00"))
        txt_TotalBaseImponible.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + DblBaseIVAP
        TxtTotalIvap.Text = Val(Format(DblTotIncIvap, "0.00")) - Val(Format(DblBaseIVAP, "0.00"))
    End If
    
    
    txt_TotalBruto.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(DblExonerado, "0.00"))
    
    gDetalle.Dataset.EnableControls
    If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    Else
        lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub calcularTotalesAnt()
Dim DblImponible As Double
Dim DblExonerado As Double
Dim DblTotIgv    As Double
    
    txt_TotalBruto.Text = 0#
    txt_TotalIGV.Text = 0#
    txt_TotalNeto.Text = 0#
    
    txt_TotalDsctoVV.Text = 0#
    txt_TotalDsctoPV.Text = 0#
    txt_TotalBaseImponible.Text = 0#
    txt_TotalExonerado.Text = 0#
    
    DblImponible = 0#
    DblExonerado = 0#
    DblTotIgv = 0#
    
    gDetalle.Dataset.DisableControls
    
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        txt_TotalBruto.Text = Val(txt_TotalBruto.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        '---- CALCULO DEL PRECIO UNITARIO
        txt_TotalDsctoVV.Text = Val(txt_TotalDsctoVV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalVVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)))
        txt_TotalDsctoPV.Text = Val(txt_TotalDsctoPV.Value) + Val(((gDetalle.Columns.ColumnByFieldName("TotalPVBruto").Value) - (gDetalle.Columns.ColumnByFieldName("TotalPVNeto").Value)))
        
        If gDetalle.Columns.ColumnByFieldName("Afecto").Value = 0 Then
            txt_TotalExonerado.Text = Val(txt_TotalExonerado.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            DblExonerado = Val(DblExonerado + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        Else
            txt_TotalBaseImponible.Text = Val(txt_TotalBaseImponible.Value) + Val(gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
            DblImponible = Val(DblImponible + gDetalle.Columns.ColumnByFieldName("TotalVVNeto").Value)
        End If
        
        gDetalle.Dataset.Next
    Loop
    
    txt_TotalIGV.Text = Val(Format((DblImponible * dblIgvNEw), "0.00"))
    DblTotIgv = DblImponible * dblIgvNEw
    txt_TotalNeto.Text = Val(Format(txt_TotalBaseImponible.Text, "0.00")) + Val(Format(txt_TotalExonerado.Text, "0.00")) + Val(Format(txt_TotalIGV.Text, "0.00"))
    
    gDetalle.Dataset.EnableControls
    If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    Else
        lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
 
End Sub

Private Sub eliminaNulosGrilla()
Dim indWhile As Boolean
Dim indEntro As Boolean
Dim i As Integer
    
    indWhile = True
    Do While indWhile = True
        If gDetalle.Count >= 1 Then
            gDetalle.Dataset.First
            indEntro = False
            Do While Not gDetalle.Dataset.EOF
                If Trim(gDetalle.Columns.ColumnByFieldName("idProducto").Value) = "" Or gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 0 Then
                    gDetalle.Dataset.Delete
                    indEntro = True
                    Exit Do
                End If
                gDetalle.Dataset.Next
            Loop
            indWhile = indEntro
        Else
            indWhile = False
        End If
    Loop
    
    If gDetalle.Count >= 1 Then
        gDetalle.Dataset.First
        i = 0
        Do While Not gDetalle.Dataset.EOF
            i = i + 1
            With RsDetProductos
                If .RecordCount > 0 Then
                    .MoveFirst
                    .Filter = "ItemDocVentas = " & Val(gDetalle.Columns.ColumnByFieldName("Item").Value) & ""
                    Do While Not .EOF
                        .Fields("ItemDocVentas") = i
                        .Update
                        .MoveNext
                    Loop
                    .Filter = ""
                    .Filter = adFilterNone
                End If
            End With
            gDetalle.Dataset.Edit
            gDetalle.Columns.ColumnByFieldName("item").Value = i
            If gDetalle.Dataset.State = dsEdit Then gDetalle.Dataset.Post
            gDetalle.Dataset.Next
        Loop
    Else
        indInserta = True
        gDetalle.Dataset.Append
        indInserta = False
    End If
    
End Sub

Private Sub eliminaNulosGrillaDocRef()
Dim indWhile As Boolean
Dim indEntro As Boolean
Dim i As Integer
    
    indWhile = True
    Do While indWhile = True
        If gDocReferencia.Count >= 1 Then
            gDocReferencia.Dataset.First
            indEntro = False
            Do While Not gDocReferencia.Dataset.EOF
                If Trim(gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value) = "" Or gDocReferencia.Columns.ColumnByFieldName("idSerie").Value = "" Or gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value = "" Then
                    gDocReferencia.Dataset.Delete
                    indEntro = True
                    Exit Do
                End If
                gDocReferencia.Dataset.Next
            Loop
            indWhile = indEntro
        Else
            indWhile = False
        End If
    Loop
    
    If gDocReferencia.Count >= 1 Then
        gDocReferencia.Dataset.First
        i = 0
        Do While Not gDocReferencia.Dataset.EOF
            i = i + 1
            gDocReferencia.Dataset.Edit
            gDocReferencia.Columns.ColumnByFieldName("item").Value = i
            If gDocReferencia.Dataset.State = dsEdit Then gDocReferencia.Dataset.Post
            gDocReferencia.Dataset.Next
        Loop
        
    Else
        indInsertaDocRef = True
        gDocReferencia.Dataset.Append
        indInsertaDocRef = False
    End If
    
End Sub

Private Sub ocultarColumnasEstado()

    Select Case strEstDocVentas
        Case "GEN"
            
             If strTipoDoc = "86" Or strTipoDoc = "92" Or strTipoDoc = "40" Or strTipoDoc = "07" Or strTipoDoc = "89" Or strTipoDoc = "08" Or (strTipoDoc = "25" And IndAtribucionNC = 1) Then      'Guia Or strTipoDoc = "40" Pedido
                Toolbar1.Buttons(7).Visible = False 'IMPRIMIR
                Toolbar1.Buttons(11).Visible = False
                If strTipoDoc = "92" Then
                    Toolbar1.Buttons(11).Visible = False
                End If
                Toolbar1.Buttons(12).Visible = False 'Letra
                Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
                Toolbar1.Buttons(21).Visible = False 'PRELIMINAR
                If strTipoDoc = "86" Then
                    Toolbar1.Buttons(8).Visible = False
                Else
                    Toolbar1.Buttons(8).Visible = False
                End If
                
            Else
                Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
                Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
            End If
            Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
        Case "ANU"
            Toolbar1.Buttons(2).Visible = False 'GRABAR
            Toolbar1.Buttons(3).Visible = False 'MODIFICAR
            Toolbar1.Buttons(5).Visible = False 'ELIMINAR
            Toolbar1.Buttons(6).Visible = False 'ANULAR
            Toolbar1.Buttons(7).Visible = False 'IMPRIMIR
            Toolbar1.Buttons(8).Visible = False
            Toolbar1.Buttons(9).Visible = False 'LISTAR
            Toolbar1.Buttons(11).Visible = False
            If strTipoDoc = "92" Then
                Toolbar1.Buttons(11).Visible = False
            End If
            Toolbar1.Buttons(12).Visible = False 'LETRAS
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(18).Visible = False
            Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
            Toolbar1.Buttons(21).Visible = False 'PRELIMINAR
            Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
        Case "CAN"
            Toolbar1.Buttons(7).Visible = False 'IMPRIMIR
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
            Toolbar1.Buttons(21).Visible = False 'IMPRIME HOJA BLANCO
        Case "IMP"
            Toolbar1.Buttons(2).Visible = False 'GRABAR
            Toolbar1.Buttons(3).Visible = False 'MODIFICAR
            Toolbar1.Buttons(5).Visible = False 'ELIMINAR
            Toolbar1.Buttons(6).Visible = False 'ANULAR
            Toolbar1.Buttons(7).Visible = False 'IMPRIMIR
            If strTipoDoc = "86" Then
                Toolbar1.Buttons(8).Visible = False
            Else
                Toolbar1.Buttons(8).Visible = False
            End If
            Toolbar1.Buttons(11).Visible = False
            If strTipoDoc = "92" Then
                Toolbar1.Buttons(11).Visible = False
            End If
            Toolbar1.Buttons(12).Visible = False 'Letra
            Toolbar1.Buttons(16).Visible = False
            Toolbar1.Buttons(17).Visible = False
            Toolbar1.Buttons(20).Visible = False 'PRELIMINAR
            Toolbar1.Buttons(21).Visible = False 'IMPRIME HOJA BLANCO
            Toolbar1.Buttons(7).Visible = True 'IMPRIMIR
    End Select

End Sub

Private Sub generaSTRDocReferencia()
Dim strAbre As String

    txt_DocReferencia.Text = ""
    If gDocReferencia.Count > 0 Then
        gDocReferencia.Dataset.First
        Do While Not gDocReferencia.Dataset.EOF
            If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value <> "" Then
                strAbre = traerCampo("documentos", "AbreDocumento", "idDocumento", gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value, False)
                If txt_DocReferencia.Text = "" Then
                    txt_DocReferencia.Text = strAbre & " " & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "-" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                Else
                    txt_DocReferencia.Text = txt_DocReferencia.Text & " / " & strAbre & " " & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "-" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                End If
            End If
            gDocReferencia.Dataset.Next
        Loop
    End If

End Sub

Private Sub mostrarDocImportado_SinAgrupar(ByVal rscd As ADODB.Recordset, ByVal rsdd As ADODB.Recordset, ByVal strTipoDocImportado As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rsg As New ADODB.Recordset
Dim RsD As New ADODB.Recordset
Dim strSerieDocventas As String
Dim i As Integer
Dim indExisteDocRef As Boolean
Dim StrCodfPago     As String
Dim StrCodfPagoAnt  As String

    'LUIS 17/10/2018 valida la forma de pago
    StrCodfPago = ""
    StrCodfPagoAnt = ""
    
    If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
        If rscd.State = 1 Then
            rscd.MoveFirst
            If Not rscd.EOF Then
                Do While Not rscd.EOF
                                                    
                    If strTipoDocImportado = "92" Or strTipoDocImportado = "40" Or strTipoDocImportado = "86" Then
                        
                        If StrCodfPago <> "" And StrCodfPago <> Trim("" & rscd.Fields("idFormaPago")) Then
                            StrMsgError = "No se puede documentos con diferentes formas de pago, verifique": GoTo Err
                        End If
                    
                        StrCodfPago = Trim("" & rscd.Fields("idFormaPago"))
                    End If
        
                rscd.MoveNext
                Loop
            End If
            rscd.MoveFirst
        End If
    End If
    '********************************************
    
    indCargando = True
    i = 0
    strEstDocVentas = "GEN"

    '--- Formato Detalle
    rsg.Fields.Append "Item", adInteger, , adFldRowID
    rsg.Fields.Append "numOrdenCompra", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "GlsProducto", adVarChar, 800, adFldIsNullable
    rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
    rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
    rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
    rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "ItemPro", adInteger, , adFldRowID
    rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
    rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
    rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    rsg.Open

    '---- Formato Documento de refrencia
    RsD.Fields.Append "Item", adInteger, , adFldRowID
    RsD.Fields.Append "idDocumento", adChar, 2, adFldIsNullable
    RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
    RsD.Fields.Append "idSerie", adChar, 4, adFldIsNullable
    RsD.Fields.Append "idNumDOc", adChar, 8, adFldIsNullable
    RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
    
    '--- Tipo Cambio
    RsD.Fields.Append "TipoCambio", adChar, 10, adFldIsNullable
    RsD.Open , , adOpenKeyset, adLockOptimistic

    If rscd.RecordCount = 0 Then
        txt_OrdenCompra.Text = ""
    Else
        txt_OrdenCompra.Text = "" & rscd.Fields("numOrdenCompra")
        txt_Llegada.Text = "" & rscd.Fields("llegada")
        txtCod_Moneda.Text = "" & rscd.Fields("idmoneda")
        txtCod_Vehiculo.Text = Trim("" & rscd.Fields("idVehiculo"))
        txtGls_Vehiculo.Text = Trim("" & rscd.Fields("GlsVehiculo"))
        txtCod_Chofer.Text = ("" & rscd.Fields("idPerChofer"))
        txtGls_Chofer.Text = Trim("" & rscd.Fields("glsChofer"))
        txtCod_EmpTrans.Text = Trim("" & rscd.Fields("idPerEmpTrans"))
        txtGls_EmpTrans.Text = Trim("" & rscd.Fields("GlsEmpTrans"))
        txt_Placa.Text = Trim("" & rscd.Fields("Placa"))
        txt_Marca.Text = Trim("" & rscd.Fields("Marca"))
        txt_Color.Text = Trim("" & rscd.Fields("Color"))
        txt_Modelo.Text = Trim("" & rscd.Fields("Modelo"))
        txt_CodInscripcion.Text = Trim("" & rscd.Fields("CodInsCrip"))
        txt_Brevete.Text = Trim("" & rscd.Fields("Brevete"))
        txt_RUCEmp.Text = Trim("" & rscd.Fields("rucEmpTrans"))
        txtCod_CentroCosto.Text = Trim("" & rscd.Fields("IdCentroCosto"))
        txtCod_Lista.Text = Trim("" & rscd.Fields("idLista"))
        txtCod_Almacen.Text = Trim("" & rscd.Fields("IdAlmacen"))
        
        TxtTipoDescuentoGlobal.Text = traerCampo("DocVentas", "TipoDescuentoGlobal", "IdDocumento", strTipoDocImportado, True, "IdSerie = '" & rscd.Fields("IdSerie") & "' And IdDocVentas = '" & rscd.Fields("IdDocVentas") & "'")
        
        If TxtTipoDescuentoGlobal.Text = "P" Then
            OptTipoDecuentoGlobal(0).Value = True
        Else
            OptTipoDecuentoGlobal(1).Value = True
        End If
        
        TxtDescuentoGlobal.Text = Val("" & traerCampo("DocVentas", "DescuentoGlobal", "IdDocumento", strTipoDocImportado, True, "IdSerie = '" & rscd.Fields("IdSerie") & "' And IdDocVentas = '" & rscd.Fields("IdDocVentas") & "'"))
        
        indCargando = False
        txtCod_Cliente.Text = traerCampo("DocVentas", "IdPerCliente", "IdDocumento", strTipoDocImportado, True, "IdSerie = '" & rscd.Fields("IdSerie") & "' And IdDocVentas = '" & rscd.Fields("IdDocVentas") & "'")
                
        'LUIS 17/10/2018 valida la forma de pago
        If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
            
            If Me.strTipoDoc = "40" Then
                        
                If (strTipoDocImportado = "40") Then
                    txtCod_FormaPago.Text = ""
                    cmbAyudaFormaPago.Enabled = True
                Else
                    txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
                    cmbAyudaFormaPago.Enabled = False
                End If
                
            Else
        
                txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
                                
                If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_ACTIVO_FACTURA", True) = "S" Then
                    cmbAyudaFormaPago.Enabled = True
                Else
                    cmbAyudaFormaPago.Enabled = False
                End If
            
            End If
        Else
            txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
        End If
        '**********************************************
        'txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
        
        ChkTransferenciaGratuitaMP.Value = Val("" & traerCampo("DocVentas", "IndTransGratuitaMP", "IdDocumento", strTipoDocImportado, True, "IdSerie = '" & rscd.Fields("IdSerie") & "' And IdDocVentas = '" & rscd.Fields("IdDocVentas") & "'"))
        ChkTransferenciaGratuita.Value = Val("" & traerCampo("DocVentas", "IndTransGratuita", "IdDocumento", strTipoDocImportado, True, "IdSerie = '" & rscd.Fields("IdSerie") & "' And IdDocVentas = '" & rscd.Fields("IdDocVentas") & "'"))
        
        indCargando = True
    End If

    If rsdd.RecordCount = 0 Then
        rsg.AddNew
        rsg.Fields("Item") = 1
        rsg.Fields("idProducto") = ""
        rsg.Fields("idCodFabricante") = ""
        rsg.Fields("GlsProducto") = ""
        rsg.Fields("idMarca") = ""
        rsg.Fields("GlsMarca") = ""
        rsg.Fields("idUM") = ""
        rsg.Fields("GlsUM") = ""
        rsg.Fields("Factor") = 1
        rsg.Fields("Afecto") = 1
        rsg.Fields("Cantidad") = 0
        rsg.Fields("Cantidad2") = 0
        rsg.Fields("VVUnit") = 0
        rsg.Fields("IGVUnit") = 0
        rsg.Fields("PVUnit") = 0
        rsg.Fields("TotalVVBruto") = 0
        rsg.Fields("TotalPVBruto") = 0
        rsg.Fields("PorDcto") = "0"
        rsg.Fields("DctoVV") = 0
        rsg.Fields("DctoPV") = 0
        rsg.Fields("TotalVVNeto") = 0
        rsg.Fields("TotalIGVNeto") = 0
        rsg.Fields("TotalPVNeto") = 0
        rsg.Fields("idTipoProducto") = ""
        rsg.Fields("idMoneda") = ""
        rsg.Fields("idDocumentoImp") = ""
        rsg.Fields("idDocVentasImp") = ""
        rsg.Fields("idSerieImp") = ""
        rsg.Fields("NumLote") = ""
        rsg.Fields("IdLote") = ""
        rsg.Fields("FecVencProd") = ""
        rsg.Fields("VVUnitLista") = 0
        rsg.Fields("PVUnitLista") = 0
        rsg.Fields("VVUnitNeto") = 0
        rsg.Fields("PVUnitNeto") = 0
        rsg.Fields("CodigoRapido") = ""
        rsg.Fields("idTallaPeso") = 0
        rsg.Fields("ItemPro") = 1
        rsg.Fields("IdCentroCosto") = ""
        rsg.Fields("GlsPlaca") = ""
        rsg.Fields("IdSucursalPres") = ""
        rsg.Fields("IdDocumentoPres") = ""
        rsg.Fields("IdSeriePres") = ""
        rsg.Fields("IdDocVentasPres") = ""
        rsg.Fields("IdUPCliente") = ""
        rsg.Fields("IvapUnit") = 0
        rsg.Fields("TotalIvapNeto") = 0
        rsg.Fields("GlsProveedor") = ""
        rsg.Fields("CostoS") = 0
        rsg.Fields("CostoSInc") = 0
        rsg.Fields("CostoD") = 0
        rsg.Fields("Margen") = 0
    Else
        rsdd.MoveFirst
        Do While Not rsdd.EOF
            rsg.AddNew
            i = i + 1
            rsg.Fields("Item") = i
            rsg.Fields("idProducto") = "" & rsdd.Fields("idProducto")
            rsg.Fields("idCodFabricante") = "" & rsdd.Fields("idCodFabricante")
            rsg.Fields("GlsProducto") = "" & rsdd.Fields("GlsProducto")
            rsg.Fields("idMarca") = "" & rsdd.Fields("idMarca")
            rsg.Fields("GlsMarca") = "" & rsdd.Fields("GlsMarca")
            rsg.Fields("idUM") = "" & rsdd.Fields("idUM")
            rsg.Fields("GlsUM") = "" & rsdd.Fields("GlsUM")
            rsg.Fields("Factor") = "" & rsdd.Fields("Factor")
            rsg.Fields("Afecto") = "" & rsdd.Fields("Afecto")
            rsg.Fields("Cantidad") = "" & rsdd.Fields("Cantidad")
            rsg.Fields("Cantidad2") = "" & rsdd.Fields("Cantidad2")
            rsg.Fields("VVUnit") = "" & rsdd.Fields("VVUnit")
            rsg.Fields("IGVUnit") = "" & rsdd.Fields("IGVUnit")
            rsg.Fields("PVUnit") = "" & rsdd.Fields("PVUnit")
            rsg.Fields("TotalVVBruto") = "" & rsdd.Fields("TotalVVBruto")
            rsg.Fields("TotalPVBruto") = "" & rsdd.Fields("TotalPVBruto")
            rsg.Fields("PorDcto") = "" & rsdd.Fields("PorDcto")
            rsg.Fields("DctoVV") = "" & rsdd.Fields("DctoVV")
            rsg.Fields("DctoPV") = "" & rsdd.Fields("DctoPV")
            rsg.Fields("TotalVVNeto") = "" & rsdd.Fields("TotalVVNeto")
            rsg.Fields("TotalIGVNeto") = "" & rsdd.Fields("TotalIGVNeto")
            rsg.Fields("TotalPVNeto") = "" & rsdd.Fields("TotalPVNeto")
            rsg.Fields("idTipoProducto") = "" & rsdd.Fields("idTipoProducto")
            rsg.Fields("idMoneda") = "" & rsdd.Fields("idMoneda")
            rsg.Fields("idDocumentoImp") = strTipoDocImportado
            rsg.Fields("idDocVentasImp") = "" & rsdd.Fields("idDocVentas")
            rsg.Fields("idSerieImp") = "" & rsdd.Fields("idSerie")
            rsg.Fields("NumLote") = "" & rsdd.Fields("NumLote")
            rsg.Fields("IdLote") = "" & rsdd.Fields("IdLote")
            rsg.Fields("FecVencProd") = "" & rsdd.Fields("FecVencProd")
            rsg.Fields("VVUnitLista") = "" & rsdd.Fields("VVUnitLista")
            rsg.Fields("PVUnitLista") = "" & rsdd.Fields("PVUnitLista")
            rsg.Fields("VVUnitNeto") = "" & rsdd.Fields("VVUnitNeto")
            rsg.Fields("PVUnitNeto") = "" & rsdd.Fields("PVUnitNeto")
            rsg.Fields("CodigoRapido") = "" & rsdd.Fields("CodigoRapido")
            rsg.Fields("idTallaPeso") = Val("" & rsdd.Fields("idTallaPeso"))
            rsg.Fields("CantidadAnt") = "" & rsdd.Fields("Cantidad")
            
            rsg.Fields("Simbolo1") = lbl_SimbMonBruto.Caption
            rsg.Fields("Simbolo2") = lbl_SimbMonBruto.Caption
            rsg.Fields("Simbolo3") = "%"
            rsg.Fields("ItemPro") = Val("" & rsdd.Fields("ItemPro"))
            rsg.Fields("IdCentroCosto") = ""
            rsg.Fields("GlsPlaca") = ""
            rsg.Fields("IdSucursalPres") = ""
            rsg.Fields("IdDocumentoPres") = ""
            rsg.Fields("IdSeriePres") = ""
            rsg.Fields("IdDocVentasPres") = ""
            rsg.Fields("IdUPCliente") = ""
            rsg.Fields("IvapUnit") = Val("" & rsdd.Fields("IvapUnit"))
            rsg.Fields("TotalIvapNeto") = Val("" & rsdd.Fields("TotalIvapNeto"))
        
            rsg.Fields("GlsProveedor") = ""
            rsg.Fields("CostoS") = 0
            rsg.Fields("CostoSInc") = 0
            rsg.Fields("CostoD") = 0
            rsg.Fields("Margen") = 0
        
            If RsD.RecordCount > 0 Then RsD.MoveFirst
            indExisteDocRef = False
            Do While Not RsD.EOF
               If RsD.Fields("idDocumento") = strTipoDocImportado And Trim("" & RsD.Fields("idSerie")) = Trim("" & rsdd.Fields("idSerie")) And RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas") Then
                   indExisteDocRef = True
                   Exit Do
               End If
               RsD.MoveNext
            Loop

            If indExisteDocRef = False Then
                RsD.AddNew
                RsD.Fields("Item") = "" & RsD.RecordCount
                RsD.Fields("idDocumento") = strTipoDocImportado
                RsD.Fields("GlsDocumento") = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDocImportado, False)
                RsD.Fields("idSerie") = "" & rsdd.Fields("idSerie")
                RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas")
                RsD.Fields("IndImportado") = "1"
                
                If strTipoDocImportado = "40" And traerCampo("Parametros", "ValParametro", "GlsParametro", "APRUEBA_PEDIDO_AUTOMATICO", True) = "1" Then
                    Jala_Materiales_Conversion txtCod_CentroCosto.Text, StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                
                Else
                    Jala_Formula_Documento strTipoDocImportado, rsdd.Fields("IdSerie"), rsdd.Fields("IdDocVentas"), StrMsgError
                    If StrMsgError <> "" Then GoTo Err
                End If
            End If
            RsD.Fields("TipoCambio") = "" & rscd.Fields("TC")
            rsdd.MoveNext
        Loop
    End If
    mostrarDatosGridSQL gDetalle, rsg, StrMsgError
    If StrMsgError <> "" Then GoTo Err

    '---- Documentos de referencia
    If RsD.RecordCount = 0 Then
        RsD.AddNew
        RsD.Fields("Item") = 1
        RsD.Fields("idDocumento") = ""
        RsD.Fields("GlsDocumento") = ""
        RsD.Fields("idSerie") = ""
        RsD.Fields("idNumDOc") = ""
        RsD.Fields("IndImportado") = "0"
    End If
    
    mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
    If StrMsgError <> "" Then GoTo Err

    '---- Recalculamos totales por fila
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        gDetalle.Dataset.Edit
        calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("IGVUnit").Value, gDetalle.Columns.ColumnByFieldName("PVUnit").Value, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
        gDetalle.Dataset.Post
        gDetalle.Dataset.Next
    Loop
    
    '---- Calculamos totales
    calcularTotales StrMsgError
    If StrMsgError <> "" Then GoTo Err

    If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    Else
        lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    End If

    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    
    If strTipoDoc = "07" Then
        txt_TipoCambio.Text = RsD.Fields("TipoCambio")
    End If
    
    indCargando = False
    Me.Refresh
    
    Exit Sub
Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub mostrarDocImportado(ByVal rscd As ADODB.Recordset, ByVal rsdd As ADODB.Recordset, ByVal strTipoDocImportado As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rsg                         As New ADODB.Recordset
Dim RsD                         As New ADODB.Recordset
Dim rsdClone                    As New ADODB.Recordset
Dim strSerieDocventas           As String
Dim i                           As Integer
Dim indExisteDocRef             As Boolean
Dim cAuxIdProducto              As String
Dim StrCodfPago     As String
Dim StrCodfPagoAnt  As String

    'LUIS 17/10/2018 valida la forma de pago
    StrCodfPago = ""
    StrCodfPagoAnt = ""
    
    If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
        If rscd.State = 1 Then
            rscd.MoveFirst
            If Not rscd.EOF Then
                Do While Not rscd.EOF
                                                    
                    If strTipoDocImportado = "92" Or strTipoDocImportado = "40" Or strTipoDocImportado = "86" Then
                        
                        If StrCodfPago <> "" And StrCodfPago <> Trim("" & rscd.Fields("idFormaPago")) Then
                            StrMsgError = "No se puede documentos con diferentes formas de pago, verifique": GoTo Err
                        End If
                    
                        StrCodfPago = Trim("" & rscd.Fields("idFormaPago"))
                    End If
        
                rscd.MoveNext
                Loop
            End If
            rscd.MoveFirst
        End If
    End If
    '********************************************
    
    indCargando = True
    i = 0
    strEstDocVentas = "GEN"
    
    '---- Formato Detalle
    rsg.Fields.Append "Item", adInteger, , adFldRowID
    rsg.Fields.Append "numOrdenCompra", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "GlsProducto", adVarChar, 800, adFldIsNullable
    rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
    rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
    rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
    rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "ItemPro", adInteger, , adFldRowID
    rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
    rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
    rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    rsg.Open
    
    '---- Formato Documento de refrencia
    RsD.Fields.Append "Item", adInteger, , adFldRowID
    RsD.Fields.Append "IdDocumento", adChar, 2, adFldIsNullable
    RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
    RsD.Fields.Append "IdSerie", adChar, 4, adFldIsNullable
    RsD.Fields.Append "IdNumDoc", adChar, 8, adFldIsNullable
    RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
    
    RsD.Open , , adOpenKeyset, adLockOptimistic
    
    If rscd.RecordCount = 0 Then
        txt_OrdenCompra.Text = ""
    Else
        txt_OrdenCompra.Text = "" & rscd.Fields("numOrdenCompra")
        txt_Llegada.Text = "" & rscd.Fields("llegada")
        txtCod_Moneda.Text = "" & rscd.Fields("idmoneda")
        dtp_IniTraslado.Value = "" & rscd.Fields("FecIniTraslado")
        
        'LUIS 17/10/2018 valida la forma de pago
        If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_X_CLIENTE", True) = "S" Then
            
            If Me.strTipoDoc = "40" Then
                        
                If (strTipoDocImportado = "40") Then
                    txtCod_FormaPago.Text = ""
                    cmbAyudaFormaPago.Enabled = True
                Else
                    txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
                    cmbAyudaFormaPago.Enabled = False
                End If
                
            Else
        
                txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
                                
                If traerCampo("PARAMETROS", "VALPARAMETRO", "GLSPARAMETRO", "FORMA_PAGOS_ACTIVO_FACTURA", True) = "S" Then
                    cmbAyudaFormaPago.Enabled = True
                Else
                    cmbAyudaFormaPago.Enabled = False
                End If
            
            End If
        Else
            txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
        End If
        '**********************************************
        'txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
        
        txtCod_Chofer.Text = ("" & rscd.Fields("idPerChofer"))
        txtGls_Chofer.Text = Trim("" & rscd.Fields("glsChofer"))
        txtCod_EmpTrans.Text = Trim("" & rscd.Fields("idPerEmpTrans"))
        txtGls_EmpTrans.Text = Trim("" & rscd.Fields("GlsEmpTrans"))
        txtCod_Vehiculo.Text = Trim("" & rscd.Fields("idVehiculo"))
        txtGls_Vehiculo.Text = Trim("" & rscd.Fields("GlsVehiculo"))
        txt_Placa.Text = Trim("" & rscd.Fields("Placa"))
        txt_Marca.Text = Trim("" & rscd.Fields("Marca"))
        txt_Color.Text = Trim("" & rscd.Fields("Color"))
        txt_Modelo.Text = Trim("" & rscd.Fields("Modelo"))
        txt_CodInscripcion.Text = Trim("" & rscd.Fields("CodInsCrip"))
        txt_Brevete.Text = Trim("" & rscd.Fields("Brevete"))
        txt_RUCEmp.Text = Trim("" & rscd.Fields("rucEmpTrans"))
        txtCod_CentroCosto.Text = Trim("" & rscd.Fields("IdCentroCosto"))
        txtCod_Lista.Text = Trim("" & rscd.Fields("idLista"))
        
        'txt_Partida.Text = "" & rscd.Fields("GlsPartida")
        txt_Partida.Text = traerCampo("Docventas", "Partida", "idDocumento", strTipoDocImportado, True, "IdSerie = '" & rsdd.Fields("idSerie") & "' And idDocventas = '" & rsdd.Fields("idDocVentas") & "'")
        
    End If
        
    If rsdd.RecordCount = 0 Then
        rsg.AddNew
        rsg.Fields("Item") = 1
        rsg.Fields("idProducto") = ""
        rsg.Fields("idCodFabricante") = ""
        rsg.Fields("GlsProducto") = ""
        rsg.Fields("idMarca") = ""
        rsg.Fields("GlsMarca") = ""
        rsg.Fields("idUM") = ""
        rsg.Fields("GlsUM") = ""
        rsg.Fields("Factor") = 1
        rsg.Fields("Afecto") = 1
        rsg.Fields("Cantidad") = 0
        rsg.Fields("Cantidad2") = 0
        rsg.Fields("VVUnit") = 0
        rsg.Fields("IGVUnit") = 0
        rsg.Fields("PVUnit") = 0
        rsg.Fields("TotalVVBruto") = 0
        rsg.Fields("TotalPVBruto") = 0
        rsg.Fields("PorDcto") = "0"
        rsg.Fields("DctoVV") = 0
        rsg.Fields("DctoPV") = 0
        rsg.Fields("TotalVVNeto") = 0
        rsg.Fields("TotalIGVNeto") = 0
        rsg.Fields("TotalPVNeto") = 0
        rsg.Fields("idTipoProducto") = ""
        rsg.Fields("idMoneda") = ""
        rsg.Fields("idDocumentoImp") = ""
        rsg.Fields("idDocVentasImp") = ""
        rsg.Fields("idSerieImp") = ""
        rsg.Fields("NumLote") = ""
        rsg.Fields("IdLote") = ""
        rsg.Fields("FecVencProd") = ""
        rsg.Fields("VVUnitLista") = 0
        rsg.Fields("PVUnitLista") = 0
        rsg.Fields("VVUnitNeto") = 0
        rsg.Fields("PVUnitNeto") = 0
        rsg.Fields("CantidadAnt") = 0
        rsg.Fields("ItemPro") = 1
        rsg.Fields("IdCentroCosto") = ""
        rsg.Fields("GlsPlaca") = ""
        rsg.Fields("IdSucursalPres") = ""
        rsg.Fields("IdDocumentoPres") = ""
        rsg.Fields("IdSeriePres") = ""
        rsg.Fields("IdDocVentasPres") = ""
        rsg.Fields("IdUPCliente") = ""
        rsg.Fields("IvapUnit") = 0
        rsg.Fields("TotalIvapNeto") = 0
        rsg.Fields("GlsProveedor") = ""
        rsg.Fields("CostoS") = 0
        rsg.Fields("CostoSInc") = 0
        rsg.Fields("CostoD") = 0
        rsg.Fields("Margen") = 0
    Else
        rsdd.MoveFirst
        rsdd.Sort = "idProducto"
        Set rsdClone = rsdd.Clone
        Do While Not rsdd.EOF
            cAuxIdProducto = "" & rsdd.Fields("idProducto")
            rsg.AddNew
            i = i + 1
            rsg.Fields("Item") = i
            rsg.Fields("idProducto") = "" & rsdd.Fields("idProducto")
            rsg.Fields("idCodFabricante") = "" & rsdd.Fields("idCodFabricante")
            rsg.Fields("GlsProducto") = "" & rsdd.Fields("GlsProducto")
            rsg.Fields("idMarca") = "" & rsdd.Fields("idMarca")
            rsg.Fields("GlsMarca") = "" & rsdd.Fields("GlsMarca")
            rsg.Fields("idUM") = "" & rsdd.Fields("idUM")
            rsg.Fields("GlsUM") = "" & rsdd.Fields("GlsUM")
            rsg.Fields("Factor") = "" & rsdd.Fields("Factor")
            rsg.Fields("Afecto") = "" & rsdd.Fields("Afecto")
            rsg.Fields("idTipoProducto") = "" & rsdd.Fields("idTipoProducto")
            rsg.Fields("idMoneda") = "" & rsdd.Fields("idMoneda")
            rsg.Fields("idDocumentoImp") = strTipoDocImportado
            rsg.Fields("idDocVentasImp") = "" & rsdd.Fields("idDocVentas")
            rsg.Fields("idSerieImp") = "" & rsdd.Fields("idSerie")
            rsg.Fields("NumLote") = "" & rsdd.Fields("NumLote")
            rsg.Fields("IdLote") = "" & rsdd.Fields("IdLote")
            rsg.Fields("FecVencProd") = "" & rsdd.Fields("FecVencProd")
            rsg.Fields("CodigoRapido") = "" & rsdd.Fields("CodigoRapido")
            rsg.Fields("idTallaPeso") = Val("" & rsdd.Fields("idTallaPeso"))
            rsg.Fields("VVUnit") = Val("" & rsdd.Fields("VVUnit"))
            rsg.Fields("IGVUnit") = Val("" & rsdd.Fields("IGVUnit"))
            rsg.Fields("PVUnit") = Val("" & rsdd.Fields("PVUnit"))
            rsg.Fields("VVUnitLista") = Val("" & rsdd.Fields("VVUnitLista"))
            rsg.Fields("PVUnitLista") = Val("" & rsdd.Fields("PVUnitLista"))
            rsg.Fields("VVUnitNeto") = Val("" & rsdd.Fields("VVUnitNeto"))
            rsg.Fields("PVUnitNeto") = Val("" & rsdd.Fields("PVUnitNeto"))
            rsg.Fields("ItemPro") = Val("" & rsdd.Fields("ItemPro"))
            rsg.Fields("IdCentroCosto") = ""
            rsg.Fields("GlsPlaca") = ""
            rsg.Fields("IdSucursalPres") = ""
            rsg.Fields("IdDocumentoPres") = ""
            rsg.Fields("IdSeriePres") = ""
            rsg.Fields("IdDocVentasPres") = ""
            rsg.Fields("IdUPCliente") = ""
            rsg.Fields("IvapUnit") = Val("" & rsdd.Fields("IvapUnit"))
            rsg.Fields("TotalIvapNeto") = Val("" & rsdd.Fields("TotalIvapNeto"))
            rsg.Fields("GlsProveedor") = ""
            rsg.Fields("CostoS") = 0
            rsg.Fields("CostoSInc") = 0
            rsg.Fields("CostoD") = 0
            rsg.Fields("Margen") = 0
            Do While cAuxIdProducto = "" & rsdd.Fields("idProducto")
                rsg.Fields("Cantidad") = Val("" & rsg.Fields("Cantidad")) + Val("" & rsdd.Fields("Cantidad"))
                rsg.Fields("Cantidad2") = Val("" & rsg.Fields("Cantidad2")) + Val("" & rsdd.Fields("Cantidad2"))
                rsg.Fields("TotalVVBruto") = Val("" & rsg.Fields("TotalVVBruto")) + Val("" & rsdd.Fields("TotalVVBruto"))
                rsg.Fields("TotalPVBruto") = Val("" & rsg.Fields("TotalPVBruto")) + Val("" & rsdd.Fields("TotalPVBruto"))
                rsg.Fields("PorDcto") = Val("" & rsg.Fields("PorDcto")) + Val("" & rsdd.Fields("PorDcto"))
                rsg.Fields("DctoVV") = Val("" & rsg.Fields("DctoVV")) + Val("" & rsdd.Fields("DctoVV"))
                rsg.Fields("DctoPV") = Val("" & rsg.Fields("DctoPV")) + Val("" & rsdd.Fields("DctoPV"))
                rsg.Fields("TotalVVNeto") = Val("" & rsg.Fields("TotalVVNeto")) + Val("" & rsdd.Fields("TotalVVNeto"))
                rsg.Fields("TotalIGVNeto") = Val("" & rsg.Fields("TotalIGVNeto")) + Val("" & rsdd.Fields("TotalIGVNeto"))
                rsg.Fields("TotalPVNeto") = Val("" & rsg.Fields("TotalPVNeto")) + Val("" & rsdd.Fields("TotalPVNeto"))
                rsg.Fields("CantidadAnt") = Val("" & rsg.Fields("Cantidad")) + Val("" & rsdd.Fields("Cantidad"))
                rsg.Fields("Simbolo1") = lbl_SimbMonBruto.Caption
                rsg.Fields("Simbolo2") = lbl_SimbMonBruto.Caption
                rsg.Fields("Simbolo3") = "%"
            
                If RsD.RecordCount > 0 Then RsD.MoveFirst
                indExisteDocRef = False
                Do While Not RsD.EOF
                   If Trim("" & RsD.Fields("idDocumento")) = Trim("" & strTipoDocImportado) And Trim("" & RsD.Fields("idSerie")) = Trim("" & rsdd.Fields("idSerie")) And Trim("" & RsD.Fields("idNumDOc")) = Trim("" & rsdd.Fields("idDocVentas")) Then
                       indExisteDocRef = True
                       Exit Do
                   End If
                   RsD.MoveNext
                Loop
                
                If indExisteDocRef = False Then
                    RsD.AddNew
                    RsD.Fields("Item") = "" & RsD.RecordCount
                    RsD.Fields("IdDocumento") = strTipoDocImportado
                    RsD.Fields("GlsDocumento") = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDocImportado, False)
                    RsD.Fields("IdSerie") = "" & rsdd.Fields("idSerie")
                    RsD.Fields("IdNumDoc") = "" & rsdd.Fields("idDocVentas")
                    RsD.Fields("IndImportado") = "1"
                    
                    If strTipoDoc = "40" And traerCampo("Parametros", "ValParametro", "GlsParametro", "APRUEBA_PEDIDO_AUTOMATICO", True) = "1" Then
                        Jala_Materiales_Conversion txtCod_CentroCosto.Text, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                    Else
                        Jala_Formula_Documento strTipoDocImportado, rsdd.Fields("IdSerie"), rsdd.Fields("IdDocVentas"), StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                    End If
                End If
                rsdd.MoveNext
                If rsdd.EOF Then Exit Do
            Loop
            If rsg.Fields("PorDcto") > 0 And rsdd.RecordCount > 1 Then
                rsdClone.Filter = adFilterNone
                rsdClone.Filter = "idProducto='" & rsg.Fields("idProducto") & "'"
                If Not rsdClone.EOF Then
                    rsg.Fields("PorDcto") = rsg.Fields("PorDcto") / rsdClone.RecordCount
                End If
            End If
        Loop
    End If
    
    mostrarDatosGridSQL gDetalle, rsg, StrMsgError
    If StrMsgError <> "" Then GoTo Err
        
    '---- Documentos de referencia
    If RsD.RecordCount = 0 Then
        RsD.AddNew
        RsD.Fields("Item") = 1
        RsD.Fields("IdDocumento") = ""
        RsD.Fields("GlsDocumento") = ""
        RsD.Fields("IdSerie") = ""
        RsD.Fields("IdNumDOc") = ""
        RsD.Fields("IndImportado") = "0"
    End If

    mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
    If StrMsgError <> "" Then GoTo Err
 
    '---- Recalculamos totales por fila
    gDetalle.Dataset.First
    Do While Not gDetalle.Dataset.EOF
        gDetalle.Dataset.Edit
        calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("IGVUnit").Value, gDetalle.Columns.ColumnByFieldName("PVUnit").Value, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
        gDetalle.Dataset.Post
        gDetalle.Dataset.Next
    Loop
    
    '---- Calculamos totales
    calcularTotales StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
        lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    Else
        lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
    End If
    txt_MontoLetras.Text = lbl_TotalLetras.Caption
    indCargando = False
    Me.Refresh
    
    Exit Sub

Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub eliminar(ByRef StrMsgError As String)
On Error GoTo Err
Dim rsValida            As New ADODB.Recordset
Dim rscta               As New ADODB.Recordset
Dim rsCta_Mvto          As New ADODB.Recordset
Dim RScTA_dCTO          As New ADODB.Recordset
Dim rs                  As New ADODB.Recordset
Dim rst                 As New ADODB.Recordset
Dim rstcab              As New ADODB.Recordset
Dim indTrans            As Boolean
Dim strCodVale          As String
Dim strNumMovCaja       As String
Dim cabrev              As String
Dim cdocumento          As String
Dim cbusca              As String
Dim numFactura          As String
Dim serieFactura        As String
Dim estFactura          As String
Dim idFormaPago         As String
Dim Cta_Dcto            As String
Dim idmovcaja           As String
Dim strMovCaja          As String
Dim IndEvaluacion       As Integer
Dim Pagos               As Integer
Dim idValeDocventas     As String
Dim strTipoVale         As String
Dim rsliquidacion       As New ADODB.Recordset
Dim CadMysqlLiq         As String
Dim CadMysqlLiqAct      As String
Dim idValescabIngreso As String
Dim strTipoValeIngreso As String
Dim strSucursalDes As String

    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    If Val("" & traerCampo("DocVentas", "IndAceptadoSunat", "IdDocumento", strTipoDoc, True, "IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'")) = 1 Then
        StrMsgError = "El documento ya ha sido aceptado por Sunat. No puede ser eliminado.": GoTo Err
    End If
    
    '--- Parametro que evaluará la liberación del detalle de un documento de  referencia por el item del producto
    strParamItemPro = Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "EVALUA_ITEM_DETALLE_PRODUCTO", True))
    
    If MsgBox("¿Seguro de eliminar el documento?" & vbCrLf & "Se eliminaran todas sus dependencias.", vbQuestion + vbYesNo, App.Title) = vbNo Then Exit Sub
        
    idValeDocventas = Trim("" & traerCampo("docventas", "idValesCab", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoVale = Trim("" & traerCampo("docventas", "tipoVale", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    
    idValescabIngreso = Trim("" & traerCampo("docventas", "idValesCabing", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoValeIngreso = Trim("" & traerCampo("docventas", "tipoValeing", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strSucursalDes = Trim("" & traerCampo("docventas", "SucursalDestino", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    
    If strTipoDoc = "86" Then
        '---- Buscamos la factura q esta amarrada
        If gDocReferencia.Count > 0 Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                    numFactura = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                    serieFactura = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                    Exit Do
                End If
                gDocReferencia.Dataset.Next
            Loop
        End If
            
        '---- Verificamos el estado de la factura
        estFactura = traerCampo("docventas", "estDocVentas", "iddocventas", numFactura, True, " iddocumento = '01' and idSerie = '" & serieFactura & "' ")
        If estFactura = "IMP" Then
            StrMsgError = "La factura ya fue impresa, no se puede eliminar la Guia"
            GoTo Err
        End If
            
        '---- Verificamos si la factura tiene pagos
        idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and idDocumento = '01' and idTipoMovCaja = '99990002'")
        cabrev = "Fac"
        cdocumento = cabrev & serieFactura & "/" & numFactura
        Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
        Pagos = 0
        If Cta_Dcto <> "" Then Pagos = Val(traerCampo("Cta_Mvto", "count(*)", "idCta_Dcto", Cta_Dcto, True))
        idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
        If idFormaPago <> "06090001" And idFormaPago <> "06090004" And Pagos <> 0 Then
           StrMsgError = "No se puede eliminar el documento porque esta cancelado en cuentas por cobrar"
           GoTo Err
        End If
    End If
        
    Cn.BeginTrans
    indTrans = True
    
'    FacturacionEntreEmpresasElimina StrMsgError, txt_serie.Text, txt_numdoc.Text
'    If StrMsgError <> "" Then GoTo Err
    
    '---- ELIMINANDO
    If strTipoDoc = "86" Then
        '---- Eliminamos la factura de ctas por cobrar
        csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
        rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
        Do While Not rsCta_Mvto.EOF
            csql = "select idCta_Dcto, Nro_Comp, idMoneda from cta_dcto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' and idEmpresa = '" & glsEmpresa & "'"
            If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
            RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            Do While Not RScTA_dCTO.EOF
                If left(RScTA_dCTO.Fields("Nro_Comp") & "", 3) = "Efe" Then
                    csql = "delete from cta_dcto where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                Else
                    If RScTA_dCTO.Fields("idMoneda") & "" = "PEN" Then
                        If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    ElseIf RScTA_dCTO.Fields("idMoneda") & "" = "USD" Then
                        If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    End If
                End If
                Cn.Execute (csql)
                RScTA_dCTO.MoveNext
            Loop
            csql = "delete from cta_mvto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                     "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            rsCta_Mvto.MoveNext
        Loop
        csql = "delete from CTA_DCTO WHERE IDCTA_DCTO = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        Cn.Execute csql
        
        '---- Eliminamos la factura de Docventas
        csql = "delete from docventas " & _
                " WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
                "' AND idDocumento = '01' AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
        Cn.Execute csql
        
        '---- Eliminamos el ingreso a caja
        csql = "delete from movcajasdet " & _
                 "WHERE idMovCaja = '" & idmovcaja & "' " & _
                 "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '01' " & _
                 "AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
        Cn.Execute csql
    
        '---- Eliminamos del pagosDocVentas
        csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                "AND idDocumento = '01' and idDocVentas = '" & numFactura & "' and idSerie = '" & serieFactura & "'"
        Cn.Execute csql
    End If
    
    If traerCampo("Parametros", "ValParametro", "GlsParametro", "AGRUPAPRODUCTOS", True) = "N" Then
        '---- Cambiamos el estado a Importado
        csql = "SELECT d.idDocumentoImp,d.idDocVentasImp,d.idSerieImp,d.idProducto,d.idUM,d.Cantidad,d.Cantidad2,d.ItemPro " & _
                "FROM docventasdet d " & _
                "WHERE d.idEmpresa = '" & glsEmpresa & "' " & _
                "AND d.idSucursal = '" & glsSucursal & "' " & _
                "AND d.idDocumento = '" & strTipoDoc & "' " & _
                "AND d.idDocVentasImp <> '' " & _
                "AND d.idSerie = '" & Trim(txt_Serie.Text) & "' " & _
                "AND d.idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
                "ORDER BY d.idDocumentoImp DESC "
          
        If rst.State = 1 Then rst.Close
        rst.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rst.EOF Then
            rst.MoveFirst
            rst.Sort = "idProducto"
            Do While Not rst.EOF
                '---- ACTUALIZAMOS CANTIDAD IMPORTADA
                If strParamItemPro = "S" Then
                    csql = "UPDATE docventasdet dd  " & _
                          "SET dd.CantidadImp = dd.CantidadImp - " & CStr(rst.Fields("Cantidad")) & ", dd.estDocImportado = 'N' " & _
                          "WHERE dd.idEmpresa = '" & glsEmpresa & "' " & _
                          "AND dd.idSucursal = '" & glsSucursal & "' " & _
                          "AND dd.idDocumento = '" & rst.Fields("idDocumentoImp") & "' " & _
                          "AND dd.idDocVentas = '" & rst.Fields("idDocVentasImp") & "' " & _
                          "AND dd.idSerie = '" & rst.Fields("idSerieImp") & "' " & _
                          "AND dd.idProducto = '" & rst.Fields("idProducto") & "' " & _
                          "AND dd.idUM = '" & rst.Fields("idUM") & "' " & _
                          "AND dd.ItemPro ='" & rst.Fields("ItemPro") & "' "
                Else
                    csql = "UPDATE dd  " & _
                          "SET dd.CantidadImp = dd.CantidadImp - " & CStr(rst.Fields("Cantidad")) & ", dd.estDocImportado = 'N' FROM docventasdet dd " & _
                          "WHERE dd.idEmpresa = '" & glsEmpresa & "' " & _
                          "AND dd.idSucursal = '" & glsSucursal & "' " & _
                          "AND dd.idDocumento = '" & rst.Fields("idDocumentoImp") & "' " & _
                          "AND dd.idDocVentas = '" & rst.Fields("idDocVentasImp") & "' " & _
                          "AND dd.idSerie = '" & rst.Fields("idSerieImp") & "' " & _
                          "AND dd.idProducto = '" & rst.Fields("idProducto") & "' " & _
                          "AND dd.idUM = '" & rst.Fields("idUM") & "' "
                End If
                Cn.Execute csql
                rst.MoveNext
            Loop
        End If
    
        '---- Marcamos la Cabecera
        csql = "SELECT DISTINCT idDocumentoImp,idDocVentasImp,idSerieImp,idProducto  FROM docventasdet " & _
                "WHERE idEmpresa = '" & glsEmpresa & "' " & _
                "AND idSucursal = '" & glsSucursal & "' " & _
                "AND idDocumento = '" & strTipoDoc & "' " & _
                "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
                "AND idSerie = '" & Trim(txt_Serie.Text) & "' " & _
                "AND idDocVentasImp <> '' AND idDocVentasImp is not null"
        If rstcab.State = 1 Then rstcab.Close
        rstcab.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        If Not rstcab.EOF Then
            rst.MoveFirst
            Do While Not rstcab.EOF
                csql = "UPDATE  c  SET c.estDocImportado = 'N' FROM docVentas c " & _
                      "WHERE c.idEmpresa = '" & glsEmpresa & "' " & _
                      "AND c.idSucursal = '" & glsSucursal & "' " & _
                      "AND c.idDocumento = '" & rstcab.Fields("idDocumentoImp") & "' " & _
                      "AND c.idDocVentas = '" & rstcab.Fields("idDocVentasImp") & "' " & _
                      "AND c.idSerie = '" & rstcab.Fields("idSerieImp") & "' "
                Cn.Execute csql
                rstcab.MoveNext
            Loop
        End If
        
    Else
        csql = "select idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia,idproducto,cantidad from docreferenciadet " & _
                "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "' "
        If RstDet.State = 1 Then RstDet.Close
        RstDet.Open csql, Cn, adOpenStatic, adLockReadOnly
    
        If RstDet.RecordCount > 0 Then
            RstDet.MoveFirst
            Do While Not RstDet.EOF
                csql = "update docventasdet set cantidadimp = cantidadimp - " & CStr(RstDet.Fields("Cantidad")) & " " & _
                        "where idempresa = '" & Trim(RstDet.Fields("idempresa")) & "' and iddocumento =  '" & Trim(RstDet.Fields("tipodocreferencia")) & "' " & _
                        "and idserie = '" & Trim(RstDet.Fields("seriedocreferencia")) & "' and iddocventas = '" & Trim(RstDet.Fields("numdocreferencia")) & "' and idproducto = '" & Trim(RstDet.Fields("idproducto")) & "' "
                Cn.Execute csql
                RstDet.MoveNext
            Loop
        End If
        If RstDet.State = 1 Then RstDet.Close: Set RstDet = Nothing
           
        'Actualizamos los producto importados(detalle) docventasdet
        csql = "select idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia from docreferencia " & _
                "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "' "
        If rstdocref.State = 1 Then rstdocref.Close
        rstdocref.Open csql, Cn, adOpenStatic, adLockReadOnly
        If rstdocref.RecordCount > 0 Then
            rstdocref.MoveFirst
            Do While Not rstdocref.EOF
                If Len(Trim("" & rstdocref.Fields("numdocreferencia"))) = 8 Then
                    csql = "select idempresa,iddocumento,idserie,iddocventas,idproducto,cantidad,cantidadimp from docventasdet " & _
                            "where idempresa = '" & Trim(rstdocref.Fields("idempresa")) & "'and iddocumento = '" & Trim(rstdocref.Fields("tipodocreferencia")) & "' " & _
                            "and idserie = '" & Trim(rstdocref.Fields("seriedocreferencia")) & "' and iddocventas = '" & Trim(rstdocref.Fields("numdocreferencia")) & "' "
                    If rst.State = 1 Then rst.Close
                    rst.Open csql, Cn, adOpenStatic, adLockReadOnly
                    If rst.RecordCount > 0 Then
                        rst.MoveFirst
                        Do While Not rst.EOF
                            If CDbl(Trim("" & rst.Fields("cantidad"))) = CDbl(Trim("" & rst.Fields("cantidadimp"))) Then
                                csql = "Update docventasdet set  estdocimportado = 'S' " & _
                                        "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("iddocumento")) & "' and idserie = '" & Trim(rst.Fields("idserie")) & "'  and iddocventas = '" & Trim(rst.Fields("iddocventas")) & "' and idproducto = '" & Trim(rst.Fields("idproducto")) & "' "
                                Cn.Execute csql
                            ElseIf CDbl(Trim("" & rst.Fields("cantidad"))) > CDbl(Trim("" & rst.Fields("cantidadimp"))) Then
                                csql = "Update docventasdet set estdocimportado = 'N' " & _
                                        "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("iddocumento")) & "' and idserie = '" & Trim(rst.Fields("idserie")) & "'  and iddocventas = '" & Trim(rst.Fields("iddocventas")) & "' and idproducto = '" & Trim(rst.Fields("idproducto")) & "' "
                                Cn.Execute csql
                            End If
                            rst.MoveNext
                        Loop
                    End If
                End If
                rstdocref.MoveNext
            Loop
        End If

        '--- Actualizamos la cabecera docventas
        csql = "select distinct idempresa,tipodocreferencia,seriedocreferencia,numdocreferencia from docreferencia " & _
                "where idempresa = '" & glsEmpresa & "' and tipodocorigen = '" & strTipoDoc & "' and seriedocorigen = '" & Trim(txt_Serie.Text) & "'  and numdocorigen = '" & Trim(txt_NumDoc.Text) & "' "
        If rst.State = 1 Then rst.Close
        rst.Open csql, Cn, adOpenStatic, adLockReadOnly
            
        If rst.RecordCount > 0 Then
            rst.MoveFirst
            Do While Not rst.EOF
                If Len(Trim("" & rst.Fields("numdocreferencia"))) = 8 Then
                    csql = "select distinct estdocimportado from docventasdet " & _
                            "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                    If rsh.State = 1 Then rsh.Close
                    rsh.Open csql, Cn, adOpenStatic, adLockReadOnly
                    If rsh.RecordCount > 0 Then
                        If rsh.RecordCount > 1 Then
                            csql = "Update docventas set  estdocimportado = 'N' " & _
                                   "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                            Cn.Execute csql
                        
                        ElseIf rsh.RecordCount = 1 And (Trim("" & rsh.Fields("estdocimportado"))) = "N" Then
                            csql = "Update docventas set  estdocimportado = 'N' " & _
                                    "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                            Cn.Execute csql
                        ElseIf rsh.RecordCount = 1 And (Trim("" & rsh.Fields("estdocimportado"))) = "S" Then
                            csql = "Update docventas set  estdocimportado = 'S' " & _
                                   "where idempresa = '" & Trim(rst.Fields("idempresa")) & "' and iddocumento = '" & Trim(rst.Fields("tipodocreferencia")) & "' and idserie = '" & Trim(rst.Fields("seriedocreferencia")) & "'  and iddocventas = '" & Trim(rst.Fields("numdocreferencia")) & "'"
                        End If
                    End If
                End If
                rst.MoveNext
            Loop
        End If
        
        '--- Eliminando docreferenciadet
        csql = "DELETE FROM docreferenciadet " & _
                "WHERE idEmpresa = '" & glsEmpresa & "' AND tipoDocOrigen = '" & strTipoDoc & "' AND numDocOrigen = '" & Trim(txt_NumDoc.Text) & "' AND serieDocOrigen = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
    
        csql = "DELETE FROM docreferenciadet " & _
                "WHERE idEmpresa = '" & glsEmpresa & "' AND tipoDocreferencia = '" & strTipoDoc & "' AND numDocreferencia = '" & Trim(txt_NumDoc.Text) & "' AND serieDocreferencia = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
    End If
    
    '---- Eliminamos el Documento
    csql = "delete from docventas " & _
          " WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
          "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
          "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    csql = "delete from docventasdet " & _
             "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
             "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
             "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    '----------------------------------------------------------------------------------
    '---- ELIMINA DE CTASXCOBRAR MYSQL
    cabrev = traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False)
    'lUIS 25 / 02 / 2018
    cdocumento = cabrev & Trim("" & txt_Serie.Text) & "/" & Format(txt_NumDoc.Text, "00000000")
    'cdocumento = cabrev & Format(txt_Serie.Text, "000") & "/" & Format(txt_NumDoc.Text, "00000000")
    Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
    
    If cabrev = "Cre" Then
        csql = "select idCta_Comp as idCta_Dcto, idCta_Dcto as idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Comp = '" & Cta_Dcto & "' And IdCta_Comp <> '' and idEmpresa = '" & glsEmpresa & "' "
    Else
        csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' And IdCta_Dcto <> '' and idEmpresa = '" & glsEmpresa & "' "
    End If
    If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
    rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
    If Not rsCta_Mvto.EOF Then
        idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", txt_NumDoc.Text, True, "idSerie = '" & txt_Serie.Text & "' and idDocumento = '" & strTipoDoc & "' and idTipoMovCaja = '99990002'")
        idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
        If idFormaPago <> "06090001" And idFormaPago <> "06090004" Then
           StrMsgError = "No se puede eliminar el documento porque está cancelado en Cuentas por Cobrar."
           GoTo Err
        End If
            
        Do While Not rsCta_Mvto.EOF
            csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                     "from cta_dcto " & _
                     "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                     "and idEmpresa = '" & glsEmpresa & "'"
            If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
            RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            Do While Not RScTA_dCTO.EOF
                If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                    csql = "delete from cta_dcto " & _
                             "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "'"
                Else
                    If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                        If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                        If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    End If
                End If
                Cn.Execute (csql)
                RScTA_dCTO.MoveNext
            Loop
            If cabrev = "Cre" Then
                csql = "delete from cta_mvto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
            Else
                csql = "delete from cta_mvto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
            End If
            Cn.Execute csql
            rsCta_Mvto.MoveNext
        Loop
    End If
    
    csql = "delete from CTA_DCTO " & _
             "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
             "and idEmpresa = '" & glsEmpresa & "' "
    Cn.Execute csql
    
    If traerCampo("seriesdocumento", "IndTransferencia", "idDocumento", strTipoDoc, True, " idserie = '" & Trim(txt_Serie.Text) & "' ") <> "S" Then
        '----------------------------------------------------------------------------------
        '---- Anulamos los vales q se generaron
        csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                 "from docReferencia " & _
                 "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                 "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '99' " & _
                 "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal= '" & glsSucursal & "' "
                 
        If Len(Trim("" & idValeDocventas)) > 0 Then
            actualizaStock idValeDocventas, 1, StrMsgError, strTipoVale, False
            If StrMsgError <> "" Then GoTo Err
            
            actualizaStock_Lote idValeDocventas, 1, StrMsgError, strTipoVale, False
            If StrMsgError <> "" Then GoTo Err
            
            csql = "delete from valescab " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
            csql = "delete from valesdet " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
            csql = "Delete From valesdetLotes " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
        End If
    
    Else
        '----------------------------------------------------------------------------------
        '---- Anulamos los vales q se generaron Salida
        csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                 "from docReferencia " & _
                 "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                 "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '99' " & _
                 "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal= '" & glsSucursal & "' "
                 
        If Len(Trim("" & idValeDocventas)) > 0 Then
            actualizaStock idValeDocventas, 1, StrMsgError, strTipoVale, False
            If StrMsgError <> "" Then GoTo Err
            
            actualizaStock_Lote idValeDocventas, 1, StrMsgError, strTipoVale, False
            If StrMsgError <> "" Then GoTo Err
            
            csql = "delete from valescab " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
            csql = "delete from valesdet " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
            csql = "delete from valesdetLotes " & _
                     "WHERE idValesCab = '" & idValeDocventas & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoVale & "' "
            Cn.Execute csql
            
        End If
    
        '----------------------------------------------------------------------------------
        '---- Anulamos los vales q se generaron Ingreso
        csql = "select NumDocOrigen, idEmpresa, idSucursal " & _
                 "from docReferencia " & _
                 "where tipoDocReferencia = '" & strTipoDoc & "' and serieDocReferencia = '" & txt_Serie.Text & "' " & _
                 "and numDocReferencia = '" & txt_NumDoc.Text & "' and TipoDocOrigen = '88' " & _
                 "and SerieDocOrigen = '000' and idEmpresa = '" & glsEmpresa & "' and idSucursal= '" & glsSucursal & "' "
                 
           
        If Len(Trim("" & idValescabIngreso)) > 0 Then
            actualizaStockTransferencia idValescabIngreso, 1, strSucursalDes, StrMsgError, strTipoValeIngreso, False
            If StrMsgError <> "" Then GoTo Err
            
            actualizaStock_LoteTransferencia idValescabIngreso, 1, strSucursalDes, StrMsgError, strTipoValeIngreso, False
            If StrMsgError <> "" Then GoTo Err
            
            csql = "delete from valescab " & _
                     "WHERE idValesCab = '" & idValescabIngreso & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoValeIngreso & "' "
            Cn.Execute csql
            
            csql = "delete from valesdet " & _
                     "WHERE idValesCab = '" & idValescabIngreso & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoValeIngreso & "' "
            Cn.Execute csql
            
            csql = "delete from valesdetLotes " & _
                     "WHERE idValesCab = '" & idValescabIngreso & "' AND idEmpresa = '" & glsEmpresa & "' AND tipoVale = '" & strTipoValeIngreso & "' "
            Cn.Execute csql
            
        End If
    End If
    csql = "delete from movcajasdet " & _
             "WHERE idMovCaja = '" & strMovCaja & "' " & _
             "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' " & _
             "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' AND idSerie = '" & Trim(txt_Serie.Text) & "' "
    Cn.Execute csql

    '---- Eliminamos del pagosDocVentas
    csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
            "AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
            "AND idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    If strTipoDoc = "01" Then
        '---- Buscamos la factura q esta amarrada
        If gDocReferencia.Count > 0 Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                    csql = "update docventas set estDocVentas = 'GEN' " & _
                             "where idEmpresa = '" & glsEmpresa & "' and iddocumento = '86' " & _
                             "and idserie = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' " & _
                             "and iddocventas = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' "
                    Cn.Execute csql
                    
                    Exit Do
                End If
                gDocReferencia.Dataset.Next
            Loop
        End If
    End If
    
    '---- Eliminamos las referencias
    csql = "DELETE FROM docreferencia " & _
             "WHERE idEmpresa = '" & glsEmpresa & "' " & _
             "AND idSucursal = '" & glsSucursal & "' " & _
             "AND tipoDocOrigen = '" & strTipoDoc & "' " & _
             "AND numDocOrigen = '" & Trim(txt_NumDoc.Text) & "' " & _
             "AND serieDocOrigen = '" & Trim(txt_Serie.Text) & "' "
    Cn.Execute csql
    
    csql = "DELETE FROM docreferencia " & _
             "WHERE idEmpresa = '" & glsEmpresa & "' " & _
             "AND idSucursal = '" & glsSucursal & "' " & _
             "AND tipoDocReferencia = '" & strTipoDoc & "' " & _
             "AND numDocReferencia = '" & Trim(txt_NumDoc.Text) & "' " & _
             "AND serieDocReferencia = '" & Trim(txt_Serie.Text) & "' "
    Cn.Execute csql

    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "LIQUIDACIONES", True) & "") = "S" Then
        If strTipoDoc = "86" Then
            CadMysqlLiq = "Select * from docventasdetliquidacion " & _
                          "where iddocventas = '" & Trim("" & txt_NumDoc.Text) & "' and iddocumento = '" & strTipoDoc & "' and idserie = '" & Trim("" & txt_Serie.Text) & "' " & _
                          "and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
            
            If rsliquidacion.State = 1 Then rsliquidacion.Close
            rsliquidacion.Open CadMysqlLiq, strcn, adOpenStatic, adLockOptimistic
            If Not rsliquidacion.EOF Then
                rsliquidacion.MoveFirst
                Do While Not rsliquidacion.EOF
                
                    CadMysqlLiqAct = "Update docventasliqcab set CantidadImp = (CantidadImp - " & rsliquidacion.Fields("Unidad") & ") ,PesoImp = (PesoImp - " & rsliquidacion.Fields("Kg") & ") " & _
                                     "where IdEmpresa = '" & glsEmpresa & "' and  IdSucursal = '" & glsSucursal & "' and  IdLiquidacion = '" & Trim("" & rsliquidacion.Fields("IdLiquidacion")) & "' "
                    Cn.Execute (CadMysqlLiqAct)
                    
                    rsliquidacion.MoveNext
                Loop
            End If
            
            csql = "Delete from docventasdetliquidacion where iddocventas = '" & txt_NumDoc.Text & "' and iddocumento = '" & strTipoDoc & "' " & _
                   "and idserie = '" & txt_Serie.Text & "' and idempresa = '" & glsEmpresa & "' and idsucursal = '" & glsSucursal & "' "
            Cn.Execute (csql)
        End If
    End If
    Cn.CommitTrans
    
    AsientoContableVentas StrMsgError, "E"
    If StrMsgError <> "" Then GoTo Err
            
    '---- Nuevo
    Toolbar1_ButtonClick Toolbar1.Buttons(1)
    MsgBox "Registro eliminado satisfactoriamente", vbInformation, App.Title
    
    If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
    If rstcab.State = 1 Then rstcab.Close: Set rstcab = Nothing
    
    Exit Sub
    
Err:
    If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
    If indTrans Then Cn.RollbackTrans
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub imprimePedidoCotizacion(ByRef StrMsgError As String)
On Error GoTo Err
Dim rsReporte       As New ADODB.Recordset
Dim vistaPrevia     As New frmReportePreview
Dim aplicacion      As New CRAXDRT.Application
Dim reporte         As CRAXDRT.Report
Dim strTitulo As String
Dim strcontacto                         As String
Dim strReporte                          As String
Dim strSP                               As String
Dim COT                                 As String
Dim CFormatoPedido                      As String

    Screen.MousePointer = 11
    gStrRutaRpts = App.Path + "\Reportes\"
    COT = traerCampo("parametros", "VALPARAMETRO", "GLSPARAMETRO", "IMP_COT_ALSISAC", True)
    If strTipoDoc = "40" Then 'Pedido
        CFormatoPedido = traerCampo("Parametros", "ValParametro", "GlsParametro", "IMP_FORMATO_PEDIDO", True)
        Select Case CFormatoPedido
            Case "1" ' Por defecto
                strTitulo = "Pedido"
                strReporte = "rptImpPedido.rpt"
                strSP = "spu_ImpPedido"
                
            Case "2"
                Screen.MousePointer = 1
                FraFormatoImp.Visible = True
                fraGeneral.Enabled = False
                Activa_Desc_Grid True
                Exit Sub
        End Select
    ElseIf strTipoDoc = "92" And COT = "1" Then
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacion_PROVEEPERU_Versiones.rpt"
        strSP = "spu_ImpCotizacion_Versiones"
    ElseIf strTipoDoc = "92" And COT = "0" Then
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacionJV.rpt"
        strSP = "spu_ImpCotizacion_Alsisac"
    ElseIf strTipoDoc = "92" And COT = "2" Then
        Screen.MousePointer = 1
        FraFormatoImp.Visible = True
        fraGeneral.Enabled = False
        Activa_Desc_Grid True
        Exit Sub
        
    ElseIf strTipoDoc = "92" And COT = "11" Then
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacionCarTol.rpt"
        strSP = "spu_ImpCotizacion"
        
    ElseIf strTipoDoc = "92" And COT = "10" Then
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacionAtsacom.rpt"
        strSP = "spu_ImpCotizacion_Atsacom"
    ElseIf strTipoDoc = "92" And COT = "4" Then 'Solvet
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacionSolvet.rpt"
        strSP = "spu_ImpCotizacion_Solvet"
    ElseIf strTipoDoc = "92" And COT = "5" Then 'MM
        strTitulo = "Cotizacion"
        strReporte = "rptImpCotizacionMM.rpt"
        strSP = "spu_ImpCotizacion_MM"
    ElseIf strTipoDoc = "92" And COT = "6" Then '-- CADILLO 01/10/13
        strTitulo = "Cotizacion"
        strcontacto = txt_contacto.Text
        strReporte = "rptImpCotizacionCadillo.rpt"
        strSP = "spu_ImpCotizacionCadillo"
    ElseIf strTipoDoc = "92" And COT = "7" Then '-- CADILLO COMUNICACION GRAFICA 07/10/13
        strTitulo = "Cotizacion"
        strcontacto = txt_contacto.Text
        strReporte = "rptImpCotizacionCGrafica.rpt"
        strSP = "spu_ImpCotizacionCadillo"
    ElseIf strTipoDoc = "92" And COT = "8" Then '-- MEGA
        strTitulo = "Cotizacion"
        strcontacto = txt_contacto.Text
        strReporte = "rptImpCotizacionMega.rpt"
        strSP = "spu_ImpCotizacion"
    ElseIf strTipoDoc = "92" Then 'Cotizacion
        strTitulo = "Cotizacion"
        strcontacto = txt_contacto.Text
        strReporte = "rptImpCotizacion.rpt"
        strSP = "spu_ImpCotizacion"
    ElseIf strTipoDoc = "56" Then
        strTitulo = "Nota de Venta"
        strReporte = "rptImpNotaVenta.rpt"
        strSP = "spu_ImpPedido"
    End If
    If strReporte = "" Then Screen.MousePointer = 0: Exit Sub
    Set reporte = aplicacion.OpenReport(gStrRutaRpts & strReporte)
    Set rsReporte = DataProcedimiento(strSP, StrMsgError, glsEmpresa, glsSucursal, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, Val(strNumitmlogDocVentas))
    If StrMsgError <> "" Then GoTo Err
    If Not rsReporte.EOF And Not rsReporte.BOF Then
         reporte.database.SetDataSource rsReporte, 3
         vistaPrevia.CRViewer91.ReportSource = reporte
         vistaPrevia.Caption = strTitulo
         vistaPrevia.CRViewer91.ViewReport
         vistaPrevia.CRViewer91.DisplayGroupTree = False
         Screen.MousePointer = 0
         vistaPrevia.WindowState = 2
         vistaPrevia.Show
    Else
        Screen.MousePointer = 0
        MsgBox "No existen Registros  Seleccionados", vbInformation, App.Title
    End If
    Screen.MousePointer = 0
    Set rsReporte = Nothing
    Set vistaPrevia = Nothing
    Set aplicacion = Nothing
    Set reporte = Nothing
    
    Exit Sub

Err:
    Screen.MousePointer = 0
    If StrMsgError = "" Then StrMsgError = Err.Description
    If rsReporte.State = 1 Then rsReporte.Close
    Set rsReporte = Nothing
    Set vistaPrevia = Nothing
    Set aplicacion = Nothing
    Set reporte = Nothing
    Exit Sub
    Resume
End Sub

Private Sub traerListaPrecios(ByRef StrMsgError As String)
On Error GoTo Err
Dim strCodLista As String
    
'    '******** Luis 24/03/2019 **********
'    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'        txtCod_Lista.Text = ""
'        txtGls_Lista.Text = ""
'    End If
'    '***********************************
    
    '---- Trae la lista de precio del vendedor
    If txtGls_Cliente.Text <> "" Then
        strCodLista = traerCampo("clientes", "IdLista", "idCliente", txtCod_Cliente.Text, True)
    End If
    
'    '******** Luis 24/03/2019 **********
'    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "INACTIVA_MODIFICACION_LISTA_PRECIO", True) & "") = "S" Then
'        '---- Trae la lista de precio del vendedor
'        If txtGls_Vendedor.Text <> "" And strCodLista = "" Then
'            strCodLista = traerCampo("vendedores", "IdLista", "idVendedor", txtCod_Vendedor.Text, True)
'        End If
'    End If
'    '***********************************
    
    If strCodLista <> "" Then txtCod_Lista.Text = strCodLista
    
Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub Graba_Pago_Imprime()
On Error GoTo Err
Dim Sql_pagdocventas As String
Dim sql_movcajasdet As String
Dim ntotalconver As Double
Dim strCodMovDet As String, StrMsgError As String, strCodMovCaja As String

    strCodMovCaja = Trim(traerCampo("docventas", "idMovCaja", "idDocumento", strTipoDoc, True, " idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "' AND idSucursal = '" & glsSucursal & "'"))
    If strCodMovCaja = "" Then
        strCodMovCaja = CajaAperturadaUsuario(0, StrMsgError)
        If StrMsgError <> "" Then GoTo Err
    End If
    
    intBoton = 3
    
    '---- GRABANDO PAGOS
    If txtCod_Moneda.Text = "PEN" Then
        ntotalconver = txt_TotalNeto.Text
    Else
        ntotalconver = Format(Val(Format(txt_TotalNeto.Text, "0.00")) * Val(Format(txt_TipoCambio.Text, "0.000")), "0.00")
    End If
    Sql_pagdocventas = "INSERT INTO pagosdocventas(item,idFormadePago,idMoneda,MontoOri,MontoSoles, " & _
                       " idTipoFormaPago,fecVctos,idDocumento,idDocVentas,idSerie,idEmpresa,idSucursal) " & _
                       " VALUES(1,'08020001','" & txtCod_Moneda.Text & "', " & Val(Format(txt_TotalNeto.Text, "0.00")) & " ," & ntotalconver & ",'06090001', " & _
                       " '','" & strTipoDoc & "','" & txt_NumDoc.Text & "','" & txt_Serie.Text & "','" & glsEmpresa & "','" & glsSucursal & "') "
    Cn.Execute Sql_pagdocventas
    
    strCodMovDet = GeneraCorrelativoAnoMes("movcajasdet", "idMovCajaDet")
    sql_movcajasdet = " INSERT INTO movcajasdet (idMovCajaDet,idMovCaja,idTipoMovCaja,idMoneda,ValMonto, " & _
                     " FecRegistro,idEmpresa,idSucursal,ValTipoCambio,idFormadePago,idDocumento,idDocVentas,idSerie) " & _
                     " VALUES('" & strCodMovDet & "','" & strCodMovCaja & " ','99990002','" & txtCod_Moneda.Text & "'," & ntotalconver & ", " & _
                     " sysdate(),'" & glsEmpresa & "','" & glsSucursal & "'," & Val(Format(txt_TipoCambio.Text, "0.000")) & ",'08020001','" & strTipoDoc & "','" & txt_NumDoc.Text & "','" & txt_Serie.Text & "') "
    Cn.Execute sql_movcajasdet
    
    If strTipoDoc <> "40" And strTipoDoc <> "92" Then
        imprimeDocVentas strTipoDoc, txt_NumDoc.Text, txt_Serie.Text, StrMsgError
        If StrMsgError <> "" Then GoTo Err
    
        csql = "UPDATE DOCVENTAS SET estDocventas = 'IMP', GlsFormasPago = 'CONTADO', GlsFecVectos = '" & Format(Now, "yyyy-mm-dd") & "', idMovCaja = '" & strCodMovCaja & "' " & _
               "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' AND  idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "'"
        Cn.Execute csql
    
        strEstDocVentas = "IMP"
        
        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
    Else
        imprimePedidoCotizacion StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
    Exit Sub
    
Err:
    MsgBox Err.Description, vbInformation, App.Title
    Exit Sub
    Resume
End Sub

Private Sub TxtCodCentroCostoAnt_Change()
On Error GoTo Err
Dim StrMsgError                             As String

    If Trim("" & TxtCodCentroCostoAnt.Text) = "" Then Exit Sub
    
    If Trim("" & TxtCodCentroCostoAnt.Text) <> "" Then
        
        TxtGlsCentroCostoAnt.Text = "" & traerCampo("CentrosCosto", "GlsCentroCosto", "IdCentroCosto", TxtCodCentroCostoAnt.Text, True)

    Else
    
        TxtGlsCentroCostoAnt.Text = ""
    
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub TxtCodCentroCostoNuevo_Change()
On Error GoTo Err
Dim StrMsgError                             As String

    If Trim("" & TxtCodCentroCostoNuevo.Text) = "" Then Exit Sub
    If Trim("" & TxtCodCentroCostoNuevo.Text) <> "" Then
        
        TxtGlsCentroCostoNuevo.Text = "" & traerCampo("CentrosCosto", "GlsCentroCosto", "IdCentroCosto", TxtCodCentroCostoNuevo.Text, True)

    Else
    
        TxtGlsCentroCostoNuevo.Text = ""
    
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub TxtCodDir_Recojo_Change()

    If Trim("" & TxtCodDir_Recojo.Text) = "" Then Exit Sub
    TxtGlsDir_Recojo.Text = traerCampo("dirrecojos", "GlsDirRecojo", "iddirrecojo", TxtCodDir_Recojo.Text, True)
    
End Sub

Private Sub TxtCodDir_Recojo_KeyPress(KeyAscii As Integer)
    If KeyAscii <> 13 Then
        mostrarAyudaKeyascii KeyAscii, "DIRRECOJO", TxtCodDir_Recojo, TxtGlsDir_Recojo
        KeyAscii = 0
        If TxtCodDir_Recojo.Text <> "" Then SendKeys "{tab}"
    End If
End Sub

Private Sub TxtCodSucursalDestino_Change()
On Error GoTo Err
Dim StrMsgError                             As String

    If Trim("" & TxtCodSucursalDestino.Text) = "" Then Exit Sub
    If Trim("" & TxtCodSucursalDestino.Text) <> "" Then
        
        TxtGlsSucursalDestino.Text = "" & traerCampo("Personas", "GlsPersona", "IdPersona", TxtCodSucursalDestino.Text, False)

    Else
    
        TxtGlsSucursalDestino.Text = ""
    
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub TxtDescuentoGlobal_Change()
On Error GoTo Err
Dim StrMsgError                             As String
    
    If Not indCargando Then
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub txtGls_Cliente_KeyPress(KeyAscii As Integer)
    If indCodApimas = False Then
        If KeyAscii <> 13 Then
            mostrarAyudaClientesKeyascii KeyAscii, txtCod_Cliente, txtGls_Cliente, txt_RUC, txt_Direccion
            KeyAscii = 0
            If txtGls_Cliente.Text <> "" Then SendKeys "{tab}"
        End If
    End If
End Sub

Private Sub PASE_CTASCOBRAR()
Dim strAbreDcto As String
Dim strNumComprobante As String
Dim strCodCtaDcto As String
Dim csql As String

    strAbreDcto = traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False)
    strNumComprobante = strAbreDcto & txt_Serie.Text & "/" & txt_NumDoc.Text
     
    strCodCtaDcto = GeneraCorrelativoAnoMesNuevo("cta_dcto", "idCta_Dcto", Year(getFechaSistema) & Format(Month(getFechaSistema), "00"), False)
    
    csql = "INSERT INTO cta_dcto " & _
              "(idEmpresa,idSucursal,idSucursalCobro,indViaIngreso,idCta_Dcto,Nro_Comp,Fec_Comp,Fec_Vcto,idCliente,idClienteOri,idMoneda,idMonedaOri,ValTipoCambio,ValTipoCambioOri,ValTotal,ValTotalOri,ValSaldo,indDeb_Hab) " & _
              "VALUES ('" & glsEmpresa & "','" & glsSucursal & "','" & glsSucursal & "',1,'" & strCodCtaDcto & "','" & strNumComprobante & "','" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "','" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "','" & _
              txtCod_Cliente.Text & "','" & txtCod_Cliente.Text & "','" & txtCod_Moneda.Text & "','" & txtCod_Moneda.Text & "'," & txt_TipoCambio.Value & "," & txt_TipoCambio.Value & "," & ("" & Val(Format(txt_TotalNeto.Text, "0.00"))) & "," & ("" & Val(Format(txt_TotalNeto.Text, "0.00"))) & "," & ("" & Val(Format(txt_TotalNeto.Text, "0.00"))) & ",'D')"
    Cn.Execute (csql)
    
End Sub

Private Sub validarDocReferencia(StrMsgError As String)
On Error GoTo Err
Dim RsD As New ADODB.Recordset
Dim swFactura As Boolean
Dim item As Integer

    swFactura = False

    If gDocReferencia.Count > 0 Then
        gDocReferencia.Dataset.First
        Do While Not gDocReferencia.Dataset.EOF
            If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                If swFactura = False Then
                    swFactura = True
                    sw_graba_factura = True
                Else
                    StrMsgError = "En la guia solo se puede poner una Factura"
                    GoTo Err
                End If
            End If
            gDocReferencia.Dataset.Next
        Loop
    End If
    
    If swFactura = False Then
        '---- FORMATO GRILLA DE DOC REFERENCIA
        RsD.Fields.Append "Item", adInteger, , adFldRowID
        RsD.Fields.Append "IdDocumento", adChar, 2, adFldIsNullable
        RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
        RsD.Fields.Append "IdSerie", adChar, 4, adFldIsNullable
        RsD.Fields.Append "IdNumDOc", adChar, 8, adFldIsNullable
        RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
        
        RsD.Open
        
        item = 0
        If gDocReferencia.Count > 0 Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If Trim(gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value & "") <> "" Then
                    item = item + 1
                    RsD.AddNew
                    RsD.Fields("Item") = item
                    RsD.Fields("IdDocumento") = gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value
                    RsD.Fields("GlsDocumento") = gDocReferencia.Columns.ColumnByFieldName("GlsDocumento").Value
                    RsD.Fields("IdSerie") = gDocReferencia.Columns.ColumnByFieldName("IdSerie").Value
                    RsD.Fields("IdNumDOc") = gDocReferencia.Columns.ColumnByFieldName("IdNumDOc").Value
                    RsD.Fields("IndImportado") = gDocReferencia.Columns.ColumnByFieldName("IndImportado").Value
                    
                End If
                
                gDocReferencia.Dataset.Next
            Loop
        End If
        
        item = item + 1
        RsD.AddNew
        RsD.Fields("Item") = item
        RsD.Fields("IdDocumento") = "01"
        RsD.Fields("GlsDocumento") = "Factura"
        RsD.Fields("IdSerie") = txt_Serie.Text
        RsD.Fields("IdNumDOc") = objDocVentas.generaCorrelativoDocVentas("01", txt_Serie.Text)  ''' txt_NumDoc.Text
        RsD.Fields("IndImportado") = "1"
        
        Set gDocReferencia.DataSource = Nothing
        mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        sw_graba_factura = True
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub validarNumeroFactura(serie As String, ByRef num As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rs As New ADODB.Recordset
Dim numDocumento As String
Dim numFactura As String
Dim serieFactura As String
    
    If gDocReferencia.Count > 0 Then
        gDocReferencia.Dataset.First
        Do While Not gDocReferencia.Dataset.EOF
            If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                numFactura = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                serieFactura = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                Exit Do
            End If
            gDocReferencia.Dataset.Next
        Loop
    End If
    
    If intBoton = 1 Then
        numDocumento = traerCampo("docventas", "iddocventas", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and iddocumento = '01' ")
        If numDocumento <> "" Then
            StrMsgError = "El numero de factura referencia ingresado ya existe"
            GoTo Err
        End If
    Else
        csql = "select numDocOrigen, serieDocOrigen from docReferencia " & _
                 "where tipoDocReferencia = '86' and tipoDocOrigen = '01' " & _
                 "and serieDocReferencia = '" & txt_Serie.Text & "' and numDocReferencia = '" & txt_NumDoc.Text & "' and idEmpresa = '" & glsEmpresa & "' "
        If rs.State = 1 Then rs.Close
        rs.Open csql, Cn, adOpenStatic, adLockReadOnly
        
        If rs.RecordCount <> 0 Then
            If rs.Fields("serieDocOrigen") = serieFactura And rs.Fields("numDocOrigen") = numFactura Then
                
            Else
                numDocumento = traerCampo("docventas", "iddocventas", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and iddocumento = '01' ")
                If numDocumento <> "" Then
                    StrMsgError = "El numero de factura referencia ingresado ya existe"
                    GoTo Err
                End If
            End If
        Else
            numDocumento = traerCampo("docventas", "iddocventas", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and iddocumento = '01' ")
            If numDocumento <> "" Then
                StrMsgError = "El numero de factura referencia ingresado ya existe"
                GoTo Err
            End If
        End If
    End If
    
    serie = serieFactura
    num = numFactura
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub EliminarFacturasRef(StrMsgError As String)
On Error GoTo Err
Dim rs As New ADODB.Recordset
    
    csql = "select numDocOrigen, serieDocOrigen from docReferencia " & _
             "where tipoDocReferencia = '86' and tipoDocOrigen = '01' " & _
             "and serieDocReferencia = '" & txt_Serie.Text & "' and numDocReferencia = '" & txt_NumDoc.Text & "' and idEmpresa = '" & glsEmpresa & "' "
    If rs.State = 1 Then rs.Close
    rs.Open csql, Cn, adOpenStatic, adLockReadOnly
    
    If rs.RecordCount <> 0 Then
        rs.MoveFirst
        Do While Not rs.EOF
            csql = "delete from docventas where iddocumento = '01' " & _
                     "and idserie = '" & rs.Fields("serieDocOrigen") & "' and iddocventas = '" & rs.Fields("numDocOrigen") & "' and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            
            csql = "delete from docventasdet where iddocumento = '01' " & _
                     "and idserie = '" & rs.Fields("serieDocOrigen") & "' and iddocventas = '" & rs.Fields("numDocOrigen") & "' and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            
            rs.MoveNext
        Loop
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub validarFacturaRef(serie As String, ByRef num As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rsCtas As New ADODB.Recordset
Dim strEstadoFac As String
Dim strFormaPago As String
    
    strEstadoFac = traerCampo("docventas", "estDocVentas", "idDocVentas", num, True, "idserie = '" & serie & "' and iddocumento = '01' ")
    If strEstadoFac = "" Then
        Exit Sub
    End If
    
    strFormaPago = traerCampo("docventas", "idFormaPago", "idDocVentas", num, True, "idserie = '" & serie & "' and iddocumento = '01' ")
    If strFormaPago = "07010001" Or strFormaPago = "" Then
        Exit Sub
    End If
    
    csql = "select ValTotal, ValSaldo from cta_dcto " & _
             "where Nro_Comp = 'Fac" & serie & "/" & num & "' and idEmpresa = '" & glsEmpresa & "' "
    If rsCtas.State = 1 Then rsCtas.Close
    rsCtas.Open csql, Cn, adOpenStatic, adLockReadOnly
    
    If rsCtas.RecordCount <> 0 Then
        rsCtas.MoveFirst
        If rsCtas.Fields("ValTotal") = rsCtas.Fields("ValSaldo") Then
            Exit Sub
        Else
            StrMsgError = "No se puede modificar el documento porque la factura referencia tiene pagos"
            GoTo Err
        End If
    Else
        Exit Sub
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub validarCierredeMes(anno As String, ByRef mes As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim estCaja As String
    
    estCaja = traerCampo("cierresmes", "estCierre", "idAno", anno, True, " idMes = '" & mes & "' And IdSistema = '21001'")
    If estCaja = "C" Then
        StrMsgError = "El mes se encuentra cerrado"
        GoTo Err
    End If
    
    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    
End Sub

Private Sub Jala_Formula_Documento(PIdDocumento As String, PIdSerie As String, PIdDocVentas As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim RsTabla                         As New ADODB.Recordset
    
    If RsDetProductos.State <> 1 Then
        Inicia_RecordSet RsDetProductos, 0, StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
    If "N" = "S" Then 'If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "GENERA_VALE_FORMULA", True) & "") = "S" Then
        
        csql = "Select * " & _
        "From DocVentasDetFormula " & _
        "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & PIdDocumento & "' " & _
        "And IdDocVentas = '" & PIdDocVentas & "' And IdSerie = '" & PIdSerie & "'"
        
        With RsTabla
            .Open csql, Cn, adOpenStatic, adLockReadOnly
            Do While Not .EOF
                RsDetProductos.AddNew
                RsDetProductos.Fields("Item") = Val(.Fields("Item"))
                RsDetProductos.Fields("IdProducto") = .Fields("IdProducto")
                RsDetProductos.Fields("GlsProducto") = .Fields("GlsProducto")
                RsDetProductos.Fields("CantidadStock") = Val(.Fields("CantidadStock"))
                RsDetProductos.Fields("Cantidad") = Val(.Fields("Cantidad"))
                RsDetProductos.Fields("ItemDocVentas") = Val(.Fields("ItemDocVentas"))
                RsDetProductos.Fields("IdComboCab") = .Fields("IdComboCab")
                RsDetProductos.Fields("VVUnit") = Val("" & .Fields("VVUnit"))
                RsDetProductos.Fields("PorcDcto") = Val("" & .Fields("PorcDcto"))
                RsDetProductos.Fields("TotalVVenta") = Val("" & .Fields("TotalVVenta"))
                .MoveNext
            Loop
        End With
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    
End Sub

Private Sub Inicia_RecordSet(PRs As ADODB.Recordset, PRsIndex As Integer, StrMsgError As String)
On Error GoTo Err
    
    With PRs
        Select Case PRsIndex
            Case 0
                If .State = 1 Then .Close
                .Fields.Append "Item", adDouble, 14, adFldIsNullable
                .Fields.Append "IdProducto", adVarChar, 10, adFldIsNullable
                .Fields.Append "GlsProducto", adVarChar, 240, adFldIsNullable
                .Fields.Append "CantidadStock", adDouble, 14, adFldIsNullable
                .Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
                .Fields.Append "ItemDocventas", adDouble, 14, adFldIsNullable
                .Fields.Append "IdComboCab", adVarChar, 10, adFldIsNullable
                .Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
                .Fields.Append "PorcDcto", adInteger, , adFldIsNullable
                .Fields.Append "TotalVVenta", adDouble, 14, adFldIsNullable
                .Open
        End Select
    End With
        
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub gLista_OnEditButtonClick(ByVal Column As DXDBGRIDLibCtl.IdxGridColumn, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
Dim strSerie        As String
Dim strNum          As String
Dim StrMsgError     As String
Dim strcadena       As String
On Error GoTo Err

    If Column.Index = gLista.Columns.ColumnByName("btnRC").Index Then
    
        strNum = gLista.Columns.ColumnByName("idDocVentas").Value
        strSerie = gLista.Columns.ColumnByName("idSerie").Value
        
'        Frm_Lista_Requerimiento_Compra.MostrarFrom strTipoDoc, strSerie, strNum
        If CbxGanadas.ListIndex = 0 Or CbxGanadas.ListIndex = 2 Then
            If MsgBox("Seguro de marcar como GANADA la cotización", vbQuestion + vbYesNo, App.Title) = vbYes Then
                strcadena = "UPDATE docventas SET ind_CTGanada = 1 WHERE idDocumento = '92' AND idSerie = '" & strSerie & "' AND idDocVentas = '" & strNum & "'"
                Cn.Execute strcadena
            End If
        Else
            If MsgBox("Seguro de marcar como NO GANADA la cotización", vbQuestion + vbYesNo, App.Title) = vbYes Then
                strcadena = "UPDATE docventas SET ind_CTGanada = 0 WHERE idDocumento = '92' AND idSerie = '" & strSerie & "' AND idDocVentas = '" & strNum & "'"
                Cn.Execute strcadena
            End If
        End If
        
        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
    ElseIf Column.Index = gLista.Columns.ColumnByName("CentroCosto").Index Then
        
        FraModificaCC.Visible = True
        gLista.Enabled = False
        
        TxtCodCentroCostoAnt.Text = traerCampo("DocVentas", "IdCentroCosto", "IdDocumento", strTipoDoc, True, "IdSerie = '" & Trim("" & gLista.Columns.ColumnByFieldName("IdSerie").Value) & "' And IdDocVentas = '" & Trim("" & gLista.Columns.ColumnByFieldName("IdDocVentas").Value) & "'")
        TxtCodCentroCostoNuevo.Text = ""
    
    ElseIf Column.Index = gLista.Columns.ColumnByName("ObsSUNAT").Index Then
        
        FrmObsSunat.MostrarForm StrMsgError, strTipoDoc, gLista.Columns.ColumnByFieldName("IdSerie").Value, gLista.Columns.ColumnByFieldName("IdDocVentas").Value
        If StrMsgError <> "" Then GoTo Err
        
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub

Private Sub AprobacionAutomatica(StrMsgError As String)
On Error GoTo Err
Dim rsa             As New ADODB.Recordset
Dim Cadmysql        As String
Dim CodDocventas    As String
Dim rst             As New ADODB.Recordset
Dim VVUnit                                  As Double
Dim IGVUnit                                 As Double
Dim PVUnit                                  As Double
Dim NTotBrutoVale                           As Double
Dim NTotIGVVale                             As Double
Dim NTotVentaVale                           As Double
Dim NTotBrutoReq                            As Double
Dim NTotIGVReq                              As Double
Dim NTotVentaReq                            As Double
Dim strGlsDocREF                            As String
Dim CSqlC                                   As String
Dim RsCon                                   As New ADODB.Recordset
Dim NItem1                                  As Long
Dim NItem2                                  As Long
Dim CIdConceptoI                            As String
Dim CIdConceptoS                            As String
Dim CIdValesCabI                            As String
Dim CIdValesCabS                            As String
Dim CIdAlmacenDestino                       As String
Dim CIdCentroCosto                          As String
Dim CIdSucursalDestino                      As String

    CSqlC = "Select P.IdProducto,P.GlsProducto,P.IdUMCompra,D.Factor,P.AfectoIgv,D.IdMoneda,P.IdMarca,M.GlsMarca,U.GlsUM,P.IdTipoProducto," & _
            "P.IdFabricante,D.VVUnitLista,D.PVUnitLista,P.CodigoRapido,P.IdTallaPeso,A.VVUnit * If(A.PorcDcto > 0,A.PorcDcto / 100,1) VVUnitP," & _
            "(A.VVUnit * If(A.PorcDcto > 0,A.PorcDcto / 100,1)) * " & dblIgvNEw & " IgvUnitP," & _
            "(A.VVUnit * If(A.PorcDcto > 0,A.PorcDcto / 100,1)) + ((A.VVUnit * If(A.PorcDcto > 0,A.PorcDcto / 100,1)) * " & dblIgvNEw & ") PVUnitP," & _
            "If((D.Cantidad * IfNull(A.Cantidad,1)) <= IfNull(S.CantidadStock,0),(D.Cantidad * IfNull(A.Cantidad,1)),IfNull(S.CantidadStock,0)) As Salida," & _
            "(D.Cantidad * IfNull(A.Cantidad,1)) - IfNull(S.CantidadStock,0) As Requerimiento " & _
            "From DocVentasDet D " & _
            "Left Join DocVentasDetFormula A " & _
                "On D.IdEmpresa = A.IdEmpresa And D.IdSucursal = A.IdSucursal And D.IdDocumento = A.IdDocumento And D.IdSerie = A.IdSerie " & _
                "And D.IdDocVentas = A.IdDocVentas And D.Item = A.ItemDocVentas " & _
            "Inner Join Productos P " & _
                "On D.IdEmpresa = P.IdEmpresa And If(A.IdProducto Is Null,D.IdProducto,A.IdProducto) = P.IdProducto " & _
            "Inner Join UnidadMedida U " & _
                "On P.IdUMCompra = U.IdUM " & _
            "Left Join (" & _
                "Select A.IdEmpresa,A.IdProducto,A.CantidadStock " & _
                "From ProductosAlmacen A " & _
                "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdAlmacen = '" & txtCod_Almacen.Text & "'" & _
            ") S "
                CSqlC = CSqlC & "On P.IdEmpresa = S.IdEmpresa And P.IdProducto = S.IdProducto " & _
            "Left Join Marcas M " & _
                "On P.IdEmpresa = M.IdEmpresa And P.IdMarca = M.IdMarca " & _
            "Where D.IdEmpresa = '" & glsEmpresa & "' And D.IdSucursal = '" & glsSucursal & "' And D.IdDocumento = '" & strTipoDoc & "' " & _
            "And D.IdSerie = '" & txt_Serie.Text & "' And D.IdDocVentas = '" & txt_NumDoc.Text & "' And P.IdTipoProducto <> '06002' " & _
            "Order By Salida Desc"
    
    With RsCon
        .Open CSqlC, Cn, adOpenStatic, adLockReadOnly
        If Not .EOF Then
            NTotBrutoReq = 0#
            NTotIGVReq = 0#
            NTotVentaReq = 0#
            NTotBrutoVale = 0#
            NTotIGVVale = 0#
            NTotVentaVale = 0#
            strGlsDocREF = traerCampo("Documentos", "AbreDocumento", "idDocumento", strTipoDoc, False) & Space(1) & Trim(txt_Serie.Text) & "-" & Trim(txt_NumDoc.Text)
            CIdCentroCosto = txtCod_CentroCosto.Text
            
            If Len(Trim(txtCod_CentroCosto.Text)) = 0 Then
                CIdCentroCosto = GeneraCorrelativoAnoMes("CentrosCosto", "IdCentroCosto", True)
                CSqlC = "Insert Into CentrosCosto(IdEmpresa,IdCentroCosto,GlsCentroCosto,IndEstado,AbrevCcosto,IdCodUNegocio,IndGenerado)Values(" & _
                        "'" & glsEmpresa & "','" & CIdCentroCosto & "','" & txtGls_Cliente.Text & "','A','','','A')"
                Cn.Execute (CSqlC)
                
                CSqlC = "Update DocVentas D " & _
                        "Set D.IdCentroCosto = '" & CIdCentroCosto & "',GlsCentroCosto = '" & txtGls_Cliente.Text & "' " & _
                        "Where D.IdDocumento = '" & strTipoDoc & "' And D.IdSerie = '" & Trim("" & txt_Serie.Text) & "' " & _
                        "And D.IdDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' And D.IdEmpresa = '" & glsEmpresa & "' " & _
                        "And D.IdSucursal = '" & glsSucursal & "'"
                Cn.Execute (CSqlC)
                txtCod_CentroCosto.Text = CIdCentroCosto
            End If
            
            Do While Not .EOF
                VVUnit = 0#
                IGVUnit = 0#
                PVUnit = 0#
                CSqlC = "Select A.IdMoneda,B.VVUnit,B.IGVUnit,B.PVUnit " & _
                        "From DocVentas A " & _
                        "Inner Join DocVentasDet B " & _
                            "On A.IdDocVentas = B.IdDocVentas And A.IdSerie = B.Idserie And A.IdDocumento = B.IdDocumento " & _
                            "And A.IdEmpresa = B.IdEmpresa And A.IdSucursal = B.IdSucursal " & _
                        "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdDocumento = '94' " & _
                        "And B.IdProducto = '" & .Fields("IdProducto") & "' " & _
                        "Order By A.FecEmision Desc Limit 1"
            
                rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                If Not rst.EOF Then
                    If txtCod_Moneda.Text = "PEN" Then
                        If Trim("" & rst.Fields("IdMoneda")) = "PEN" Then
                            VVUnit = Val(Format(rst.Fields("VVUnit"), "0.00"))
                            IGVUnit = Val(Format(rst.Fields("IGVUnit"), "0.00"))
                            PVUnit = Val(Format(rst.Fields("PVUnit"), "0.00"))
                        Else
                            VVUnit = Val(Format((Val(Format(rst.Fields("VVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                            IGVUnit = Val(Format((Val(Format(rst.Fields("IGVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                            PVUnit = Val(Format((Val(Format(rst.Fields("PVUnit"), "0.00")) * txt_TipoCambio.Text), "0.00"))
                        End If
                    Else
                        If Trim("" & rst.Fields("idMoneda")) = "USD" Then
                            VVUnit = Val(Format(rst.Fields("VVUnit"), "0.00"))
                            IGVUnit = Val(Format(rst.Fields("IGVUnit"), "0.00"))
                            PVUnit = Val(Format(rst.Fields("PVUnit"), "0.00"))
                        Else
                            VVUnit = Val(Format((Val(Format(rst.Fields("VVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                            IGVUnit = Val(Format((Val(Format(rst.Fields("IGVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                            PVUnit = Val(Format((Val(Format(rst.Fields("PVUnit"), "0.00")) / txt_TipoCambio.Text), "0.00"))
                        End If
                    End If
                Else
                    VVUnit = 0#
                    IGVUnit = 0#
                    PVUnit = 0#
                End If
                rst.Close: Set rst = Nothing
                    
                If Val(.Fields("Salida")) > 0 Then
                    NItem1 = NItem1 + 1
                    NTotBrutoVale = NTotBrutoVale + Val(Format((Val(Format(.Fields("Salida"), "0.00")) * VVUnit), "0.00"))
                    NTotIGVVale = NTotIGVVale + Val(Format((Val(Format(.Fields("Salida"), "0.00")) * IGVUnit), "0.00"))
                    NTotVentaVale = NTotVentaVale + Val(Format((Val(Format(.Fields("Salida"), "0.00")) * PVUnit), "0.00"))
                        
                    If NItem1 = 1 Then
                        CIdValesCabS = generaCorrelativoAnoMes_Vale("ValesCab", "IdValesCab", "S", True)
                        CIdConceptoS = traerCampo("Parametros", "ValParametro", "GlsParametro", "CONCEPTO_AUTOMATICO_SALIDA", True)
                        
                        CSqlC = "Insert Into ValesCab(IdValesCab,TipoVale,FechaEmision,ValorTotal,IgvTotal,PrecioTotal,IdProvCliente,IdConcepto," & _
                                "IdAlmacen,IdMoneda,GlsDocReferencia,TipoCambio,IdEmpresa,IdSucursal,IdPeriodoInv,IdCentroCosto,FechaRegistro,IdUsuarioRegistro)" & _
                                "Select '" & CIdValesCabS & "','S',D.FecEmision,0,0,0,D.IdPerCliente,'" & CIdConceptoS & "',D.IdAlmacen,D.IdMoneda," & _
                                "'" & strGlsDocREF & "',D.TipoCambio,D.IdEmpresa,D.IdSucursal,'" & glsCodPeriodoINV & "',D.IdCentroCosto,SysDate(),'" & glsUser & "' " & _
                                "From Docventas D " & _
                                "Where D.IdDocumento = '" & strTipoDoc & "' And D.IdSerie = '" & Trim("" & txt_Serie.Text) & "' " & _
                                "And D.IdDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' And D.IdEmpresa = '" & glsEmpresa & "' " & _
                                "And D.IdSucursal = '" & glsSucursal & "'"
                                
                        Cn.Execute (CSqlC)

                        CSqlC = "Insert Into DocReferencia(TipoDocOrigen,NumDocOrigen,SerieDocOrigen,TipoDocReferencia,NumDocReferencia," & _
                                "SerieDocReferencia,Item,IdEmpresa,IdSucursal,IdSucursalReferencia)" & _
                                "Select '99','" & CIdValesCabS & "','000','" & Trim("" & strTipoDoc) & "','" & Trim("" & txt_NumDoc.Text) & "'," & _
                                "'" & Trim("" & txt_Serie.Text) & "','1','" & glsEmpresa & "','" & glsSucursal & "',''"
                        Cn.Execute (CSqlC)
                        
                        CIdAlmacenDestino = traerCampo("Parametros", "ValParametro", "GlsParametro", "ALMACEN_AUTOMATICO_DESTINO", True)
                        CIdSucursalDestino = traerCampo("Almacenes", "IdSucursal", "IdAlmacen", CIdAlmacenDestino, True)
                        CIdConceptoI = traerCampo("Parametros", "ValParametro", "GlsParametro", "CONCEPTO_AUTOMATICO_INGRESO", True)
                        
                        CIdValesCabI = generaCorrelativoAnoMes_Vale("ValesCab", "IdValesCab", "I", True)
                        
                        CSqlC = "Insert Into ValesCab(IdValesCab,TipoVale,FechaEmision,ValorTotal,IgvTotal,PrecioTotal,IdProvCliente,IdConcepto," & _
                                "IdAlmacen,IdMoneda,GlsDocReferencia,TipoCambio,IdEmpresa,IdSucursal,IdPeriodoInv,IdCentroCosto,FechaRegistro,IdUsuarioRegistro)" & _
                                "Select '" & CIdValesCabI & "','I',D.FecEmision,0,0,0,D.IdPerCliente,'" & CIdConceptoS & "'," & _
                                "'" & CIdAlmacenDestino & "',D.IdMoneda,'" & strGlsDocREF & "',D.TipoCambio,D.IdEmpresa,D.IdSucursal," & _
                                "'" & glsCodPeriodoINV & "',D.IdCentroCosto,SysDate(),'" & glsUser & "' " & _
                                "From Docventas D " & _
                                "Where D.IdDocumento = '" & strTipoDoc & "' And D.IdSerie = '" & Trim("" & txt_Serie.Text) & "' " & _
                                "And D.IdDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' And D.IdEmpresa = '" & glsEmpresa & "' " & _
                                "And D.IdSucursal = '" & glsSucursal & "'"
                        Cn.Execute (CSqlC)
                        
                        CSqlC = "Insert Into DocReferencia(TipoDocOrigen,NumDocOrigen,SerieDocOrigen,TipoDocReferencia,NumDocReferencia," & _
                                "SerieDocReferencia,Item,IdEmpresa,IdSucursal,IdSucursalReferencia)" & _
                                "Select '88','" & CIdValesCabI & "','000','" & Trim("" & strTipoDoc) & "','" & Trim("" & txt_NumDoc.Text) & "'," & _
                                "'" & Trim("" & txt_Serie.Text) & "','1','" & glsEmpresa & "','" & glsSucursal & "',''"
                        Cn.Execute (CSqlC)
                    End If
                
                    CSqlC = "Insert Into ValesDet(TipoVale,IdValesCab,Item,IdProducto,GlsProducto,IdUM,Factor,Afecto,Cantidad,VVUnit,IGVUnit,PVUnit," & _
                            "TotalVVNeto,TotalIGVNeto,TotalPVNeto,IdMoneda,IdEmpresa,IdSucursal,FecVencProd)Values(" & _
                            "'S','" & CIdValesCabS & "'," & NItem1 & ",'" & .Fields("IdProducto") & "','" & .Fields("GlsProducto") & "'," & _
                            "'" & .Fields("IdUMCompra") & "',1,'" & .Fields("AfectoIgv") & "'," & .Fields("Salida") & "," & VVUnit & "," & _
                            "" & IGVUnit & "," & PVUnit & "," & Val(Format(.Fields("Salida"), "0.00")) * VVUnit & "," & _
                            "" & Val(Format(.Fields("Salida"), "0.00")) * IGVUnit & "," & Val(Format(.Fields("Salida"), "0.00")) * PVUnit & "," & _
                            "'" & .Fields("IdMoneda") & "','" & glsEmpresa & "','" & glsSucursal & "','')"
                    Cn.Execute (CSqlC)
                    
                    CSqlC = "Insert Into ValesDet(TipoVale,IdValesCab,Item,IdProducto,GlsProducto,IdUM,Factor,Afecto,Cantidad,VVUnit,IGVUnit,PVUnit," & _
                            "TotalVVNeto,TotalIGVNeto,TotalPVNeto,IdMoneda,IdEmpresa,IdSucursal,FecVencProd)Values(" & _
                            "'I','" & CIdValesCabI & "'," & NItem1 & ",'" & .Fields("IdProducto") & "','" & .Fields("GlsProducto") & "'," & _
                            "'" & .Fields("IdUMCompra") & "',1,'" & .Fields("AfectoIgv") & "'," & .Fields("Salida") & "," & VVUnit & "," & _
                            "" & IGVUnit & "," & PVUnit & "," & Val(Format(.Fields("Salida"), "0.00")) * VVUnit & "," & _
                            "" & Val(Format(.Fields("Salida"), "0.00")) * IGVUnit & "," & Val(Format(.Fields("Salida"), "0.00")) * PVUnit & "," & _
                            "'" & .Fields("IdMoneda") & "','" & glsEmpresa & "','" & glsSucursal & "','')"
                    Cn.Execute (CSqlC)
                    
                    If traerCampo("ProductosAlmacen", "Item", "IdSucursal", CIdSucursalDestino, True, "IdAlmacen = '" & CIdAlmacenDestino & "' And IdProducto = '" & .Fields("IdProducto") & "' And IdUMCompra = '" & .Fields("IdUMCompra") & "'") = "" Then
                        CSqlC = "Insert Into ProductosAlmacen(Item,IdEmpresa,IdSucursal,IdAlmacen,IdProducto,IdUMCompra)Values(" & _
                                "0,'" & glsEmpresa & "','" & CIdSucursalDestino & "','" & CIdAlmacenDestino & "','" & .Fields("IdProducto") & "'," & _
                                "'" & .Fields("IdUMCompra") & "')"
                        Cn.Execute CSqlC
                    End If
                End If
                
                If Val(.Fields("Requerimiento")) > 0 Then
                    NItem2 = NItem2 + 1
                    NTotBrutoReq = NTotBrutoReq + Val(Format((Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("VVUnitP"))), "0.00"))
                    NTotIGVReq = NTotIGVReq + Val(Format((Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("IgvUnitP"))), "0.00"))
                    NTotVentaReq = NTotVentaReq + Val(Format((Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("PVUnitP"))), "0.00"))
                    If NItem2 = 1 Then
                        strGlsDocREF = traerCampo("Documentos", "AbreDocumento", "idDocumento", strTipoDoc, False) & Space(1) & Trim(txt_Serie.Text) & "-" & Trim(txt_NumDoc.Text)
                        
                        CSqlC = "Select Max(IdDocVentas) " & _
                                "From DocVentas " & _
                                "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '87' " & _
                                "And IdSerie = '999'"
                        rst.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                        If Not rst.EOF Then
                            CodDocventas = Format(Val("" & rst.Fields(0)) + 1, "00000000")
                        Else
                            CodDocventas = "00000001"
                        End If
                        rst.Close: Set rst = Nothing
            
                        CSqlC = "Insert Into Docventas(IdDocumento,IdDocVentas,IdSerie,IdPerCliente,GlsCliente,RUCCliente,DirCliente,IdAlmacen," & _
                                "IdPerVendedor,FecEmision,EstDocVentas,TotalValorVenta,TotalIGVVenta,TotalPrecioVenta,IdMoneda,TipoCambio," & _
                                "ObsDocVentas,Partida,Llegada,IdPerChofer,GlsChofer,IdPerEmpTrans,GlsEmpTrans,IdVehiculo,GlsVehiculo,Placa,Marca," & _
                                "Color,Modelo,CodInsCrip,Bultos,Brevete,IdLista,GlsVendedor,IdMotivoTraslado,GlsFormasPago,GlsFecVectos,IdMotivoNCD," & _
                                "GlsMotivoNCD,TotalLetras,FecIniTraslado,RucEmpTrans,FecPago,GlsDocReferencia,SimboloMonBruto,SimboloMonIGV," & _
                                "SimboloMonNeto,IndVale,IdValesCab,IdEmpresa,IdSucursal,IdCentroCosto,GlsCentroCosto,EstDocImportado,IdMovCaja," & _
                                "IdPerVendedorCampo,GlsVendedorCampo,TotalDsctoVV,TotalDsctoPV,TotalExonerado,TotalBaseImponible,EstGuiaImportado," & _
                                "IdTipoTicket,IdUsuarioAnulacion,FecRegistro,IdUsuarioReg,Partida2,Llegada2,NumOrdenCompra,IdValeCabRec,IndAprobado," & _
                                "ComisionVtas,IndLetra,IdUPP,IdFormaPago,IndTrasladoConta,GlsFormaPago,VTercerosCliente,VTercerosDireccion," & _
                                "VTerceroCodigo,VTerceroRuc,IndReq,IdContacto,GlsMoneda,IndTrasladoContaFin,IdPerVendedorCampo_Ant,IdProvCliente," & _
                                "ObsDocVentas2,IdTienda)" & _
                                "Select '87','" & CodDocventas & "','999',IdPerCliente,GlsCliente,RUCCliente,DirCliente,IdAlmacen,IdPerVendedor," & _
                                "FecEmision,EstDocVentas,0,0,0,IdMoneda,TipoCambio,ObsDocVentas,Partida," & _
                                "Llegada,IdPerChofer,GlsChofer,IdPerEmpTrans,GlsEmpTrans,IdVehiculo,GlsVehiculo,Placa,Marca,Color,Modelo,CodInsCrip," & _
                                "Bultos,Brevete,IdLista,GlsVendedor,IdMotivoTraslado,GlsFormasPago,GlsFecVectos,IdMotivoNCD,GlsMotivoNCD," & _
                                "TotalLetras,FecIniTraslado,RucEmpTrans,FecPago,'" & strGlsDocREF & "',SimboloMonBruto,SimboloMonIGV,SimboloMonNeto," & _
                                "IndVale,IdValesCab,IdEmpresa,IdSucursal,IdCentroCosto,GlsCentroCosto,EstDocImportado,IdMovCaja,IdPerVendedorCampo," & _
                                "GlsVendedorCampo,0,0,0,0,EstGuiaImportado,IdTipoTicket,IdUsuarioAnulacion,FecRegistro,IdUsuarioReg," & _
                                "Partida2,Llegada2,NumOrdenCompra,IdValeCabRec,'1',ComisionVtas,IndLetra,IdUPP,IdFormaPago,IndTrasladoConta," & _
                                "GlsFormaPago,VTercerosCliente,VTercerosDireccion,VTerceroCodigo,VTerceroRuc,IndReq,IdContacto,GlsMoneda," & _
                                "IndTrasladoContaFin,IdPerVendedorCampo_Ant,IdProvCliente,ObsDocVentas2,IdTienda " & _
                                "From Docventas " & _
                                "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' " & _
                                "And IdDocumento = '" & strTipoDoc & "' And IdDocVentas = '" & Trim("" & txt_NumDoc.Text) & "' " & _
                                "And IdSerie = '" & Trim("" & txt_Serie.Text) & "'"
                        Cn.Execute (CSqlC)
                        
                        CSqlC = "Insert Into DocReferencia(TipoDocOrigen,NumDocOrigen,SerieDocOrigen,TipoDocReferencia,NumDocReferencia," & _
                                "SerieDocReferencia,Item,IdEmpresa,IdSucursal,IdSucursalReferencia)" & _
                                "Select '87','" & CodDocventas & "','999','" & Trim("" & strTipoDoc) & "','" & Trim("" & txt_NumDoc.Text) & "'," & _
                                "'" & Trim("" & txt_Serie.Text) & "','1','" & glsEmpresa & "','" & glsSucursal & "',''"
                        Cn.Execute (CSqlC)
                    End If
                
                    CSqlC = "Insert Into DocventasDet(IdDocumento,IdDocVentas,IdSerie,IdProducto,GlsProducto,IdMarca,IdUM,Factor,Afecto,Cantidad," & _
                            "VVUnit,IGVUnit,PVUnit,TotalVVBruto,TotalPVBruto,PorDcto,DctoVV,DctoPV,TotalVVNeto,TotalIGVNeto,TotalPVNeto,Item," & _
                            "GlsMarca,GlsUM,IdTipoProducto,IdMoneda,IdCodFabricante,IdEmpresa,IdSucursal,EstDocImportado,IdDocumentoImp," & _
                            "IdDocVentasImp,IdSerieImp,NumLote,FecVencProd,IdUsuarioDcto,VVUnitLista,PVUnitLista,CantidadImp,VVUnitNeto,PVUnitNeto," & _
                            "Cantidad2,CodigoRapido,IdTallaPeso,CantidadAnt)Values(" & _
                            "'87','" & CodDocventas & "','999','" & .Fields("IdProducto") & "','" & .Fields("GlsProducto") & "'," & _
                            "'" & .Fields("IdMarca") & "','" & .Fields("IdUMCompra") & "','" & .Fields("Factor") & "'," & _
                            "'" & .Fields("AfectoIgv") & "'," & Val(Format(.Fields("Requerimiento"), "0.00")) & "," & _
                            "" & Val("" & .Fields("VVUnitP")) & "," & Val("" & .Fields("IgvUnitP")) & "," & Val("" & .Fields("PVUnitP")) & "," & _
                            "" & Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("VVUnitP")) & "," & _
                            "" & Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("PVUnitP")) & ",0,0,0," & _
                            "" & Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("VVUnitP")) & "," & _
                            "" & (Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("VVUnitP"))) * dblIgvNEw & "," & _
                            "" & Val(Format(.Fields("Requerimiento"), "0.00")) * Val("" & .Fields("PVUnitP")) & "," & NItem2 & ",'" & .Fields("GlsMarca") & "'," & _
                            "'" & .Fields("GlsUM") & "','" & .Fields("IdTipoProducto") & "','" & .Fields("IdMoneda") & "'," & _
                            "'" & .Fields("IdFabricante") & "','" & glsEmpresa & "','" & glsSucursal & "','','','','','','',''," & _
                            "" & .Fields("VVUnitLista") & "," & .Fields("PVUnitLista") & ",0," & Val("" & .Fields("VVUnitP")) & "," & _
                            "" & Val("" & .Fields("PVUnitP")) & ",0,'" & .Fields("CodigoRapido") & "'," & Val("" & .Fields("IdTallaPeso")) & ",0)"
                    Cn.Execute (CSqlC)
                End If
                .MoveNext
            Loop
            
            If NItem2 > 0 Then
                CSqlC = "Update DocVentas " & _
                        "Set TotalValorVenta = " & NTotBrutoReq & ",TotalIGVVenta = " & NTotIGVReq & ",TotalPrecioVenta = " & NTotVentaReq & "," & _
                        "TotalBaseImponible = " & NTotBrutoReq & " " & _
                        "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '87' And IdSerie = '999' " & _
                        "And IdDocVentas = '" & CodDocventas & "'"
                Cn.Execute (CSqlC)
            End If
            
            If NItem1 > 0 Then
                CSqlC = "Update ValesCab " & _
                        "Set ValorTotal = " & NTotBrutoVale & ",IgvTotal = " & NTotIGVVale & ",PrecioTotal = " & NTotVentaVale & " " & _
                        "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And TipoVale = 'S' " & _
                        "And IdValesCab = '" & CIdValesCabS & "'"
                Cn.Execute (CSqlC)
                
                CSqlC = "Update ValesCab " & _
                        "Set ValorTotal = " & NTotBrutoVale & ",IgvTotal = " & NTotIGVVale & ",PrecioTotal = " & NTotVentaVale & " " & _
                        "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And TipoVale = 'I' " & _
                        "And IdValesCab = '" & CIdValesCabI & "'"
                Cn.Execute (CSqlC)
                
                actualizaStock CIdValesCabS, 0, StrMsgError, "S", False
                If StrMsgError <> "" Then GoTo Err
 
                actualizaStock CIdValesCabI, 0, StrMsgError, "I", False
                If StrMsgError <> "" Then GoTo Err
            End If
        End If
        .Close
    End With
    
    CSqlC = "Update DocVentas " & _
            "Set IndAprobado = '1' " & _
            "Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & strTipoDoc & "' " & _
            "And IdSerie = '" & Trim("" & txt_Serie.Text) & "' And IdDocVentas = '" & Trim("" & txt_NumDoc.Text) & "'"
    Cn.Execute (CSqlC)
                
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub Jala_Materiales_Conversion(PIdCentroCosto As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsTabla                         As New ADODB.Recordset

    CSqlC = "Select * " & _
            "From ValesConver A " & _
            "Inner Join ValesConverDet B " & _
                "On A.IdEmpresa = B.IdEmpresa And A.IdSucursal = B.IdSucursal And A.IdValesConver = B.IdValesConver " & _
            "Inner Join Productos C " & _
                "On B.IdEmpresa = C.IdEmpresa And B.IdProducto = C.IdProducto " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdSucursal = '" & glsSucursal & "' And A.IdCentroCosto = '" & PIdCentroCosto & "' " & _
            "And B.IdTipoDetalle = 'O' And estValeConver <> 'ANU'"
    If RsDetProductos.State <> 1 Then
        Inicia_RecordSet RsDetProductos, 0, StrMsgError
        If StrMsgError <> "" Then GoTo Err
    End If
    
    With RsTabla
        .Open CSqlC, Cn, adOpenStatic, adLockReadOnly
        Do While Not .EOF
            RsDetProductos.AddNew
            RsDetProductos.Fields("Item") = Val(.Fields("Item"))
            RsDetProductos.Fields("IdProducto") = .Fields("IdProducto")
            RsDetProductos.Fields("GlsProducto") = .Fields("GlsProducto")
            RsDetProductos.Fields("CantidadStock") = 0
            RsDetProductos.Fields("Cantidad") = Val("" & .Fields("Cantidad"))
            RsDetProductos.Fields("ItemDocVentas") = 1
            RsDetProductos.Fields("IdComboCab") = "" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value
            RsDetProductos.Fields("VVUnit") = 0
            RsDetProductos.Fields("PorcDcto") = 0
            RsDetProductos.Fields("TotalVVenta") = 0
            .MoveNext
        Loop
    End With
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Function traerCantSaldo(ByVal codproducto As String, ByVal codalmacen As String, ByVal strFecha As String, ByRef StrMsgError As String) As Double
On Error GoTo Err
Dim rsSaldo As New ADODB.Recordset
Dim strSQL As String

    traerCantSaldo = 0
    strSQL = "SELECT SUM(IF(vc.tipoVale = 'I',vd.Cantidad," & _
                                            "(vd.Cantidad * -1)" & _
                           ")" & _
                        ") AS STOCK " & _
            "FROM valescab vc,valesdet vd " & _
            "WHERE vc.idValesCab = vd.idValesCab " & _
            "AND vc.idEmpresa = vd.idEmpresa " & _
            "AND vc.idSucursal = vd.idSucursal " & _
            "AND vc.tipoVale = vd.tipoVale " & _
            "AND vc.idEmpresa = '" & glsEmpresa & "'" & _
            "AND vc.IdAlmacen = '" & codalmacen & "' " & _
            "AND vd.idProducto = '" & codproducto & "' " & _
            "AND (vc.idPeriodoInv) IN " & _
                    "(" & _
                        "SELECT pi.idPeriodoInv " & _
                        "FROM periodosinv pi " & _
                        "WHERE pi.idEmpresa = vc.idEmpresa AND pi.idSucursal = vc.idSucursal and pi.FecInicio <= '" & strFecha & "' " & _
                        "and (pi.FecFin >= '" & strFecha & "' or pi.FecFin is null)" & _
                    ") " & _
            "AND vc.fechaEmision <= '" & strFecha & "' " & _
            "AND vc.estValeCab <> 'ANU' Order By FechaEmision "
    rsSaldo.Open strSQL, Cn, adOpenForwardOnly, adLockReadOnly
    
    If Not rsSaldo.EOF Then
        If Not IsNull(rsSaldo.Fields("STOCK")) Then
            traerCantSaldo = rsSaldo.Fields("STOCK")
        End If
    End If
    
    If rsSaldo.State = 1 Then rsSaldo.Close: Set rsSaldo = Nothing
    
    Exit Function

Err:
    If rsSaldo.State = 1 Then rsSaldo.Close: Set rsSaldo = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
End Function

Private Sub AsientoContableVentas(StrMsgError As String, PAccion As String)
On Error GoTo Err
Dim rst                                 As New ADODB.Recordset
Dim CParam(5)                           As String
Dim indTrans                            As Boolean
Dim CIndVtaGratuita                     As String

    If strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "07" Or strTipoDoc = "08" Or strTipoDoc = "12" Or strTipoDoc = "25" Or strTipoDoc = "90" Then
        indTrans = False
        If traerCampo("Parametros", "ValParametro", "GlsParametro", "CONTABILIDAD_ONLINE", True) = "1" Then
            
            CIndVtaGratuita = Trim(traerCampo("docventas", "IndTransGratuita", "idDocumento", strTipoDoc, True, " idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "' AND idSucursal = '" & glsSucursal & "'"))
            If CIndVtaGratuita = "0" Then
                CIndVtaGratuita = Trim(traerCampo("docventas", "IndTransGratuitaMP", "idDocumento", strTipoDoc, True, " idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "' AND idSucursal = '" & glsSucursal & "'"))
            End If
            
            If CIndVtaGratuita <> "1" Then
                
                'If Trim(traerCampo("docventas", "IndTransGratuita", "idDocumento", strTipoDoc, True, " idDocVentas = '" & txt_NumDoc.Text & "' AND idSerie = '" & txt_Serie.Text & "' AND idSucursal = '" & glsSucursal & "'")) <> "1" Then
                
                    rst.Open "Select GlsParametro,ValParametro From Parametros Where IdEmpresa = '" & glsEmpresa & "'", Cn, adOpenStatic, adLockReadOnly
                    Do While Not rst.EOF
                        Select Case UCase(rst.Fields("GlsParametro"))
                            Case "ORIGEN_CONTABLE": CParam(0) = "" & rst.Fields("ValParametro")
                            Case "TRANS_CONTA_CTA_40": CParam(1) = "" & rst.Fields("ValParametro")
                            Case "TRANS_CONTA_CTA_70": CParam(2) = "" & rst.Fields("ValParametro")
                            Case "AYUDA_CENTRO_COSTO_DETALLE": CParam(3) = "" & rst.Fields("ValParametro")
                            Case "IVAP_CUENTA": CParam(4) = "" & rst.Fields("ValParametro")
                        End Select
                        rst.MoveNext
                    Loop
                    rst.Close
                    
                    CnConta.BeginTrans
                    indTrans = True
                    CnConta.Execute ("Call Spu_AsientoContableVentas('" & glsEmpresa & "','" & glsSucursal & "','" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "','" & CParam(0) & "','" & CParam(1) & "','" & CParam(2) & "','" & CIdComprobanteAux & "','" & CIdPeriodoAux & "','" & CParam(3) & "','" & CParam(4) & "','" & glsUser & "','" & fpComputerName & "','" & fpUsuarioActual & "')")
                    CnConta.CommitTrans
                    indTrans = False
                                    
'                Else
'
'                    rst.Open "Select GlsParametro,ValParametro From Parametros Where IdEmpresa = '" & glsEmpresa & "'", Cn, adOpenStatic, adLockReadOnly
'                    Do While Not rst.EOF
'                        Select Case UCase(rst.Fields("GlsParametro"))
'                            Case "ORIGEN_CONTABLE": CParam(0) = "" & rst.Fields("ValParametro")
'                            Case "TRANS_CONTA_CTA_40": CParam(1) = "" & rst.Fields("ValParametro")
'                            Case "IGV_POR_PAGAR_TG": CParam(2) = "" & rst.Fields("ValParametro")
'                        End Select
'                        rst.MoveNext
'                    Loop
'                    rst.Close
'
'                    CnConta.BeginTrans
'                    indTrans = True
'                    CnConta.Execute ("Call Spu_AsientoContableVentasTransGratuita('" & glsEmpresa & "','" & glsSucursal & "','" & strTipoDoc & "','" & txt_Serie.Text & "','" & txt_NumDoc.Text & "','" & Format(dtp_Emision.Value, "yyyy-mm-dd") & "','" & CParam(0) & "','" & CParam(1) & "','" & CParam(2) & "','" & CIdComprobanteAux & "','" & CIdPeriodoAux & "')")
'                    CnConta.CommitTrans
'                    indTrans = False
'
'                End If
                
                rst.Open "Select IdPeriodo,IdComprobante From DocVentas Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & strTipoDoc & "' And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'", Cn, adOpenStatic, adLockReadOnly
                If Not rst.EOF Then
                    CIdPeriodoAux = "" & rst.Fields("IdPeriodo")
                    CIdComprobanteAux = "" & rst.Fields("IdComprobante")
                Else
                    CIdPeriodoAux = ""
                    CIdComprobanteAux = ""
                End If
                rst.Close
                
            Else
                
                If CIdPeriodoAux <> "" And CIdComprobanteAux <> "" Then
                
                    CnConta.Execute "Delete From AsientoContableDetalle Where IdEmpresa = '" & glsEmpresa & "' And IdPeriodo = '" & CIdPeriodoAux & "' And IdComprobante = '" & CIdComprobanteAux & "'"
                    CnConta.Execute "Delete From AsientoContable Where IdEmpresa = '" & glsEmpresa & "' And IdPeriodo = '" & CIdPeriodoAux & "' And IdComprobante = '" & CIdComprobanteAux & "'"
                    
                    Cn.Execute "Update DocVentas Set IdPeriodo = '',IdComprobante = '' Where IdEmpresa = '" & glsEmpresa & "' And IdSucursal = '" & glsSucursal & "' And IdDocumento = '" & strTipoDoc & "' And IdSerie = '" & txt_Serie.Text & "' And IdDocVentas = '" & txt_NumDoc.Text & "'"
                    
                    CIdPeriodoAux = ""
                    CIdComprobanteAux = ""
                
                End If
                
            End If
        End If
    End If
        
    Exit Sub
Err:
    If indTrans Then CnConta.RollbackTrans
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub ValidaModificacionAsientoContable(StrMsgError As String, PAccion As String)
On Error GoTo Err
    
    If strTipoDoc = "01" Or strTipoDoc = "03" Or strTipoDoc = "07" Or strTipoDoc = "08" Or strTipoDoc = "12" Or strTipoDoc = "90" Then
        If traerCampo("Parametros", "ValParametro", "GlsParametro", "CONTABILIDAD_ONLINE", True) = "1" Then
            If Len(Trim(CIdPeriodoAux)) > 0 And Len(Trim(CIdComprobanteAux)) > 0 Then
                If traerCampo("Parametros", "ValParametro", "GlsParametro", "CONTABILIDAD_ONLINE_VB", True) = "1" Then
                    If traerCampoConta("AsientoContable", "VBContable", "IdPeriodo", CIdPeriodoAux, True, "IdComprobante = '" & CIdComprobanteAux & "' And IdOrigen = '" & traerCampo("Parametros", "ValParametro", "GlsParametro", "ORIGEN_CONTABLE", True) & "'") = "1" Then
                        StrMsgError = "El documento no se puede " & PAccion & ", porque el asiento contable se encuentra cerrado.": GoTo Err
                    End If
                End If
            End If
        End If
    End If
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub mostrarDocImportado_Empresas(ByVal rscd As ADODB.Recordset, ByVal rsdd As ADODB.Recordset, ByVal strTipoDocImportado As String, ByRef StrMsgError As String)
On Error GoTo Err
Dim rsg                         As New ADODB.Recordset
Dim RsD                         As New ADODB.Recordset
Dim strSerieDocventas           As String
Dim i                           As Integer
Dim indExisteDocRef             As Boolean
Dim cAuxIdProducto              As String
Dim CIdDocVentas                As String
Dim CIdSerie                    As String
Dim cidIdocumento               As String
Dim rst                         As New ADODB.Recordset
Dim rsv                         As New ADODB.Recordset
Dim cmysql                      As String
Dim strCliApi                   As String

    Set rsdEmpresas = rsdd.Clone(adLockReadOnly)
    ccodproparam = traerCampo("Parametros", "ValParametro", "GlsParametro", "CODIGO_PRODUCTO_APIMAS", True)
    indCargando = True
    i = 0
    strEstDocVentas = "GEN"
    
    '---- Formato Detalle
    rsg.Fields.Append "Item", adInteger, , adFldRowID
    rsg.Fields.Append "numOrdenCompra", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "GlsProducto", adVarChar, 800, adFldIsNullable
    rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
    rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
    rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
    rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
    rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
    rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
    rsg.Fields.Append "ItemPro", adInteger, , adFldRowID
    rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
    rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
    rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
    rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
    rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
    rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
    rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    rsg.Open
    
    '---- Formato Documento de refrencia
    RsD.Fields.Append "Item", adInteger, , adFldRowID
    RsD.Fields.Append "IdDocumento", adChar, 2, adFldIsNullable
    RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
    RsD.Fields.Append "IdSerie", adChar, 4, adFldIsNullable
    RsD.Fields.Append "IdNumDoc", adChar, 8, adFldIsNullable
    RsD.Fields.Append "EmpresaReferencia", adChar, 2, adFldIsNullable
    RsD.Fields.Append "SucursalReferencia", adVarChar, 8, adFldIsNullable
    RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
    RsD.Open , , adOpenKeyset, adLockOptimistic
    
    If rscd.RecordCount = 0 Then
        txt_OrdenCompra.Text = ""
    Else
        txt_OrdenCompra.Text = "" & rscd.Fields("numOrdenCompra")
        txt_Llegada.Text = "" & rscd.Fields("llegada")
        txtCod_Moneda.Text = "" & rscd.Fields("idmoneda")
        dtp_IniTraslado.Value = "" & rscd.Fields("FecIniTraslado")
        txtCod_FormaPago.Text = Trim("" & rscd.Fields("idFormaPago"))
        txtCod_Chofer.Text = ("" & rscd.Fields("idPerChofer"))
        txtGls_Chofer.Text = Trim("" & rscd.Fields("glsChofer"))
        txtCod_Vehiculo.Text = Trim("" & rscd.Fields("idVehiculo"))
        txtGls_Vehiculo.Text = Trim("" & rscd.Fields("GlsVehiculo"))
        txt_Placa.Text = Trim("" & rscd.Fields("Placa"))
        txt_Marca.Text = Trim("" & rscd.Fields("Marca"))
        txt_Color.Text = Trim("" & rscd.Fields("Color"))
        txt_Modelo.Text = Trim("" & rscd.Fields("Modelo"))
        txt_CodInscripcion.Text = Trim("" & rscd.Fields("CodInsCrip"))
        txt_Brevete.Text = Trim("" & rscd.Fields("Brevete"))
        txtCod_CentroCosto.Text = Trim("" & rscd.Fields("IdCentroCosto"))
        
        'Nuevos Datos a Mostrar Para Apimas por la Importacion de Documentos Entre Empresas
        strCliApi = traerCampo("Docventas", "idPercliente", "idDocumento", strTipoDocImportado, False, "idEmpresa = '" & rscd.Fields("idEmpresa") & "' And idSerie = '" & rsdd.Fields("idSerie") & "' And idDocventas = '" & rsdd.Fields("idDocVentas") & "' And idSucursal = '" & rscd.Fields("idSucursal") & "' ")
        txtCod_Cliente.Text = traerCampo("Personas p Inner Join Empresas e On p.idPersona = e.idPersona ", "p.idPersona", "e.idEmpresa", Trim("" & rscd.Fields("idEmpresa")), False)
        txt_RUC.Text = traerCampo("Personas", "Ruc", "idPersona", txtCod_Cliente.Text, False)
        txtGls_Cliente.Text = traerCampo("Personas", "GlsPersona", "idPersona", txtCod_Cliente.Text, False)
        'txt_Partida.Text = traerCampo("Personas", "Direccion", "idPersona", txtCod_Cliente.Text, False)
        'If strTipoDocImportado = "01" Then
        '    txt_Llegada.Text = traerCampo("Personas", "Direccion", "idPersona", strCliApi, False)
        'Else
        '    txt_Llegada.Text = Trim("" & rscd.Fields("Llegada"))
        'End If
        
        txt_Partida.Text = traerCampo("Docventas", "Partida", "idDocumento", strTipoDocImportado, False, "idEmpresa = '" & rscd.Fields("idEmpresa") & "' And idSerie = '" & rsdd.Fields("idSerie") & "' And idDocventas = '" & rsdd.Fields("idDocVentas") & "' And idSucursal = '" & rscd.Fields("idSucursal") & "' ")
        txt_Llegada.Text = traerCampo("Docventas", "Llegada", "idDocumento", strTipoDocImportado, False, "idEmpresa = '" & rscd.Fields("idEmpresa") & "' And idSerie = '" & rsdd.Fields("idSerie") & "' And idDocventas = '" & rsdd.Fields("idDocVentas") & "' And idSucursal = '" & rscd.Fields("idSucursal") & "' ")
        
        txtCod_EmpTrans.Text = Trim("" & rscd.Fields("idPerEmpTrans"))
        
        If txt_Partida.Text = "" Then
            If strTipoDocImportado = "01" Then
                txt_Partida.Text = traerCampo("Personas", "Direccion", "idPersona", traerCampo("Empresas", "IdPersona", "IdEmpresa", rscd.Fields("idEmpresa"), False), False)
            Else
                txt_Partida.Text = traerCampo("Personas", "Direccion", "idPersona", glsPersonaEmpresa, False)
            End If
        End If
        
        'txt_Partida.Text = traerCampo("Personas", "Direccion", "idPersona", txtCod_Cliente.Text, False)
        
    End If
    
    If strTipoDoc = "86" Then
        If rsdd.RecordCount = 0 Then
            rsg.AddNew
            rsg.Fields("Item") = 1
            rsg.Fields("idProducto") = ""
            rsg.Fields("idCodFabricante") = ""
            rsg.Fields("GlsProducto") = ""
            rsg.Fields("idMarca") = ""
            rsg.Fields("GlsMarca") = ""
            rsg.Fields("idUM") = ""
            rsg.Fields("GlsUM") = ""
            rsg.Fields("Factor") = 1
            rsg.Fields("Afecto") = 1
            rsg.Fields("Cantidad") = 0
            rsg.Fields("Cantidad2") = 0
            rsg.Fields("VVUnit") = 0
            rsg.Fields("IGVUnit") = 0
            rsg.Fields("PVUnit") = 0
            rsg.Fields("TotalVVBruto") = 0
            rsg.Fields("TotalPVBruto") = 0
            rsg.Fields("PorDcto") = "0"
            rsg.Fields("DctoVV") = 0
            rsg.Fields("DctoPV") = 0
            rsg.Fields("TotalVVNeto") = 0
            rsg.Fields("TotalIGVNeto") = 0
            rsg.Fields("TotalPVNeto") = 0
            rsg.Fields("idTipoProducto") = ""
            rsg.Fields("idMoneda") = ""
            rsg.Fields("idDocumentoImp") = ""
            rsg.Fields("idDocVentasImp") = ""
            rsg.Fields("idSerieImp") = ""
            rsg.Fields("NumLote") = ""
            rsg.Fields("IdLote") = ""
            rsg.Fields("FecVencProd") = ""
            rsg.Fields("VVUnitLista") = 0
            rsg.Fields("PVUnitLista") = 0
            rsg.Fields("VVUnitNeto") = 0
            rsg.Fields("PVUnitNeto") = 0
            rsg.Fields("CantidadAnt") = 0
            rsg.Fields("ItemPro") = 1
            rsg.Fields("IdCentroCosto") = ""
            rsg.Fields("GlsPlaca") = ""
            rsg.Fields("IdSucursalPres") = ""
            rsg.Fields("IdDocumentoPres") = ""
            rsg.Fields("IdSeriePres") = ""
            rsg.Fields("IdDocVentasPres") = ""
            rsg.Fields("IdUPCliente") = ""
            rsg.Fields("IvapUnit") = 0
            rsg.Fields("TotalIvapNeto") = 0
            rsg.Fields("GlsProveedor") = ""
            rsg.Fields("CostoS") = 0
            rsg.Fields("CostoSInc") = 0
            rsg.Fields("CostoD") = 0
            rsg.Fields("Margen") = 0
        Else
            rsdd.MoveFirst
            rsdd.Sort = "idProducto"
            Do While Not rsdd.EOF
                cAuxIdProducto = "" & rsdd.Fields("idProducto")
                rsg.AddNew
                i = i + 1
                rsg.Fields("Item") = i
                rsg.Fields("idProducto") = "" & rsdd.Fields("idProducto")
                rsg.Fields("idCodFabricante") = "" & rsdd.Fields("idCodFabricante")
                rsg.Fields("GlsProducto") = "" & rsdd.Fields("GlsProducto")
                rsg.Fields("idMarca") = "" & rsdd.Fields("idMarca")
                rsg.Fields("GlsMarca") = "" & rsdd.Fields("GlsMarca")
                rsg.Fields("idUM") = "" & rsdd.Fields("idUM")
                rsg.Fields("GlsUM") = "" & rsdd.Fields("GlsUM")
                rsg.Fields("Factor") = "" & rsdd.Fields("Factor")
                rsg.Fields("Afecto") = "" & rsdd.Fields("Afecto")
                rsg.Fields("idTipoProducto") = "" & rsdd.Fields("idTipoProducto")
                rsg.Fields("idMoneda") = "" & rsdd.Fields("idMoneda")
                rsg.Fields("idDocumentoImp") = strTipoDocImportado
                rsg.Fields("idDocVentasImp") = "" & rsdd.Fields("idDocVentas")
                rsg.Fields("idSerieImp") = "" & rsdd.Fields("idSerie")
                rsg.Fields("NumLote") = "" & rsdd.Fields("NumLote")
                rsg.Fields("IdLote") = "" & rsdd.Fields("IdLote")
                rsg.Fields("FecVencProd") = "" & rsdd.Fields("FecVencProd")
                rsg.Fields("CodigoRapido") = "" & rsdd.Fields("CodigoRapido")
                rsg.Fields("VVUnit") = Val("" & rsdd.Fields("VVUnit"))
                rsg.Fields("IGVUnit") = Val("" & rsdd.Fields("IGVUnit"))
                rsg.Fields("PVUnit") = Val("" & rsdd.Fields("PVUnit"))
                rsg.Fields("VVUnitLista") = Val("" & rsdd.Fields("VVUnitLista"))
                rsg.Fields("PVUnitLista") = Val("" & rsdd.Fields("PVUnitLista"))
                rsg.Fields("VVUnitNeto") = Val("" & rsdd.Fields("VVUnitNeto"))
                rsg.Fields("PVUnitNeto") = Val("" & rsdd.Fields("PVUnitNeto"))
                rsg.Fields("ItemPro") = Val("" & rsdd.Fields("ItemPro"))
                rsg.Fields("IdCentroCosto") = ""
                rsg.Fields("GlsPlaca") = ""
                rsg.Fields("IdSucursalPres") = ""
                rsg.Fields("IdDocumentoPres") = ""
                rsg.Fields("IdSeriePres") = ""
                rsg.Fields("IdDocVentasPres") = ""
                rsg.Fields("IdUPCliente") = ""
                rsg.Fields("IvapUnit") = 0
                rsg.Fields("TotalIvapNeto") = 0
                rsg.Fields("GlsProveedor") = ""
                rsg.Fields("CostoS") = 0
                rsg.Fields("CostoSInc") = 0
                rsg.Fields("CostoD") = 0
                rsg.Fields("Margen") = 0
        
                Do While cAuxIdProducto = "" & rsdd.Fields("idProducto")
                    rsg.Fields("Cantidad") = Val("" & rsg.Fields("Cantidad")) + Val("" & rsdd.Fields("Cantidad"))
                    rsg.Fields("Cantidad2") = Val("" & rsg.Fields("Cantidad2")) + Val("" & rsdd.Fields("Cantidad2"))
                    rsg.Fields("TotalVVBruto") = Val("" & rsg.Fields("TotalVVBruto")) + Val("" & rsdd.Fields("TotalVVBruto"))
                    rsg.Fields("TotalPVBruto") = Val("" & rsg.Fields("TotalPVBruto")) + Val("" & rsdd.Fields("TotalPVBruto"))
                    rsg.Fields("PorDcto") = Val("" & rsg.Fields("PorDcto")) + Val("" & rsdd.Fields("PorDcto"))
                    rsg.Fields("DctoVV") = Val("" & rsg.Fields("DctoVV")) + Val("" & rsdd.Fields("DctoVV"))
                    rsg.Fields("DctoPV") = Val("" & rsg.Fields("DctoPV")) + Val("" & rsdd.Fields("DctoPV"))
                    rsg.Fields("TotalVVNeto") = Val("" & rsg.Fields("TotalVVNeto")) + Val("" & rsdd.Fields("TotalVVNeto"))
                    rsg.Fields("TotalIGVNeto") = Val("" & rsg.Fields("TotalIGVNeto")) + Val("" & rsdd.Fields("TotalIGVNeto"))
                    rsg.Fields("TotalPVNeto") = Val("" & rsg.Fields("TotalPVNeto")) + Val("" & rsdd.Fields("TotalPVNeto"))
                    rsg.Fields("CantidadAnt") = Val("" & rsg.Fields("Cantidad")) + Val("" & rsdd.Fields("Cantidad"))
                    rsg.Fields("idTallaPeso") = Val("" & rsg.Fields("idTallaPeso")) + Val("" & rsdd.Fields("idTallaPeso"))
                    rsg.Fields("Simbolo1") = lbl_SimbMonBruto.Caption
                    rsg.Fields("Simbolo2") = lbl_SimbMonBruto.Caption
                    rsg.Fields("Simbolo3") = "%"
                
                    If RsD.RecordCount > 0 Then RsD.MoveFirst
                    indExisteDocRef = False
                    Do While Not RsD.EOF
                       If RsD.Fields("idDocumento") = strTipoDocImportado And RsD.Fields("idSerie") = "" & rsdd.Fields("idSerie") And RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas") Then
                           indExisteDocRef = True
                           Exit Do
                       End If
                       RsD.MoveNext
                    Loop
                    
                    If indExisteDocRef = False Then
                        
                        RsD.AddNew
                        RsD.Fields("Item") = "" & RsD.RecordCount
                        RsD.Fields("idDocumento") = strTipoDocImportado
                        RsD.Fields("GlsDocumento") = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDocImportado, False)
                        RsD.Fields("idSerie") = "" & rsdd.Fields("idSerie")
                        RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas")
                        RsD.Fields("empresaReferencia") = "" & rscd.Fields("idEmpresa")
                        RsD.Fields("sucursalReferencia") = "" & rscd.Fields("idSucursal")
                        RsD.Fields("IndImportado") = "1"
                        
                    End If
                    rsdd.MoveNext
                    If rsdd.EOF Then Exit Do
                Loop
            Loop
        End If
    
        mostrarDatosGridSQL gDetalle, rsg, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        '---- Documentos de referencia
        If RsD.RecordCount = 0 Then
            RsD.AddNew
            RsD.Fields("Item") = 1
            RsD.Fields("idDocumento") = ""
            RsD.Fields("GlsDocumento") = ""
            RsD.Fields("idSerie") = ""
            RsD.Fields("idNumDOc") = ""
            RsD.Fields("EmpresaReferencia") = ""
            RsD.Fields("SucursalReferencia") = ""
            RsD.Fields("IndImportado") = "0"
        End If
        mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
        If StrMsgError <> "" Then GoTo Err
     
        '---- Recalculamos totales por fila
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            gDetalle.Dataset.Edit
            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("IGVUnit").Value, gDetalle.Columns.ColumnByFieldName("PVUnit").Value, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            gDetalle.Dataset.Next
        Loop
        
        '---- Calculamos totales
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
                        
        If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
            lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        Else
            lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        End If
        txt_MontoLetras.Text = lbl_TotalLetras.Caption
        indCargando = False
        
    Else
        If strTipoDoc = "01" Then
            rsdd.MoveFirst
            rsdd.Sort = "idProducto"
            If Not rsdd.EOF Then
                Do While Not rsdd.EOF
                    cAuxIdProducto = "" & rsdd.Fields("idProducto")
                    Do While cAuxIdProducto = "" & rsdd.Fields("idProducto")
                        If RsD.RecordCount > 0 Then RsD.MoveFirst
                        indExisteDocRef = False
                        Do While Not RsD.EOF
                            If RsD.Fields("idDocumento") = strTipoDocImportado And RsD.Fields("idSerie") = "" & rsdd.Fields("idSerie") And RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas") Then
                                indExisteDocRef = True
                                Exit Do
                            End If
                            RsD.MoveNext
                        Loop
                        If indExisteDocRef = False Then
                            RsD.AddNew
                            RsD.Fields("Item") = "" & RsD.RecordCount
                            RsD.Fields("idDocumento") = strTipoDocImportado
                            RsD.Fields("GlsDocumento") = traerCampo("documentos", "GlsDocumento", "idDocumento", strTipoDocImportado, False)
                            RsD.Fields("idSerie") = "" & rsdd.Fields("idSerie")
                            RsD.Fields("idNumDOc") = "" & rsdd.Fields("idDocVentas")
                            RsD.Fields("EmpresaReferencia") = "" & rscd.Fields("idEmpresa")
                            RsD.Fields("SucursalReferencia") = "" & rscd.Fields("idSucursal")
                            RsD.Fields("IndImportado") = "1"
                            
                            CIdDocVentas = CIdDocVentas & "'" & rsdd.Fields("idDocVentas") & "'" & ","
                            CIdSerie = CIdSerie & "'" & rsdd.Fields("idSerie") & "'" & ","
                            cidIdocumento = cidIdocumento & "'" & strTipoDocImportado & "'" & ","
                            
                        End If
                        rsdd.MoveNext
                        If rsdd.EOF Then Exit Do
                    Loop
                Loop
            End If
            cmysql = "Select idDocumento, idDocVentas, idSerie,TotalIGVVenta, TotalPrecioVenta,  " & _
                    "Sum(CASE '" & Trim(txtCod_Moneda.Text) & "' " & _
                    "When 'PEN' Then If(d.idMoneda = 'PEN', d.TotalValorVenta,d.TotalValorVenta * d.TipoCambio) " & _
                    "When 'USD' Then If(d.idMoneda = 'USD', d.TotalValorVenta,d.TotalValorVenta / d.TipoCambio) End) As TotalValorVenta " & _
                    "From Docventas d Where  idDocventas In (" & Trim(left(CIdDocVentas, Len(CIdDocVentas) - 1)) & ") And idSerie In (" & Trim(left(CIdSerie, Len(CIdSerie) - 1)) & ") And idDocumento In (" & Trim(left(cidIdocumento, Len(cidIdocumento) - 1)) & ")  And idEmpresa = '" & rscd.Fields("idEmpresa") & "' And idSucursal = '" & rscd.Fields("idSucursal") & "' " & _
                    "Group By idEmpresa,idSucursal "
       
            If rsv.State = adStateOpen Then rsv.Close
            rsv.Open cmysql, Cn, adOpenKeyset, adLockOptimistic
        
            'Datos del Producto de Servicio
            csql = "Select * From Productos p Left Join Marcas m On p.idMarca = m.idMarca  And p.idEmpresa = m.idEmpresa Inner Join UnidadMedida u On p.idUMVenta = u.idUM Where idProducto = '" & ccodproparam & "' And p.idEmpresa  = '" & glsEmpresa & "' "
            
            If rst.State = adStateOpen Then rst.Close
            rst.Open csql, Cn, adOpenKeyset, adLockOptimistic
            rsg.AddNew
            i = i + 1
            rsg.Fields("Item") = i
            rsg.Fields("idProducto") = "" & rst.Fields("idProducto")
            rsg.Fields("idCodFabricante") = "" & rst.Fields("idFabricante")
            rsg.Fields("GlsProducto") = "" & rst.Fields("GlsProducto")
            rsg.Fields("idMarca") = "" & rst.Fields("idMarca")
            rsg.Fields("GlsMarca") = "" & rst.Fields("GlsMarca")
            rsg.Fields("idUM") = "" & rst.Fields("idUM")
            rsg.Fields("GlsUM") = "" & rst.Fields("GlsUM")
            rsg.Fields("Factor") = "01"
            rsg.Fields("Afecto") = "01"
            rsg.Fields("idTipoProducto") = "" & rst.Fields("idTipoProducto")
            rsg.Fields("idMoneda") = "" & rst.Fields("idMoneda")
            rsg.Fields("CodigoRapido") = "" & rst.Fields("CodigoRapido")
            rsg.Fields("idTallaPeso") = Val("" & rst.Fields("idTallaPeso"))
            rsg.Fields("VVUnit") = (Val("" & rsv.Fields("TotalValorVenta")) * traerCampo("Parametros", "ValParametro", "GlsParametro", "PORCENTAJE_FACTURACION", True) / 100)
            rsg.Fields("IGVUnit") = 0
            rsg.Fields("PVUnit") = 0
            rsg.Fields("VVUnitLista") = 0
            rsg.Fields("PVUnitLista") = 0
            rsg.Fields("VVUnitNeto") = 0
            rsg.Fields("PVUnitNeto") = 0
            rsg.Fields("Cantidad") = 1
            rsg.Fields("Cantidad2") = 0
            rsg.Fields("TotalVVBruto") = 0
            rsg.Fields("TotalPVBruto") = 0
            rsg.Fields("PorDcto") = 0
            rsg.Fields("DctoVV") = 0
            rsg.Fields("DctoPV") = 0
            rsg.Fields("TotalVVNeto") = 0
            rsg.Fields("TotalIGVNeto") = 0
            rsg.Fields("TotalPVNeto") = 0
            rsg.Fields("CantidadAnt") = 0
            rsg.Fields("Simbolo1") = lbl_SimbMonBruto.Caption
            rsg.Fields("Simbolo2") = lbl_SimbMonBruto.Caption
            rsg.Fields("Simbolo3") = "%"
            rsg.Fields("ItemPro") = Val("" & rst.Fields("ItemPro"))
            rsg.Fields("IdCentroCosto") = ""
            rsg.Fields("GlsPlaca") = ""
            rsg.Fields("IdSucursalPres") = ""
            rsg.Fields("IdDocumentoPres") = ""
            rsg.Fields("IdSeriePres") = ""
            rsg.Fields("IdDocVentasPres") = ""
            rsg.Fields("IdUPCliente") = ""
            rsg.Fields("IvapUnit") = 0
            rsg.Fields("TotalIvapNeto") = 0
            rsg.Fields("GlsProveedor") = ""
            rsg.Fields("CostoS") = 0
            rsg.Fields("CostoSInc") = 0
            rsg.Fields("CostoD") = 0
            rsg.Fields("Margen") = 0
        End If
        
        '---- Documentos de referencia
        If RsD.RecordCount = 0 Then
        
            RsD.AddNew
            RsD.Fields("Item") = 1
            RsD.Fields("idDocumento") = ""
            RsD.Fields("GlsDocumento") = ""
            RsD.Fields("idSerie") = ""
            RsD.Fields("idNumDOc") = ""
            RsD.Fields("EmpresaReferencia") = ""
            RsD.Fields("SucursalReferencia") = ""
            RsD.Fields("IndImportado") = "0"
            
        End If
    
        mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
        If StrMsgError <> "" Then GoTo Err
  
        mostrarDatosGridSQL gDetalle, rsg, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        '---- Recalculamos totales por fila
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            gDetalle.Dataset.Edit
            calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, gDetalle.Columns.ColumnByFieldName("VVUnit").Value, gDetalle.Columns.ColumnByFieldName("IGVUnit").Value, gDetalle.Columns.ColumnByFieldName("PVUnit").Value, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            gDetalle.Dataset.Post
            gDetalle.Dataset.Next
        Loop
        
        '---- Calculamos totales
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
                        
        If traerCampo("parametros", "valparametro", "GLSPARAMETRO", "VIZUALIZA_SON", True) = "S" Then
            lbl_TotalLetras.Caption = "SON:" & Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        Else
            lbl_TotalLetras.Caption = Cadenanum(Format(txt_TotalNeto.Value, "0.00"), txtGls_Moneda.Text)
        End If
        
        txt_MontoLetras.Text = lbl_TotalLetras.Caption
        indCargando = False
    End If
    Me.Refresh
    
    Exit Sub

Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
End Sub

Private Sub anularDocEmpresas(ByRef StrMsgError As String)
On Error GoTo Err
Dim rst                 As New ADODB.Recordset
Dim rsCta_Mvto          As New ADODB.Recordset
Dim rs                  As New ADODB.Recordset
Dim RScTA_dCTO          As New ADODB.Recordset
Dim iniTrans            As Boolean
Dim strNumVale          As String
Dim strMovCaja          As String
Dim strCodUsuarioAutorizacion As String
Dim cabrev              As String
Dim cdocumento          As String
Dim Cta_Dcto            As String
Dim numFactura          As String
Dim serieFactura        As String
Dim estFactura          As String
Dim idmovcaja           As String
Dim idFormaPago         As String
Dim IndEvaluacion       As Integer
Dim idValeDocventas     As String
Dim strTipoVale         As String
Dim Pagos As Integer

    '---- Verificamos si el mes esta cerrado
    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
    If StrMsgError <> "" Then GoTo Err

    idValeDocventas = Trim("" & traerCampo("docventas", "idValesCab", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoVale = Trim("" & traerCampo("docventas", "tipoVale", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))

    If MsgBox("Seguro de Anular el Documento", vbQuestion + vbYesNo, App.Title) = vbYes Then
        
        If strTipoDoc = "86" Then
            '---- Buscamos la factura q esta amarrada
            If gDocReferencia.Count > 0 Then
                gDocReferencia.Dataset.First
                Do While Not gDocReferencia.Dataset.EOF
                    If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                        numFactura = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                        serieFactura = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                        Exit Do
                    End If
                    gDocReferencia.Dataset.Next
                Loop
            End If
            
            '---- Verificamos el estado de la factura
            estFactura = traerCampo("docventas", "estDocVentas", "iddocventas", numFactura, True, " iddocumento = '01' and idSerie = '" & serieFactura & "' ")
            If estFactura = "IMP" Then
                StrMsgError = "La factura ya fue impresa, no se puede anular la Guia"
                GoTo Err
            End If
            
            '---- Verificamos si la factura tiene pagos
            idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and idDocumento = '01' and idTipoMovCaja = '99990002'")
            cabrev = "Fac"
            cdocumento = cabrev & serieFactura & "/" & numFactura
            Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
            Pagos = Val(traerCampo("Cta_Mvto", "count(*)", "idCta_Dcto", Cta_Dcto, True))
            idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
            If idFormaPago <> "06090001" And idFormaPago <> "06090004" And Pagos <> 0 Then
               StrMsgError = "No se puede anular el documento porque esta cancelado en cuentas por cobrar"
               GoTo Err
            End If
        End If
        
        IndEvaluacion = 0
    
        frmAprobacion.MostrarForm "01", IndEvaluacion, strCodUsuarioAutorizacion, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        If IndEvaluacion = 0 Then Exit Sub
            
        Cn.BeginTrans
        iniTrans = True
    
        If strTipoDoc = "86" Then
            '---- Anulamos la factura de ctas por cobrar
            csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
            If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
            rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            Do While Not rsCta_Mvto.EOF
                csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                         "from cta_dcto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
                If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
                RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                Do While Not RScTA_dCTO.EOF
                    If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                        csql = "delete from cta_dcto " & _
                               "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                    Else
                        If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                            If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                            If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        End If
                    End If
                    Cn.Execute (csql)
                    RScTA_dCTO.MoveNext
                Loop
                
                csql = "delete from cta_mvto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
                Cn.Execute csql
                
                rsCta_Mvto.MoveNext
            Loop
            csql = "UPDATE CTA_DCTO SET VALTOTAL = 0, VALTOTALORI = 0,VALSALDO = 0 " & _
                     "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
                     "and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            
            '---- Anulamos la factura de Docventas
            csql = "UPDATE docventas SET estDocventas = 'ANU',FechaAnulacion = '" & Format(Date, "yyyy-mm-dd") & Space(2) & Format(Time, "h:mm:ss") & "', idUsuarioAnulacion = '" & strCodUsuarioAutorizacion & _
                    "' WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
                    "' AND idDocumento = '01' AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
            Cn.Execute csql
            
            '---- Anulando el ingreso a caja
            csql = "UPDATE movcajasdet SET estMovCajaDet = 'ANU' " & _
                   "WHERE idMovCaja = '" & idmovcaja & "' " & _
                     "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '01' " & _
                     "AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
            Cn.Execute csql
        
            '---- Eliminamos del pagosDocVentas
            csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                    "AND idDocumento = '01' and idDocVentas = '" & numFactura & "' and idSerie = '" & serieFactura & "'"
            Cn.Execute csql

        End If
        
        '---- Anulando el Documento
        csql = "UPDATE docventas SET estDocventas = 'ANU', idUsuarioAnulacion = '" & strCodUsuarioAutorizacion & _
              "' WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
              "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
              "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
        
        '----------------------------------------------------------------------------------
        '---- ANULAR DE CTASXCOBRAR MYSQL
        cabrev = traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False)
        cdocumento = cabrev & Trim("" & txt_Serie.Text) & "/" & Format(txt_NumDoc.Text, "00000000")
        'cdocumento = cabrev & Format(txt_Serie.Text, "000") & "/" & Format(txt_NumDoc.Text, "00000000")
        Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
            
        If cabrev = "Cre" Then
            csql = "select idCta_Comp as idCta_Dcto, idCta_Dcto as idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Comp = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        Else
            csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                     "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        End If
        If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
        rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
        If Not rsCta_Mvto.EOF Then
            
            idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", txt_NumDoc.Text, True, "idSerie = '" & txt_Serie.Text & "' and idDocumento = '" & strTipoDoc & "' and idTipoMovCaja = '99990002'")
            idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
            
            If idFormaPago <> "06090001" And idFormaPago <> "06090004" Then
               StrMsgError = "No se puede anular el documento porque esta cancelado en cuentas por cobrar"
               GoTo Err
            End If
            
            Do While Not rsCta_Mvto.EOF
                csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                         "from cta_dcto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "'"
                If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
                RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
                
                Do While Not RScTA_dCTO.EOF
                    If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                        csql = "delete from cta_dcto " & _
                                 "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "'"
                    Else
                        If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                            If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                            If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            Else
                                csql = "update cta_dcto " & _
                                         "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                         "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                         "and idEmpresa = '" & glsEmpresa & "' "
                            End If
                        End If
                    End If
                    Cn.Execute (csql)
                    RScTA_dCTO.MoveNext
                Loop
                
                If cabrev = "Cre" Then
                    csql = "delete from cta_mvto " & _
                             "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                             "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                             "and idEmpresa = '" & glsEmpresa & "' "
                Else
                    csql = "delete from cta_mvto " & _
                             "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                             "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                             "and idEmpresa = '" & glsEmpresa & "' "
                End If
                Cn.Execute csql
                rsCta_Mvto.MoveNext
            Loop
            
        End If
        
        csql = "UPDATE CTA_DCTO SET VALTOTAL = 0, VALTOTALORI = 0,VALSALDO = 0 " & _
                 "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
                 "and idEmpresa = '" & glsEmpresa & "' "
        Cn.Execute csql
        
        '----------------------------------------------------------------------------------
      
        '---- Anulando el ingreso a caja
        strMovCaja = traerCampo("movcajasdet", "idMovCaja", "idSucursal", glsSucursal, True, "idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & "' and idSerie = '" & Trim(txt_Serie.Text) & "'")
        csql = "UPDATE movcajasdet SET estMovCajaDet = 'ANU' " & _
                 "WHERE idMovCaja = '" & strMovCaja & "' " & _
                 "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' " & _
                 "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' AND idSerie = '" & Trim(txt_Serie.Text) & "' "
        Cn.Execute csql

        '---- Eliminamos del pagosDocVentas
        csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                "AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
                "AND idSerie = '" & Trim(txt_Serie.Text) & "'"
        Cn.Execute csql
        
        If strTipoDoc = "01" Then
            '---- Buscamos la factura q esta amarrada
            If gDocReferencia.Count > 0 Then
                gDocReferencia.Dataset.First
                Do While Not gDocReferencia.Dataset.EOF
                    If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                        csql = "update docventas set estDocVentas = 'GEN' " & _
                                 "where idEmpresa = '" & glsEmpresa & "' and iddocumento = '86' " & _
                                 "and idserie = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' " & _
                                 "and iddocventas = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' "
                        Cn.Execute csql
                        
                        Exit Do
                    End If
                    gDocReferencia.Dataset.Next
                Loop
            End If
        End If
        
            '---- Eliminamos las referencias
            '---- Eliminamos las referencias
            csql = "DELETE FROM Docreferenciaempresas " & _
                     "WHERE idEmpresaOrigen = '" & glsEmpresa & "' " & _
                     "AND idSucursalOrigen = '" & glsSucursal & "' " & _
                     "AND tipoDocOrigen = '" & strTipoDoc & "' " & _
                     "AND numDocOrigen = '" & Trim(txt_NumDoc.Text) & "' " & _
                     "AND serieDocOrigen = '" & Trim(txt_Serie.Text) & "' "
            Cn.Execute csql
            
            gDocReferencia.Dataset.First
            If Not gDocReferencia.Dataset.EOF Then
                Do While Not gDocReferencia.Dataset.EOF
                     csql = "DELETE FROM Docreferenciaempresasdet " & _
                     "WHERE idEmpresaReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("EmpresaReferencia").Value & "' " & _
                     "AND idSucursalReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("SucursalReferencia").Value & "' " & _
                     "AND tipoDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value & "' " & _
                     "AND numDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' " & _
                     "AND serieDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' "
                    Cn.Execute csql
                    gDocReferencia.Dataset.Next
                Loop
            End If
        
        
        
        Cn.CommitTrans
        
        AsientoContableVentas StrMsgError, "A"
        If StrMsgError <> "" Then GoTo Err
            
        '---- Cambiando valores a variables
        strEstDocVentas = "ANU"
        lblDoc.ForeColor = &HFF&
        lblDoc.Caption = lblDoc.Caption & " - ANULADA"
        fraGeneral.Enabled = False
        'fraDetalle.Enabled = False
        Activa_Desc_Grid True

        listaDocVentas StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        habilitaBotones 6, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
    End If
    
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    
    Exit Sub
    
Err:
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    If iniTrans Then Cn.RollbackTrans
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub eliminardocEmpresas(ByRef StrMsgError As String)
On Error GoTo Err
Dim rsValida            As New ADODB.Recordset
Dim rscta               As New ADODB.Recordset
Dim rsCta_Mvto          As New ADODB.Recordset
Dim RScTA_dCTO          As New ADODB.Recordset
Dim rs                  As New ADODB.Recordset
Dim rst                 As New ADODB.Recordset
Dim indTrans            As Boolean
Dim strCodVale          As String
Dim strNumMovCaja       As String
Dim cabrev              As String
Dim cdocumento          As String
Dim cbusca              As String
Dim numFactura          As String
Dim serieFactura        As String
Dim estFactura          As String
Dim idFormaPago         As String
Dim Cta_Dcto            As String
Dim idmovcaja           As String
Dim strMovCaja          As String
Dim IndEvaluacion       As Integer
Dim Pagos               As Integer
Dim idValeDocventas     As String
Dim strTipoVale         As String

    getEstadoCierreMes Format(dtp_Emision.Value, "dd/mm/yyyy"), StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    If MsgBox("¿Seguro de eliminar el documento?" & vbCrLf & "Se eliminaran todas sus dependencias.", vbQuestion + vbYesNo, App.Title) = vbNo Then Exit Sub
        
    idValeDocventas = Trim("" & traerCampo("docventas", "idValesCab", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    strTipoVale = Trim("" & traerCampo("docventas", "tipoVale", "iddocventas", txt_NumDoc.Text, True, " idserie = '" & txt_Serie.Text & "' and iddocumento = '" & strTipoDoc & "' and idsucursal = '" & glsSucursal & "' "))
    
    If strTipoDoc = "86" Then
        '---- Buscamos la factura q esta amarrada
        If gDocReferencia.Count > 0 Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "01" Then
                    numFactura = gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value
                    serieFactura = gDocReferencia.Columns.ColumnByFieldName("idSerie").Value
                    Exit Do
                End If
                gDocReferencia.Dataset.Next
            Loop
        End If
            
        '---- Verificamos el estado de la factura
        estFactura = traerCampo("docventas", "estDocVentas", "iddocventas", numFactura, True, " iddocumento = '01' and idSerie = '" & serieFactura & "' ")
        If estFactura = "IMP" Then
            StrMsgError = "La factura ya fue impresa, no se puede eliminar la Guia"
            GoTo Err
        End If
            
        '---- Verificamos si la factura tiene pagos
        idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", numFactura, True, "idSerie = '" & serieFactura & "' and idDocumento = '01' and idTipoMovCaja = '99990002'")
        cabrev = "Fac"
        cdocumento = cabrev & serieFactura & "/" & numFactura
        Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
        Pagos = Val(traerCampo("Cta_Mvto", "count(*)", "idCta_Dcto", Cta_Dcto, True))
        idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
        If idFormaPago <> "06090001" And idFormaPago <> "06090004" And Pagos <> 0 Then
           StrMsgError = "No se puede eliminar el documento porque esta cancelado en cuentas por cobrar"
           GoTo Err
        End If
    End If
        
    Cn.BeginTrans
    indTrans = True
    
    '---- ELIMINANDO
    If strTipoDoc = "86" Then
        '---- Eliminamos la factura de ctas por cobrar
        csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
        rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
        Do While Not rsCta_Mvto.EOF
            csql = "select idCta_Dcto, Nro_Comp, idMoneda from cta_dcto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' and idEmpresa = '" & glsEmpresa & "'"
            If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
            RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            Do While Not RScTA_dCTO.EOF
                If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                    csql = "delete from cta_dcto where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                Else
                    If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                        If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                        If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    End If
                End If
                Cn.Execute (csql)
                RScTA_dCTO.MoveNext
            Loop
            
            csql = "delete from cta_mvto where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                     "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' and idEmpresa = '" & glsEmpresa & "' "
            Cn.Execute csql
            
            rsCta_Mvto.MoveNext
        Loop
        csql = "delete from CTA_DCTO WHERE IDCTA_DCTO = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
        Cn.Execute csql
        
        '---- Eliminamos la factura de Docventas
        csql = "delete from docventas " & _
                " WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
                "' AND idDocumento = '01' AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
        Cn.Execute csql
        
        '---- Eliminamos el ingreso a caja
        csql = "delete from movcajasdet " & _
                 "WHERE idMovCaja = '" & idmovcaja & "' " & _
                 "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '01' " & _
                 "AND idDocVentas = '" & numFactura & "' AND idSerie = '" & serieFactura & "'"
        Cn.Execute csql
    
        '---- Eliminamos del pagosDocVentas
        csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
                "AND idDocumento = '01' and idDocVentas = '" & numFactura & "' and idSerie = '" & serieFactura & "'"
        Cn.Execute csql
 
    End If
    
    '---- Eliminamos el Documento
    csql = "delete from docventas " & _
          " WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
          "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
          "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    csql = "delete from docventasdet " & _
             "WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & _
             "' AND idDocumento = '" & strTipoDoc & "' and idDocVentas = '" & Trim(txt_NumDoc.Text) & _
             "' and idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    '----------------------------------------------------------------------------------
    '---- ELIMINA DE CTASXCOBRAR MYSQL
    cabrev = traerCampo("documentos", "AbreDocumento", "idDocumento", strTipoDoc, False)
    cdocumento = cabrev & Trim("" & txt_Serie.Text) & "/" & Format(txt_NumDoc.Text, "00000000")
    'cdocumento = cabrev & Format(txt_Serie.Text, "000") & "/" & Format(txt_NumDoc.Text, "00000000")
    Cta_Dcto = traerCampo("Cta_Dcto", "idCta_Dcto", "Nro_Comp", cdocumento, True)
    
    If cabrev = "Cre" Then
        csql = "select idCta_Comp as idCta_Dcto, idCta_Dcto as idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Comp = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
    Else
        csql = "select idCta_Dcto, idCta_Comp, ValImputaSO, ValImputaDO, ValTipoCambio " & _
                 "from cta_mvto where idCta_Dcto = '" & Cta_Dcto & "' and idEmpresa = '" & glsEmpresa & "' "
    End If
    If rsCta_Mvto.State = 1 Then rsCta_Mvto.Close
    rsCta_Mvto.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
        
    If Not rsCta_Mvto.EOF Then
        
        idFormaPago = traerCampo("movcajasdet", "idFormadePago", "iddocventas", txt_NumDoc.Text, True, "idSerie = '" & txt_Serie.Text & "' and idDocumento = '" & strTipoDoc & "' and idTipoMovCaja = '99990002'")
        idFormaPago = traerCampo("formaspagos", "idTipoFormaPago", "idFormaPago", idFormaPago, True)
        
        If idFormaPago <> "06090001" And idFormaPago <> "06090004" Then
           StrMsgError = "No se puede eliminar el documento porque esta cancelado en cuentas por cobrar"
           GoTo Err
        End If
            
        Do While Not rsCta_Mvto.EOF
            csql = "select idCta_Dcto, Nro_Comp, idMoneda " & _
                     "from cta_dcto " & _
                     "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                     "and idEmpresa = '" & glsEmpresa & "'"
            If RScTA_dCTO.State = 1 Then RScTA_dCTO.Close
            RScTA_dCTO.Open csql, Cn, adOpenForwardOnly, adLockReadOnly
            
            Do While Not RScTA_dCTO.EOF
                If left(RScTA_dCTO.Fields("Nro_Comp"), 3) = "Efe" Then
                    csql = "delete from cta_dcto " & _
                             "where idcta_dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' and idEmpresa = '" & glsEmpresa & "'"
                Else
                    If RScTA_dCTO.Fields("idMoneda") = "PEN" Then
                        If rsCta_Mvto.Fields("ValImputaSO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaSO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaDO") * rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    ElseIf RScTA_dCTO.Fields("idMoneda") = "USD" Then
                        If rsCta_Mvto.Fields("ValImputaDO") <> 0 Then
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & rsCta_Mvto.Fields("ValImputaDO") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        Else
                            csql = "update cta_dcto " & _
                                     "set ValSaldo = ValSaldo + " & Format(rsCta_Mvto.Fields("ValImputaSO") / rsCta_Mvto.Fields("ValTipoCambio"), "0.00") & " " & _
                                     "where idCta_Dcto = '" & RScTA_dCTO.Fields("idCta_Dcto") & "' " & _
                                     "and idEmpresa = '" & glsEmpresa & "' "
                        End If
                    End If
                End If
                Cn.Execute (csql)
                RScTA_dCTO.MoveNext
            Loop
            If cabrev = "Cre" Then
                csql = "delete from cta_mvto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
            Else
                csql = "delete from cta_mvto " & _
                         "where idCta_Dcto = '" & rsCta_Mvto.Fields("idCta_Dcto") & "' " & _
                         "and idCta_Comp = '" & rsCta_Mvto.Fields("idCta_Comp") & "' " & _
                         "and idEmpresa = '" & glsEmpresa & "' "
            End If
            Cn.Execute csql
            rsCta_Mvto.MoveNext
        Loop
        
    End If
    
    csql = "delete from CTA_DCTO " & _
             "WHERE IDCTA_DCTO = '" & Cta_Dcto & "' " & _
             "and idEmpresa = '" & glsEmpresa & "' "
    Cn.Execute csql
    '----------------------------------------------------------------------------------
    
    csql = "delete from movcajasdet " & _
             "WHERE idMovCaja = '" & strMovCaja & "' " & _
             "AND idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' AND idDocumento = '" & strTipoDoc & "' " & _
             "AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' AND idSerie = '" & Trim(txt_Serie.Text) & "' "
    Cn.Execute csql

    '---- Eliminamos del pagosDocVentas
    csql = "delete from pagosDocVentas WHERE idEmpresa = '" & glsEmpresa & "' AND idSucursal = '" & glsSucursal & "' " & _
            "AND idDocumento = '" & strTipoDoc & "' AND idDocVentas = '" & Trim(txt_NumDoc.Text) & "' " & _
            "AND idSerie = '" & Trim(txt_Serie.Text) & "'"
    Cn.Execute csql
    
    If strTipoDoc = "01" Then
        '---- Buscamos la factura q esta amarrada
        If gDocReferencia.Count > 0 Then
            gDocReferencia.Dataset.First
            Do While Not gDocReferencia.Dataset.EOF
                If gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value = "86" Then
                    csql = "update docventas set estDocVentas = 'GEN' " & _
                             "where idEmpresa = '" & glsEmpresa & "' and iddocumento = '86' " & _
                             "and idserie = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' " & _
                             "and iddocventas = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' "
                    Cn.Execute csql
                    
                    Exit Do
                End If
                gDocReferencia.Dataset.Next
            Loop
        End If
    End If
    
    '---- Eliminamos las referencias
    '---- Eliminamos las referencias
    csql = "DELETE FROM Docreferenciaempresas " & _
             "WHERE idEmpresaOrigen = '" & glsEmpresa & "' " & _
             "AND idSucursalOrigen = '" & glsSucursal & "' " & _
             "AND tipoDocOrigen = '" & strTipoDoc & "' " & _
             "AND numDocOrigen = '" & Trim(txt_NumDoc.Text) & "' " & _
             "AND serieDocOrigen = '" & Trim(txt_Serie.Text) & "' "
    Cn.Execute csql
    
    gDocReferencia.Dataset.First
    If Not gDocReferencia.Dataset.EOF Then
        Do While Not gDocReferencia.Dataset.EOF
             csql = "DELETE FROM Docreferenciaempresasdet " & _
             "WHERE idEmpresaReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("EmpresaReferencia").Value & "' " & _
             "AND idSucursalReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("SucursalReferencia").Value & "' " & _
             "AND tipoDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idDocumento").Value & "' " & _
             "AND numDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idNumDoc").Value & "' " & _
             "AND serieDocReferencia = '" & gDocReferencia.Columns.ColumnByFieldName("idSerie").Value & "' "
            Cn.Execute csql
            gDocReferencia.Dataset.Next
        Loop
    End If
 
    Cn.CommitTrans
    
    AsientoContableVentas StrMsgError, "E"
    If StrMsgError <> "" Then GoTo Err
            
    '---- Nuevo
    Toolbar1_ButtonClick Toolbar1.Buttons(1)
    MsgBox "Registro eliminado satisfactoriamente", vbInformation, App.Title
    If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing

    Exit Sub
    
Err:
    If rsValida.State = 1 Then rsValida.Close: Set rsValida = Nothing
    If indTrans Then Cn.RollbackTrans
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub Activa_Desc_Grid(SwColum As Boolean)

    gDetalle.Columns.ColumnByFieldName("item").DisableEditor = True
    gDetalle.Columns.ColumnByFieldName("idProducto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idCodFabricante").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("GlsProducto").DisableEditor = True
    gDetalle.Columns.ColumnByFieldName("idMarca").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("GlsMarca").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idUM").DisableEditor = True
    gDetalle.Columns.ColumnByFieldName("GlsUM").DisableEditor = True
    gDetalle.Columns.ColumnByFieldName("Factor").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("Afecto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("cantidad").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("VVUnit").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("IGVUnit").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("PVUnit").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("TotalVVBruto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("TotalPVBruto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("PorDcto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("DctoVV").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("DctoPV").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("TotalVVNeto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("TotalIGVNeto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("TotalPVNeto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idTipoProducto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idMoneda").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idDocumentoImp").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idDocVentasImp").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idSerieImp").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("FecVencProd").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idUsuarioDcto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("VVUnitLista").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("PVUnitLista").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("VVUnitNeto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("PVUnitNeto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("cantidad2").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("CodigoRapido").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("NumLote").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idLote").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("idTallaPeso").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("IdFormula").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("CantidadAnt").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("simbolo1").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("simbolo2").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("simbolo3").DisableEditor = SwColum
    
    gDetalle.Columns.ColumnByFieldName("GlsProveedor").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("CostoS").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("CostoSInc").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("CostoD").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("Margen").DisableEditor = SwColum
'    If Trim(traerCampo("Parametros", "ValParametro", "GlsParametro", "LIQUIDACIONES", True) & "") = "S" Then
'        gDetalle.Columns.ColumnByFieldName("idLiquidacion").DisableEditor = False
'    Else
'        gDetalle.Columns.ColumnByFieldName("idLiquidacion").DisableEditor = SwColum
'    End If
        
    gDetalle.Columns.ColumnByFieldName("itemPro").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("IdCentroCosto").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("IdSeriePres").DisableEditor = SwColum
    gDetalle.Columns.ColumnByFieldName("IdDocVentasPres").DisableEditor = SwColum
    
End Sub

Private Sub Acumula_Facturado(StrMsgError As String, PIdCentroCosto As String, PItem As Long, PTotFacHC)
Dim RsGrid                          As New ADODB.Recordset
Dim RsGridC                         As New ADODB.Recordset
On Error GoTo Err
    
    Set RsGrid = gDetalle.DataSource
    Set RsGridC = RsGrid.Clone(adLockReadOnly)
    
    RsGridC.Filter = "IdCentroCosto = '" & PIdCentroCosto & "' And Item <> " & PItem & ""
    Do While Not RsGridC.EOF
        PTotFacHC = PTotFacHC + Val("" & RsGridC.Fields("TotalVVNeto"))
        RsGridC.MoveNext
    Loop
    RsGridC.Close: Set RsGridC = Nothing
    
    Exit Sub
    
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Function DatosPrecioUltimaVenta(ByVal StrMsgError As String, ByVal strCodProd As String, ByVal strTipoProd As String, ByVal strCodUM As String, ByRef strglsum As String, ByRef dblVVUnit As Double, ByRef dblFactor As Double) As Boolean
Dim rst As New ADODB.Recordset
On Error GoTo Err

    Set rst = DataProcedimiento("Spu_InsertProductosxCliente", StrMsgError, glsEmpresa, glsSucursal, strTipoDoc, txt_Serie.Text, txt_NumDoc.Text, strCodProd, "", strCodUM, txt_TipoCambio.Text, strTipoProd, txtCod_Lista.Text, "S")
    If StrMsgError <> "" Then GoTo Err

    If Not rst.EOF Then
        DatosPrecioUltimaVenta = True
        strglsum = "" & rst.Fields("GlsUM")
        dblVVUnit = "" & rst.Fields("VVUnit")
        dblFactor = "" & rst.Fields("Factor")
    Else
        DatosPrecioUltimaVenta = False
        strglsum = ""
        dblVVUnit = 0
        dblFactor = 1
    End If
    rst.Close: Set rst = Nothing
    
    Exit Function
    
Err:
    If rst.State = 1 Then rst.Close: Set rst = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
End Function

Private Sub GDetalle_OnKeyUp(KeyCode As Integer, ByVal Shift As Long)
Dim StrMsgError         As String
On Error GoTo Err


    If KeyCode = 113 And SwF2 = True Then
        gdetalle_OnEditButtonClick gDetalle.Columns.FocusedColumn, Nothing
        SwF2 = False
    Else
        SwF2 = True
    End If

    Exit Sub

Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
    Exit Sub
End Sub

Private Sub InsertaItemAutomatico(StrMsgError As String, PIdProducto As String)
On Error GoTo Err
Dim dblVVUnit               As Double
Dim dblIGVUnit              As Double
Dim dblPVUnit               As Double
Dim dblFactor               As Double
Dim CArray(7)               As String
Dim strMoneda               As String

    traerCampos "Productos", "GlsProducto,CodigoRapido,IdFabricante,IdMarca,AfectoIgv,IdTipoProducto,IdUMCompra", "IdProducto", PIdProducto, 7, CArray, True
    
    gDetalle.SetFocus
    gDetalle.Dataset.Edit
    gDetalle.Columns.ColumnByFieldName("idProducto").Value = PIdProducto
    gDetalle.Columns.ColumnByFieldName("GlsProducto").Value = CArray(0)
    gDetalle.Columns.ColumnByFieldName("CodigoRapido").Value = CArray(1)
    gDetalle.Columns.ColumnByFieldName("idTallaPeso").Value = 0
    
    strMoneda = traerCampo("Listaprecios", "idMoneda", "idLista", txtCod_Lista.Text, True)
    gDetalle.Columns.ColumnByFieldName("idCodFabricante").Value = CArray(2)
    gDetalle.Columns.ColumnByFieldName("idMarca").Value = CArray(3)
    gDetalle.Columns.ColumnByFieldName("GlsMarca").Value = traerCampo("Marcas", "GlsMarca", "IdMarca", CArray(3), True)
    gDetalle.Columns.ColumnByFieldName("Afecto").Value = CArray(4)
    gDetalle.Columns.ColumnByFieldName("idTipoProducto").Value = CArray(5)
    gDetalle.Columns.ColumnByFieldName("idMoneda").Value = strMoneda 'falta esta columna en el detalle de la grilla
    gDetalle.Columns.ColumnByFieldName("Cantidad").Value = 1
    
    If DatosPrecio(Trim("" & PIdProducto), CArray(5), CArray(6), "", dblVVUnit, dblFactor) = False Then
    End If
        
    gDetalle.Columns.ColumnByFieldName("idUM").Value = CArray(6)
    gDetalle.Columns.ColumnByFieldName("GlsUM").Value = traerCampo("unidadMedida", "abreUM", "idUM", CArray(6), False)
    gDetalle.Columns.ColumnByFieldName("Factor").Value = 1
    
    procesaMoneda strMoneda, txtCod_Moneda.Text, 0, dblVVUnit, Val("" & CArray(4)), dblVVUnit, dblIGVUnit, dblPVUnit, 0, StrMsgError, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
    If StrMsgError <> "" Then GoTo Err
    
    gDetalle.Columns.ColumnByFieldName("VVUnit").Value = dblVVUnit
    gDetalle.Columns.ColumnByFieldName("IGVUnit").Value = dblIGVUnit
    gDetalle.Columns.ColumnByFieldName("PVUnit").Value = dblPVUnit
    gDetalle.Columns.ColumnByFieldName("VVUnitLista").Value = dblVVUnit
    gDetalle.Columns.ColumnByFieldName("PVUnitLista").Value = dblPVUnit
    
    gDetalle.Dataset.Post
    gDetalle.Dataset.Edit
    calculaTotalesFila gDetalle.Columns.ColumnByFieldName("Cantidad").Value, dblVVUnit, dblIGVUnit, dblPVUnit, gDetalle.Columns.ColumnByFieldName("PorDcto").Value, gDetalle.Columns.ColumnByFieldName("Afecto").Value, Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
    gDetalle.Dataset.Post
    
    calcularTotales StrMsgError
    If StrMsgError <> "" Then GoTo Err
    
    gDetalle.SetFocus

    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub MostrarAtencion(StrMsgError As String, PIdAtencion As String)
On Error GoTo Err
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
Dim RsD                             As New ADODB.Recordset
Dim rsg                             As New ADODB.Recordset
    
    CSqlC = "Select A.IdAtencion,A.IdCliente,B.GlsPlanTarifario,Date_Format(A.Fecha,'%d/%m/%Y') Fecha,ConCat(A.GlsApellidos,' ',A.GlsNombres) GlsPaciente," & _
            "A.IdCodigoUnico,A.GlsNumero_Poliza,A.GlsDX_Cliente,D.GlsMedico,D.IdCMP,E.GlsTipoServicio,B.TotalVenta," & _
            "IfNull(F.GlsPlanTarifario,'') GlsPlanTarifario2," & _
            "Cast(((((Time_Format(A.TiempoDemora,'%h') * 60) + Time_Format(A.TiempoDemora,'%i')) * IfNull(F.TotalVenta,0)) / 60) As Decimal(14,2)) TotalVenta2 " & _
            "From RegistroAtenciones A " & _
            "Inner Join PlanesTarifarios B " & _
                "On A.IdEmpresa = B.IdEmpresa And A.Item_Tarifario = B.IdPlanTarifario " & _
            "Inner Join Medicos D " & _
                "On A.IdEmpresa = D.IdEmpresa And A.IdMedico_Origen = D.IdMedico " & _
            "Inner Join TiposServicios E " & _
                "On A.IdEmpresa = E.IdEmpresa And A.IdTipoServicio = E.IdTipoServicio " & _
            "Left Join PlanesTarifarios F " & _
                "On A.IdEmpresa = F.IdEmpresa And A.Item_Tarifario2 = F.IdPlanTarifario " & _
            "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdAtencion = '" & PIdAtencion & "'"
            
    RsC.Open CSqlC, Cn, adOpenStatic, adLockOptimistic
    
    If Not RsC.EOF Then
    
        txtCod_Cliente.Text = Trim("" & RsC.Fields("IdCliente"))
        dtp_Emision.Value = Trim("" & RsC.Fields("Fecha"))
        
        rsg.Fields.Append "Item", adInteger, , adFldRowID
        rsg.Fields.Append "numOrdenCompra", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "idProducto", adVarChar, 20, adFldIsNullable
        rsg.Fields.Append "idCodFabricante", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "GlsProducto", adVarChar, 800, adFldIsNullable
        rsg.Fields.Append "idMarca", adChar, 8, adFldIsNullable
        rsg.Fields.Append "GlsMarca", adVarChar, 185, adFldIsNullable
        rsg.Fields.Append "idUM", adChar, 8, adFldIsNullable
        rsg.Fields.Append "GlsUM", adVarChar, 185, adFldIsNullable
        rsg.Fields.Append "Factor", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "Afecto", adInteger, 4, adFldIsNullable
        rsg.Fields.Append "Cantidad", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "Cantidad2", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "VVUnit", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "IGVUnit", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "PVUnit", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalVVBruto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalPVBruto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "PorDcto", adVarChar, 20, adFldIsNullable
        rsg.Fields.Append "DctoVV", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "DctoPV", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalVVNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalIGVNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalPVNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "idTipoProducto", adChar, 5, adFldIsNullable
        rsg.Fields.Append "idMoneda", adChar, 3, adFldIsNullable
        rsg.Fields.Append "idDocumentoImp", adVarChar, 2, adFldIsNullable
        rsg.Fields.Append "idDocVentasImp", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "idSerieImp", adVarChar, 4, adFldIsNullable
        rsg.Fields.Append "NumLote", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "IdLote", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "FecVencProd", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "idUsuarioDcto", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "VVUnitLista", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "PVUnitLista", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "VVUnitNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "PVUnitNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "CodigoRapido", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "idTallaPeso", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "CantidadAnt", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "Simbolo1", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "Simbolo2", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "Simbolo3", adVarChar, 30, adFldIsNullable
        rsg.Fields.Append "ItemPro", adInteger, , adFldRowID
        rsg.Fields.Append "IdCentroCosto", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "GlsPlaca", adVarChar, 15, adFldIsNullable
        rsg.Fields.Append "IdSucursalPres", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "IdDocumentoPres", adVarChar, 2, adFldIsNullable
        rsg.Fields.Append "IdSeriePres", adVarChar, 4, adFldIsNullable
        rsg.Fields.Append "IdDocVentasPres", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "IdUPCliente", adVarChar, 8, adFldIsNullable
        rsg.Fields.Append "IvapUnit", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "TotalIvapNeto", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "GlsProveedor", adVarChar, 150, adFldIsNullable
        rsg.Fields.Append "CostoS", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "CostoSInc", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "CostoD", adDouble, 14, adFldIsNullable
        rsg.Fields.Append "Margen", adInteger, adFldIsNullable
    
        rsg.Open
        
        InsertaDetalleAtencion StrMsgError, 1, rsg, RsC
        If StrMsgError <> "" Then GoTo Err
        
        If Len(Trim("" & RsC.Fields("GlsPlanTarifario2"))) > 0 Then
            
            InsertaDetalleAtencion StrMsgError, 2, rsg, RsC
            If StrMsgError <> "" Then GoTo Err
        
        End If
        
        mostrarDatosGridSQL gDetalle, rsg, StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        calcularTotales StrMsgError
        If StrMsgError <> "" Then GoTo Err
        
        RsD.Fields.Append "Item", adInteger, , adFldRowID
        RsD.Fields.Append "idDocumento", adChar, 2, adFldIsNullable
        RsD.Fields.Append "GlsDocumento", adVarChar, 185, adFldIsNullable
        RsD.Fields.Append "idSerie", adChar, 4, adFldIsNullable
        RsD.Fields.Append "idNumDOc", adChar, 8, adFldIsNullable
        RsD.Fields.Append "IndImportado", adChar, 1, adFldIsNullable
        
        RsD.Open , , adOpenKeyset, adLockOptimistic
        
        RsD.AddNew
        RsD.Fields("Item") = "" & RsD.RecordCount
        RsD.Fields("idDocumento") = "80"
        RsD.Fields("GlsDocumento") = traerCampo("documentos", "GlsDocumento", "idDocumento", "80", False)
        RsD.Fields("idSerie") = "999"
        RsD.Fields("idNumDOc") = "" & RsC.Fields("IdAtencion")
        RsD.Fields("IndImportado") = "1"
                    
        mostrarDatosGridSQL gDocReferencia, RsD, StrMsgError
        If StrMsgError <> "" Then GoTo Err
    
    End If
    
    RsC.Close: Set RsC = Nothing
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub InsertaDetalleAtencion(StrMsgError As String, NItem As Integer, rsg As ADODB.Recordset, RsC As ADODB.Recordset)
On Error GoTo Err
Dim CCodServicio                    As String
Dim CArray(9)                       As String

    CCodServicio = leeParametro("CODIGO_SERVICIO_ATENCIONES")
    
    rsg.AddNew
    rsg.Fields("Item") = rsg.RecordCount
    rsg.Fields("idProducto") = CCodServicio
    rsg.Fields("idCodFabricante") = ""
    
    If NItem = 1 Then
        rsg.Fields("GlsProducto") = Trim("" & RsC.Fields("GlsPlanTarifario")) & "  " & Chr(13) & Chr(10)
    Else
        rsg.Fields("GlsProducto") = Trim("" & RsC.Fields("GlsPlanTarifario2")) & "  " & Chr(13) & Chr(10)
    End If
    
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Fecha: " & Trim("" & RsC.Fields("Fecha")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Paciente: " & Trim("" & RsC.Fields("GlsPaciente")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Código: " & Trim("" & RsC.Fields("IdCodigoUnico")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Póliza: " & Trim("" & RsC.Fields("GlsNumero_Poliza")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & Trim("" & RsC.Fields("GlsDX_Cliente")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Médico: " & Trim("" & RsC.Fields("GlsMedico")) & " " & Trim("" & RsC.Fields("IdCMP")) & "  " & Chr(13) & Chr(10)
    rsg.Fields("GlsProducto") = rsg.Fields("GlsProducto") & "Servicio: " & Trim("" & RsC.Fields("GlsTipoServicio"))
    
    traerCampos "Productos A Inner Join Marcas B On A.IdEmpresa = B.IdEmpresa And A.IdMarca = B.IdMarca " & _
                "Inner Join UnidadMedida C On A.IdUMVenta = C.IdUM", _
    "A.IdMarca,B.GlsMarca,A.IdUMVenta,C.GlsUM,A.AfectoIgv,A.IdTipoProducto,A.IdMoneda,A.CodigoRapido,A.IdTallaPeso", "A.IdProducto", CCodServicio, 9, CArray, False, "A.IdEmpresa = '" & glsEmpresa & "'"
    
    rsg.Fields("idMarca") = CArray(0)
    rsg.Fields("GlsMarca") = CArray(1)
    rsg.Fields("idUM") = CArray(2)
    rsg.Fields("GlsUM") = CArray(3)
    rsg.Fields("Factor") = "1"
    rsg.Fields("Afecto") = CArray(4)
    rsg.Fields("idTipoProducto") = CArray(5)
    rsg.Fields("idMoneda") = CArray(6)
    rsg.Fields("idDocumentoImp") = "80"
    rsg.Fields("idDocVentasImp") = "" & RsC.Fields("IdAtencion")
    rsg.Fields("idSerieImp") = "999"
    rsg.Fields("NumLote") = ""
    rsg.Fields("IdLote") = ""
    rsg.Fields("FecVencProd") = getFechaSistema
    rsg.Fields("CodigoRapido") = CArray(7)
    rsg.Fields("idTallaPeso") = Val("" & CArray(8))
    
    If NItem = 1 Then
    
        rsg.Fields("PVUnit") = Val("" & RsC.Fields("TotalVenta"))
        rsg.Fields("PVUnitNeto") = Val("" & RsC.Fields("TotalVenta"))
        rsg.Fields("TotalPVBruto") = Val("" & RsC.Fields("TotalVenta"))
        rsg.Fields("TotalPVNeto") = Val("" & RsC.Fields("TotalVenta"))
    
    Else
    
        rsg.Fields("PVUnit") = Val("" & RsC.Fields("TotalVenta2"))
        rsg.Fields("PVUnitNeto") = Val("" & RsC.Fields("TotalVenta2"))
        rsg.Fields("TotalPVBruto") = Val("" & RsC.Fields("TotalVenta2"))
        rsg.Fields("TotalPVNeto") = Val("" & RsC.Fields("TotalVenta2"))
    
    End If
    
    If CArray(4) = "1" Then
        
        If NItem = 1 Then
        
            rsg.Fields("VVUnit") = Val("" & RsC.Fields("TotalVenta")) / (1 + glsIGV)
            rsg.Fields("VVUnitNeto") = Val("" & RsC.Fields("TotalVenta")) / (1 + glsIGV)
            rsg.Fields("TotalVVBruto") = Val("" & RsC.Fields("TotalVenta")) / (1 + glsIGV)
            rsg.Fields("TotalVVNeto") = Val("" & RsC.Fields("TotalVenta")) / (1 + glsIGV)
        
            rsg.Fields("IGVUnit") = Val("" & RsC.Fields("TotalVenta")) - (Val("" & RsC.Fields("TotalVenta")) / (1 + glsIGV))
                        
            rsg.Fields("TotalIGVNeto") = Val("" & RsC.Fields("TotalVenta")) * glsIGV
        
        Else
            
            rsg.Fields("VVUnit") = Val("" & RsC.Fields("TotalVenta2")) / (1 + glsIGV)
            rsg.Fields("VVUnitNeto") = Val("" & RsC.Fields("TotalVenta2")) / (1 + glsIGV)
            rsg.Fields("TotalVVBruto") = Val("" & RsC.Fields("TotalVenta2")) / (1 + glsIGV)
            rsg.Fields("TotalVVNeto") = Val("" & RsC.Fields("TotalVenta2")) / (1 + glsIGV)
        
            rsg.Fields("IGVUnit") = Val("" & RsC.Fields("TotalVenta2")) - (Val("" & RsC.Fields("TotalVenta2")) / (1 + glsIGV))
                        
            rsg.Fields("TotalIGVNeto") = Val("" & RsC.Fields("TotalVenta2")) * glsIGV
            
        End If
        
    Else
        
        If NItem = 1 Then
        
            rsg.Fields("VVUnit") = Val("" & RsC.Fields("TotalVenta"))
            rsg.Fields("VVUnitNeto") = Val("" & RsC.Fields("TotalVenta"))
            rsg.Fields("TotalVVBruto") = Val("" & RsC.Fields("TotalVenta"))
            rsg.Fields("TotalVVNeto") = Val("" & RsC.Fields("TotalVenta"))
        
        Else
            
            rsg.Fields("VVUnit") = Val("" & RsC.Fields("TotalVenta2"))
            rsg.Fields("VVUnitNeto") = Val("" & RsC.Fields("TotalVenta2"))
            rsg.Fields("TotalVVBruto") = Val("" & RsC.Fields("TotalVenta2"))
            rsg.Fields("TotalVVNeto") = Val("" & RsC.Fields("TotalVenta2"))
        
        End If
        
        rsg.Fields("IGVUnit") = 0
        rsg.Fields("TotalIGVNeto") = Val("0")
        
    End If
    
    rsg.Fields("VVUnitLista") = 1
    rsg.Fields("PVUnitLista") = 1
    rsg.Fields("ItemPro") = "1"
    rsg.Fields("IdCentroCosto") = ""
    rsg.Fields("GlsPlaca") = ""
    rsg.Fields("IdSucursalPres") = ""
    rsg.Fields("IdDocumentoPres") = ""
    rsg.Fields("IdSeriePres") = ""
    rsg.Fields("IdDocVentasPres") = ""
    rsg.Fields("IdUPCliente") = ""
    rsg.Fields("Cantidad") = 1
    rsg.Fields("Cantidad2") = 1
    
    rsg.Fields("PorDcto") = Val("0")
    rsg.Fields("DctoVV") = Val("0")
    rsg.Fields("DctoPV") = Val("0")
    
    rsg.Fields("CantidadAnt") = 1
    rsg.Fields("Simbolo1") = lbl_SimbMonBruto.Caption
    rsg.Fields("Simbolo2") = lbl_SimbMonBruto.Caption
    rsg.Fields("Simbolo3") = "%"
    rsg.Fields("IvapUnit") = 0
    rsg.Fields("TotalIvapNeto") = Val("0")
    rsg.Fields("GlsProveedor") = ""
    rsg.Fields("CostoS") = 0
    rsg.Fields("CostoSInc") = 0
    rsg.Fields("CostoD") = 0
    rsg.Fields("Margen") = 0
        
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub VerificaLineaCredito(StrMsgError As String, PIdCliente As String, PIndVencidos As Boolean, PIdUsuarioPase As String)
On Error GoTo Err
Dim cEstado                         As String
Dim CSqlC                           As String
Dim RsC                             As New ADODB.Recordset
Dim NImporteDocumento               As Double
Dim NImporteDocumentoG              As Double
Dim RsD                             As New ADODB.Recordset
Dim IndEvaluacion                   As Integer

    If Len(Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "MONEDA_LINEA_CREDITO", True))) > 0 Then 'Si tiene asignada la Moneda se entiende que debe controlar
        
        If (strTipoDoc = "01" Or strTipoDoc = "86" Or strTipoDoc = "08") Then
            
            If strTipoDoc = "86" Then
                
                If Val("" & traerCampo("MotivosTraslados", "IndEvaluaLC", "IdMotivoTraslado", txtCod_MotivoTraslado.Text, False)) <> 1 Then
                    
                    Exit Sub
                    
                End If
                
            End If
            
            CSqlC = "Select A.IndSuspension,A.Estado,A.Saldo,A.IdMoneda " & _
                    "From ControlLineaCredito A " & _
                    "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdCliente = '" & PIdCliente & "'"
            RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
            If Not RsC.EOF Then
                
                If Val("" & RsC.Fields("IndSuspension")) = 1 Then
                    
                    StrMsgError = "El Cliente se encuentra Suspendido": GoTo Err
                
                ElseIf Trim("" & RsC.Fields("Estado")) = "52000" Then
                    
                    If intBoton = 1 Then
                        
                        If strTipoDoc <> "86" And gDocReferencia.Dataset.RecordCount > 0 Then
                                
                            gDocReferencia.Dataset.First
                            
                            If gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value = "86" Then
                                
                                CSqlC = "Select A.IdMoneda,A.TotalPrecioVenta - Sum(IfNull(C.TotalPrecioVenta,0)) TotalPrecioVenta,A.TipoCambio " & _
                                        "From DocVentas A " & _
                                        "Left Join DocReferencia B " & _
                                            "On A.IdEmpresa = B.IdEmpresa And A.IdDocumento = B.TipoDocReferencia And A.IdSerie = B.SerieDocReferencia " & _
                                            "And A.IdDocVentas = B.NumDocReferencia " & _
                                        "Left Join DocVentas C " & _
                                            "On B.IdEmpresa = C.IdEmpresa And B.TipoDocOrigen = C.IdDocumento And B.SerieDocOrigen = C.IdSerie " & _
                                            "And B.NumDocOrigen = C.IdDocVentas " & _
                                        "Where A.IdEmpresa = '" & glsEmpresa & "' " & _
                                        "And A.IdDocumento = '" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value & "' " & _
                                        "And A.IdSerie = '" & gDocReferencia.Columns.ColumnByFieldName("IdSerie").Value & "' " & _
                                        "And A.IdDocVentas = '" & gDocReferencia.Columns.ColumnByFieldName("IdNumDoc").Value & "' " & _
                                        "Group By A.IdDocumento,A.IdSerie,A.IdDocVentas"
                                RsD.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                                If Not RsD.EOF Then
                                
                                    If Trim("" & RsD.Fields("IdMoneda")) = txtCod_Moneda.Text Then
                                        
                                        NImporteDocumentoG = Val("" & RsD.Fields("TotalPrecioVenta"))
                                    
                                    ElseIf txtCod_Moneda.Text = "PEN" Then
                                    
                                        NImporteDocumentoG = Val(Format(Val("" & RsD.Fields("TotalPrecioVenta")) * Val("" & RsD.Fields("TipoCambio")), "0.00"))
                                        
                                    ElseIf txtCod_Moneda.Text = "USD" Then
                                        
                                        NImporteDocumentoG = Val(Format(Val("" & RsD.Fields("TotalPrecioVenta")) / Val("" & RsD.Fields("TipoCambio")), "0.00"))
                                        
                                    End If
                                    
                                    If Val(Format(txt_TotalNeto.Text, "0.00")) > NImporteDocumentoG Then
                                            
                                        NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) - NImporteDocumentoG, "0.00"))
                                    
                                    Else
                                    
                                        NImporteDocumento = Val(Format(NImporteDocumentoG - Val(Format(txt_TotalNeto.Text, "0.00")), "0.00"))
                                        
                                    End If
                                    
                                End If
                                
                                RsD.Close: Set RsD = Nothing
                            
                            Else
                                
                                If Trim("" & RsC.Fields("IdMoneda")) = txtCod_Moneda.Text Then
                
                                    NImporteDocumento = Val(Format(txt_TotalNeto.Text, "0.00"))
                                
                                ElseIf Trim("" & RsC.Fields("IdMoneda")) = "PEN" Then
                                    
                                    NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) * Val("" & txt_TipoCambio.Text), "0.00"))
                                
                                ElseIf Trim("" & RsC.Fields("IdMoneda")) = "USD" Then
                                
                                    NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) / Val("" & txt_TipoCambio.Text), "0.00"))
                                
                                End If
                            
                            End If
                        
                        Else
                            
                            If Trim("" & RsC.Fields("IdMoneda")) = txtCod_Moneda.Text Then
                
                                NImporteDocumento = Val(Format(txt_TotalNeto.Text, "0.00"))
                            
                            ElseIf Trim("" & RsC.Fields("IdMoneda")) = "PEN" Then
                                
                                NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) * Val("" & txt_TipoCambio.Text), "0.00"))
                            
                            ElseIf Trim("" & RsC.Fields("IdMoneda")) = "USD" Then
                            
                                NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) / Val("" & txt_TipoCambio.Text), "0.00"))
                            
                            End If
                                
                        End If
                        
                    Else
                        
                        CSqlC = "Select A.IdMoneda,A.TotalPrecioVenta,A.TipoCambio " & _
                                "From DocVentas A " & _
                                "Where A.IdEmpresa = '" & glsEmpresa & "' And A.IdDocumento = '" & strTipoDoc & "' And A.IdSerie = '" & txt_Serie.Text & "' " & _
                                "And A.IdDocVentas = '" & txt_NumDoc.Text & "'"
                        RsD.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
                        If Not RsD.EOF Then
                        
                            If Trim("" & RsD.Fields("IdMoneda")) = txtCod_Moneda.Text Then
                                
                                NImporteDocumentoG = Val("" & RsD.Fields("TotalPrecioVenta"))
                            
                            ElseIf txtCod_Moneda.Text = "PEN" Then
                            
                                NImporteDocumentoG = Val(Format(Val("" & RsD.Fields("TotalPrecioVenta")) * Val("" & RsD.Fields("TipoCambio")), "0.00"))
                                
                            ElseIf txtCod_Moneda.Text = "USD" Then
                                
                                NImporteDocumentoG = Val(Format(Val("" & RsD.Fields("TotalPrecioVenta")) / Val("" & RsD.Fields("TipoCambio")), "0.00"))
                                
                            End If
                            
                            If Val(Format(txt_TotalNeto.Text, "0.00")) > NImporteDocumentoG Then
                                    
                                NImporteDocumento = Val(Format(Val(Format(txt_TotalNeto.Text, "0.00")) - NImporteDocumentoG, "0.00"))
                            
                            Else
                            
                                NImporteDocumento = Val(Format(NImporteDocumentoG - Val(Format(txt_TotalNeto.Text, "0.00")), "0.00"))
                                
                            End If
                            
                            If Trim("" & RsC.Fields("IdMoneda")) <> txtCod_Moneda.Text Then
                        
                                If Trim("" & RsC.Fields("IdMoneda")) = "PEN" Then
                                
                                    NImporteDocumento = Val(Format(NImporteDocumento * Val("" & txt_TipoCambio.Text), "0.00"))
                                
                                ElseIf Trim("" & RsC.Fields("IdMoneda")) = "USD" Then
                                
                                    NImporteDocumento = Val(Format(NImporteDocumento / Val("" & txt_TipoCambio.Text), "0.00"))
                                
                                End If
                                
                            End If
                        
                        End If
                        
                        RsD.Close: Set RsD = Nothing
                        
                    End If
                    
                    If NImporteDocumento > Val("" & RsC.Fields("Saldo")) Then
                        
                        StrMsgError = "El Importe del Documento excede su Línea de Crédito": GoTo Err
                    
                    End If
                    
                ElseIf Trim("" & RsC.Fields("Estado")) = "52001" Then
                    
                    StrMsgError = "El Cliente ha excedido su Línea de Crédito": GoTo Err
                
                ElseIf Trim("" & RsC.Fields("Estado")) = "52002" Then
                    
                    If PIdUsuarioPase = "Pase" Then
                        
                        MsgBox "El Cliente presenta Documentos Vencidos", vbInformation, App.Title
                        
                        PIdUsuarioPase = ""
                        
                        frmAprobacion.MostrarForm "21", IndEvaluacion, PIdUsuarioPase, StrMsgError
                        If StrMsgError <> "" Then GoTo Err
                        
                        If IndEvaluacion = 0 Then
                            
                            StrMsgError = "No tiene permisos para seguir facturando": GoTo Err
                            
                        Else
                        
                            PIndVencidos = True
                            
                        End If
                    
                    ElseIf PIdUsuarioPase <> "Pase2" Then
                    
                        StrMsgError = "El Cliente presenta Documentos Vencidos": GoTo Err
                    
                    End If
                    
                End If
                
            Else
                
                StrMsgError = "El Cliente no presenta Línea de Crédito": GoTo Err
                
            End If
            
            RsC.Close: Set RsC = Nothing
            
        End If
    
    End If
    
    Exit Sub
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If RsD.State = 1 Then RsD.Close: Set RsD = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub ActualizaLineaCredito(StrMsgError As String, PIdCliente As String)
On Error GoTo Err
Dim CSqlC                       As String
Dim CPC                         As String
        
    If Len(Trim("" & traerCampo("Parametros", "ValParametro", "GlsParametro", "MONEDA_LINEA_CREDITO", True))) > 0 Then 'Si tiene asignada la Moneda se entiende que debe controlar
        
        If Len(Trim(CTmpDocumentos)) = 0 Then
        
            CPC = ComputerName
            CPC = Replace(CPC, "-", "")
            CPC = Trim(CPC)
            
            CTmpDocumentos = "TmpDocumentosV" & Trim(Format(Now, "ddmmyyy") & Format(Now, "hhMMss") & glsUser & CPC)
            
        End If
        
        If Len(Trim(CTmpGuiasNF)) = 0 Then
    
            CPC = ComputerName
            CPC = Replace(CPC, "-", "")
            CPC = Trim(CPC)
            
            CTmpGuiasNF = "TmpGuiasNFV" & Trim(Format(Now, "ddmmyyy") & Format(Now, "hhMMss") & glsUser & CPC)
            
        End If
        
        If Len(Trim(CTmpDocumentosGen)) = 0 Then
    
            CPC = ComputerName
            CPC = Replace(CPC, "-", "")
            CPC = Trim(CPC)
            
            CTmpDocumentosGen = "TmpDocumentosGenV" & Trim(Format(Now, "ddmmyyy") & Format(Now, "hhMMss") & glsUser & CPC)
            
        End If
        
        CSqlC = "Call Spu_VerificaMorosos('" & glsEmpresa & "','" & PIdCliente & "','0','" & CTmpDocumentos & "','" & CTmpGuiasNF & "','" & CTmpDocumentosGen & "')"
                
        Cn.Execute CSqlC
                
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    Exit Sub
    Resume
End Sub

Private Sub ValidaStock(StrMsgError As String, PIdDocumento As String, PIdSerie As String, PIdDocVentas As String, PIdProducto As String, PCantidad As Double, PFechaEmi As String)
On Error GoTo Err
Dim CSqlC                       As String
Dim RsC                         As New ADODB.Recordset
    
    CalculaStock StrMsgError, PIdDocumento, PIdSerie, PIdDocVentas, PIdProducto, PFechaEmi, "0", "0"
    If StrMsgError <> "" Then GoTo Err
    
    CSqlC = "Select * From " & CTmpStock
    RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
    If Not RsC.EOF Then
    
        If Val(PCantidad) > Val("" & RsC.Fields("Stock")) Then
            
            StrMsgError = "El Producto excede su Stock " & Trim("" & RsC.Fields("Stock"))
            
            Cn.Execute "Drop Table " & CTmpStock
            
            GoTo Err
        
        End If
        
    End If
    RsC.Close: Set RsC = Nothing
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub CalculaStock(StrMsgError As String, PIdDocumento As String, PIdSerie As String, PIdDocVentas As String, PIdProducto As String, PFechaEmi As String, PIndSelecciona As String, PIndProductos As String)
On Error GoTo Err
Dim CSqlC                       As String
Dim CPC                         As String
Dim RsC                         As New ADODB.Recordset
Dim CTipoVale                   As String
Dim CIdValesCab                 As String
Dim StrProducto                 As String
Dim dblCantidad                 As Double

    indCargando = True
    
    PFechaEmi = Format(PFechaEmi, "yyyy-mm-dd")
    
    CTipoVale = traerCampo("DocVentas", "TipoVale", "IdDocumento", PIdDocumento, True, "IdSerie = '" & PIdSerie & "' And IdDocVentas = '" & PIdDocVentas & "'")
    
    If CTipoVale <> "" Then
        CIdValesCab = traerCampo("DocVentas", "IdValesCab", "IdDocumento", PIdDocumento, True, "IdSerie = '" & PIdSerie & "' And IdDocVentas = '" & PIdDocVentas & "'")
    End If
    
    If PIndProductos = "1" Then
        PIdProducto = ""
        StrProducto = ""
        
        gDetalle.Dataset.First
        Do While Not gDetalle.Dataset.EOF
            
            PIdProducto = PIdProducto & "''" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value & "'',"
                           
            StrProducto = Trim("" & gDetalle.Columns.ColumnByFieldName("IdProducto").Value)
            dblCantidad = Val(Format(gDetalle.Columns.ColumnByFieldName("cantidad").Value, "0.00"))
            
            If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
            
            CSqlC = " SELECT Format(ifnull(XZ.sc_stock,0) + ifnull(s.Stock,0),2) as Stock " & _
            "FROM productos p INNER JOIN marcas m ON p.idEmpresa = m.idEmpresa AND p.idMarca = m.idMarca " & _
            "INNER JOIN unidadMedida u ON p.idUMCompra = u.idUM " & _
            "INNER JOIN monedas o ON p.idMoneda = o.idMoneda " & _
            "LEFT JOIN tallapeso t ON p.idEmpresa = t.idEmpresa AND p.idTallaPeso = t.idTallaPeso " & _
            "Left Join (Select P.idEmpresa,IfNull(vd.idSucursal,'') Idsucursal,P.idProducto,vc.idAlmacen, " & _
            "sum(If(vd.idempresa is null,0,if(vd.tipovale = 'I',Cantidad,Cantidad * -1))) as Stock " & _
            "From Productos P Inner Join ValesDet vd On P.IdEmpresa = vd.IdEmpresa And P.IdProducto = vd.IdProducto " & _
            "Inner Join Valescab vc On vd.idEmpresa = vc.idEmpresa And vd.idSucursal = vc.idSucursal " & _
            "And vd.tipoVale = vc.tipoVale And vd.idValesCab = vc.idValesCab " & _
            "Where P.idEmpresa = '" & glsEmpresa & "' AND estProducto = 'A' and vc.Idvalescab <> '" & CIdValesCab & "' " & _
            "AND vc.idSucursal = '" & glsSucursal & "' And vc.estValeCab <> 'ANU' " & _
            "AND vc.idAlmacen = '" & Trim("" & txtCod_Almacen.Text) & "' AND DATE_FORMAT(vc.fechaemision, '%Y%m%d')  = DATE_FORMAT(sysdate(), '%Y%m%d') AND (p.idProducto = '" & StrProducto & "') " & _
            "Group bY P.idEmpresa,P.idProducto,vc.idAlmacen) S " & _
            "On P.idEmpresa = S.idEmpresa And P.idProducto = S.idProducto " & _
            "Left Join (SELECT sc_periodo,sc_codalm,sc_codart,sc_stock,idempresa FROM tbsaldo_costo_kardex z " & _
            "where sc_codalm = '" & Trim("" & txtCod_Almacen.Text) & "' and sc_periodo = DATE_FORMAT(sysdate(), '%Y%m') and sc_stock <> 0) XZ " & _
            "On P.idEmpresa  = xz.idempresa And P.idProducto = xz.sc_codart " & _
            "Where p.idEmpresa = '" & glsEmpresa & "' AND (p.idProducto = '" & StrProducto & "') AND estProducto = 'A' "
            
            RsC.Open CSqlC, Cn, adOpenKeyset, adLockReadOnly
            If Not RsC.EOF Then
            
                If Val(Format("" & RsC.Fields("Stock"), "0.00")) < Val(Format(dblCantidad, "0.00")) Then
                    StrMsgError = StrMsgError & " La Cantidad Ingresada para el Producto " & " " & StrProducto & " Exede el stock Verifique" & "  " & Chr(13) & Chr(10)
                End If
            
            End If
            
            RsC.Close: Set RsC = Nothing
    

            gDetalle.Dataset.Next
        Loop
        If Len(Trim("" & PIdProducto)) > 0 Then PIdProducto = left(PIdProducto, Len(PIdProducto) - 1)
        
        If StrMsgError <> "" Then GoTo Err
        
    Else
        
        If PIdProducto <> "" Then
            PIdProducto = "''" & PIdProducto & "''"
        End If
        
    End If
    
'************* LUIS LARA 13/01/2018 ****************
''''    If CTmpStock = "" Then
''''
''''        CPC = ComputerName
''''        CPC = Replace(CPC, "-", "")
''''        CPC = Trim(CPC)
''''
''''        CTmpStock = "TmpStock" & Trim(Format(Now, "ddmmyyy") & Format(Now, "hhMMss") & glsUser & CPC)
''''
''''    End If
''''
''''    CSqlC = "Call Spu_CalculaStockNuevo('" & glsEmpresa & "','" & CTmpStock & "','" & PIdProducto & "','" & PIndSelecciona & "','" & glsSucursal & "','" & CTipoVale & "','" & CIdValesCab & "','" & txtCod_Almacen.Text & "','" & PFechaEmi & "')"
''''
''''    Cn.Execute CSqlC
'***************************************************

    indCargando = False
    
Exit Sub
Err:
    indCargando = False
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub ValidaStock_Y_Saldos(StrMsgError As String, PIdDocumento As String, PIdSerie As String, PIdDocVentas As String, PIdProducto As String, PFechaEmi As String)
On Error GoTo Err
Dim CSqlC                       As String
Dim RsC                         As New ADODB.Recordset
Dim CDocReferencias             As String
Dim CPC                         As String
Dim NCantidadPorV               As Double
Dim RsDet                       As New ADODB.Recordset
Dim RsDetClone                  As New ADODB.Recordset
    
    'Luis 24/06/2017

    If Trim("" & txtCod_MotivoTraslado.Text) <> "" Then
    
        CSqlC = Trim("" & traerCampo("motivostraslados", "indtipovale", "idMotivoTraslado", Trim("" & txtCod_MotivoTraslado.Text), False, " idDocumento = '" & PIdDocumento & "' "))
        If CSqlC = "I" Then Exit Sub
    
    End If
    
    If CTmpReferencia = "" Then
    
        CPC = ComputerName
        CPC = Replace(CPC, "-", "")
        CPC = Trim(CPC)
        
        CTmpReferencia = "TmpDocsReferencia" & Trim(Format(Now, "ddmmyyyy") & Format(Now, "hhMMss") & glsUser & CPC)
    
    End If
    
    If CTmpProductosDesp = "" Then
    
        CPC = ComputerName
        CPC = Replace(CPC, "-", "")
        CPC = Trim(CPC)
        
        CTmpProductosDesp = "TmpProductosDesp" & Trim(Format(Now, "ddmmyyyy") & Format(Now, "hhMMss") & glsUser & CPC)
    
    End If
    
    gDocReferencia.Dataset.First
    Do While Not gDocReferencia.Dataset.EOF
        
        If Len(Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value)) > 0 _
        And Len(Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdSerie").Value)) > 0 _
        And Len(Trim("" & gDocReferencia.Columns.ColumnByFieldName("IdDocVentas").Value)) > 0 Then
        
            CDocReferencias = CDocReferencias & "''" & gDocReferencia.Columns.ColumnByFieldName("IdDocumento").Value & _
                            gDocReferencia.Columns.ColumnByFieldName("IdSerie").Value & gDocReferencia.Columns.ColumnByFieldName("IdDocVentas").Value & "'',"
                
        End If
        
        gDocReferencia.Dataset.Next
        
    Loop
    
    If Len(Trim("" & CDocReferencias)) > 0 Then
        
        CDocReferencias = left(CDocReferencias, Len(CDocReferencias) - 1)
    
    End If
    
    CalculaStock StrMsgError, PIdDocumento, PIdSerie, PIdDocVentas, PIdProducto, PFechaEmi, "0", "1"
    If StrMsgError <> "" Then GoTo Err
    
'********************* luis lara 13/01/2018 **************************
''''    CSqlC = "Call Spu_ValidaStock_Y_Saldos('" & glsEmpresa & "','" & CTmpReferencia & "','" & CTmpProductosDesp & "','" & CTmpStock & "','1'," & _
''''            "'" & txtCod_Cliente.Text & "','" & PIdDocumento & "','" & PIdSerie & "','" & PIdDocVentas & "','" & CDocReferencias & "')"
''''    RsC.Open CSqlC, Cn, adOpenStatic, adLockReadOnly
''''    If Not RsC.EOF Then
''''
''''        Set RsDet = GDetalle.DataSource
''''        Set RsDetClone = RsDet.Clone(adLockReadOnly)
''''
''''        Do While Not RsC.EOF
''''
''''            RsDetClone.Filter = "IdProducto = '" & RsC.Fields("IdProducto") & "'"
''''            NCantidadPorV = Val("" & RsDetClone.Fields("Cantidad")) - Val("" & RsC.Fields("CantidadPorI"))
''''            If NCantidadPorV > 0 Then
''''
''''                If NCantidadPorV > Val("" & RsC.Fields("Stock")) Then
''''
''''                    If Val("" & RsC.Fields("CantidadPorI")) > 0 Then
''''
''''                        StrMsgError = StrMsgError & "La Cantidad(" & Val("" & RsDetClone.Fields("Cantidad")) & " - " & Val("" & RsC.Fields("CantidadPorI")) & " = " & NCantidadPorV & ") de el Producto " & RsC.Fields("IdProducto") & " excede su Stock(" & Val("" & RsC.Fields("Stock")) & ")" & "  " & Chr(13) & Chr(10)
''''
''''                    Else
''''
''''                        StrMsgError = StrMsgError & "La Cantidad(" & NCantidadPorV & ") de el Producto " & RsC.Fields("IdProducto") & " excede su Stock(" & Val("" & RsC.Fields("Stock")) & ")" & "  " & Chr(13) & Chr(10)
''''
''''                    End If
''''
''''                End If
''''
''''            End If
''''
''''            RsC.MoveNext
''''
''''        Loop
''''
''''        RsDetClone.Close: Set RsDetClone = Nothing
''''
''''    End If
''''
''''    RsC.Close: Set RsC = Nothing
    
    If StrMsgError <> "" Then
        
        If PIdDocumento <> "40" And PIdDocumento <> "92" Then
            GoTo Err
        Else
            MsgBox StrMsgError, vbInformation, App.Title
            StrMsgError = ""
        End If
        
    End If
    
Exit Sub
Err:
    If RsC.State = 1 Then RsC.Close: Set RsC = Nothing
    If RsDetClone.State = 1 Then RsDetClone.Close: Set RsDetClone = Nothing
    If StrMsgError = "" Then StrMsgError = Err.Description
End Sub

Private Sub TxtIdCentroCostoCliente_Change()
On Error GoTo Err
Dim StrMsgError                         As String

    If Trim("" & TxtIdCentroCostoCliente.Text) = "" Then Exit Sub
    If TxtIdCentroCostoCliente.Text = "" Or Not FraCentroCostoCliente.Visible Then
        TxtGlsCentroCostoCliente.Text = ""
    Else
        TxtGlsCentroCostoCliente.Text = traerCampo("CentrosCosto", "GlsCentroCosto", "IdCentroCosto", TxtIdCentroCostoCliente.Text, False, "IdEmpresa = '" & traerCampo("Empresas", "IdEmpresa", "IdPersona", txtCod_Cliente.Text, False) & "'")
    End If
    
    Exit Sub
Err:
    If StrMsgError = "" Then StrMsgError = Err.Description
    MsgBox StrMsgError, vbInformation, App.Title
End Sub
